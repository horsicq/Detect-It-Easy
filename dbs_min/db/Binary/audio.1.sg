meta("audio",""),includeScript("chunkparsers"),includeScript("soundchips"),includeScript("bytecodeparsers")
var debug=0
function isWinCert(){if(X.Sz()>=(_wcsz=X.U32(0,_LE))&&X.c("00 02 02 00 30",4)){if(_wcp=9,!((_wca=X.U8(_wcp++))<128))if(128<_wca)for(_wcc=128^_wca,_wci=_wca=0;_wci<_wcc;_wci++)_wca=(_wca<<8)+X.U8(_wcp++)
else _wca=-1
if(0<_wca&&_wca+_wcp<=_wcsz&&X.c("06 09 2A 86 48 86 F7 0D 01 07 02",_wcp))return!0}return!1}function detect(){if(!isWinCert()){var e,t,es,rs,G=0,Y=0,c=0,U=0,j=0,i=0,E=0,k=0,K=-1,F="",p="",l="",r="",a="",_="",O=""
if(X.c("'[1tracker module]'0D0A"))sName="Shiru's 1tracker module (.1TM)",bDetected=1,0<=(j=X.fStr(1,64,"Engine="))&&(i=X.fStr(j+7,64,"."),sVersion="for "+X.SA(j+7,i-j-7)),X.isVerbose()&&(0<=(j=X.fStr(i,128,"Title="))&&(i=X.fSig(j+6,64,"0D0A"),sOption(X.SA(j+6,i-j-6))),0<=(j=X.fStr(i,128,"Author="))&&(i=X.fSig(j+7,64,"0D0A"),sOption(X.SA(j+7,i-j-7),"by: ")),0<=(j=X.fStr(i,128,"Speed=")))&&(i=X.fSig(j+7,64,"0D0A"),sOption(X.SA(j+7,i-j-7),"spd:"))
else if(X.c("'_A2module_'")&&isWithin(nV=X.U8(14),1,14))bDetected=1,bad=!1,sName="subz3ro's AdLib Tracker II module (.A2M)",sVersion="/┤DLiB TR/┤CK3R ][ v"+nV,ptn=X.U8(15),(bad=!ptn||64<ptn?"!badptn":bad)?sVersion+="/malformed"+bad:X.isVerbose()&&sOption("ptn:"+ptn)
else if(X.c("'_A2tiny_module_'")&&isWithin(nV=X.U8(19),1,14))sName="subz3ro's AdLib Tracker II module (.A2T)",bDetected=1,bad=!1,sVersion="/┤DLiB TR/┤CK3R ][ v"+nV+" tiny",(!(ptn=X.U8(20))||64<ptn)&&(bad="!badptn"),tmp=X.U8(21),spd=X.U8(22),rows=X.U16(24),trk=X.U8(26),bad?sVersion+="/malformed"+bad:X.isVerbose()&&sOption("tempo:"+tmp+" spd:"+tmp+" trk:"+trk+" ptn:"+ptn)
else if(X.c("'EXITgB'2018201820182F18201024C94AA80004660A558006A80000000200042200D28924C1D0A8000424C0D1DF2018D1D82018D1D82018201812D804800000000166F660B4610000'H|'017E01610000'Z|'027E02610000'R|'037E03610000'JL'DF7FFF'NuH'E7FFFE7E01610000AC7E02610000A67E03610000A04CDF7FFF'Nu`'0A602260000092600000'~A'FA....4BF900DFF000'p0;|'000000AA0440001064F4'NuK'F900DFF0003007C0FC",26))bDetected=1,sName="Franck Sauer and Yves Grolet's Art & Magic module (.AAM)",X.isVerbose()&&(0<=(E=X.fSig(32768,Math.min(65535,X.Sz()),"'EXIT'"))?sOption(outSz(E+4),"sz:"):sVersion="malformed!short")
else if(X.c("'ADLIB'01"))sName="Martin Fernandez's Adlib module (.ADLIB)",bDetected=1,X.isVerbose()&&(E=X.SA(6,256),g=X.SA(6+E.length+1,256),sOption(E),sOption(g,"for: "))
else if(X.c("'AERO'00000001")&&202==X.U8(15)&&202==X.U8(31)&&202==X.U8(47))sName="ioNeo's Aero Studio module (.AERO)",bDetected=1,X.isVerbose()&&sOption("sz:"+outSz(X.U32(8)+12))
else if(0<X.fSig(20,256,'\'<aks:song xmlns:aks="http://www.julien-nevo.com/ArkosTrackerSong"'))sName="Julien Névo's Arkos Tracker 2 module (.AKS)",sVersion="unpacked",bDetected=1
else if(X.c("'AM01'000000")&&X.c("'ASD1'",56)&&0<(amp=X.fSig(64,16777216,"'AMP'.. ........'ASSH'"))){for(sName="New Beat's Ace Tracker module (.AM)",bDetected=1,maxsz=Math.min(X.Sz(),16777216),F=by=bad="",ptn=ord=smp=K=0,ptns=[],G=60;G<amp&&smp<64&&(E=X.U32(G,_BE));)G+=E,smp++
for(G+=4,X.c("'AMP'.. ........'ASSH'",G)||(G=amp,bad=bad.addIfNone("!badsmp"),smp=Math.max(1,smp)),3<(ampv=X.U8(G+3)-48)&&(bad=bad.addIfNone("!unkver")),sVersion="v"+ampv,ins=X.U32(G+4,_BE),G+=12,inss=[],Y=0;Y<ins;Y++,G+=1==ampv?205:2==ampv?209:3==ampv?212:0)""!=(E=X.SA(G+4,20).trim())&&"Empty"!=E&&inss.push(E)
if(X.c("'ASG1'",G)||(bad=bad.addIfNone("!badins")),asg1=X.fSig(amp,maxsz,"'ASG1'"),ord=ptn=0,asg1<0)bad=bad.addIfNone("!nosong")
else for(F=X.SC(asg1+4,20,"CP437"),by=X.SC(asg1+24,20,"CP437"),Y=asg1+44;Y<asg1+300;Y++)(E=X.U8(Y))&&(ord=Y-asg1-43,E>ptn)&&(ptn=E)
if(G=asg1+300,apn1=X.fSig(asg1,1024,"'APN1'"),ch=ptn_=-1,0<apn1){for(G!=apn1&&(bad=bad.addIfNone("!badptn")),ptn_=X.U32(apn1+4,_BE),ptn!=ptn_&&(bad=bad.addIfNone("!badptn"+ptn+"/"+ptn_)),Y=0,G=apn1+8;Y<ptn_;Y++)(E=X.SC(G+4,12,"CP437").trim()).length&&"Empty"!=E&&ptns.push(E),(ch_=X.U16(G,_BE))>ch&&(ch=ch_),G+=16+4*ch_*X.U16(G+2,_BE)
K=G}else bad=bad.addIfNone("!noptns");(bad=16<ch?bad.addIfNone("!badchn"):bad).length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(F),sOptionT(by,"by: "),sOptionT(addEllipsis(inss.filter(funSampleName).join(" ")),'ins/msg:"','"'),sOptionT(addEllipsis(ptns.join(" ")),'ptns:"','"'),sOption((0<ch?"ch:"+ch+" ":"")+"ord:"+ord+" ptn:"+(ptn!=ptn_?ptn+"/":"")+ptn_+" ins:"+ins+" smp:"+smp+" xpos:"+X.I32(52)+(K?" sz:"+outSz(K):"")))}else if(X.c("'ASG1'")&&X.c("'APN1'",300)){for(sName="New Beat's Ace Tracker module patterns (.ASG)",bDetected=1,bad="",F=X.SC(4,20,"CP437"),by=X.SC(24,20,"CP437"),ptn=ord=0,G=44;G<300;G++)(E=X.U8(G))&&(ord=G-43,E>ptn)&&(ptn=E)
for(ch=-1,ptns=[],Y=0,G=308;Y<255;Y++)(ch_=X.U16(G,_BE))>ch&&(ch=ch_),ptnsz=ch_*X.U16(G+2,_BE),G+=4,ptnsz&&((E=X.SC(G,12,"CP437").trim()).length&&"Empty"!=E&&ptns.push(E),G+=12+4*ptnsz)
K=G,(bad=16<ch?bad.addIfNone("!badchn"):bad).length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(F),sOptionT(by,"by: "),sOptionT(addEllipsis(ptns.join(" ")),'ptns:"','"'),sOption((0<ch?"ch:"+ch+" ":"")+"ord:"+ord+" ptn:"+ptn+" sz:"+outSz(K)))}else if(X.c("'AMC V1.2 REPLAY!'")&&X.c("0000003C0002\t",78)){if(sName="Marc Hawlitzeck's A.M. Composer module (.AMC)",bDetected=1,sVersion="v"+X.SA(5,3),X.isVerbose()){for(d0=X.U32(20,_BE),a3=X.U32(24,_BE),d3=l=0,G=72,special="",smp=0;G<X.Sz()&&G<a3;G+=16)d2=X.I32(G,_BE)+2*X.U16(G+4,_BE),smp++,d2>d3&&(d3=d2)
if((G=d3)<X.Sz()){for(;G+l<X.Sz()&&isWithin(X.U8(G+l),32,126);)l++
X.U8(G+l)||G+l+1!=X.Sz()||l++,special=X.SA(G,l)}sOption(special,'info:"','"'),sOption("smp:"+smp+" sz:"+outSz(G+l))}}else if(X.c("'<o'EF'QU'EE'RoR'",1062)||X.c("'MaDoKaN96'",1062)){if(sName="Elyssis AMUSiC module (.AMD)",bDetected=1,sVersion="<"!=X.SA(1062,1)?"xms rip-off":"<o∩QUεRoR/ε£¥$$ì$ v101%",17==X.U8(1071)&&(sVersion=sVersion.appendS("packed","/")),X.isVerbose()){for(sOptionT(X.SA(0,24)),sOptionT(X.SA(24,24),"by: "),Y=0,smps=[];Y<26;Y++)smps.push(X.SC(48+34*Y,22,"CP437").replaceAll("ÿ"," ").trim())
if(sOptionT(addEllipsis(smps.filter(funSampleName).join(" "),256,160),'smp/msg:"','"'),ptn=X.U8(933)+1,notes=-1,17==X.U8(1071)){for(G=1072+18*ptn,trk=X.U16(G),G+=2,Y=0;Y<trk&&G<X.Sz();Y++)for(i=0,G+=2;i<64&&G<X.Sz();)128&(l=X.U8(G++))?i+=127&l:(G+=2,i++,notes++)
K=G}else K=1072+1728*ptn
sOption("ord:"+X.U8(932)+" ptn:"+ptn+(0<K?" sz:"+outSz(K):""))}}else if(X.c("'ASYLUM Music Format V1.0'00000000 00000000")&&X.U8(34)<=64&&X.Sz()>=2662+2048*X.U8(35)){if(sName="Electronic Arts' ASYLUM Music Format module (.AMF)",bDetected=1,sVersion="v"+X.SA(21,3),X.isVerbose()){spd0=X.U8(32),bpm0=X.U8(33),smp=X.U8(34),ptn=X.U8(35),ord=X.U8(36)
var G=294,B=0
for(smps=[],Y=0;Y<smp;Y++)smps.push(decAnsi(294+37*Y,22,CP437,!0,Chars0to1F).trim()),B+=X.U32(294+37*Y+25)
K=2662+2048*ptn+B,sOptionT(addEllipsis(smps.filter(funSampleName).join(" "),256,160),'smp/msg:"','"'),sOption("spd0:"+spd0+" bpm0:"+bpm0+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" smpsz:"+Hex(B)+" sz:"+outSz(K))}}else if(X.c("'Extreme0'01")&&X.U8(15)<=32){if(sName="Extreme's Tracker Advanced Module System track (.AMS)",bDetected=1,X.isVerbose()){for(cmd=X.U8(9)>>5,sch=1+(31&X.U8(9)),smp=X.U8(10),ptn=X.U16(11),ord=X.U16(13),vmch=X.U8(15),xtra=X.U16(16),G=xtra+18,S=[],Y=B=0;Y<smp;Y++,G+=17){var A=X.U32(G)
B+=A,co=3&X.U8(G+16),b16=128&X.U8(G+16)?2:1,S.push([co,A,b16])}for(sOptionT(X.SC(G+1,X.U8(G),"CP437")),G+=1+X.U8(G),smps=[],Y=0;Y<smp;Y++)smps.push(X.SC(G+1,X.U8(G),"CP437")),G+=1+X.U8(G)
for(schs=[],Y=0;Y<sch;Y++)schs.push(X.SC(G+1,X.U8(G),"CP437")),G+=1+X.U8(G)
for(Y=0;Y<ptn;Y++)G+=1+X.U8(G)
var r=X.readBytes(G+2,X.U16(G),!0),D=[]
for(G+=2+X.U16(G),Y=0;Y<r.length;Y++)r[Y]<128?D.push(r[Y]):r[Y]<=160?D.push(32):D.push(10)
for(r=decEncoding(D,"CP437"),D=void 0,mptn=-1,Y=0;Y<ord;Y++)(E=X.U16(G+2*Y))>mptn&&(mptn=E)
for(mptn++,G+=2*ord,Y=0;Y<ptn;Y++)G+=4+X.U32(G)
for(allsmpcsz=0,Y=0;Y<smp;Y++)S[Y][0]?S[Y][1]&&(G+=4,scosz=X.U32(G),cc=X.U8(G+4),G+=5+scosz,allsmpcsz+=scosz):G+=8+S[Y][1]*S[Y][2]
S=void 0,sOption(addEllipsis(schs.join(" "),160,128),'chns:"','"'),sOption(addEllipsis(r.trim(),256,128),'msg:"','"'),sOption("ord:"+ord+" ptn:"+ptn+(mptn!=ptn?"/"+mptn:"")+" smp:"+smp+" cmd:"+cmd+" strk:"+sch+(vmch?" mtrk:"+vmch:"")+" co.smpsz:"+(100*allsmpcsz/B).toFixed(1)+"% sz:"+outSz(G))}}else if(X.c("'AMShdr'1A")&&X.U8(7)<=30&&2==X.U8(9+X.U8(7))&&X.U8(8+X.U8(7))<=2){if(bDetected=1,G=8+X.U8(7),nv=X.U8(G),sName="Velvet Studio Advanced Module System track (.AMS)",sVersion="v"+X.U8(G+1)+"."+nv,bad="",1024<(ptn=X.U16(G+3))&&(bad=bad.addIfNone("!badptn")),ord=X.U16(G+5),X.isVerbose()){for(F=X.SC(8,G-8,"CP437"),ins=X.U8(G+2),G+=7,X.Sz()<47+2*ins+2*ord+4*ptn&&(bad=bad.addIfNone("!short")),2==nv?(bpm0=Math.max(8192,X.U16(G)),G+=2,bpm0=(bpm0>>8)+"."+(255&bpm0),spd0=Math.max(1,X.U8(G++)),G+=3,flg=X.U16(G),G+=2):(bpm0=Math.max(32,X.U8(G++)),spd0=Math.max(1,X.U8(G++)),flg=X.U8(G++)),ch=flg>>6&1?"2":"1",linfreqtbl=64&flg?" lnr.freq.tbl.":"",midiused=128&flg?" MIDI used":"",sOptionT(F),inss=[],smps=[],S=[],B=allsmpcsz=smp=shd=0,Y=0;Y<ins;Y++)if(30<(t_=X.U8(G++))&&(bad=bad.addIfNone("!badins")),E=X.SC(G,t_,"CP437").trim(),G+=t_,""!=E&&inss.push(E),inssmp=X.U8(G++))for(0==nv?G+=100:G+=124,63<(E=X.U8(G++))&&(bad=bad.addIfNone("!badenv")),G+=3*E+4,63<(E=X.U8(G++))&&(bad=bad.addIfNone("!badpan")),G+=3*E+4,63<(E=X.U8(G++))&&(bad=bad.addIfNone("!badvibenv")),G+=3*E,E=X.U8(G),(shdins=0<E)&&shd++,G+=5,s=0;s<inssmp;s++)22<(t_=X.U8(G++))&&(bad=bad.addIfNone("!badsmp")),E=X.SC(G,t_,"CP437").trim(),G+=t_,A=X.U32(G),G+=4,shdins||smp++,A&&(shdins||(B+=A,sfl=X.U8(G+15),co=3&sfl,b16=4&sfl?2:1,S.push([co,A,b16])),G+=16)
for(t_=X.U8(G++),sOptionT(X.SC(G,t_,"CP437"),"by:"),G+=t_,schs=[],Y=0;Y<32;Y++)schs.push(X.SC(G+1,X.U8(G),"CP437")),G+=1+X.U8(G)
if(r=X.readBytes(G+11,X.U32(G)-11),D=[],co=X.U8(G+10),G+=X.U32(G),co){for(Y=0;Y<r.length;)if(255==(l=r[Y++])&&2<=r.length-Y)if(l=r[Y++],n=r[Y++],32!=l)for(c=0;c<n;c++)D.push(l)
else n<=32?D.push(32):D.push(10)
else D.push(l)
r=decEncoding(D,"CP437")}else r=decEncoding(r,"CP437")
for(D=void 0,G+=ord<<1,Y=0;Y<ptn;Y++)G+=4+X.U32(G)
for(G>X.Sz()&&(bad=bad.addIfNone("!short")),Y=0;Y<smp;Y++)S[Y][0]?S[Y][1]&&(scosz=X.U32(G+4),cc=X.U8(G+9),G+=9+scosz,allsmpcsz+=scosz):G+=S[Y][1]*S[Y][2]
K=G,sOption(addEllipsis(schs.join(" "),160,128),'chns:"','"'),sOption(addEllipsis(inss.filter(funSampleName).join(" "),160,128),'insts/msg:"','"'),sOption(addEllipsis(r.trim(),160),'msg:"','"'),sOption("ch:"+ch+" ins:"+ins+(shd?"+"+shd+"sh":"")+" ord:"+ord+" ptn:"+ptn+" bpm0:"+bpm0+" spd0:"+spd0+linfreqtbl+midiused+" co.smpsz:"+(100*allsmpcsz/B).toFixed(1)+"% sz:"+outSz(K))}bad&&(sVersion=sVersion.appendS("malformed"+bad,"/"))}else if(X.c("'AMX "))sName="Dmitry 'AND' Andreev's XSynth module (.AMX)",bDetected=1
else if(X.c("'AON4'")||X.c("'AON8'")){if(sName="Bastian 'Twice' Spiegel's Art of Noise/Chorus module (.AON)",bDetected=1,ch=X.U8(3)-48,X.isVerbose()){for(id=X.SA(4,42),G=46,E=p=d=l="",ord=ptn=ins=0;G<X.Sz();){if(63==X.U8(G)){G+=4-G&3
break}if(hkhd=X.readBytes(G,4),charStat(hkhd,1).indexOf("allasc")<0)break
switch(hkhd=decEncoding(hkhd,CP437),hksz=X.U32(G+4,_BE),G+=8,hkhd){case"NAME":E=X.SC(G,hksz,"CP1252")
break
case"AUTH":p=X.SC(G,hksz,"CP1252")
break
case"DATE":d=X.SC(G,hksz,"CP1252")
break
case"RMRK":l=X.SC(G,hksz,"CP1252")
break
case"PLST":for(ord=hksz,Y=0;Y<ord;Y++)(o=X.U8(G+Y)+1)>ptn&&(ptn=o)
break
case"WLEN":for(Y=0;Y<hksz>>2;Y+=4)X.U32(G+Y,_BE)&&ins++}G+=hksz}sOptionT(E),sOptionT(p,"by: "),sOptionT(d,"on: "),sOption(id,"in: "),sOption(addEllipsis(l.trim(),160)),sOption("ch:"+ch+" ord:"+ord+" ptn:"+ptn+" ins:"+ins+" sz:"+outSz(G))}}else if(X.c("'ADRVPACK'"))sName="Petter A. Urkedal's AProSys module (.APS)",bDetected=1
else if(X.c("'ARP.'"))sName="Major Tom's Player 2 module (.ARP)",bDetected=1
else if(X.c("'ACTIONAMICS SOUND TOOL'",62))sName="Michael Kleps's Actionamics Sound Tool module (.AST)",bDetected=1,sVersion="v"+X.SA(86,3)
else if(X.c("08'AST '")&&isWithin(X.U8(9),4,8)&&X.U16(10)<=1001){if(sName="Patrice 'Cagliostro' Bouchand's All Sound Tracker module (.AST)",sVersion="v"+X.SA(5,4),bDetected=1,X.isVerbose()){for(L=X.U16(10),a=X.SC(12,L+1,"CP850"),G=13+L,s="",Y=0;Y<L;Y+=38)(E=a.slice(Y,Y+38).trim()).length&&(s=s.appendS(E,"\n"))
for(sOption(addEllipsis(s,512)),ord=X.U8(G++),Y=ptn=K=0;Y<=ord;Y++)ptn=Math.max(ptn,X.U8(G++)+1)
for(fmp=X.I32(G),awp=X.I32(G+4),ptnp=X.I32(G+8),awesonp=X.I32(G+12),wavep=X.I32(G+16),G+=20,K=Math.max(K,G),G=fmp,fmi=0,n=X.U8(G++);n<255&&G<X.Sz();fmi++)G+=20,n=X.U8(G++)
for(K=Math.max(K,G),G=awp,awes=0,n=X.U8(G++);n<255&&G<X.Sz();awes++)G+=51,n=X.U8(G++)
for(awei=0,n=X.U8(G++);n<255&&G<X.Sz();awei++)G+=39,n=X.U8(G++)
for(awed=0,n=X.U8(G++);n<255&&G<X.Sz();awed++)G+=3,n=X.U8(G++)
for(G=G+2+793,K=Math.max(K,G),G=ptnp,ptn_=0,n=X.U8(G++);n<255&&G<X.Sz();ptn_++)G+=2+X.U16(G),n=X.U8(G++)
for(K=Math.max(K,G),G=wavep,wf=0,n=X.U8(G++);n<255&&G<X.Sz();wf++)G+=36,n=X.U8(G++)
K=Math.max(K,G),"v0001"===sVersion&&K--,sOption("def:"+X.U8(9)+" ord:"+ord+" ptn:"+ptn+(ptn_!=ptn?"/"+ptn_:"")+" wavep:"+Hex(wavep)+(fmi?" FMins:"+fmi:"")+(awes?" AWEsmp:"+awes:"")+(awei?" AWEins:"+awei:"")+(wf?" wf:"+wf:"")+" sz:"+outSz(K))}}else if(X.c("'AudioSculpture10'00180018"))sName="Synchron Assembly's Audio Sculpture synth file (.AS)",bDetected=1
else if(X.c("'##synth'0D0A"))sName="Athaudia's Athtune module (.ATHTUNE)",bDetected=1
else if(X.c("'FORM'.... ....'AXSFUSER'")&&X.c("'SHDR'",E=X.U32(16,_BE)+20)&&X.c("'SONG'",X.U32(E+4,_BE)+E+8)){if(sName="Resolution's AXS module (.AXS)",bDetected=1,X.isVerbose()){for(ord=ptn=ins=smp=0,K=X.U32(4,_BE)+8,G=12,maxsz=Math.min(K,X.Sz());G<maxsz&&(hkhd=X.readBytes(G,4),!(charStat(hkhd,1).indexOf("allasc")<0));){switch(hkhd=decEncoding(hkhd,CP437),hksz=X.U32(G+4,_BE),G+=8,hkhd){case"SONG":ord=hksz>>3
break
case"BLOK":ptn++
break
case"INST":ins++
break
case"SAMP":smp++}G+=hksz}sOption("ord:"+ord+" ptn:"+ptn+(ins?" syn:"+ins:"")+(smp?" smp:"+smp:"")+" sz:"+outSz(K))}}else if(X.c("'BBSONG'00'0001'00")){sName="Shiru's Beepola module (.BBSONG)",bDetected=1
var is=!(G=12)
for(ord=orn=ptn=svgptn=svgwarp=phains=0,bad=F=auth=engine="";G<X.Sz()&&!(G>=X.Sz());){if(58!=X.U8(G++)){G--
break}switch(E=X.SA(G,254),G+=E.length+1,E){case"INFO":for(;G<X.Sz()&&(E=X.SC(G,TOEOF,"CP1251"),G+=E.length+1,":END"!==E);)switch((xx=2<(xx=E.split("=")).length?[xx[0],xx.slice(1,xx.length).join("=")]:xx)[0]){case"Title":F=xx[1]
break
case"Author":auth=xx[1]
break
case"Engine":engine=xx[1]}break
case"LAYOUT":for(is=!0;G<X.Sz()&&(E=X.SC(G,TOEOF,"CP1251"),G+=E.length+1,":END"!==E);)switch((xx=2<(xx=E.split("=")).length?[xx[0],xx.slice(1,xx.length).join("=")]:xx)[0]){case"LoopStart":lp=+xx[1]
break
case"Length":for(ord=+xx[1],ptn=0,Y=0;Y<ord;Y++)ptn<=(E=X.U8(G++))&&(ptn=E+1)}break
case"PATTERNDATA":for(;G<X.Sz()&&(E=X.SC(G,1024,"CP1251"),G+=E.length+1,":END"!==E);)if("PatternCount"===(xx=2<(xx=E.split("=")).length?[xx[0],xx.slice(1,xx.length).join("=")]:xx)[0])for(ptns=+xx[1],Y=0;Y<ptns&&G<X.Sz()&&(E=X.SC(G,1280,"CP1251"),G+=E.length+1,":END"!==E);Y++)"PatternName"===(xx=2<(xx=E.split("=")).length?[xx[0],xx.slice(1,xx.length).join("=")]:xx)[0]&&(G+=8+5*X.U32(G))
break
case"SVGPATTERNDATA":for(;G<X.Sz()&&(E=X.SC(G,1024,"CP1251"),G+=E.length+1,":END"!==E);)if("PatternCount"===(xx=2<(xx=E.split("=")).length?[xx[0],xx.slice(1,xx.length).join("=")]:xx)[0])for(svgptn=+xx[1],Y=0;Y<svgptn&&G<X.Sz();Y++)G+=4+16*X.U32(G)
break
case"SVGWARPDATA":for(;G<X.Sz()&&(E=X.SC(G,1024,"CP1251"),G+=E.length+1,":END"!==E);)if("PatternCount"===(xx=2<(xx=E.split("=")).length?[xx[0],xx.slice(1,xx.length).join("=")]:xx)[0])for(svgwarp=+xx[1],Y=0;Y<svgwarp&&G<X.Sz();Y++)G+=4+2*X.U32(G)
break
case"P1INSTR":for(;G<X.Sz()&&(E=X.SC(G,1024,"CP1251"),G+=E.length+1,":END"!==E);)"Length"===(xx=2<(xx=E.split("=")).length?[xx[0],xx.slice(1,xx.length).join("=")]:xx)[0]&&(phains=+xx[1],G+=phains)
break
case"SVGORNAMENTS":for(;G<X.Sz()&&(E=X.SC(G,1024,"CP1251"),G+=E.length+1,":END"!==E);)if("OrnamentCount"===(xx=2<(xx=E.split("=")).length?[xx[0],xx.slice(1,xx.length).join("=")]:xx)[0])for(orn=+xx[1],Y=0;Y<orn&&G<X.Sz();Y++)G+=4+X.U32(G)
break
default:bad=bad.addIfNone("!badchunk")}}is||(bad=bad.addIfNone("!corrupt")),sVersion="engine:"+engine,""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(F),sOptionT(auth,"by: "),sOption("ord:"+ord+(lp?" lp:"+lp:"")+" ptn:"+ptn+(svgptn?"+svg":"")+(svgwarp?" warp":"")+(orn?" orn":"")+(phains?" phasers":"")+" sz:"+outSz(G)))}else if(X.c("000003F3")&&X.U8(20)&&X.c("70FF4E75'DAGLISH!'",32)&&X.U32(44,_BE)&&X.U32(48,_BE)&&X.U32(52,_BE)&&X.U32(56,_BE))bDetected=1,sName="Ben Daglish's SID (.BDS)",sVersion="v1.1",X.isVerbose()&&(F=X.SA(32+X.U32(60,_BE),256),auth=X.SA(32+X.U32(64,_BE),256),misc=X.SA(32+X.U32(68,_BE),256),sOptionT(F),1<(k=X.U32(56,_BE))&&sOption(k,"×"),sOptionT(auth,"by: "),sOptionT(misc))
else if(/BMF1\.[012]/.test(X.SA(0,6))&&8<X.Sz()&&6<X.fSig(6,42,"00")){if(sName="The Brain's Easy Adlib module (.BMF)",sV=X.SA(5,1),sVersion="v1."+sV,bDetected=1,X.isVerbose()&&"0"<sV){if(G=6,bad=F=author="",f=X.fSig(G,-1,"00"),F=X.SA(G,f-G),G+=F.length+1,0<(f=X.fSig(G,-1,"00"))){if(author=X.SA(G,f-G),G+=author.length+1,spd=X.U8(G++),X.isDeepScan()){for(fl=X.U32(G),G+=4,ins=0,Y=0;Y<32;Y++)1&fl&&(G+=24)>X.Sz()&&(bad=bad.addIfNone("!short")),fl>>=1,ins++
fl=X.U32(G),G+=4
for(trk=0,trkend=!1,Y=0;Y<32;Y++){if(1&fl)for(trk++,trkend=!1,q=0;G<X.Sz()&&!trkend&&q<=1023;q<1023&&q++)switch(E=X.U8(G++)){case 254:trkend=!0
break
case 252:case 125:break
default:evnote=127&E,128&E&&(128&(E=X.U8(G))&&(evdly=63&E,G++,!(64&E))||(64<=(E=X.U8(G++))?evvol=E+1-64:32<=E&&E<=63?evins=E+1-32:"2"==sV&&1<=E&&E<=6&&G++))}fl>>=1}trkend||(bad=bad.addIfNone("!short"),G=-1)}}else bad=bad.addIfNone("!badtags")
""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),sOptionT(F),sOptionT(author,"by: "),sOption("spd:"+spd+(X.isDeepScan()?" trk:"+trk+" ins:"+ins+" sz:"+outSz(G):""))}}else if(384<X.Sz()&&X.c("'Buzz'")&&isWithin(X.U32(4),1,12)&&X.c("7C010000",12)&&0<X.fSig(8,64,"'MACH'"))sName="Oskari Tammelin's Jeskola Buzz module (.BMX)",bDetected=1
else if(28252<=X.Sz()&&X.c("0100'ADLIB'9D02A0021C000000")&&502458809==X.adler32(0,28252))sName="Instrument bank for Adlib Visual Composer (STANDARD.BNK)",bDetected=1,X.isVerbose()&&sOption(outSz(28252),"sz:")
else if(X.c("'BRTF'")&&["NAME","INFO"].includes(X.SA(8,4))){if(sName="Benjamin 'BeRo' Rousseaux's BeRoTracker module (.BRT)",bDetected=1,X.isVerbose()){for(E=l=q="",instmsg=[],sainmsg=[],ins=smp=ptn=ord=0,bpm0=spd0=st0=mvol=rowsperbeat=hltu=hltd=0,end=!(G=8);!end&&G<X.Sz();){switch(hkhd=X.SA(G,4),hksz=X.U32(G+4,_LE),G+=8,hkhd){case"NAME":E=X.UCSD(G)
break
case"MESS":l=X.SC(G+2,X.U32(G,_LE),"CP1252")
break
case"BPMI":rpb=X.U8(G)
break
case"INFO":spd0=X.U8(G+4),bpm0=X.U8(G+5),st0=X.U8(G+6),mvol=X.U8(G+10)
break
case"PORD":ord=X.U8(G)
break
case"PATT":ptn++
break
case"PAIN":hltu=X.U8(G+1),hltd=X.U8(G+2)
break
case"SAIN":smp++,(q=X.UCSD(G+2)).trim().length&&sainmsg.push(q)
break
case"INST":X.U8(G)&&ins++,(q=X.UCSD(G+1)).trim().length&&instmsg.push(q)
break
case"DONE":end=!0}G+=hksz}sOption(E),sOption(l),sOption(instmsg.filter(funSampleName).join("\n"),"ins/msg:\n"),sOption(sainmsg.filter(funSampleName).join("\n"),"smp/msg:\n"),sOption("bpm0:"+bpm0+" spd0:"+spd0+" ord:"+ord+" ins:"+ins+" smp:"+smp+" hlt:"+hltu+"/"+hltd+" RPB:"+rpb+" st.sep0:"+st0+" mixvol:"+mvol+" sz:"+outSz(X.U32(4)+8))}}else if(X.c("01000000")&&isWithin(X.U8(4),1,15)&&X.c("FFFFFFFF",52)&&X.c("1027",348)&&X.c("1027",356)&&X.c("1027",364))sName="Christer Andersson's BoyScout module (.BSF)",bDetected=1
else if(X.c("'FUCO'")&&X.c("'DIGI'",17412)&&X.c("'DIGP'",18424)){for(sName="Anthony J. 'Slates' Bybell's BSI Future Composer module (.BSI)",bDetected=1,bad="",smp=smpsz=Y=0;Y<63;Y++)(E=X.U32(17420+16*Y,_BE))&&smp++,smpsz+=E,131072<E&&(bad=bad.addIfNone("!badsmpsz"))
""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&sOption("smp:"+smp+" sz:"+outSz(18428+smpsz))}else if(X.c("'NuBEATHOVEN'",34))bDetected=1,sName="Thomas 'Dr.Nobody' Lopatic's Beathoven Synthesizer (.BSS)",sVersion="v"+X.SA(45,3),X.isVerbose()&&(F=X.SA(108,256),auth=X.SA(108+F.length+1,256),misc=X.SA(108+F.length+auth.length+2,256),sOptionT(F),sOptionT(auth,"by: "),sOptionT(misc))
else if(X.c("'CBA'F9")&&26==X.U8(36)&&332+X.U16(37)+48*X.U8(41)<=X.Sz()&&isWithin(X.U8(39),1,32)&&X.U8(43)&&32<=X.U8(44)){if(sName="Chuck Biscuits & Zenic/Heretics' module (.CBA)",bDetected=1,X.isVerbose()){for(msglen=X.U16(37),ch=X.U8(39),ptn=X.U8(40)+1,ord=X.U8(41),smp=X.U8(42),spd0=X.U8(43),tmp0=X.U8(44),Y=smpsz=0;Y<smp;Y++)smpsz+=X.U32(332+48*Y+36)
K=332+48*smp+64*ptn*5*ch+smpsz,r=X.SC(K,msglen,"CP437").trim(),K+=msglen,sOptionT(X.SA(4,32)),sOption(addEllipsis(r,192,160),'msg:"','"'),sOption("spd:"+spd0+" tempo:"+tmp0+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K))}}else if(X.c("'<CUD-FM-File>'1ADEE0")&&(!X.U8(19)&&X.c("'CUD-FM-File - SEND A POSTCARD -'",1537)||X.U8(19)&&X.c("'YsComp'07'CUD1997'1A04",32)))sName="Daniel Eshcbach/CUD's Boom Tracker 4 module (.CFF)",sVersion="v"+X.U8(16),bDetected=1,X.U8(19)&&(sVersion+="/LZW-packed"),X.isVerbose()&&sOption(outSz(32+X.U16(17)),"sz:")
else if(X.c("'CHIPv1.0'")){for(sName="Dmitry 'Alone Coder' Bystrov's Chip Tracker module (.CHI)",bDetected=1,sVersion="v"+X.SA(5,1),bad="",X.Sz()<=256&&(bad=bad.addIfNone("!badsz")),ptn=smp=0,tempo=X.U8(40),ord=X.U8(41)+1,lp=X.U8(48),Y=0;Y<ord;Y++)(G=X.U8(256+Y)+1)>ptn&&(ptn=G),31<G&&(bad=bad.addIfNone("!badord"))
for(K=512+512*ptn,Y=0;Y<16;Y++)(A=X.U16(45+4*Y))&&(smp++,255&(K+=A))&&(K+=256-(255&K))
bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(decAnsi(8,32,CPSpeccy,!1,Chars0to1FSpeccy)),sOption("tempo:"+tempo+" ord:"+(lp?lp+"-":"")+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K)))}else if(X.c("000003F3")&&X.c("70FF4E75'S.PHIPPS'",32)&&0<X.I32(64,_BE)<X.Sz()&&0<X.I32(68,_BE)<X.Sz())sName="Simon Phipps/Core Design module (.CORE)",bDetected=1,X.isVerbose()&&(F=X.SA(104,256),auth=X.SA(104+F.length+1,256),misc=X.SA(104+F.length+auth.length+2,256),sOptionT(F),sOptionT(auth,"by: "),sOptionT(misc))
else if(X.c("'CAT '................'FORM'"))sName="Andreas Öman's Cybertracker module (.CT)",bDetected=1
else if(X.c("0004'NNTRKMZX'")){if(sName="CyberBrain's Cybertracker C64 module (.CT)",bDetected=1,sVersion="v"+X.U8(11)+"."+X.U8(10),X.isVerbose()){for(sng=0;sng<X.U16(1209,_LE)&&0!=X.U8(1211+sng-1);sng++);sng?(sng0ord=X.U8(1211),loop0=X.U8(1725),1<sng?sOption("×"+sng+" ord0:"+sng0ord+" loop0:"+loop0):sOption(" ord:"+sng0ord+" loop:"+loop0)):sOption("empty")}}else if(X.c("0004'NNTRKINS'"))sName="CyberBrain's Cybertracker C64 instrument (.CI)",bDetected=1,sVersion="v"+X.U8(11)+"."+X.U8(10),X.isVerbose()&&sOptionT(X.SA(26,16))
else if(X.c("000003F3")&&0<X.fStr(32,256,"NuDELIRIUM"))sName="DeliTracker player addon or Amiga Custom Module (.CUST)",bDetected=1,sVersion="CustomPlay",X.isVerbose()&&sOptionT(X.SA(X.fStr(0,256,"NuDELIRIUM")+20,256))
else if(X.c("'JCH'26026601")&&X.c("'Creative Voice File'1A1A000A01291101......C300",64))sName="Jens Christian 'JCH/Vibrants' Huus's Edlib Tracker samples (.S01)",bDetected=1
else if(X.Sz()<65535&&(X.c("'JCH'26 026600")||X.c("'JCH'26 026680"))&&(X.c("FFFF",X.U16(113,_LE)-2)||X.c("FFFF",X.U16(115,_LE)-2))){for(msgp=0,Y=0;Y<4;)65535!=(E=X.U16(113+Y,_LE))&&E>msgp&&(msgp=E),Y+=2
K=X.fSig(msgp,TOEOF,"FFFF")+2,bDetected=1,bad=0,sName="Jens Christian 'JCH/Vibrants' Huus's Edlib Tracker module (.D00,.D01)",sVersion="v"+X.U8(7),(bad=1<X.U8(10)?1:bad)&&(sVersion+="/malformed"+bad),X.isVerbose()&&(k=X.U8(9),sOptionT(X.SC(11,32,"CP850")),1<k&&sOption(k,"×"),sOptionT(X.SC(43,32,"CP850"),"by: "),sOptionT(X.SC(msgp,K-msgp-2,"CP850")),sOption(outSz(K),"sz:"))}else if(X.c("'DBM0'........'NAME'0000002C")&&X.U8(4)<4&&X.c("'INFO'0000000A",60)&&X.c("'SONG'",78)&&X.U16(68,_BE)<=255&&X.U16(70,_BE)<=255&&X.U16(74,_BE)<=1024&&4<=X.U16(76,_BE)&&X.U16(76,_BE)<=254&&!(X.U16(76,_BE)%1)){for(sName="APC&TCP/Andeas Magerl's DigiBooster Pro module (.DBM)",bDetected=1,sVersion="v"+X.U8(4)+"."+X.U8(5).padStart(2,"0"),done=gotinfo=!(G=8),bad="",X.isVerbose()&&(ord=[]),insts=[],titles=[];!done&&G<X.Sz();){switch(hkhd=X.SA(G,4),hksz=X.U32(G+4,_BE),G+=8,hkhd){case"INFO":k=X.U16(G+4,_BE),ins=X.U16(G,_BE),a="ch:"+X.U16(G+8,_BE)+" ptn:"+X.U16(G+6,_BE)+" ins:"+ins+" smp:"+X.U16(G+2,_BE),gotinfo=!0
break
case"SONG":if(gotinfo){if(X.isVerbose())for(q=0;q+44<hksz;)E=X.SC(G+q,44,"CP1250").trim(),titles.push(E),q+=44,ord.push(X.U16(G+q,_BE)),q+=2+2*ord[ord.length-1]}else bad=bad.addIfNone("!badchunkorder")
break
case"INST":if(gotinfo)for(Y=0;Y<ins;Y++)""!=(E=X.SA(G+50*Y,34).trim())&&insts.push(E),((c3freq=X.U32(G+50*Y+34,_BE))<2e3||192e3<c3freq)&&(bad=bad.addIfNone("!badc3freq"))
else bad=bad.addIfNone("!badchunkorder")
break
case"SMPL":gotinfo||(bad=bad.addIfNone("!badchunkorder")),done=!0}G+=hksz}""!=(bad=!done||G>X.Sz()?bad.addIfNone("!short"):bad)&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(F=X.SA(16,44).trim(),sOption(F),sOption(titles.join("; "),F||1!=F.length?"":"songs:"),""!=F||titles.length||sOptionT(X.SA(216,28)),1<k&&sOption(k,"×"),sOptionT(addEllipsis(insts.join(" "),256,160),'smp/msg: "','"'),a="ord:"+ord.join("+")+" "+a,sOption(a+" sz:"+outSz(G)))}else if(X.c("'DSNGSEQU'00"))sName="David Hanney's module (.DH)",bDetected=1
else if(X.c("'DIGI Booster module'00")&&1572<=X.Sz()&&X.U8(25)&&X.U8(25)<=8&&X.U8(47)<=127){if(sName="APC&TCP/Andeas Magerl's DigiBooster module (.DIGI)",bDetected=1,nV=X.U8(24),sVersion="v"+(nV>>4)+"."+(15&nV),co=X.U8(26),sVersion!=X.SA(20,4).toLowerCase()&&(sVersion+='/"'+X.SA(20,4)+'"'),co&&(sVersion=sVersion.appendS("co.ptn","/")),X.isVerbose()){for(sOptionT(decAnsi(610,32,CPAmiga,!0)),r=[],ch=X.U8(25),ord=X.U8(47)+1,ptn=X.U8(46)+1,smp=A=0,Y=0;Y<31;Y++)(slen=X.U32(176+4*Y,_BE))&&(smp++,A+=slen)
for(Y=0;Y<31;Y++)r.push(decAnsi(642+30*Y,30,CPAmiga,!0).trim())
if(K=1572,co)for(Y=0;Y<ptn&&K<=X.Sz();Y++)K+=2+X.U16(K,_BE)
else K+=256*ptn*ch;(K+=A)>X.Sz()&&!X.isVerbose()&&(sVersion=sVersion.appendS("malformed!short","/")),sOptionT(addEllipsis(r.filter(funSampleName).join(" "),256,160),'by/msg: "','"'),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K))}}else if(X.c("000003F3")&&X.c("70FF'NuUNCLEART'",32)&&X.U8(20)&&X.U32(44,_BE)&&X.U32(48,_BE)&&X.U32(56,_BE)){if(sName="Dave 'Uncle Tom' Lowe module (.DL)",bDetected=1,X.isVerbose()){if(smpip=32+X.U32(60,_BE),smpiep=32+X.U32(64,_BE),smp=smpiep?Math.floor((smpiep-smpip)/14):0,F=X.SA(32+X.U32(80,_BE),256),auth=X.SA(32+X.U32(84,_BE),256),cmt=X.SA(32+X.U32(88,_BE),256),loadsz=32+X.U32(92,_BE),K=32+X.U32(96,_BE),sza=Hex(X.Sz()-K),smpsz=32+X.U32(100,_BE),songsz=32+X.U32(104,_BE),sfx=32+X.U32(108,_BE),k=1,d1=32+X.U32(76,_BE))for(a1=d1;;){if(a1+=16,!(d1=X.U32(a1,_BE)))break
if(!(d1-=X.U8(a1+3)))break
k++}sOptionT(F),1<k&&sOption(k,"×"),sOptionT(auth,"by: "),sOptionT(cmt),sOption("smp:"+smp+" sfx:"+sfx)}}else if(X.c("'ALL '0000 .... 0000")&&X.U8(6)<=1&&X.U8(10)<=1)sName="Bent 'SHOGUN' Nielsen's Delta Music module (.DM)",sVersion="v1.3",bDetected=1
else if(X.c("4A00670003B40C000001670001EC0C000002670A0C000003671270004E7541FA0B680201003F11",4)&&X.c("0000'.FNL'",3012))sName="Bent 'SHOGUN' Nielsen's Delta Music 2 module (.DM2)",sVersion="v2.0",bDetected=1
else if(X.c("'DMF'0E"))sName="Webfoot Digital Sound and Music Interface Advanced Music Format hack (.DMF)",sOption("delta samples & no text"),bDetected=1
else if(X.c("'DDMF'")&&X.U8(4)&&X.U8(4)<=10&&X.U16(63)&&X.c("'CMSG'",66)){for(sName="D-Lusion X-Tracker module (.DMF)",bDetected=1,nV=X.U8(4),sVersion="v"+nV,G=66,hkhd=hksz=end=lpst=ch=ord=ptn=smp=K=ptntotallen=B=0,lped=65535;"ENDE"!=hkhd&&G<X.Sz();){switch(hkhd=X.SA(G,4),hksz=X.U32(G+4),G+=8,hkhd){case"SEQU":ord=0,3==nV?G+=2:4==nV&&(G+=4),u=G,3<=nV&&(lpst=X.U16(u),u+=2),4<=nV&&(lpst=X.U16(u),u+=2),4===nV&!lped&&(lped=65535),ord=G+hksz-u>>1
break
case"PATT":var ns=nV<3?9:8
for(u=G,ptn=X.U16(u),trk=X.U8(u+2),u+=3,32<(ch=(ch=trk)<1?1:ch)&&(ch=32),Y=0;Y<ptn;Y++){u+=ns-4
var M=X.U32(u)
ptntotallen+=M,u+=M}break
case"SMPI":for(u=G,smp=X.U8(u++),Y=0;Y<smp;Y++){var os=nV<2?30:X.U8(u++),C=X.SC(u,os,"CP437").trim(),A=(u+=os,X.U32(u)),T=(B+=A,u+=14,X.U8(u++)),I=X.U8(u++)
8<=nV&&(X.SC(u,8,"CP437"),u+=8),u+=1<nV?6:2}break
case"SMPD":if(!X.c("'ENDE'",G+hksz)){if((E=X.fSig(G,Math.min(X.Sz()-G,3*B),"'ENDE'"))<0){sVersion+="/malformed!noeof",hkhd="ENDE"
break}hksz=E-G}break
case"ENDE":G-=4+hksz}K=G,G+=hksz}if("ENDE"!=hkhd?sVersion+="/malformed!short":K=G,X.isVerbose()){sOptionT(X.SC(13,30,"CP437")),sOptionT(X.SC(43,20,"CP437"),"by: "),yy=X.U8(65),yyyy=yy<80?"20":"19",yyyy+=yy.padStart(2,"0"),sOptionT(yyyy+"-"+X.U8(64).padStart(2,"0")+"-"+X.U8(63).padStart(2,"0"),"on: "),sOptionT(X.SA(5,8),"in: "),cmt="",cnt=X.U32(70)-1
for(var ps=75;cnt;){var Xs=Math.min(cnt,40,512),ms=X.SC(ps,Xs,"CP437")
""!=ms&&(cmt=cmt.appendS(ms,"\n")),cnt-=Xs,ps+=Xs}sOption(addEllipsis(cmt,256,128)),sOption("ch:"+ch+"+1 ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K))}}else if(X.c("'.DelekDefleMask.'")){if(sName="Leonardo Demartino's DeFleMask module (.DMF)",bDetected=1,sVersion="v"+X.U8(16),X.isVerbose()){switch(X.U8(17)){case 1:sVersion+="#YMU759",ch=17
break
case 2:sVersion+="#Genesis (10ch)",ch=10
break
case 3:sVersion+="#SMS (4ch)",ch=4
break
case 4:sVersion+="#GameBoy (4ch)",ch=4
break
case 5:sVersion+="#PCEngine (6ch)",ch=6
break
case 6:sVersion+="#NES (5ch)",ch=5
break
case 7:case 71:sVersion+="#C64 (3ch)",ch=3
break
case 8:sVersion+="#YM2151 (13ch)",ch=13
break
default:ch=4}sOption(X.UCSD(18)),j=X.U8(18),G=18+j+1,sOption(X.UCSD(G),"by: "),j=X.U8(G),G+=j+1+2,tbase=X.U8(G++),tick1=X.U8(G++),tick2=X.U8(G++),Hz=X.U8(G++)?"60(NTSC)":"50(PAL)",X.U8(G++)?Hz=X.U8(G++)+":"+X.U8(G++)+":"+X.U8(G++):G+=3,sOption("tbase:"+tbase+" tck:"+tick1+":"+tick2+" freq:"+Hz)}}else if(X.c("' M'........'IAN'")&&X.c("0000....0000....0000....0000",28)&&(smp=X.U32(68,_BE))<=255&&(!(smpsz=X.U32(72,_BE))||smp||smp&&smpsz)&&isWithin(ins=X.U32(60,_BE),1,255)){if(sName="Reinier 'Rhino' van Vliet's Digital Mugician module (.DMU,.MUG)","/"==(sv=X.SA(9,1))?sVersion="v1":"2"==sv&&(sVersion="v2"),bDetected=1,X.isVerbose()){for(k=ord=0,ptn=X.U16(26,_BE),wf=X.U32(64,_BE),Y=76,G=28,a2=204;Y<204&&X.U32(Y,_BE);Y+=16,G+=4){for((1!=X.U32(G,_BE)||X.U32(a2,_BE)||X.U32(a2+4,_BE))&&k++,a2+=X.U32(G,_BE)<<3,E=X.SA(Y+4,12);E[E.length-1]<" ";)E=E.slice(0,E.length-1)
sOptionT(E)}for(Y=28;Y<60;Y+=4)ord+=X.U32(Y,_BE)
K=32*smp+16*ins+smpsz+460+256*ptn+128*wf+8*ord,1<k&&sOption(k,"×"),sOption("ord:"+ord+" ptn:"+ptn+" ins:"+ins+" smp/syn:"+smp+"+"+wf+" sz:"+outSz(K))}}else if(X.c("'DSM'10")&&X.c("1A",36)&&X.U16(178)-X.U16(176)==4&&X.c("'DSI'10",X.U16(176)<<4)&&X.c("'DSI'10",X.U16(176+2*X.U8(39)-2)<<4)){if(sName="Carlos Hasan's Digital Audio Sound Interface Kit module (.DSM)",bDetected=1,X.isVerbose()){for(Y=175;48<=Y&&255==X.U8(Y);Y--);for(rord=Y-47,mptn=0;48<=Y;Y--)(E=X.U8(Y)+1)>mptn&&(mptn=E)
for(ord=X.U8(38),ptn=X.U8(40),G=X.U16(176)<<4,inss=[],mp=0,Y=ins=0;Y<X.U8(39);Y++,G+=64)X.c("'DSI'10",G)||(bad=bad.addIfNone("!badins")),inss.push(X.SC(G+4,32,"CP437").trim()),(Q=X.U16(G+36)<<4)&&ins++,Q>mp&&(mp=Q+X.U16(G+38))
G=176+2*X.U8(39)+2*ptn-2,G=X.U16(G)<<4,G+=2+X.U16(X.U16(G)),K=Math.max(mp,G),sOptionT(X.SC(4,32,"CP437")),sOption(addEllipsis(inss.filter(funSampleName).join(" "),160),'ins/msg:"','"'),sOption("ord:"+(rord==ord?"":rord+"/")+ord+" ptn:"+(mptn==ptn?"":mptn+"/")+ptn+" ins:"+ins+" sz:"+outSz(K))}}else if(X.c("'RIFF'........'DSMFSONG'")&&X.U16(54)<=128&&X.U16(56)<=128&&X.U16(60)<=256&&X.U16(62)<=16){if(sName="Carlos Hasan's Digital Sound Interface Kit module (.DSM)",bDetected=1,sVersion="RIFF",X.isVerbose()){for(sOptionT(X.SC(20,28,"CP437")),K=X.U32(4)+8,G=12,smp=0;G<K;)hkhd=X.SA(G,4),hksz=X.U32(G+4),G+=8,"INST"==hkhd&&smp++,G+=hksz
G>X.Sz()&&(sVersion+="/malformed!badchunk"),sOption("ch:"+Math.max(1,X.U16(62))+" spd0:"+X.U8(66)+" bpm0:"+X.U8(67)+" ord:"+X.U16(56)+"("+X.U16(52)+"-"+X.U16(54)+") ptn:"+X.U16(60)+" smp:"+X.U16(58)+"/"+smp+" sz:"+outSz(K))}}else if(X.c("'DSm'1A20"))sName="The Loom Syndicate's Dynamic Studio module (.DSM)",bDetected=1,X.isVerbose()&&(sOptionT(X.SA(5,20)),sOptionT(X.SA(25,20),"by: "))
else if(X.c("'DSFmt1'0D0A"))sName="Audio Simulation's DreamStation module (.DSS)",bDetected=1,sVersion="v1.0",X.isVerbose()&&4<=(pt=(pt=X.fSig(0,TOEOF,"F0E40001")+4)<4?X.fSig(0,TOEOF,"F0E40000")+4:pt)&&(pa=X.fSig(pt,TOEOF,"0D0A"),E=X.SA(pt,pa-pt),pa+=2,pc=X.fSig(pa,TOEOF,"0D0A"),p=X.SA(pa,pc-pa),pc+=2,l=X.SA(pc,X.Sz()-pc),sOption(E),sOption(p,"by: "),sOption(l))
else if(X.c("'DS2F0'....'Default'"))sName="Audio Simulation's DreamStation II module (.DS2)",bDetected=1,sVersion="v2",X.isVerbose()&&(ts=X.U8(98),E=X.SA(99,ts),pa=98+ts+1,as=X.U8(pa),p=X.SA(pa+1,as),pc=pa+as+1,cs=X.U8(pc),l=X.SA(pc+1,cs),sOption(E),sOption(p,"by: "),sOption(l))
else if(X.c("'MMU2'00"))sName="Great Valley Products' Digital Sound Studio module (.DSS)",bDetected=1,sVersion="v1-3.0",X.isVerbose()&&(sOptionT(X.SA(10,32)),sOption("ord:"+X.I16(1436,_BE)))
else if(X.c("'DTL'00")&&X.c("0000001000",22))sName="Larry Tipton's Drum Traker module (.DTL)",bDetected=1,X.isVerbose()&&sOptionT(X.SA(4,20))
else if(X.c("'D.T.'00"))0<=(sv=["S.Q.","VERS"].indexOf(X.SA(42,4)))&&(sName="Softjee's Digital Tracker module (.DTM)",bDetected=1,X.isVerbose())&&(0==sv?sOptionT(X.SA(22,20)):sOptionT(X.SA(22,24)))
else if(X.c("'DeFy DTM'"))sName="DeFy AdLib Tracker module (.DTM)",bDetected=1,sVersion="v"+X.SA(9,3),X.isVerbose()&&(sOptionT(X.SA(13,20)),sOptionT(X.SA(33,20),"by: "))
else if(X.c("'SONG'........'NAME'"))sName="Horst Beham Jr.'s DigiTrekker module (.DTM)",bDetected=1,X.isVerbose()&&sOptionT(X.SA(16,20))
else if(X.c("48E7F1FE610000964CDF7F8F'NuH'E70010610000'$L'DF0800'NuH'E7F1FE610001844CDF7F8F'NuH'E70010610000'NL'DF0800'NuG'FAFFC651EB05',Q'EB05'PQ'EB05'tQ'EB059833FC000F00DFF09633FC00FF00DFF09E33FC000000DFF0A833FC000000DFF0B833FC000000DFF0C833FC000000DFF0D8'NuG'FAFF80177C00010524177C00010548177C0001056C177C00010590'NuG'FAFF'bJ+'00BA670E'S+'00B96608177C000600B9'Nu`'0003180006"))sName="David Whittaker's SFX module (.DW)",bDetected=1
else if(X.c("' PWD'03")&&X.c("'Master'",14))sName="Daniel Werner/ExperimentalScene's DarkWave Studio module (.DWP)",bDetected=1
else if(X.c("'EASO'"))sName="Morten Grouleff's EarAche module (.EA,.EAS)",bDetected=1
else if(X.c("'FORM'.... ....'EMODEMIC'")&&X.c("'PATT'",pt=20+X.U32(16,_BE))&&X.c("'8SMP'",q=pt+8+X.U32(pt+4,_BE))){for(sName="Bo Lincoln's Quadra Composer module (.EMOD)",bDetected=1,sVersion="v"+X.U16(20,_BE),(smp=X.U8(63))&&(smps=[]),K=X.U32(4,_BE)+8,Y=A=0,G=64;Y<smp;Y++,G+=34)""!=(E=X.SC(G+4,20,"CP1252").trim())&&smps.push(E),A+=X.U16(G+2,_BE)<<1
bad="",A!=X.U32(q+4,_BE)&&(bad=bad.addIfNone("!badsmplen:"+X.U32(q+4,_BE)+" vs "+A)),ptn=X.U8(++G),G++,G+=26*ptn,X.c("'MDIN'",q1=q+8+X.U32(q+4,_BE))&&(q=q1),1<Math.abs(K-(sz1=q+8+X.U32(q+4,_BE)))&&(bad=bad.addIfNone("!badlen:"+K+" vs "+sz1)),K<sz1&&(K=sz1),ord=X.U8(G++),""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT("<sans titre>"===(E=X.SA(22,20))?"":E),smp&&sOptionT(addEllipsis(smps.join(" "),192,160),'smp/msg: "','"'),smps=void 0,sOption("bpm:"+X.U8(62)+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K)))}else if(X.c("'E.M.S. V6.0'..00010000")&&isWithin(X.U8(11),49,54))sName="Sean 'Odie' Connolly's Electronic Music System module (.EMS)",bDetected=1,sVersion="v6."+X.SA(10,2),X.isVerbose()&&(a1=X.U32(14,_BE),a2=X.U32(18,_BE),a3=X.U32(22,_BE),G=lb0=34,G+=a1,lb4=G,G+=a2,lb8=G,G+=a3,insp=G,K=G+X.U32(30,_BE),sOption("sz:"+outSz(K)))
else if(X.c("'ENF '....'scor'")){for(sName="Musitek SmartScore Extended Notation Format sheet music (.ENF)",bDetected=1,G=6,staf=brln=0,hkhd="dumm";G<X.Sz()&&(hkhd=X.SA(G,4),/[a-z\[\]\-0-9]{4}/.test(hkhd));)hksz=X.U16(G+4,_BE),"staf"===hkhd?staf++:"brln"===hkhd&&brln++,G+=hksz
sOption("staves:"+staf+" bars:"+brln+" sz:"+outSz(G))}else if(36<X.Sz()&&X.c("'ETracker (C) BY ESI.'",10)||1236<X.Sz()&&(X.c("21B384")||X.c("21B304"))&&X.c("'ETracker (C) BY ESI.'",1213)){for(sName=" Maciej J. Wołoszyk & Andrzej Siuda's E-Tracker file (.ETC,.SAA)",bDetected=1,ofs=X.c("21B384")||X.c("21B304")?(sVersion="&player",1203):0,G=ofs,k=mp=K=0,ords=[],ptns=[];G<X.Sz()-36&&X.c("'ETracker (C) BY ESI.'",G+10);){if(k++,(ordp=G+X.U16(G))>mp&&(mp=ordp),(ptnp=G+X.U16(G+2))>mp&&(mp=ptnp),(smpp=G+X.U16(G+4))>mp&&(mp=smpp),(ornp=G+X.U16(G+6))>mp&&(mp=ornp),(svd=ofs+X.U16(G+6))>mp&&(mp=svd),K<mp&&(K=mp),1==k&&K>X.Sz())return!1
ord=lp=xpos=ptn=0
for(G=ordp;G<X.Sz();G++){if(255==(o=X.U8(G))){G++
break}if(254==o)lp=ord
else if(96<=o)xpos=o-96
else{if(1==k&&o%3)return _log("SAAFault @"+Hex(G)+": trk "+k+" pos not divisible by 3"),!1
if(o=Util.div64(o,3),1==k&&31<o)return _log("SAAFault: trk "+k+" pos over 1Fh"),!1
o>ptn&&(ptn=o),ord++}if(254<ord)return _log("SAAFault: trk "+k+" pos not divisible by 3"),!1}if(!ord)return!1
for(ords.push(++ord),ptns.push(++ptn),K<G&&(K=G),G=ptnp+12*ptn,Y=ptnp;Y<G;Y+=2)if((E=X.U16(Y))>mp-ofs&&(mp=ofs+E),E<30)return!1
if(1==k&&mp>X.Sz())return!1
if(notes=-1,G<E)for(G=E+64,G=ptnp,notes=0,chncnt=[64,64,64,64,64,64],j=0;j<64;j++)for(l=0;l<6;l++)if(chncnt[l])chncnt[l]--
else for(;G<X.Sz();){if(210<=(cmd=X.U8(G++))){chncnt[l]-=cmd-210
break}if(114<=cmd)notes++
else if(!(82<=cmd)&&81<=cmd)break}K<G&&(K=G),ornp==mp&&K<mp&&(K=mp),smpp==mp&&K<mp&&(K=mp),svd==mp&&K<mp&&(K=mp)}X.isVerbose()&&(1<k&&sOption(k,"×"),sOption("ord:"+ords.join("+")+(lp?" looped":"")+" ptn:"+ptns.join("+")+(xpos?" xpos:"+xpos:"")+(-1<notes?" notes:"+notes:"")+" sz:"+outSz(K)))}else if(2060<X.Sz()&&X.c("00000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF",993)&&X.c("......00 ......00 ......00 ......00 ......00 ......00 ......00",1236))sName="EUPHONY module (.EUP)",bDetected=1,X.isVerbose()&&sOption(X.SC(0,32,"CP932"))
else if(X.c("'EuGH'")&&X.c("'EuSH'",E=8+X.U32(4,_BE))&&X.c("'MThd'",E=E+8+X.U32(E+4,_BE))&&X.c("'MTrk'",G=E+8+X.U32(E+4,_BE))){for(sName="Fujitsu EUPHONY II/MTR module (.EUX)",bDetected=1,trk=X.U16(E+10,_BE),K=G,txt=by=F=lyr="",Y=0;Y<trk;Y++){var N=20
if(!X.c("'MTrk'",G)||Y&&!X.c("FF2F00",G-3)){bad+="!badtrk"+Y
break}for(len=X.U32(G+4,_BE),K=G+=8;N&&G<K+len&&G<X.Sz();){switch(N--,dt=readVarUInt(G),G+=dt[0],X.U8(G++)){case 240:case 247:E=readVarUInt(G),G+=E[0]+E[1]
break
case 255:switch(p=X.U8(G++)){case 0:2!=X.U8(G++)?N=0:G+=4
break
case 3:E=readVarUInt(G),G+=E[0],F=F.append(X.SC(G,E[1],"SJIS")),G+=E[1]
break
case 2:E=readVarUInt(G),G+=E[0],by=by.append(X.SC(G,E[1],"SJIS")),G+=E[1]
break
case 1:E=readVarUInt(G),G+=E[0],txt=txt.append(X.SC(G,E[1],"SJIS")),G+=E[1]
break
case 5:E=readVarUInt(G),G+=E[0],lyr=lyr.append(X.SC(G,E[1],"SJIS"),"-"),G+=E[1]
break
case 4:case 6:case 7:E=readVarUInt(G),G+=E[0]+E[1]
break
case 32:E=readVarUInt(G),G+=E[0]+E[1],1!=E[1]&&(N=0,bad+="!badprefix@"+(G-E[0]-E[1]))
break
case 47:E=readVarUInt(G),G+=E[0]+E[1],E[1]&&(bad+="!badEoTtag@"+(G-E[0]-E[1])),N=0
break
case 81:E=readVarUInt(G),G+=E[0]+E[1],3!=E[1]&&(N=0,bad+="!badtempo@"+(G-E[0]-E[1]))
break
case 84:E=readVarUInt(G),G+=E[0]+E[1],5!=E[1]&&(N=0,bad+="!badSMPTE@"+(G-E[0]-E[1]))
break
case 88:E=readVarUInt(G),G+=E[0]+E[1],(E[1]<2||4<E[1])&&(N=0,bad+="!badtime@"+(G-E[0]-E[1]))
break
case 89:E=readVarUInt(G),G+=E[0]+E[1],2!=E[1]&&(N=0,bad+="!badkey@"+(G-E[0]-E[1]))
break
default:E=readVarUInt(G),G+=E[0]+E[1]}}(""!=txt&&""!=by&&""!=F||512<G-K)&&(N=0)}if(K+=len,(G=K)>X.Sz()&&!X.isVerbose()){bad+="!short"
break}}bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(F),sOptionT(by,"by: "),sOptionT(txt),sOption((1<trk?"trk:"+trk+" ":"")+"sz:"+outSz(K)))}else if(X.c("'FAR'FE")&&X.c("0D0A1A",44)&&X.Sz()>X.U16(47)){if(bDetected=1,nV=X.U8(49),sName="Daniel Potter/Digital Infinity's Farandole Composer module (.FAR)",sVersion="v"+(nV>>4)+"."+(15&nV),ch=X.readBytes(50,16).filter(function(s){return 1==s}).length,X.isVerbose()){for(sOptionT(X.SC(4,40,"CP437")),msgsz=X.U16(96),r=[],Y=0,G=98;Y<msgsz&&G<X.Sz();Y+=132,G+=Math.max(0,Math.min(132,msgsz-Y)))r.push(X.SC(G,Math.max(0,Math.min(132,msgsz-Y)),"CP437").trim())
for(sOptionT(addEllipsis(r.join(" "),256),'msg:"','"'),G=98+msgsz+256,ptn=X.U8(G++),ord=X.U8(G++),lp=X.U8(G++),Y=psz=0;Y<256;Y++,G+=2)psz+=X.U16(G)
for(G=X.U16(47)+psz,smp=0,smpm=X.readBytes(G,8),smps=[],G+=8,Y=0;Y<64;Y++)smpm[Y>>3]&1<<(7&Y)&&smp++
for(Y=0;Y<smp;Y++)smps.push(X.SC(G,32,"CP437")),G+=48+X.U32(G+32)
sOptionT(addEllipsis(smps.filter(funSampleName).join(" "),256),'smp/msg:"','"'),sOption("ch:"+ch+" ord:"+(lp?lp+"~":"")+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(G))}}else if(X.c("'FPT'FE")&&X.c("0D0A1A",36))sName="Daniel Potter/Digital Infinity's Farandole Composer pattern (.FPT)",bDetected=1,X.isVerbose()&&sOptionT(X.SC(4,32,"CP850"))
else if(X.c("'FSM'FE")&&X.c("0A0D1A",36))sName="Daniel Potter/Digital Infinity's Farandole Composer sample (.FSM)",bDetected=1,X.isVerbose()&&(sOptionT(X.SC(4,32,"CP850")),type=X.U8(53)?"16bit":"8bit",looped=4&X.U8(54)?" looped":"",sVersion=type+looped,sOption(outSz(X.U32(39)),"sz:"))
else if(X.c("'SMOD'")&&112<X.Sz()&&isWithin(X.U32(8,_BE),112,X.Sz())&&isWithin(X.U32(16,_BE),112,X.Sz())&&isWithin(X.U32(24,_BE),112,X.Sz())&&isWithin(X.U32(32,_BE),112,X.Sz())){if(sName="Superions' Future Composer module (.FC,.FC13,.SMOD)",sVersion="v1.0~3",bDetected=1,X.isVerbose()){for(ordsz=X.U32(4,_BE),ordsz+=ordsz%2,ord=(ord=Util.divu64(ordsz,13))||1,ptnp=X.U32(8,_BE),ptnsz=X.U32(12,_BE),ptn=ptnsz>>6,smpp=X.U32(32,_BE),smpsz=X.U32(36,_BE),smp=wf=0,sszs=[],G=40,Y=0;Y<10;Y++,G+=6)(E=X.U16(G,_BE)<<1)&&smp++,sszs.push(E)
for(Y=10;Y<90;Y++)sszs.push(X.U8(G++)<<1)
for(Y=89;10<=Y&&!sszs[Y];Y--);wf=Y-9,sszs=void 0,sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" wf:"+wf+" sz:"+outSz(smpp+smpsz))}}else if(X.c("'FC14'")&&192<X.Sz()&&isWithin(X.U32(8,_BE),192,X.Sz())&&isWithin(X.U32(16,_BE),192,X.Sz())&&isWithin(X.U32(32,_BE),192,X.Sz())&&isWithin(X.U32(36,_BE),192,X.Sz())){if(sName="Superions' Future Composer module (.FC,.FC14)",sVersion="v1.4",bDetected=1,X.isVerbose()){for(ordsz=X.U32(4,_BE),ord=(ord=Util.divu64(ordsz,13))||1,ptnp=X.U32(8,_BE),ptnsz=X.U32(12,_BE),ptn=ptnsz>>6,smpp=X.U32(32,_BE),wfp=X.U32(36,_BE),smp=10,rsmp=msmp=wf=0,sszs=[],G=40,Y=0;Y<10;Y++,G+=6)sszs.push(X.U16(G,_BE)<<1)
for(K=0,Y=10;Y<90;Y++)K+=E=X.U8(G++)<<1,sszs.push(E)
for(Y=89;10<=Y&&!sszs[Y];Y--);for(wf=Y-9,K+=X.U32(36,_BE),G=smpp,Y=0;Y<10;Y++)if(rsmp++,sszs[Y]&&X.c("'SSMP'")){for(mszs=[],G+=4,msmp++,smp--,rsmp--,c=0;c<20;c++,G+=20)mszs.push(X.U16(G+4,_BE)<<1)
for(c=0;c<20;c++)mszs[c]&&rsmp++
smp++}sszs=void 0,mszs=void 0,sOption("ord:"+ord+" ptn:"+ptn+" smp:"+rsmp+(smp!=rsmp?"("+smp+")":"")+(msmp?" ssmp:"+msmp:"")+" wf:"+wf+" sz:"+outSz(K))}}else if(X.c("'FMK!'")&&244==X.U8(60)&&isWithin(X.U8(61),1,2)){if(sName="Sami Wilenius's FM-Kingtracker module (.FMK)",sVersion=[,"v1.00~03","v1.06+"][X.U8(61)],bDetected=1,X.isVerbose()){for(text=!0,Y=0;Y<56;Y++)if(X.U8(Y+4)<32){text=!1
break}text&&(sOptionT(X.SA(4,28)),sOptionT(X.SA(32,28),"by: ")),sOption("ord:"+X.U8(74)+" ptn:"+X.U8(76)+" ins:"+X.U8(75))}}else if(X.c("'FMTracker'....'The FM Tracker!'"))sName="Davey W. Taylor's FM Tracker module (.FMT)",bDetected=1,sVersion="v"+X.U8(9)+"."+X.U8(10),X.isVerbose()&&sOptionT(X.SA(31,32))
else if(X.c("'JSR_FMT~"))sName="Jean-Sebastien 'XorJS' Royer's FM-Tracker module (.FMT)",bDetected=1
else if(X.c("'FMTRK'1A"))sName="Morten Stenshorne/Sagitta Software's FM Tracker module (.FMT)",bDetected=1,X.isVerbose()&&sOptionT(X.SA(16,32))
else if(X.c("000003F3")&&X.U8(20)&&X.c("70FF4E75'F.PLAYER'",32)&&X.I32(64,_BE)){if(sName="Paul van der Valk's Future Player module (.FP)",bDetected=1,X.isVerbose()){for(sOptionT(X.SA(X.I32(44,_BE)+32,256)),k=1,G=72;(E=X.U32(G,_BE))&&k++,G+=8,E;);1<k&&sOption(k,"×"),sOptionT(X.SA(X.I32(48,_BE)+32,256),"by:"),sOptionT(outSz(X.I32(56,_BE)+32),"sz:")}}else if(X.c("'Fred Editor '0000")&&X.U16(14,_BE)<=10){for(G=16+1025*(k=X.U16(14,_BE)),spds=[],Y=16;Y<16+k;Y++)spds.indexOf(E=X.U8(Y))<0&&spds.push(E)
if(G<X.Sz())for(Y=0;Y<128&&G<X.Sz();Y++)trksz=X.U32(G,_BE),G+=trksz+4
if(G<X.Sz())for(ins=X.U16(G,_BE),G+=2,Y=syn=un=0;Y<ins&&G<X.Sz();Y++)255===X.U8(G+83)?un++:syn++,G+=96
for(smp=X.U16(G,_BE),syn-=smp,G+=2,Y=0;Y<smp&&G<X.Sz();Y++)G+=4+X.U16(G+2,_BE)
X.c("12345678",G)&&(bDetected=1,K=G+4),bDetected&&(sName="Fred & Julien Clermonte's Fred Editor module (.FRED,.MOD)",sVersion="project",X.isVerbose())&&(1<k&&sOption(k,"×"),sOption("tempos:"+spds.sort().join("-")+" ins:"+(ins-un)+(un?"("+ins+")":"")+(smp?" smp:"+smp:"")+(syn?" syn:"+syn:"")+" sz:"+outSz(K)))}if(!bDetected)if(X.c("'FTMN'03")&&X.U8(5)<64&&4096<=X.U16(8,_BE)&&X.U16(8,_BE)<20480&&X.U8(10)<12&&X.U8(12)<64&&!(252&X.U8(13))&&X.U8(14)&&X.U8(14)<=24&&4<=X.U8(15)&&X.U8(15)<=96&&X.U8(15)==Util.div64(96,X.U8(14))&&X.U8(80)<=64&&!X.U8(81)&&X.Sz()>=82+32*X.U8(5)+4*X.U8(80)){if(sName="Jörg W.Schmidt/MAXON's Face the Music module (.FTM)",sVersion="v"+X.U8(4),bDetected=1,X.isVerbose()){for(smp=X.U8(5),msr=X.U16(6,_BE),bpm0=(1766278.163/X.U16(8,_BE)).toFixed(0),fl=X.U8(13),fx=X.U8(80),gvol0=X.U8(12),G=82+32*smp,realsmp=0,Y=0;Y<smp;Y++)X.U8(82+32*Y)&&realsmp++
for(fxln=0,ticksper=X.U8(14),rowsper=X.U8(15),Y=0;Y<fx;Y++)E=X.U16(G,_BE),fxln+=E,G+=4+4*E
if(msr)for(Y=0;Y<8;Y++)G+=6+X.U32(G+2,_BE)
if(1&fl)for(Y=0;Y<realsmp;Y++)G+=4+2*(X.U16(G,_BE)+X.U16(G+2,_BE))
sOptionT(decAnsi(16,32,CPAmiga)),sOptionT(decAnsi(48,32,CPAmiga),"by: "),sOption("bpm0:"+bpm0+" ptn:"+msr+" smp:"+realsmp+"/"+smp+" fx:"+fx+"/"+fxln+" msr:"+ticksper+"/"+rowsper+(1&fl?"":" ext.smps")+" gvol0:"+gvol0+" sz:"+outSz(G))}}else if(X.c("'FMS!'..000000"))sName="BleuBleu's FamiStudio module (.FMS)",bDetected=1,sVersion="v"+X.U8(4)
else if(X.c("'FamiTracker Module'")&&0<X.fSig(18,16,"00'PARAMS'")&&0<X.fSig(24,256,"00'INFO'"))sName="Jonathan Liss's FamiTracker module (.FTM)",bDetected=1,X.isVerbose()&&(itag=X.fStr(24,256,"INFO"),sOptionT(X.SA(itag+24,32)),sOptionT(X.SA(itag+56,32),"by: "),sOptionT(X.SA(itag+88,32)))
else if(X.c("'-Furnace '")){switch(X.SA(9,7)){case"module-":cV="m",bDetected=1,sName="tildearrow et al.'s Furnace Tracker module (.FUR)"
break
case"instr.-":cV="i",bDetected=1,sName="tildearrow et al.'s Furnace Tracker instrument (.FUI)"
break
case"waveta-":cV="w",bDetected=1,sName="tildearrow et al.'s Furnace Tracker wavetable (.FUW)"
break
default:cv="?",bDetected=1,sName="unknown tildearrow et al.'s Furnace Tracker file"}if(nV=X.U16(16,_LE),sVersion=nV<12?"["+nV+"]":nV<=14?"v0.2.x":nV<=16?"v0.3.x":nV<=27?"v0.4.x":nV<35?"["+nV+"]":nV<=54?"v0.5.x":nV<57?"["+nV+"]":75==nV?"v.dev75/April Fools' 0.6pre0":nV<=99?"v.dev"+nV:100==nV?"v0.6pre1":101==nV?"v0.6pre1 (dev101)":102==nV?"v0.6pre1 (dev102)":nV<=115?"v.dev"+nV:116==nV?"v.0.6pre1.5":nV<=131?"v.dev"+nV:132==nV?"v.0.6pre2":133==nV?"v.0.6pre3":nV<=140?"v.dev"+nV:141==nV?"Tournament Edition":142==nV?"v.dev"+nV:143==nV?"v.0.6pre4":nV<=145?"v.dev"+nV:146==nV?"v.Pro (joke edition)":nV<=157?"v.dev"+nV:158==nV?"v.0.6pre5":nV<=160?"v.dev"+nV:161==nV?"v.0.6pre6":162==nV?"v.0.6pre7":nV<=165?"v.dev"+nV:166==nV?"v.0.6pre8":nV<=168?"v.dev"+nV:169==nV?"v.0.6pre9":nV<=170?"v.dev"+nV:171==nV?"v.0.6pre10":172==nV?"v.0.6pre11":173==nV?"v.0.6pre12":174==nV?"v.0.6pre13":175==nV?"v.0.6pre14":nV<=176?"v.dev"+nV:177==nV?"v.0.6pre15":178==nV?"v.0.6pre16":179==nV?"v.0.6pre17":180==nV?"v.0.6pre18":181==nV?"v.0.6":nV<=191?"v.dev"+nV:192==nV?"v.0.6.1":nV<=196?"v.dev"+nV:197==nV?"v.0.6.2":nV<=200?"v.dev"+nV:201==nV?"v.0.6.3":nV<=211?"v.dev"+nV:212==nV?"v.0.6.4":nV<=213?"v.dev"+nV:214==nV?"v.0.6.5":nV<=217?"v.dev"+nV:218==nV?"v.0.6.6":219==nV?"v.0.6.7":nV<=224?"v.dev"+nV:225==nV?"v.0.6.8pre1":226==nV?"v.0.6.8pre2":227==nV?"v.0.6.8":228==nV?"v.0.6.8.1":"["+nV+"]","i"===cV&&0<(G=X.U32(20,_LE))&&X.c("'INST'",G)){switch(ity=X.U16(16,_LE)){case 0:sVersion+="/std"
break
case 1:sVersion+="/FM (OPM/OPN)"
break
case 2:sVersion+="/Game Boy"
break
case 3:sVersion+="/C64"
break
case 4:sVersion+="/Amiga|smp"
break
case 5:sVersion+="/PC Engine"
break
case 6:sVersion+="/AY-3-8910"
break
case 7:sVersion+="/AY8930"
break
case 8:sVersion+="/TIA"
break
case 9:sVersion+="/SAA1099"
break
case 10:sVersion+="/VIC"
break
case 11:sVersion+="/PET"
break
case 12:sVersion+="/VRC6"
break
case 13:sVersion+="/OPLL"
break
case 14:sVersion+="/OPL"
break
case 15:sVersion+="/FDS"
break
case 16:sVersion+="/Vritual Boy"
break
case 17:sVersion+="/Namco 163"
break
case 18:sVersion+="/SCC"
break
case 19:sVersion+="/OPZ"
break
case 20:sVersion+="/POKEY"
break
case 21:sVersion+="/PC Speaker"
break
case 22:sVersion+="/WonderSwan"
break
case 23:sVersion+="/Lynx"
break
case 24:sVersion+="/VERA"
break
case 25:sVersion+="/X1-010"
break
case 26:sVersion+="/VRC6(saw)"
break
case 27:sVersion+="/ESS5506"
break
case 28:sVersion+="/MultiPCM"
break
case 29:sVersion+="/SNES"
break
case 30:sVersion+="/Sound Unit"
break
case 31:sVersion+="/Namco WSG"
break
default:sVersion+="/unk"}X.isVerbose()&&(wvt=X.U16(G+24,_LE),smp=X.U16(G+26,_LE),sOptionT(X.SC(G+12,512,"UTF8")),sOption(" wvt:"+wvt+" smp:"+smp))}if("m"===cV&&X.isVerbose()&&0<(G=X.U32(20,_LE))&&X.c("'INFO'",G)){for(E=X.SC(G+256,512,"UTF8"),p1=X.fSig(G+256,512,"00")+1,p=X.SC(p1,512,"UTF8"),p1=X.fSig(p1,512,"00")+1,ins=X.U16(G+22,_LE),wvt=X.U16(G+24,_LE),smp=X.U16(G+26,_LE),ptng=X.U32(G+28,_LE),freq=X.F32(G+12,_LE),A4freq=X.F32(p1,_LE),s1spd=X.U8(G+9)+"/"+X.U8(G+10),s1ptn=X.U16(G+16),s1ord=X.U16(G+18),sOptionT(E),sOptionT(p,"by: "),chips=[],el=!1,Y=0;!el&&Y<32;){switch(X.U8(G+32+Y)){case 0:el=!0
break
case 1:chips[Y]="YMU759 (17ch)"
break
case 2:chips[Y]="Genesis (10ch comp.)"
break
case 3:chips[Y]="SN76489 (SMS) (4ch)"
break
case 4:chips[Y]="Game Boy (4ch)"
break
case 5:chips[Y]="PC Engine (6ch)"
break
case 6:chips[Y]="NES (5ch)"
break
case 7:chips[Y]="C64 (8580) (3ch)"
break
case 8:chips[Y]="Arcade (YM2151+SegaPCM) (13ch)"
break
case 9:chips[Y]="Neo Geo CD (YM2610) (13ch)"
break
case 66:chips[Y]="Genesis extended (13ch)"
break
case 67:chips[Y]="SN76489 (SMS) + YM2413 (OPLL) (13ch comp.)"
break
case 70:chips[Y]="NES+VRC7 (11ch)"
break
case 71:chips[Y]="C64 (6581) (3ch)"
break
case 73:chips[Y]="Neo Geo CD extended (16ch)"
break
case 128:chips[Y]="AY-3-8910 (3ch)"
break
case 129:chips[Y]="Amiga (4ch)"
break
case 130:chips[Y]="YM2151 (8ch)"
break
case 131:chips[Y]="YM2612 (6ch)"
break
case 132:chips[Y]="TIA (2ch)"
break
case 133:chips[Y]="VIC-20 (4ch)"
break
case 134:chips[Y]="PET (1ch)"
break
case 135:chips[Y]="SNES (8ch)"
break
case 136:chips[Y]="VRC6 (3ch)"
break
case 137:chips[Y]="YM2413 (OPLL) (9ch)"
break
case 138:chips[Y]="FDS (1ch)"
break
case 139:chips[Y]="MMC5 (3ch)"
break
case 140:chips[Y]="Namco 163 (8ch)"
break
case 141:chips[Y]="YM2203 (6ch)"
break
case 142:chips[Y]="YM2608 (16ch)"
break
case 143:chips[Y]="YM3526 (OPL) (9ch)"
break
case 144:chips[Y]="YM3812 (OPL2) (9ch)"
break
case 145:chips[Y]="YMF262 (OPL3) (18ch)"
break
case 146:chips[Y]="MultiPCM (28ch)"
break
case 147:chips[Y]="Intel 8253 (beeper) (1ch)"
break
case 148:chips[Y]="POKEY (4ch)"
break
case 149:chips[Y]="RF5C68 (8ch)"
break
case 150:chips[Y]="WonderSwan (4ch)"
break
case 151:chips[Y]="Philips SAA1099 (6ch)"
break
case 152:chips[Y]="OPZ (YM2414) (8ch)"
break
case 153:chips[Y]="Pokémon Mini (1ch)"
break
case 154:chips[Y]="AY8930 (3ch)"
break
case 155:chips[Y]="SegaPCM (16ch)"
break
case 156:chips[Y]="Virtual Boy (6ch)"
break
case 157:chips[Y]="VRC7 (6ch)"
break
case 158:chips[Y]="YM2610B (16ch)"
break
case 159:chips[Y]="ZX Spectrum (beeper) (6ch)"
break
case 160:chips[Y]="YM2612 extended (9ch)"
break
case 161:chips[Y]="Konami SCC (5ch)"
break
case 162:chips[Y]="OPL drums (YM3526) (11ch)"
break
case 163:chips[Y]="OPL2 drums (YM3812) (11ch)"
break
case 164:chips[Y]="OPL3 drums (YMF262) (20ch)"
break
case 165:chips[Y]="Neo Geo (YM2610) (14ch)"
break
case 166:chips[Y]="Neo Geo extended (YM2610) (17ch)"
break
case 167:chips[Y]="OPLL drums (YM2413) (11ch)"
break
case 168:chips[Y]="Atari Lynx (4ch)"
break
case 169:chips[Y]="SegaPCM (DefleMask compat.) (5ch)"
break
case 170:chips[Y]="MSM6295 (4ch)"
break
case 171:chips[Y]="MSM6258 (1ch)"
break
case 172:chips[Y]="Commander X16 (VERA) (17ch)"
break
case 173:chips[Y]="Bubble System WSG (2ch)"
break
case 174:chips[Y]="OPL4 (YMF278B) (42ch)"
break
case 175:chips[Y]="OPL4 drums (YMF278B) (44ch)"
break
case 176:chips[Y]="Seta/Allumer X1-010 (16ch)"
break
case 177:chips[Y]="Ensoniq ES5506 (32ch)"
break
case 178:chips[Y]="Yamaha Y8950 (10ch)"
break
case 179:chips[Y]="Yamaha Y8950 drums (12ch)"
break
case 180:chips[Y]="Konami SCC+ (5ch)"
break
case 181:chips[Y]="tildearrow Sound Unit (8ch)"
break
case 182:chips[Y]="YM2203 extended (9ch)"
break
case 183:chips[Y]="YM2608 extended (19ch)"
break
case 184:chips[Y]="YMZ280B (8ch)"
break
case 185:chips[Y]="Namco WSG (3ch)"
break
case 186:chips[Y]="Namco 15xx (8ch)"
break
case 187:chips[Y]="Namco CUS30 (8ch)"
break
case 188:chips[Y]="MSM5232 (8ch)"
break
case 189:chips[Y]="YM2612 extra features extended (11ch)"
break
case 190:chips[Y]="YM2612 extra features (7ch)"
break
case 191:chips[Y]="T6W28 (4ch)"
break
case 192:chips[Y]="PCM DAC (1ch)"
break
case 193:chips[Y]="YM2612 CSM (10ch)"
break
case 194:chips[Y]="Neo Geo CSM (YM2610) (18ch)"
break
case 195:chips[Y]="YM2203 CSM (10ch)"
break
case 196:chips[Y]="YM2608 CSM (20ch)"
break
case 197:chips[Y]="YM2610B CSM (20ch)"
break
case 198:chips[Y]="K007232 (2ch)"
break
case 199:chips[Y]="GA20 (4ch)"
break
case 200:chips[Y]="SM8521 (4ch)"
break
case 201:chips[Y]="M114S (16ch)"
break
case 202:chips[Y]="ZX Spectrum (beeper/QuadTone) (5ch)"
break
case 203:chips[Y]="Casio PV-1000 (3ch)"
break
case 204:chips[Y]="K053260 (4ch)"
break
case 205:chips[Y]="TED (2ch)"
break
case 206:chips[Y]="Namco C140 (24ch)"
break
case 207:chips[Y]="Namco C219 (16ch)"
break
case 208:chips[Y]="Namco C352 (32ch)"
break
case 209:chips[Y]="ESFM (18ch)"
break
case 210:chips[Y]="Ensoniq ESS503 (32ch)"
break
case 212:chips[Y]="PowerNoise (4ch)"
break
case 213:chips[Y]="Dave (4ch)"
break
case 214:chips[Y]="NDS (16ch)"
break
case 215:chips[Y]="GBA (direct) (2ch)"
break
case 216:chips[Y]="GBA (MinMod) (16ch)"
break
case 217:chips[Y]="Bifurcator (4ch)"
break
case 218:chips[Y]="SCSP (32ch)"
break
case 219:chips[Y]="YMF271 (OPX) (48ch)"
break
case 220:chips[Y]="RF5C400 (32ch)"
break
case 221:chips[Y]="YM2612 XGM (9ch)"
break
case 222:chips[Y]="YM2610B extended (19ch)"
break
case 223:chips[Y]="YM2612 XGM extended (13ch)"
break
case 224:chips[Y]="QSound (19ch)"
break
case 225:chips[Y]="PS1 (24ch)"
break
case 226:chips[Y]="C64 (6581)+PCM (4ch)"
break
case 227:chips[Y]="Watara Supervision (4ch)"
break
case 229:chips[Y]="µPD1771C-017 (4ch)"
break
case 240:chips[Y]="SID2 (3ch)"
break
case 241:chips[Y]="5E01 (5ch)"
break
case 245:chips[Y]="SID3 (7ch)"
break
case 252:chips[Y]="Pong (1ch)"
break
case 253:chips[Y]="Dummy System (8ch)"
break
case 254:case 255:chips[Y]="reserved for development"
break
default:chips[Y]="unk."}el||Y++}sOption("chips: "+chips.join("+")),sOption("ticks="+freq.toFixed(2)+"Hz, A4="+A4freq+"Hz"),sOption("ins:"+ins+" wvt:"+wvt+" smp:"+smp+" glob.ptn:"+ptng),sOption("1st song's spd:"+s1spd+" ptn:"+s1ptn+" ord:"+s1ord)}}else if(X.c("'FWMP'00"))sName="Capcom/ARC Developments' Forgotten Worlds BGM module (.FW)",bDetected=1
else if(X.c("'FXSM'"))sName="František Fuka's Fuxoft AY Language module (.FXM)",bDetected=1
else if(X.c("'GBRF'..00")&&isWithin(X.U8(4),1,48)&&isWithin(X.U8(6),0,3)&&isWithin(X.U8(7),1,3))sName="Gameboy Ripped Format chiptune (.GBR)",bDetected=1,""!=(E=X.SA(340,19))&&/^([a-zA-Z0-9_ -]{4,})/.test(E)&&(sOptions=sOptions.append(E))
else if(112<X.Sz()&&X.c("'GBS'01")&&X.U8(4)&&167<=X.U8(13))bDetected=1,sName="Gameboy Sound chiptune (.GBS)",X.isVerbose()&&sOptionT(X.SA(16,32)),1<(tc=X.U8(4))&&sOption(tc,"×"),X.isVerbose()&&(sOptionT(X.SA(48,32),"by: "),sOptionT(X.SA(80,32)))
else if(X.c("'GDM'FE")&&X.c("0D0A1A'GMFS'",68)&&X.U16(116)<=9&&isWithin(ordp=X.U32(118),157,X.Sz())&&isWithin(ptnp=X.U32(123),157,X.Sz())&&isWithin(smptp=X.U32(128),157,X.Sz())&&isWithin(smpp=X.U32(132),157,X.Sz())){if(sName="BWSB General Digital Music module (.GDM)",bDetected=1,trkr="",0==X.U16(77,_BE)&&(trkr="2gdm"),sVersion="v"+X.U8(75)+"."+X.U8(76),""!=trkr&&(sVersion+="/"+trkr+" v"+X.U8(79)+"."+X.U8(80)),X.isVerbose()){for(ord=X.U8(122)+1,ptn=X.U8(127)+1,smp=X.U8(136)+1,ch=0,Y=81;Y<113;ch+=255!=X.U8(Y++));for(smps=[],Y=B=0,G=smptp;Y++<smp;G+=62)smps.push(X.SC(G,32,"CP437").trim()),B+=X.U32(G+45)
switch(Math.max(ordp,ptnp,smptp,smpp)){case ordp:K=ordp+ord
break
case ptnp:for(G=ptnp,Y=0;Y++<ptn&&G<X.Sz();G+=X.U16(G));K=G
break
case smptp:K=smptp+62*smp
break
case smpp:K=smpp+B}sOptionT(X.SC(4,32,"CP437")),sOptionT(X.SC(36,32,"CP437"),"by: "),sOption(["","ProTracker MOD","Multitracker","Scream Tracker 3","Composer 669 / UNIS 669","Farandole Composer","UltraTracker","Scream Tracker 2","OctaMED","Epic Megagames MASI"][X.U16(116)],"orig:"),sOptionT(X.SC(X.U32(137),X.U32(141),"CP437")),sOptionT(addEllipsis(smps.filter(funSampleName).join("\n"),176),'smp/msg:"\n','"'),sOption("ch:"+ch+" tmp0:"+X.U8(114)+" bpm0:"+X.U8(115)+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K))}}else if(X.c("'GLUE'B8B3AABA")){if(sName="Lars 'GlueMaster' Malmborg's GlueMon module (.GLUE)",bDetected=1,X.isVerbose()){for(sOptionT(X.SA(8,8)),ins=X.U8(127),ord=X.U8(158),ptn=0,Y=0;Y<ord;Y++)255!=(E=X.U8(159+Y))&&ptn<E&&(ptn=E)
ptn++,sOption("ord:"+ord+" ptn:"+ptn+" ins:"+ins)}}else if(X.c("'NuFREDGRAY'",34))sName="Fred Gray's module (.GRAY)",bDetected=1,X.isVerbose()&&(E=X.SA(80,256),pn=80+E.length+1,p=X.SA(pn,256),pn+=p.length+1,l=X.SA(pn,256),sOptionT(E),sOptionT(p,"by: "),sOptionT(l))
else if(X.c("'GTK'")&&isWithin(X.U8(3),1,4)&&X.U16(196,_BE)<=255&&isWithin(X.U16(198,_BE),1,256)&&isWithin(X.U16(200,_BE),1,32)&&(ord=X.U16(202,_BE))<=256&&X.U16(204,_BE)<=ord||X.c("'GT2'")&&(5<X.U8(3)&&228==X.U32(4,_BE)||X.U32(4,_BE)==236+2*X.U16(234,_BE))&&isWithin(X.U16(202,_BE),1994,9999)){switch(bDetected=1,sigv=0,bad="",X.U8(2)){case 75:sName="Laurent 'Dumbo' de Soras's Graoumf Tracker module (.GTK)",sVersion="Amiga ",sigv=1
break
case 50:sName="Laurent 'Dumbo' de Soras's Graoumf Tracker 2 module (.GT2)",sVersion="PC ",sigv=2}if(v=X.U8(3),sVersion+="v"+v,1==sigv&&v<6)switch(v){case 1:sVersion+="/GT v0.7"
break
case 2:sVersion+="/GT v0.726"
break
case 3:sVersion+="/GT v0.731"}else 9==v&&(sVersion+="/GT r27")
if(tracker=statln="",1==sigv){for(E=X.SC(4,32,"ISO8859-1").trim(),d=xc="",l=X.SC(36,160,"ISO8859-1").trim(),trk=X.U16(200,_BE),ord=X.U16(202,_BE),smp=0,smprecs=X.U16(196,_BE),rows=X.U16(198,_BE),lp=X.U16(204,_BE),smpinfosz=v<=2?48:64,sszofs=1==v?32:28,3<=v&&(sszofs+=16),2<=v&&(sszofs+=4),smp=smpsz=0,G=206,Y=0;Y<smprecs;Y++)(A=X.U32(G+sszofs,_BE))&&(smpsz+=A,smp++),G+=smpinfosz,A%2&&(bad=bad.addIfNone("!oddsmpsz"))
for(ptn=0,Y=0;Y<ord;Y++)(pt=X.U16(G,_BE))>ptn&&(ptn=pt),G+=2
ptn++,nn=4==v?5:4,songsz=718+smprecs*smpinfosz+ptn*rows*trk*nn,K=songsz+smpsz,statln="trk:"+trk+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+(lp?" lp:"+lp:"")+" sz:"+outSz(K)}else{for(E=X.SA(8,32).trim(),d=X.U16(202,_BE)+"-"+X.U8(201).padStart(2,"0")+"-"+X.U8(200).padStart(2,"0"),l=X.SA(40,160).trim(),tracker=X.SA(204,24),pn=songhk=spd=bpm=ord=lp=mptn=ptn=ins=smp=trk=0,K=-1,xc=[],v<6&&(spd=X.U16(228,_BE),bpm=X.U16(230,_BE));pn<X.Sz();){switch(hkhd=X.SA(pn,4),hksz=X.U32(pn+4,_BE),pn+=8,hkhd){case"SONG":for(ord=X.U16(pn,_BE),lp=X.U16(pn+2,_BE),mptn=0,G=pn+4,Y=0;Y<ord;Y++,G+=2)mptn=Math.max(mptn,X.U16(G,_BE))
mptn++,songhk++
break
case"PATD":case"PAIN":case"PAFX":case"PAMI":ptn++,trk=Math.max(trk,X.U16(pn+22,_BE))
break
case"INST":ins++
break
case"SAMP":case"SAM1":case"SAM2":smp++
break
case"XCOM":xcc=X.U16(pn,_BE),xc=xc.push(X.SA(pn+2,xcc).trim())
break
case"TCN2":bpm=X.U16(pn+2,_BE)+(X.U16(pn+4,_BE)?"."+X.U16(pn+4,_BE):"")
case"ENDC":K=pn+hksz-8}if(pn+=0<hksz-8?hksz-8:0,0<=K)break
if(charStat(next=X.SA(pn,4)).indexOf("allasc")<0||next.toUpperCase()!=next)break}songhk||(bad=bad.addIfNone("!noSONG")),K<=0&&(K=pn,bad=bad.addIfNone("!noendtag")),ptn!=mptn&&(ptn=mptn+"/"+ptn),statln=statln.appendS((bpm?"bpm0:"+bpm+" ":"")+(spd?"spd0:"+spd+" ":"")+"trk:"+trk+" ord:"+ord+(lp?" lp:"+lp:"")+" ptn:"+ptn+" ins:"+ins+" smp:"+smp+" sz:"+outSz(K)," ")}X.isVerbose()&&(sOption(E),sOption(d,"on:"),sOption(tracker,"in:"),sOption(l),xc.length&&sOption(addEllipsis(xc.join("\n"),256,160),'msg: "','"'),sOption(statln)),""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/"))}else if(X.c("'NuH.DAVIES'",34))sName="Howie Davies's module (.HD)",bDetected=1,X.isVerbose()&&(E=X.SA(100,256),pn=100+E.length+1,p=X.SA(pn,256),pn+=p.length+1,l=X.SA(pn,256),sOptionT(E),sOptionT(p,"by: "),sOptionT(l))
else if(X.c("'HESM'00")&&isWithin(X.U8(7),125,254)&&X.c("FFF8",8)&&isWithin(X.I8(10),-8,32)&&isWithin(X.I8(11),-8,32)&&isWithin(X.I8(12),-8,32)&&isWithin(X.I8(13),-8,32)&&isWithin(X.I8(14),-8,32)&&X.c("'DATA'",16)&&0<=[0,224].indexOf(X.U8(20))&&X.c("002000000000000000",23)&&256<=X.Sz()){function fs(){var s,e,t
return!X.U8(G)||(s=32,X.U8(G+31)&&!X.U8(G+47)&&(s=48),(t=(e=X.readBytes(G,s)).indexOf(0))<0)||charStat(e.slice(0,t),1).indexOf("asc")<0||(G+=s,"<?>"==(e=decEncoding(e,CP437,!0,Chars0to1F)))?"":e}sName="Hudson Entertainment System multitrack tune (.HES)",bDetected=1,sVersion="v"+X.U8(4),startsong=X.U8(5),reqaddr=X.U16(6),dtsz=X.U32(20),dtaddr=X.U32(24),X.isVerbose()&&(E=p=l="",G=64,32<=X.U8(G)&&(sOptionT(fs()),sOptionT(fs(),"by:"),sOptionT(fs())),sOption("from:"+startsong+" sz:"+outSz(dtaddr+dtsz)))}else if(X.c("'GTI5'"))sName="Lasse 'Faust' Öörni's GoatTracker 2 Instrument (.INS)",bDetected=1
else if(X.c("'ISM!V1.2'"))sName="Hans Bergstedt's Sound Invasion Music System/In Stereo! module (.IS)",bDetected=1,sVersion="v"+X.SA(5,3),X.isVerbose()&&sOptionT(X.SA(36,25))
else if(X.c("'IS20DF10STBL'"))sName="Hans Bergstedt's Sound Invasion Music System/In Stereo! module (.IS20)",bDetected=1,sVersion="v2.0"
else if(X.c("'IXS!'"))sName="Sahara Surfers' iXalance module (.IXS)",bDetected=1,sVersion="compressed",X.isVerbose()&&(sOptionT(X.SA(24,32)),sOption(outSz(56+X.U32(16)),"sz:"))
else if((X.c("'MUSE'DEADBEAF")||X.c("'MUSE'DEADBABE"))&&X.U32(16)+24==X.U32(8))sName="Jazz Jackrabbit 2 container (.J2B)/Galaxy Sound System module",sVersion="compressed",bDetected=1,X.isVerbose()&&sOption("sz:"+X.U32(8))
else if(X.c("'NuJ.FLOGEL'",34))sName="Janko Mrsic-Flogel's module (.JMF)",bDetected=1,X.isVerbose()&&(E=X.SA(84,256),pn=84+E.length+1,p=X.SA(pn,256),pn+=p.length+1,l=X.SA(pn,256),sOptionT(E),sOptionT(p,"by: "),sOptionT(l))
else if(X.c("2B7C.... ........ 2B7C.... ........ 2B7C.... ........ 2B7C.... ........ 303C00FF 32004EB9 ........ 4E75")&&46<=X.I32(2,_BE)){if(sName="Steve Turner's module (.JPO)",bDetected=1,X.isVerbose()){for(ofs=X.U32(2,_BE),p1=G=X.U32(18,_BE)-ofs+46,d1=10;G<=Math.min(X.Sz(),1048576)&&61695!=(E=X.U16(G,_BE));)G+=2,(d0=E)>d1&&(d1=d0)
for(0<(K=X.fSig(p1+d1,TOEOF,"FF"))&&K++,G=X.U32(10,_BE)-ofs+46,k=0;G<X.Sz()&&!(d0=65520&X.U16(G,_BE));)G+=12,k++
X.c("2b7c0004449c0faa2b7c000479840fa22b7c00047ab40fa62b7c000458980fae")&&(k=5),d0=20+X.U32(26,_BE)-ofs,smp=(X.U32(d0,_BE)>>2)-1,smpsz=X.U32(d0+4,_BE),1<k&&sOption(k,"×"),sOption("smp:"+smp+" smpsz:"+Hex(smpsz)+" sz:"+outSz(K))}}else if(X.c("'KSCC'")&&!X.U8(14)&&!(224&X.U8(15))||X.c("'KSSX'")&&!X.U32(20))sName="Konami's KSS chiptune (.KSS)",bDetected=1,X.c("'KSSX'")?(nv=1,sVersion="extended"):nv=0,bnk=127&X.U8(13),bnk16=128&X.U8(13)?1:2,bnk&&(sVersion=sVersion.appendS("banks"+(1==bnk16?"8k":"16k"),",")),chip=X.U8(15),X.isVerbose()&&X.c("'MBM'",32)&&sOptionT(X.SA(36,52)),K=16+X.U8(14)+X.U16(6)+8192*bnk*bnk16,hnmmode=rammode=!1,scc=!0,ch=1,scc=2&chip?(sVersion+="#SEGA-MkIII(SMS)",4&chip?(sVersion+="/GameGear-Stereo",ch=2):sVersion+="/SMS-SNG(SN76489)",1&chip&&(sVersion+="/FM-UNIT(YM2413)"),136&chip&&(rammode=!0),!1):(16&chip?8&chip?(sVersion+="#MSX-AUDIO-STEREO",ch=2):(sVersion+="#MSX-AUDIO",hnmmode=!0):sVersion+="#MSX-AUDIO",1&chip&&(sVersion+="/MSX-MUSIC"),128&chip?!(rammode=!0):!(rammode=0!=(4&chip))),rammode&&(sVersion+="/RAM"),scc&&(sVersion+="/SCC"),hnmmode&&(sVersion+="/牌の魔術師DAC"),nv&&11<=X.U8(14)&&X.isVerbose()&&(x1=X.U16(24),1<(x2=X.U16(26))-x1)&&sOption("subsongs "+x1+"-"+x2),X.isVerbose()&&sOption("ch:"+ch+(bnk?" ex.bnk:"+bnk:"")+" sz:"+outSz(K))
else if(X.c("'cyd!song'")&&X.U8(8)<30){if(sName="Tero 'kometbomb' Lindeman's Klystrack/Klystron module (.KT)",bDetected=1,v=X.U8(8),sVersion="v"+v,X.isVerbose()){for(G=9,ch=6<=v?X.U8(G++):3<v?4:3,timesig=X.U8(G++)+"/"+X.U8(G++),17<=v&&(G+=2),ins=X.U8(G++),ptn=X.U16(G),G+=2,nseq=[],Y=0;Y<ch;Y++,G+=2)nseq[Y]=X.U16(G)
if(len=X.U16(G),G=G+2+2,12<=v&&G++,spd=X.U8(G++),spd2=X.U8(G++),rate=X.U8(G++),2<v?(fl=X.U32(G),G+=4):fl=0,9<=v&&G++,16<=v&&G++,tlen=17,11<=v&&(tlen=X.U8(G++)),5<=v&&(tlen=Math.min(tlen,65)),sOptionT(X.SC(G,tlen,"CP1250")),G+=tlen,10<=v?fx=X.U8(G++):1&fl&&(fx=1),fx)if(10<=v)for(Y=0;Y<fx;Y++)22<=v&&(nsz=X.U8(G++))&&(G+=Math.min(nsz,32)),G+=9,v<27&&G++,v<21&&G++,27<=v?G+=96:G+=32,G++,19<=v&&G++
else G+=64*fx
for(13<=v&&(G+=2*ch),insn=[],Y=0;Y<ins;Y++)G=(G+=17)+(2*X.U8(G)+1)+7,20<=v&&G++,nsz=v<11?16:Math.min(X.U8(G++),33),insn.push(X.SC(G,nsz,"CP1250").trim()),G+=nsz,1<=v&&(G+=4),7<=v&&(G+=3),10<=v&&G++,11<=v&&(G+=3),18<=v&&G++,wt_entry=12<=v?X.U8(G++):0,23<=v&&(G+=11),25<=v&&G++,fm_wave=23<=v?X.U8(G++):0
for(ord=0,Y=0;Y<ch;Y++)ord=Math.max(nseq[Y],ord),v<8?G+=6*nseq[Y]:G+=5*nseq[Y]
for(notes=0,Y=0;Y<ptn;Y++)if(steps=X.U16(G),G+=2,24<=v&&G++,v<8)s=v<2?3:6,G+=steps*s
else for(slen=(steps>>1)+(1&steps),packed=X.readBytes(G,slen),G+=slen,s=l=0;s<steps;s++)1&(bits=1&s||s==steps-1?15&packed[l]:packed[l]>>4)&&(G++,notes++),2&bits&&G++,4&bits&&(ctl=X.U8(G++),14<=v)&&(bits|=-8&ctl),8&bits&&(G+=2),128&bits&&G++,1&s&&l++
if(maxwt=0,12<=v)for(maxwt=X.U8(G++),Y=0;Y<maxwt;Y++)sn=X.U32(G+8),G+=22,sn&&(v<15?G+=2*sn:(dtsz=X.U32(G),G+=4+Util.divu64(dtsz+7,8)))
if(wts=[],26<=v)for(Y=0;Y<maxwt;Y++)E=X.U8(G++),wts.push(X.SC(G,E,"CP1250").trim()),G+=E
sOptionT(addEllipsis(insn.filter(funSampleName).join(",")),'ins/msg:"','"'),sOption("ch:"+ch+" tsig:"+timesig+" rate:"+rate+" ord:"+ord+" ptn:"+ptn+" ins:"+ins+" wt:"+maxwt+" notes:"+notes+" spd:"+spd+"-"+spd2+" fx:"+fx+" sz:"+outSz(G))}}else if(X.c("'cyd!inst'"))sName="Tero 'kometbomb' Lindeman's Klystrack instrument (.KI)",bDetected=1
else if(X.c("'cyd!efex'"))sName="Tero 'kometbomb' Lindeman's Klystrack effects (.KF?)",bDetected=1
else if(X.c("'ADL '0000....'MDhd'00000008000080..00000080'MThd'00000006000200..01E0'MTrk'0000....00FF03")||X.U32(0,_LE)==X.Sz()&&X.c("'AD'",4))sName="Lucas Arts Adlib chiptune (.LAA)",bDetected=1,sVersion="ADL "===X.SA(0,4)?"new":"old"
else if(X.c("'Liquid Module:'")||(X.isHeuristicScan()||X.c("'NO'"))&&extIs("liq")||X.c("21",470)&&X.c("21",2770)&&X.c("21",3046)&&X.c("FF",3796)&&X.c("FF",3816))sName="Nir Oren's Liquid Tracker module (.LIQ)",bDetected=1,sVersion=X.SA(65,20).trim(),X.isVerbose()&&("NO"==X.SA(0,2)?sOptionT(X.SA(5,20)):"Liq"==X.SA(0,3)&&(sOptionT(X.SA(14,50)),sOptionT(X.SA(14,15),"by: ")))
else if(56<X.Sz()&&X.c("'LME'00")&&X.fSig(4,32,"00")<0&&!X.U32(36,_BE)){if(sName="Steve 'Leggless' Hasler module (.LME)",bDetected=1,X.isVerbose()){for(a=decAnsi(4,32,CPAmiga).trim(),songsz=44+X.U32(52,_BE),d3=ins=Util.divu64(X.U32(56,_BE)-(Y=X.U32(40,_BE)),58),k=Y-16>>4,Y+=40,smp=synsmp=smpsz=0,d7=3;d3;d3--,Y+=58)(E=X.U32(Y,_BE))?E>d7&&(d7=E,smpsz+=X.U16(Y+4,_BE)<<1,smp++):synsmp++
steps=X.U32(48,_BE)-X.U32(44,_BE)>>2,K=songsz+smpsz,1<k&&sOption(k,"×"),sOption(a,'info:"','"'),sOption("steps:"+steps+" ins:"+ins+" sz:"+outSz(K))}}else if(X.c("'sa-team 89a'10610A6108610678006000",364)&&X.c("'dynamite89'",564)&&isWithin(X.U16(1290,_BE),0,15)){if(sName="Oscar Giesen & Marco Swagerman's Music Assembler module (.MA)",bDetected=1,X.isVerbose()){for(k=ptn=0,vp=[],ptns=[],ord=[],ch=[],G=1200,Y=0;Y<40;Y++,G+=2)vp[Y]=1570+X.U16(G,_BE)
for(Y=0;Y<40;Y+=4){for(ch_=ord_=0,c=Y;c<Y+4&&c<40;c++)254!=X.U8(vp[c])&&ch_++
if(ch_){for(c=Y,G=vp[c];c<Y+4&&G<X.Sz()&&254!=(E=X.U8(G));G+=2)255==E?c++:(ord_++,ptns.indexOf(E)<0&&ptns.push(E))
ord_&&(k++,ord.push(ord_)),ch.push(ch_)}}1<k&&sOption(k,"×"),insp=1570+X.U32(1462,_BE),ins=Util.divu64(vp[0]-insp,24),sOption("ch:"+ch.join("/")+" ord:"+ord.join("+")+" ptn:"+ptns.length+" ins:"+ins+" sz:"+outSz(1570+X.U32(1454,_BE)))}}else if(X.c("'MADG'"))sName="B. Birney's PlayerPro module (.MAD)",bDetected=1,X.isVerbose()&&sOption(X.SA(4,18))
else if(X.c("D040D0404EFB"))sName="Mark Cooksey's module (.MC)",sVersion="new",bDetected=1
else if(X.c("'MDC'1A 00080040")){for(sName="かるちゃん/CUL.'s music creative driver module (.MDC)",bDetected=1,a="",maxsz=Math.max(X.Sz(),65536),K=X.U32(8,_BE),G=X.U32(20,_BE),midires=X.U16(44,_BE),G&&G<maxsz&&0<(E=X.fSig(G,maxsz,"0D0A1A"))&&(a=X.SC(G,E-G,"Shift_JIS")),G=trkp=X.U32(16,_BE),32<(k=X.U16(G,_BE))&&(sVersion="!badsongcnt"),Y=ch=0,G+=2;Y<Math.min(k,32);Y++,G+=8)ch<X.U8(G+5)&&(ch=X.U8(G+5))
X.isVerbose()&&(sOptionT(a),1<k&&sOption(k,"×"),sOption("ch:"+ch+(K?" sz:"+outSz(K):"")))}else if(X.c("'DMDL'..'IN'"))sName="Digitrakker module (.MDL)",bDetected=1,X.isVerbose()&&(sOptionT(X.SA(11,32)),sOptionT(X.SA(43,20),"by: "))
else if(X.c("'MMDC'"))sName="Tony Crowther's packed MED module (.MMDC)",bDetected=1,X.isVerbose()&&sOption(outSz(X.U32(4,_BE)),"sz:")
else if(X.c("000001001100010014000000'GameBoy Music Module'"))sName="Paragon 5/Beyond Game Boy Tracker module (.MGB)",bDetected=1
else if(X.c("'MGT'11BD'MCS'"))sName="Megatracker module (.MGT)",bDetected=1,sOptionT(X.SA(58,32))
else if(X.c("'MThd'")&&X.c("'MTrk'",8+X.U32(4,_BE))&&X.U16(8,_BE)<=2){switch(sName="Standard MIDI File (.MID)",sVersion="v1.0",nV=X.U16(8,_BE),bad="",bDetected=1,nV){case 0:sVersion+=" t.0:one track"
break
case 1:sVersion+=" t.1:tracks"
break
case 2:sVersion+=" t.2:tracks+tempo"}for(bDetected=1,charset="SJIS",1<(trk=X.U16(10,_BE))&&sOption(trk,"trk:"),0==nV&&1!=trk&&(bad+="!badvertrk"),K=G=14,txt=by=F=lyr="",Y=0;Y<trk;Y++){N=20
if(!X.c("'MTrk'",G)||Y&&!X.c("FF2F00",G-3)){bad+="!badtrk"
break}for(len=X.U32(G+4,_BE),K=G+=8;N&&G<K+len&&G<X.Sz();){switch(N--,dt=readVarUInt(G),G+=dt[0],X.U8(G++)){case 240:case 247:E=readVarUInt(G),G+=E[0]+E[1]
break
case 255:switch(p=X.U8(G++)){case 0:2!=X.U8(G++)?N=0:G+=4
break
case 3:E=readVarUInt(G),G+=E[0],F=F.append(X.SC(G,E[1],charset).trim()),G+=E[1]
break
case 2:E=readVarUInt(G),G+=E[0],by=by.append(X.SC(G,E[1],charset).trim()),G+=E[1]
break
case 1:E=readVarUInt(G),G+=E[0],txt=txt.append(X.SC(G,E[1],charset).trim()),G+=E[1]
break
case 5:E=readVarUInt(G),G+=E[0],lyr=lyr.append(X.SC(G,E[1],charset,"-").trim()),G+=E[1]
break
case 4:case 6:case 7:E=readVarUInt(G),G+=E[0]+E[1]
break
case 32:E=readVarUInt(G),G+=E[0]+E[1],1!=E[1]&&(N=0,bad+="!badprefix@"+(G-E[0]-E[1]))
break
case 47:E=readVarUInt(G),G+=E[0]+E[1],E[1]&&(bad+="!badEoTtag@"+(G-E[0]-E[1])),N=0
break
case 81:E=readVarUInt(G),G+=E[0]+E[1],3!=E[1]&&(N=0,bad+="!badtempo@"+(G-E[0]-E[1]))
break
case 84:E=readVarUInt(G),G+=E[0]+E[1],5!=E[1]&&(N=0,bad+="!badSMPTE@"+(G-E[0]-E[1]))
break
case 88:E=readVarUInt(G),G+=E[0]+E[1],(E[1]<2||4<E[1])&&(N=0,bad+="!badtime@"+(G-E[0]-E[1]))
break
case 89:E=readVarUInt(G),G+=E[0]+E[1],2!=E[1]&&(N=0,bad+="!badkey@"+(G-E[0]-E[1]))
break
default:E=readVarUInt(G),G+=E[0]+E[1]}}(""!=txt&&""!=by&&""!=F||512<G-K)&&(N=0)}if(K+=len,(G=K)>X.Sz()){bad+="!short"
break}}bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(F),sOptionT(by,"by: "),sOptionT(txt),sOption(outSz(K),"sz:"))}else if(X.c("'SMF2CLIP'"))sName="MIDI Clip File (.midi2)",sVersion="v2.0",bDetected=1
else if(X.c("'MKJamz'"))sName="MK-Jamz module (.MKJ)",bDetected=1
else if(X.c("'MLEDMODL'000000")&&X.c("'VERS'",X.U32(8,_BE)+12)){for(sName="Musicline Editor module (.ML)",bDetected=1,G=4,l=E="",ch=smp=ins=ptn=k=0;G<X.Sz()&&(hkhd=X.SA(G,4),hksz=X.U32(G+4,_BE),!(charStat(hkhd).indexOf("allasc")<0));){switch(G+=8,hkhd){case"VERS":v=X.U16(G,_BE),sVersion="v"+(v>>8)+"."+((240&v)>>4)+(15&v)
break
case"TUNE":for(k++,E=E.appendS(X.SC(G,hksz,"CP1252").trim(),"; "),tmp0=X.U16(G+32,_BE),spd0=X.U8(G+34,_BE),groove=X.U8(G+35,_BE),ch=X.U8(G+39),chsz=0,hksz=40,Y=0;Y<ch;Y++)chsz+=X.U32(G+hksz,_BE),hksz+=4
hksz+=chsz
break
case"INFO":for(q=0;q<hksz;)z=X.fSig(G+q,hksz-q,"00"),j=-1<z?z-G-q:hksz,l+=X.SC(G+q,j,"CP1252")+"\n",q+=j+1
break
case"PART":ptn++
break
case"INST":ins++
break
case"SMPL":smp++,G+=6}G+=hksz}X.isVerbose()&&(1<k&&sOption(k,"×"),sOptionT(E),sOptionT(addEllipsis(l,160,128),'msg: "','"'),sOption("ch:"+ch+" ptn:"+ptn+" ins:"+ins+" smp:"+smp+" sz:"+outSz(G)))}else if(X.c("'FORM'........'MMV8SDAT'................'SE'"))sName="Thomas Winischhofer's Music Maker EXT module (.MM8,.MM4)",bDetected=1,sVersion="v8",X.isVerbose()&&(sOptionT(X.SA(26,20)),sOptionT(X.SA(54,41)),sOption(outSz(X.I32(4,_BE)+8),"sz:"))
else if(X.c("'SEI1XX'00"))sName="Music Maker STD instrument (.IP)",bDetected=1,sVersion="v8 old"
else if(X.c("'MO3'"))sName="MO3 MOD module (.MO3)",bDetected=1
else if(X.c("'RASP'",1080))sName="Generic module (.MOD)",bDetected=1,sVersion=X.SA(1080,4),X.isVerbose()&&(sOptionT(X.SC(0,20,"IBM850")),sOptionT(X.SC(20,22,"IBM850"),"by/inst: "))
else if(X.c("08'MONOTONE'")&&351<=X.Sz()){if(sName="MONOTONE module (.MON)",bDetected=1,sVersion="v"+X.U8(91),X.isVerbose()){for(sOptionT(X.UCSD(9)),sOptionT(X.UCSD(50)),ptn=X.U8(92),trk=X.U8(93),cellsz=X.U8(94),ord=0,Y=95;255!=(E=X.U8(Y++))&&ord++,Y<351&&255!=Y;);sOption("trk:"+trk+" ord:"+ord+" ptn:"+ptn+" sz:"+outSz(351+64*ptn*trk*cellsz))}}else if(/SONG[0-9.]{4}(COMP|NORM)/.test(X.SA(0,12)))sName="Megastation track (.MS)",bDetected=1,sVersion="v"+X.SA(4,5).toLowerCase()
else if(/SNGM[0-9.]{4}(COMP|NORM)/.test(X.SA(0,12)))sName="Megastation MOD module (.MSM)",bDetected=1,sVersion="v"+X.SA(4,5).toLowerCase()
else if(X.c("'MSOB'00000026")&&X.c("FFFF0000",36)&&0<(k=X.U16(40,_BE)))sName="Medley module (.MSO)",bDetected=1,X.isVerbose()&&1<k&&sOption(k,"×")
else if(X.c("'MTC1'00")&&X.U8(5)<16&&X.Sz()>=(K=X.U32(4,_BE)+8)){if(sName="Multi-track Container module (.MTC)",bDetected=1,X.isVerbose()){for(name=auth=l="",G=8,k=0;G<K;){switch(hkhd=X.SA(G,4),hksz=X.U32(G+4,_BE),G+=8,hkhd){case"NAME":name=name.addIfNone(decAnsi(G,hksz,CPSpeccy),"/")
break
case"AUTH":auth=auth.addIfNone(decAnsi(G,hksz,CPSpeccy),"/")
break
case"ANNO":l=l.addIfNone(decAnsi(G,hksz,CPSpeccy),"/")
break
case"TRCK":k++}(G+=hksz)%2&&G++}sOptionT(name),sOptionT(auth,"by:"),sOptionT(addEllipsis(l,160)),sOption("trk:"+k+" sz:"+outSz(K))}}else if(X.c("'mpu401tr'92'kk'EE'r'"))sName="MPU-401 Trakker Adlib module (.MTK)",bDetected=1,X.isVerbose()&&(E=X.UCSD(24),sOptionT(E),sOptionT(X.SA(24+E.length+2),"by: "))
else if(X.c("'MTM'")){if(sName="StarScream/Renaissance's Multitracker module (.MTM)",bDetected=1,v=X.U8(3),sVersion="v"+(v>>4)+"."+(15&v),X.isVerbose()){for(sOptionT(X.SA(4,20)),trk=X.U16(24),ptn=X.U8(26),ord=X.U8(27)+1,csz=X.U16(28),nos=X.U8(30),bpt=X.U8(32),smpsz=0,Y=88;Y<88+37*nos;Y+=37)smpsz+=X.U32(Y)
pxc=194+37*nos+192*trk+32*(ptn+1)*2,l=X.SA(pxc,csz),K=pxc+csz+smpsz,l.length<csz&&(l=l.trim()+" <...>"),sOptionT(l),sOption("trk:"+(trk+1)+" ord:"+(ord+1)+" ptn:"+(ptn+1)+" smp:"+nos+" sz:"+outSz(K))}}else if(X.c("'MT20'")&&388<=X.Sz()&&2==X.U8(9)&&X.U16(112)<64&&X.U16(106)<=256){for(sName="MadTracker 2 module (.MT2)",nV=X.U8(8),bDetected=1,sVersion="v"+X.U8(9)+"."+nV.toString(16).padStart(2,"0"),bad="",ord=X.U16(106),loop=X.U16(108),ptn=X.U16(110),trk=X.U16(112),flags=X.U32(118),ins=X.U16(122),smp=X.U16(124),hasdrums=0!=X.U16(382),dptn=hasdrums?X.U16(384):0,G=388+(hasdrums?274:0),addp=G+X.U32(G-4),r="",vst2=0,igskip=0,smpszs=[],insszs=[],inss=[],smps=[],extsmp=[];G<addp;){switch(hkhd=X.SA(G,4),hksz=X.U32(G+4),G+=8,hkhd){case"MSG":showmsg=X.U8(G),r=X.SC(G+1,hksz-1,"CP1252").replace("\r","\n").replace("\n\n","\n")
break
case"SUM":_=X.SC(G+6,hksz-6,"CP1252")
break
case"VST2":vst2=X.U32(G)}G+=hksz}if(G>addp)bad=bad.addIfNone("!badaddsz")
else if(G>X.Sz())bad=bad.addIfNone("!short")
else{for(Y=0;Y<ptn&&G<X.Sz();Y++)G+=6+(X.U32(G+2)+1&-2)
if(hasdrums)for(Y=0;Y<dptn&&G<X.Sz();Y++)G+=2+32*X.U16(G)
if(2&flags)for(env=trk+(8&flags)+(80<=nV?vst2:0)+(16&flags?1:0),q=0;q<ptn;q++)for(P=0;P<env&&G+4<=X.Sz();P++)for(3<=nV?(fl=X.U32(G),G+=8):(fl=X.U16(G),G+=4);fl;)1&fl&&(G+=260),(fl>>=1)<0&&(fl=-fl)}if(G>X.Sz())bad=bad.addIfNone("!short")
else for(Y=0;Y<255;Y++)!r&&inss.length<3&&""!=(E=X.SC(G,32,"CP1252")).trim()&&inss.push(E),32==(dtlen=X.U32(G+32))&&(dtlen+=396),1<nV&&dtlen&&(dtlen+=4),dtlen&&(igskip+=X.U16(G+36)<<3),G+=36+dtlen
if(G>X.Sz())bad=bad.addIfNone("!short")
else{for(Y=0;Y<256;Y++)r||(E=X.SA(G,32),Y<smp&&""!=E.trim()&&smps.push(E)),dtlen=X.U32(G+32),G+=36,dtlen&&Y<smp&&(slen=X.U32(G),5&(sfl=X.U8(G+10))?smpszs.push({ext:1,slen:0}):slen&&smpszs.push({ext:0,slen:slen}),G+=dtlen)
if((G+=igskip)>X.Sz())bad=bad.addIfNone("!short")
else for(Y=0;Y<smp&&G<X.Sz();Y++)smpszs[Y].ext?(slen=X.U32(G),G+=16,iextsmp.push(X.SA(G,slen)),G+=slen):G+=smpszs[Y].slen}""!=bad&&(sVersion+="/malformed"+bad),X.isVerbose()&&(sOptionT(X.SA(42,64)),""!=r?showmsg?sOption(addEllipsis(r,128),"msg: "):sOption("("+addEllipsis(r,128)+")","msg: "):inss.length?sOption('"'+addEllipsis(inss.join(" "),200)+'"',"ins/msg:"):smps.length&&sOption('"'+addEllipsis(smps.join(" "),200)+'"',"smp/msg:"),sOption("ord:"+ord+" loop:"+loop+" ptn:"+ptn+(hasdrums?"+"+dptn:"")+" ins:"+ins+" smp:"+smp+(0<extsmp.length?" ext.smp: ["+extsmp.join(",")+"]":"")+" trk:"+trk+(hasdrums?"+8":"")+(vst2?"vst2:"+vst2:"")+" sz:"+outSz(G)))}else if(X.c("'MTRAC'")&&26==X.U8(49))sName="Pyro-Fyre/Arkham's Master Tracker module (.MTR)",bDetected=1
else if(X.c("3C4F3123 20391E00 1FdF1F9F 0C020C05 04040407 1AF60627"))sName="Packen/ぱっくん Software MUAP98/みゅあっぷ tone data (TONES.DTA)",bDetected=1,X.isVerbose()&&sOption(outSz(6400),"sz:")
else if(X.c("'MVSM1'"))sName="Kaneda's MVSTracker Suite module (.MUS)",bDetected=1
else if(X.c("'MUS'1A")&&X.U16(4)>=X.U16(6))sName="idSoft's DOOM music module (.MUS)",bDetected=1,X.isVerbose()&&sOption(outSz(X.U16(4)),"sz:")
else if(X.c("'MXM'00")&&isWithin(X.U32(4),1,256)&&X.U32(8)<X.U32(4)&&isWithin(X.U32(12),1,255)&&X.U32(16))sName="Niklas 'pascal' Beisert's MXMplay module (.MXM)",bDetected=1,X.isVerbose()&&(ord=X.U32(4),lp=X.U32(8),ch=X.U32(12),ptn=X.U32(16),ins=X.U32(20),spd0=X.U8(24),bpm0=X.U8(25),sOption("spd0:"+spd0+" bpm0:"+bpm0+" ch:"+ch+" ord:"+(lp?lp+"-":"")+ord+" ptn:"+ptn+" ins:"+ins))
else if(X.c("'MXTX'00"))sName="David 'Talin' Joiner & Joe Pearce's MaxTrax/Music-X module (MXTX.+SMPL.)",bDetected=1
else if(X.c("'TWNNSNG1'00"))sName="J.A.A. 'Arguru' Ruis's NoiseTrekker module (.NTK)",bDetected=1,sVersion="v1.6b",X.isVerbose()&&sOption(X.SA(9,20))
else if(X.c("'TWNNSNG2'00"))sName="J.A.A. 'Arguru' Ruis's NoiseTrekker module (.NTK)",bDetected=1,sVersion="v2.0",X.isVerbose()&&sOption(X.SA(9,20))
else if(X.c("'TWNNSNG'..00")&&["6","G","I"].indexOf(0<=X.SA(7,1))||X.c("'PROTREK'"))sName="J.A.A. 'Arguru' Rius et al.'s ProTrekkr module (.PTK)",bDetected=1,sVersion="v"+X.SA(7,1),X.isVerbose()&&"v6"==sVersion&&sOption(X.SA(9,20))
else if(X.c("'NESM'1A")||X.c("'NSFE'")){if(sName="Nintendo Sound Format audio (.",bDetected=1,sig=X.SA(0,4),filever="NSFE"===sig?"NSFe":2==X.U8(5)?"NSF2":"NSF",sName+=filever+")",INFOready=!1,NEND=!1,hkhd="",pn=4,nsf2jump=palntsc=K=-1,spd="",vrc7repl=0,playtime=Number(0),g="",taut=[],tlbl=[],xc=l=p=E="","NSFe"===filever){if(X.isVerbose())for(;pn<X.Sz()&&(hksz=X.U32(pn,_BE),"INFO"!==(hkhd=X.SA(pn+4,4)));)pn+=hksz+8
nsf2jump=0}else bDetected=1,sVersion="",X.isVerbose()&&(palntsc=X.U8(122),chip=X.U8(123),tc=X.U8(6),E=X.SA(14,32),p=X.SA(46,32),l=X.SA(78,32)),INFOready=!0,nsf2jump=X.U24(125,_LE),pn+=nsf2jump
if(0<=nsf2jump&&"NSFe"===filever&&X.isVerbose())for(;pn<X.Sz()&&!NEND;){switch(hksz=X.U32(pn,_LE),hkhd=X.SA(pn+4,4),pn+=8,hkhd){case"NEND":NEND=!0
break
case"INFO":INFOready||(palntsc=X.U8(pn+6),chip=X.U8(pn+7),tc=X.U8(pn+7),INFOready=!0)
break
case"RATE":spd="rate :: NTSC: "+X.U16(pn,_LE)+" ticks",0<(palspd=X.U16(pn+2,_LE))&&(spd+=", PAL: "+palspd+" ticks"),0<(dendyspd=X.U16(pn+4,_LE))&&(spd+=", Dendy: "+dendyspd+" ticks")
break
case"VRC7":vrc7repl=X.U8(pn)
break
case"time":for(Y=0;4*Y<hksz;Y++)(curtime=4*Y>=hksz?-1:X.I32(pn+4*Y,_LE))<0&&(curtime=12e4),playtime+=curtime/1e3
break
case"auth":apn=0,g=X.SC(pn,256,"UTF8"),apn+=g.length+1,p=X.SC(pn+apn,256,"UTF8"),apn+=p.length+1,l=X.SC(pn+apn,256,"UTF8"),apn+=l.length+1,l+=", rip: "+X.SC(pn+apn,256,"UTF8")
break
case"taut":if(X.isDeepScan())for(apn=0;apn<hksz;)trkauth=X.SC(pn+apn,hksz-apn,"UTF8"),apn+=trkauth.length+1,taut.push(trkauth)
break
case"tlbl":if(X.isDeepScan())for(apn=0;apn<hksz;)trklbl=X.SC(pn+apn,hksz-apn,"UTF8"),apn+=trklbl.length+1,tlbl.push(trklbl)
break
case"text":X.isDeepScan()&&(xc=X.SC(pn,hksz,"UTF8"))}pn+=hksz,K=pn}if(X.isVerbose()&&INFOready){switch(palntsc){case 0:sVersion+=" NTSC"
break
case 1:sVersion+=" PAL"
break
case 2:sVersion+=" NTSC/PAL"}1&chip&&(sVersion+="#VRC6"),2&chip&&(1===vrc7repl?sVersion+="#YM2413":sVersion+="#VRC7"),4&chip&&(sVersion+="#FDS"),8&chip&&(sVersion+="#MMC5"),16&chip&&(sVersion+="#Namco163"),32&chip&&(sVersion+="#Sunsoft5B"),sOptionT(E),1<tc&&sOption(tc,"×"),sOptionT(p,"by: "),sOptionT(l)}if(X.isVerbose()){for(1<playtime&&sOption(new Date(Math.round(1e3*playtime)).toISOString().substr(11,8),"Playtime: "),0<Math.max(tlbl.length,taut.length)&&sOption("[Tracks]"),Y=0;Y<Math.max(tlbl.length,taut.length);Y++)ttlbl=Y<tlbl.length?tlbl[Y]:"#"+(Y+1),ttaut=Y<taut.length?" by: "+taut[Y]:"",sOption(ttlbl+ttaut)
""!=xc&&sOption(xc,"[Commentary]: "),-1<K&&sOption(outSz(K),"sz:")}}else if(X.c("'OKTASONGCMOD'00000008")&&X.c("'SAMP'00000480",24)&&X.c("'SPEE'00000002....'SLEN'00000002....'PLEN'00000002....'PATT'00000080",1184)&&X.c("'PBOD'",1350)){if(sName="Armin Sander's Oktalyzer module (.OK,.OKT,.OKTA)",bDetected=1,sVersion="v"+X.U16(20,_BE)+"."+X.U16(22,_BE).padStart(2,"0"),X.isVerbose()){for(G=32,smp=0,smps=[];G<1184;G+=32)""!=(E=decAnsi(G,20,CPAmiga).trim())&&smps.push(E),X.U32(G+20,_BE)&&smp++
for(sOption(addEllipsis(smps.join(" ")),'smp/msg:"','"'),tmp0=X.U16(1192,_BE),ptn=X.U16(1202,_BE),ord=X.U16(1212,_BE),rsmp=0,G=1350;G<X.Sz()&&rsmp<smp&&(hkhd=X.SA(G,4),!(charStat(hkhd,1).indexOf("allasc")<0));)hksz=X.U32(G+4,_BE),"SBOD"===hkhd&&rsmp++,G+=8+hksz
sOption("tmp0:"+tmp0+" ord:"+ord+" ptn:"+ptn+" smp:"+(rsmp!=smp?rsmp+"/":"")+smp+" sz:"+outSz(G))}}else if(X.c("'Onyx Music File'1A0001")&&X.c("80808080",398)){if(sName="Altar/Onyx's Onyx Music File (.OMF)",bDetected=1,X.isVerbose()){for(ch=X.U8(402)+1,ptn=X.U8(403)+1,ord=X.U8(404)/2+1,F=X.SA(405,31).trim(),sn=[],smp=smpsz=0,Y=0;Y<31;Y++)(E=X.SA(436+28*Y,21).trim()).length&&sn.push(E),(E=X.U16(460+28*Y))&&(smpsz+=E,smp++)
for(Y=0,G=1306;Y<ptn;Y++)G+=3+256*X.U8(G+2)
for(K=G+smpsz+3*smp,Y=0;Y<smp;Y++)G+=3+X.U16(G+1)
G!=K&&(sVersion="malformed!badsmpcnk"),sOptionT(F),sOptionT(addEllipsis(sn.filter(funSampleName).join(" ")),'smp/msg:"','"'),sOption("ch:"+ch+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K))}}else if((X.c("'Org-02'")||X.c("'Org-03'"))&&114<=X.Sz()){if(sName="Amaya 'Pixel' Daisuke's Organya/ORG Maker module (.ORG)",bDetected=1,50===X.U8(5)?sVersion:sVersion="v2",X.isVerbose()){for(l=ins=0,Y=0;Y<16;Y++)(E=X.U16(22+6*Y))&&(ins++,l+=E)
sOption("ins:"+ins+" tempo:"+X.U16(6)+" rhythm:"+X.U8(8)+"/"+X.U8(9)+" notes:"+l+" sz:"+outSz(114+(l<<3)))}}else if(X.c("'OBISYNTHPACK'")&&1296<X.Sz()&&(X.c("0100",1292)||!X.U32(1292,_BE))){if(sName="Karsten 'Obi' Obarski's Synth Pack module (.OSP+SMP.set)",bDetected=1,X.isVerbose()){for(G=a2=12,k=ord=0,d1=64;G<X.Sz()&&d1--&&(d2=X.U32(G,_BE),G+=4,d2);)ord++,240==(d2&=65535)&&k++
for(d3=d6=0;a2<X.Sz()&&d6<64&&(d4=X.U32(a2,_BE),a2+=4,d4?(65024!=(d4&=65280)&&64512!=d4||d3++,d6++):X.U32(a2,_BE)&&d6++,!(64<=d6)););for(d3>k&&(k=d3,ord=d6),(X.c("2000",12)||X.c("FE",14))&&(k=7),d1=256,G<X.Sz()&&(G=268),ptn=0;G<X.Sz()&&d1--;)(E=X.U8(G))>ptn&&(ptn=E),G+=4
if(G<X.Sz()&&(G=1292),X.U32(1292,_BE)){for(;G<X.Sz()&&X.U16(G,_BE);G+=2);for(G+=X.U16(G-2,_BE);G<X.Sz()&&!X.c("FFFFFFFF5FFF",G);G+=2);G+=6}else G+=384*(ptn+1)
1<k&&sOption(k,"×"),sOption("ord:"+ord+" ptn:"+ptn+" sz:"+outSz(G))}}else if(X.c("'OBISYNTHPACK'")){for(G=12,Y=smp=0;G<X.Sz()&&Y<64;Y++)E=X.U32(G+4,_BE)-X.U32(G,_BE),G+=4,E&&smp++
G-=4,(K=X.U32(G,_BE))<=X.Sz()&&(sName="Karsten 'Obi' Obarski's Synth Pack's sample set (SMP.SET)",bDetected=1,X.isVerbose())&&sOption("smp:"+smp+" sz:"+outSz(K))}else if(X.c("00800404 1214191C 1FCE26D6 328E35EA 3CF23CF2")&&X.c("0C000384000000000000",128)){for(Y=smp=G=0;G<X.Sz()&&Y<64;Y++)E=X.U16(G+2,_BE)-X.U16(G,_BE),G+=2,E&&smp++
G-=2,(K=X.U16(G,_BE))<=X.Sz()&&(sName="Synth Pack's sample set (SMP.SET)",sVersion="headerless",bDetected=1,X.isVerbose())&&sOption("smp:"+smp+" sz:"+outSz(K))}else if(X.c("'PACG'........'PAIN'")&&16<(E=X.fSig(12,256,"'SOIN'")+8)&&X.U16(E+2)&&X.U8(E+4)&&X.c("4005",E+5)&&X.U32(4)+8<=X.Sz()){for(sName="Henning Hellström's SBStudio II module (.PAC)",bDetected=1,K=(G=8)+X.U32(4),F=tracker=bad="",end=trk=ord=ptn=spd0=bpm0=smp=0;G<X.Sz()&&(hkhd=X.SA(G,4),!(charStat(hkhd).indexOf("allasc")<0));){switch(hksz=X.U32(G+4),G+=8,hkhd){case"SND ":smp++
break
case"SOIN":spd0=X.U8(G),bpm0=X.U8(G+1),ptn=X.U16(G+2),trk=X.U8(G+4)
break
case"SONA":F=X.SC(G,hksz,"CP850")
break
case"SOOR":ord=hksz>>1
break
case"PAOR":tracker=X.SC(G,hksz,"CP850")
break
case"END ":end=1}if(G+=hksz,end)break}""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(F),sOption(tracker,"in: "),sOption("trk:"+trk+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(X.U32(4)+8)))}else if(X.c("'PLM'1A..10")&&isWithin(ch=X.U8(54),1,32)&&X.Sz()>=4*((smp=X.U8(92))+(ptn=X.U8(93))+(ord=X.U16(94,_LE)))&&firstNotOf(60,32,[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15])<0){for(sName="Alex 'Statix' Evans' Disorder Tracker 2 module (.PLM)",bDetected=1,G=X.U8(4),ofs=rsmp=0,rptn=[],ptns=[],smps=[],mp=[0,"unk"],bad="",Y=0;Y<ord;Y++,G+=4)rptn.indexOf(E=X.U8(G+3))<0&&rptn.push(E)
for(Y=0;Y<ptn;Y++,G+=4)(E=X.U32(G))>mp[0]&&(mp=[E,"ptn"]),(E=X.SC(E+7,25,"CP437").trim()).length&&ptns.push(E)
for(Y=0;Y<smp;Y++,G+=4)(E=X.U32(G))>mp[0]&&(mp=[E,"smp"]),E&&(X.c("'PLS'1A",E)||(bad=bad.addIfNone("!badsmpsig:"+X.SA(E,4))),isWithin(X.I8(E+50),-1,15)||(bad=bad.addIfNone("!badsmppan")),64<X.U8(E+51)&&(bad=bad.addIfNone("!badsmpvol")),smps.push(X.SC(E+6,32,"CP437").trim()),X.U32(E+67))&&rsmp++
switch(rptn=rptn.length,G>X.Sz()&&(bad=bad.addIfNone("!short")),K=Math.max(mp[0],G),mp[1]){case"ptn":K=mp[0]+X.U32(mp[0],_LE)
break
case"smp":K=mp[0]+X.U8(mp[0]+4)+X.U32(mp[0]+67,_LE)}bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(X.SC(6,48,"CP437")),sOption(addEllipsis(smps.filter(funSampleName).join(" "),224),'smp/msg:"','"'),sOption("ch:"+X.U8(54)+" bpm0:"+X.U8(58)+" spd0:"+X.U8(59)+" ord:"+ord+" ptn:"+(rptn!=ptn?rptn+"/":"")+ptn+" smp:"+(rsmp!=smp?rsmp+"/":"")+smp+" sz:"+outSz(K)))}else if(X.c("'PLX'")&&X.U8(3)<=2&&X.U8(4)&&X.U16(7)<X.Sz()&&X.U16(9)<X.Sz()&&X.U16(11)<X.Sz()){if(sName="Rainbow Arts' Palladix Sound System module (.PLX)",bDetected=1,X.isVerbose()){for(ch=0,G=7;G<17;G+=2)X.U16(G)&&ch++
sOption("ch:"+ch)}}else if(X.c("FFFFE002E102"))sName="Achim Haertel's POKEYNoise chiptune (.PN)",bDetected=1
else if(X.c("01080B08 E1079E32 30363100 000078D8 A2FF9A20 1B082000"))sName="Aleksi Eeben's Polyanna module (.PRG)",sVersion="v1.0&player",bDetected=1,X.isVerbose()&&sOption("sz:"+outSz(22529))
else if(X.c("'PSA'00")&&52<X.U32(40,_BE)<X.Sz()&&52<X.U32(44,_BE)<X.Sz()&&52<X.U32(48,_BE)<X.Sz()){if(sName="Professional Sound Artists module (.PSA)",bDetected=1,X.isVerbose()){for(sOptionT(X.SA(4,20)),d2=X.U32(40,_BE),1<(k=d2-56>>3)&&sOption(k,"×"),d3=X.U32(44,_BE),d0=X.U32(48,_BE),ins=d3-d2>>6,d3=ins,synsmp=0,smp=0,B=0,d7=3;d3;)(ts=X.U32(d2,_BE))?ts<d7&&(d7=ts,smpsz=X.U16(d2,_BE)+4<<1,B+=smpsz,smp++):synsmp++,d2+=64,d3--
K=X.U32(36,_BE),songsz=K-B,ptn=songsz-d0>>10,sOption("ptn:"+ptn+" ins:"+ins+" smp:"+smp+" syn.smp:"+synsmp+" songsz:"+songsz+" sz:"+outSz(K))}}else if(X.c("'PSF'")){if(0<(nV=X.U8(3))){switch(bDetected=1,sName="Neil Corlett's Portable Sound Format module (.",nV){case 1:sName+="PSF,.PSF1,.MINIPSF,.MINIPSF1)",sVersion="Playstation"
break
case 2:case 3:sName+="PSF2,.MINIPSF2)",sVersion="Playstation 2"
break
case 17:sName+="SSF,.MINISSF)",sVersion="Saturn"
break
case 18:sName+="DSF,.MINIDSF)",sVersion="Dreamcast"
break
case 33:sName+="USF,.MINIUSF)",sVersion="Ultra64"
break
case 34:sName+="GSF,.MINIGSF)",sVersion="Gameboy"
break
case 35:sName+="SNSF,.MINISNSF)",sVersion="Super Nintendo"
break
case 36:sName+="2SF,.MINI2SF)",sVersion="Nintendo DS"
break
case 37:sName+="NCSF,.MININCSF)",sVersion="Nintendo DS Nitro Sound"
break
case 65:sName+="QSF,.MINIQSF)",sVersion="Capcom Q-Sound"
break
default:sName+="*SF,.MINI*SF)",sVersion="unk.console"}if(sVersion="v"+Hex(nV)+" "+sVersion,X.isVerbose())if(ptags=X.U32(8,_LE)+21,sig2=!1,(sig2=21<ptags&&ptags<X.Sz()?"[TAG]"===X.SA(ptags-5,5):sig2)||21<(ptags=X.U32(4,_LE)+21)&&ptags<X.Sz()&&(sig2="[TAG]"===X.SA(ptags-5,5)),sig2){for(tags=X.SC(ptags,X.Sz()-ptags,"UTF8").trim(),g=p="",y=E="",j="",tagl=tags.split("\n"),Y=0;Y<tagl.length;Y++)switch((tag=tagl[Y].split("="))[0]){case"length":j=tag[1]
break
case"title":E=tag[1]
break
case"game":g=tag[1]
break
case"artist":p=tag[1]
break
case"copyright":""==p&&(p=tag[1])
break
case"year":y=tag[1]
break
case"ssfby":""==p&&(p=tag[1])}sOption(E),sOption(p,"by: "),sOption(y,"'"),sOption(g,"for: "),sOption(j,"len ")}else sVersion+=" library"
X.Sz()<768&&(sVersion+=" header")}}else if(X.c("'PSG'1A"))sName="Kirill Kolpakov's fMSX/x128 PSG chiptune (.PSG)",bDetected=1
else if(X.c("'EPSG'1A"))sName="Kirill Kolpakov's Extended PSG chiptune (.EPSG)",bDetected=1,0===(hw=X.U8(5))&&(sVersion="ZX Spectrum 128k"),hw<2&&!X.c("00000000 000000000000",6)&&(sVersion+="/malformed")
else if(X.c("'PSG2'"))sName="PSG2 chiptune (.PSG2)",bDetected=1
else if((X.c("'PSM '")||X.c("'PSM'FE"))&&0<=X.fStr(8,10,"FILE")&&0<=X.fStr(16,50,"MAINSONG"))sName="Epic Megagames MASI module (.PSM)",bDetected=1,X.isVerbose()&&(0<(pt=X.fStr(16,50,"MAINSONGTITL"))&&(ts=X.U32(pt+12),sOptionT(X.SA(pt+16,ts))),sOption(outSz(X.U32(4)+12),"sz:"))
else if(X.c("'PSY'..'SONG")){if(sName="J.M.A. Segura/Psycledelics' Psycle Modular Music Creation Studio module (.PSY)",bDetected=1,sV=X.SA(3,1),sVersion="v"+sV,X.isVerbose())switch(sV){case"0":case"1":sOptionT(X.SC(8,32,"CP1252")),sOptionT(X.SC(40,32,"CP1252"),"by: "),sOptionT(X.SC(72,128,"CP1252"))
break
case"2":if(sOptionT(X.SC(8,32,"CP1252")),sOptionT(X.SC(40,32,"CP1252"),"by: "),sOptionT(X.SC(72,128,"CP1252")),bpm=X.I32(200),ord=X.I32(401),trk=X.I32(405),ptn=X.I32(409),G=413,X.isDeepScan()){for(inss=[],vsts=[],macs=[],waves=mach=0,bad="",Y=0;Y<ptn;Y++)rows=X.I32(G),G+=36+160*rows
for(G+=4,inss=[],Y=0;Y<255;Y++)""!=(E=X.SC(G,32,"CP1252").trim())&&"empty"!=E&&inss.push(E),G+=32
if((G+=14284)>X.Sz())bad=bad.addIfNone("!short")
else for(Y=0;Y<255&&G<X.Sz();Y++)for(w=0;w<16&&G<X.Sz();w++){var x,E=X.U32(G)
G+=4,E&&(w||waves++,G+=45,x=X.U8(G++)+1,G+=E<<x)}if(G>X.Sz())bad=bad.addIfNone("!short")
else for(Y=0;Y<256;Y++)(E=X.U8(G++))&&(""!=(E=X.SC(G,128,"CP1252").trim())&&vsts.push(E),G+=128,E=X.I32(G),G+=4+4*E)
for(m=[],Y=0;Y<128;Y++)(E=X.U8(G++))&&mach++,m[Y]=E
E=oldt=0
for(Y=0;Y<128;Y++)if(m[Y]){for(E=X.I32(G+8),G+=12,tn=X.SA(8===E?G+256:G,16),tpn=8===E?X.SA(G,256):"",ts=tn+tpn,nonascii=!1,q=0;q<ts.length;q++)if(ts[q]<" "||"~"<ts[q]||/["+?*]/.test(ts[q])){nonascii=!0
break}if((15<E&&E<255||ts.length<2||nonascii)&&8===oldt){bad=bad.addIfNone("!pluginDefinedDataSize")
break}if(15<E&&E<255){bad=bad.addIfNone("!badMachineType")
break}switch(oldt=E){case 8:macs.push(tn),E=X.I32(G+272),G=G+(276+4*E)+385
break
case 9:case 10:vsts.push(tn),G+=407
break
default:macs.push(X.SA(G,16)),G+=401}}G>X.Sz()&&(bad=bad.addIfNone("!short")),(G+=1275)>X.Sz()&&(bad=bad.addIfNone("!noP0")),(G+=64)>X.Sz()&&(bad=bad.addIfNone("!noP1")),G<X.Sz()&&X.U8(G++)&&(G+=4+X.U32(G)),""!=bad&&(sVersion+="/malformed"+bad),inss.length&&sOption("inss: ["+inss.join(",")+"]"),vsts.length&&sOption("vsts: ["+vsts.join(",")+"]"),macs.length&&sOption("mcn: ["+macs.join(",")+"]"),sOption("ord:"+ord+" ptn:"+ptn+" trk:"+trk+" bpm:"+bpm+" mach:"+mach+" smp:"+waves+" sz:"+outSz(G))}else sOption("ord:"+ord+" ptn:"+ptn+" trk:"+trk+" bpm:"+bpm)
break
case"3":for(nV=X.I32(8),sVersion+="/"+nV,G=16+X.U32(12),hkn=X.U32(16,_LE),l=p=E="",trk=0,bpm=0,ptnlns=0,ptn=0,mac=0,ins=0,eins=0;0<hkn;){switch(hkhd=X.SA(G,4),hkn--,cV=X.U32(G+4,_LE),hksz=X.U32(G+8,_LE),G+=12,hkhd){case"INFO":p1=G,0==(65280&cV)&&(E=X.SC(p1,128,"CP1252"),p1+=E.length+1,p=X.SC(p1,64,"CP1252"),p1+=p.length+1,l=X.SC(p1,65535,"CP1252"),p1+=l.length+1,0==cV)&&(hksz=E.length+p.length+l.length+3)
break
case"SNGI":0==(65280&cV)&&(trk=X.I32(G,_LE),0==cV&&(hksz=44+2*trk),bpm=X.I16(G+4,_LE)+X.I16(G+6,_LE)/100)
break
case"SEQD":0==(65280&cV)&&(seqlen=X.I32(G+4,_LE))
break
case"PATD":0==(65280&cV)&&(_idx=X.I32(G,_LE),ptnlns=X.I32(G+4,_LE),ptnn=X.SA(G+12,32),p1=G+12+ptnn.length+1,ptnsz=X.I32(p1,_LE),ptn++,p1+=4,0==cV)&&p1+ptnsz==G+hksz+4&&(hksz+=4)
break
case"MACD":mac++
break
case"INSD":ins++
break
case"EINS":65536==(4294901760&cV)&&(eins=X.U32(G,_LE))}G+=hksz}sOptionT(E),sOptionT(p,"by: "),sOptionT(l),sOption("bpm:"+bpm+" trk:"+trk+" ptnlns:"+ptnlns+" mac:"+mac+" ptn:"+ptn+"/idx:"+_idx+" ins:"+ins+" eins:"+eins+" sz:"+outSz(G))
break
case"4":sVersion+="/future"}}else if(X.c("'PSMP'")&&0<=[0,16].indexOf(X.U8(4)))sName="Sega MegaDrive Pre-SMP chiptune (.PSZ)",bDetected=1,sVersion=X.U8(4)?"BE":"LE",X.isVerbose()&&sOption("tempo:"+X.U8(5))
else if(X.c("'PTCOLLAGE-'")||X.c("'PTTUNE--20'")){switch(bDetected=1,v1=X.SA(2,1),sName="T"===v1?(rough=10,"Amaya 'Pixel' Daisuke's pxtone tune (.PTTUNE)"):(rough=1,"Amaya 'Pixel' Daisuke's pxtone project (.PTCOP)"),(dt=X.SA(10,6))<="050227"?(sV="v.x1x",nV=1):dt<="050608"?(sV="v.x2x",nV=2):dt<="060115"?(sV="v.x3x",nV=3):dt<="060930"?(sV="v.x4x",nV=4):dt<="071119"&&(sV="v5",nV=5),d=dt.substr(0,2)+"-"+dt.substr(2,2)+"-"+dt.substr(4,2),sVersion=sV+"/20"+d,nV){case 1:case 2:G=16
break
default:G=20}for(E=l=bad="",bclock=lclock=bnum=btempo=bps=ch=0,bEnd=!1;!bEnd&&G<X.Sz();){switch(hkhd=X.SA(G,8),hksz=X.U32(G+8,_LE),_l2r("px",G,hkhd),hkhd){case"PROJECT=":E=X.SC(G+12,16,"Shift_JIS"),btempo=X.F32(G+28,_LE).toFixed(0),bclock=X.I16(G+32,_LE),bnum=X.I16(G+34,_LE)
break
case"evenMAST":3!=X.U16(G+12,_LE)?sVersion+="/unk":(-12<(e=X.fSig(G+3,256,"'textNAME'")-12)||-12<(e=X.fSig(G+3,256,"'textCOMM'")-12))&&(G=e-hksz)
break
case"MasterV5":15!=hksz&&(bad=bad.addIfNone("!badv5fmt")),bclock=X.I16(G+12)*rough,bnum=X.I8(G+14),btempo=X.F32(G+15).toFixed(0),lmeas=(X.I32(G+23)/(bnum*bclock)).toFixed(0)
break
case"Event V5":var ls=X.U32(G+12,_LE)
q=G+11
for(var P=0;P<ls;P++){for(Y=0;Y<5&&!(X.U8(++q)<128);Y++);for(q+=2,Y=0;Y<5&&!(X.U8(++q)<128);Y++);}hksz=4+q-G-11
break
case"textNAME":E=X.SC(G+12,hksz,"Shift_JIS")
break
case"textCOMM":l=addEllipsis(X.SC(G+12,hksz,"Shift_JIS"),160)
break
case"assiWOIC":ch++
break
case"END=====":case"pxtoneND":bEnd=!0}G+=12+hksz}bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&("no name"!=E&&sOption(E),sOptionT(l),0<bclock+btempo+bnum&&sOption("ch:"+ch+" bpm:"+btempo+" bclock:"+bclock+" bnum:"+bnum),sOption(outSz(G),"sz:"))}else if(X.c("'PTNOISE-'"))sName="Amaya 'Pixel' Daisuke's pxtone Noise instrument (.PTNOISE)",bDetected=1
else if(X.c("'PTVOICE-'"))sName="Amaya 'Pixel' Daisuke's pxtone Voice instrument (.PTVOICE)",bDetected=1,X.isVerbose()&&sOption(outSz(X.U32(12)+16),"sz:")
else if(X.c("'PTMF'",44)&&26==X.U8(28)&&X.U8(30)<=2&&isWithin(ch=X.U16(38),1,32)&&(ord=X.U16(32))<256&&isWithin(ins=X.U16(34),1,255)&&isWithin(ptn=X.U16(36),1,128)){for(sName="Lone Ranger/AcmE's Poly Tracker module (.PTM)",bDetected=1,sV=Hex(X.U16(29)),sVersion="v"+sV.substr(0,1)+"."+sV.substr(1,2),bad="",sn=[],Y=mp=rsmp=0,G=608;Y<ins;Y++,G+=80)3&X.U8(G)&&(rsmp++,E=X.U32(G+18),mp<E)&&(mp=E,K=E+X.U32(G+22)),(E=X.SC(G+48,28,"CP437").trim()).length&&sn.push(E)
K=Math.max(K,G),(bad=rsmp?bad:bad.addIfNone("!badsmpavl")).length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(X.SC(0,28,"CP437")),sOption(addEllipsis(sn.join(" ")),'ins/msg:"','"'),sOption("ch:"+ch+" ord:"+ord+" ptn:"+ptn+" ins:"+ins+" smp:"+rsmp+" sz:"+outSz(K)))}else if(X.c("'RAD by REALiTY!!'")){if(sName="Shayde & Rogue & Void's Reality ADlib Tracker module (.RAD)",bDetected=1,sV=(nV=X.U8(16)).toString(16),sVersion="v"+sV[0]+"."+sV[1],bad="",X.isVerbose()){if(al=X.U8(17),fbpm=32<nV&&32&al,16==nV&&128&al||32<=nV){for(j=18,fbpm&&(j+=2),desc="",maxdesc=250,cutoff=!1,i=X.fSig(j,X.Sz()-32-j,"00"),G=i+1,i<0?(maxdesc=0,bad=bad.addIfNone("!baddesc")):i>j+maxdesc&&(i=j+maxdesc,cutoff=!0),tmp=X.readBytes(j,i-j),Y=0;desc.length<maxdesc&&Y<i-j;Y++)switch(tmp[Y]){case 0:Y=i-j
break
case 1:desc+="\n"
break
default:if(tmp[Y]<32)for(c=0;c<tmp[Y]&&desc.length<=maxdesc;c++)desc+=" "
else desc+=String.fromCharCode(tmp[Y])}cutoff&&(desc+="..."),sOptionT(desc)}else G=18
for(spd0=31&al,bpm=fbpm?X.U16(18):125,ins=0,insns=[];G<X.Sz()&&(insn=X.U8(G++))&&!(G>X.Sz());)ins++,16==nV?G+=11:33==nV?(nmlen=X.U8(G++),insns.push(X.SA(G,nmlen)),G+=nmlen,rm=X.U8(G),riff=128&rm,(midi=7==(7&rm))?G+=7:G+=24,riff&&(G+=X.U16(G)+2)):bad=bad.addIfNone("!badver")
if(ord=X.U8(G++),G+=ord,(!ord||128<ord)&&(bad=bad.addIfNone("!badord")),ptn=ptns=0,32<nV)for(;G<X.Sz()&&255!=(E=X.U8(G++));)ptns++,ptn<=E&&(ptn=E+1),G+=2+X.U16(G)
else{for(Y=mptn=0;Y<32;++Y,G+=2)(E=X.U16(G))&&ptn++,mptn=Math.max(mptn,E),E>X.Sz()&&(bad=bad.addIfNone("!short"))
if(mptn)for(G=mptn,end=!1;!end&&G<X.Sz();)for(128&(E=X.U8(G++))&&(end=!0);G<X.Sz()&&(E=X.U8(G),G+=2,7&X.U8(G++)&&G++,!(128&E)););}if(ptn||(bad=bad.addIfNone("!badptn")),ins||(bad=bad.addIfNone("!badins")),riff=riffs=0,32<nV){for(;G<X.Sz()&&255!=(E=X.U8(G++));)riffs++,riff<E&&(riff=E),G+=2+X.U16(G)
sOptionT(addEllipsis(insns.filter(funSampleName).join(" "),256),'ins:"','"'),sOption("spd0:"+spd0+" bpm:"+bpm+" ord:"+ord+" ptn:"+ptns+(ptn!=ptns?"/"+ptn:"")+" ins:"+ins+" riffs:"+riffs+(riff!=riffs?"/"+riff:""))}else sOption("spd0:"+spd0+" bpm:"+bpm+" ord:"+ord+" ptn:"+ptn+" ins:"+ins)
bad&&(sVersion+="/malformed"+bad),sOption("sz:"+outSz(G))}}else if(X.c("'RAWADATA'")&&10<X.Sz()){if(sName="Raw OPL Capture chiptune (.RAW)",bDetected=1,X.isVerbose()&&(X.isDeepScan()||X.Sz()<65535)){for(G=10,len=X.Sz()-10>>1,tagdata=!1,E=p=d="",next=0,Y=0;Y<len&&G<X.Sz();Y++)k=tagdata?65535:X.U16(G),G+=2,tagdata||65535!=k||(26==(tagcode=X.U8(G++))?tagdata=!0:!tagcode&&charStat(X.readBytes(G,5),!0).includes("allxsc")?(d=X.SA(G,1023),G+=1023,tagdata=!0):G--)
tagdata&&G+40<=X.Sz()&&(F=X.SA(G,40),G+=40,27!=X.U8(G++)&&(G--,32<=X.U8(G)?(p=X.SA(G,60),G+=60,d=X.SA(G,1023),G+=1023,next=2):G--,next=1),next||(p=X.SA(G,40),G+=40),1!=next||(next=0,next=28!=X.U8(G++)?2:next)||(d=X.SA(G,1023),G+=1023)),sOption(F),sOption(p,"by: "),sOption(d)}X.isVerbose()&&sOption(X.U16(8),"clkspd:")}else if(X.c("'RNS0'")&&X.c("'>>> Chunk Start <<<'00",9)){if(sName="Eduard Müller's Renoise module (.RNS)",bDetected=1,sV=X.SA(3,4),sVersion="v"+sV,sV<"05"?sVersion+="/RN<1.1.1":"05"===sV?sVersion+="/RN1.1.1":sV<"015"?sVersion+="/RN<1.2.7":"015"===sV?sVersion+="/RN1.2.7":sV<"018"?sVersion+="/RN<1.5.2":"018"===sV?sVersion+="/RN1.5.2":sVersion+="/RN>1.5.2",X.isVerbose())for(G=9;G<X.Sz()&&X.c("'>>> Chunk Start <<<'00",G);){if(G+=20,X.c("'Header V00         '00",G)){sOptionT(X.SC(G+20,20,"CP1252")),sOptionT(X.SC(G+40,20,"CP1252"),"by: "),sOptionT(X.SC(G+60,20,"CP1252"),"style: ")
break}if(X.c("'Header V01         '00",G)){G+=20,K=X.U32(G),sOptionT(X.SC(G+4,K,"CP1252")),G+=K+4,K=X.U32(G),sOptionT(X.SC(G+4,K,"CP1252"),"by: "),G+=K+4,K=X.U32(G),sOptionT(X.SC(G+4,K,"CP1252"),"style: ")
break}if(X.c("Header V02         '00",G)){G+=20,K=X.U32(G),sOptionT(X.SC(G+4,K,"CP1252")),G+=K+4,K=X.U32(G),sOptionT(X.SC(G+4,K,"CP1252"),"by: "),G+=K+4,K=X.U32(G),sOptionT(X.SC(G+4,K,"CP1252"),"style: "),G+=K+4+5,K=X.U32(G),sOptionT(X.SC(G+4,K,"CP1252"))
break}if(-1==(G=X.fSig(G+1,TOEOF,"''>>>  Chunk End  <<<'00")))break
G+=20}}else if(extIs("xrns")&&X.c("'PK'0304"))sName="Eduard Müller's Renoise module (.XRNS)",sType="~audio",sVersion="xml",bDetected=1
else if(extIs("xrdp")&&0<=X.fStr(0,256,"<FilterDevicePreset"))sName="Eduard Müller's Renoise filter device preset (.XRDP)",bDetected=1,G=X.fStr(20,256,"doc_version="),sVersion=G<0?"malformed":(sVp=X.SA(G,16),"v"+/doc_version=\"(\d*)\"/.exec(sVp)[1])
else if(extIs("xrni")&&X.c("'PK'0304"))sName="Eduard Müller's Renoise instrument (.XRNI)",sType="~audio",sVersion="xml",bDetected=1
else if(extIs("xrno")&&0<=X.fStr(0,256,"<SampleModulationSet"))sName="Eduard Müller's Renoise sample modulation set (.XRNO)",bDetected=1,G=X.fStr(15,256,"doc_version="),sVersion=G<0?"malformed":(sVp=X.SA(G,16),"v"+/doc_version=\"(\d*)\"/.exec(sVp)[1])
else if(extIs("xrnt")&&0<=X.fStr(0,256,"<RenoiseDeviceChain"))sName="Eduard Müller's Renoise effect chain (.XRNT)",bDetected=1,G=X.fStr(15,256,"doc_version="),sVersion=G<0?"malformed":(sVp=X.SA(G,16),"v"+/doc_version=\"(\d*)\"/.exec(sVp)[1])
else if(extIs("xrnt")&&X.c("'PK'0304"))sName="Eduard Müller's Renoise effect chain (.XRNT)",sVersion="v<3.0",bDetected=1
else if(extIs("xrnz")&&0<=X.fStr(0,256,"<InstrumentPhrase"))sName="Eduard Müller's Renoise instrument phrase (.XRNZ)",bDetected=1,G=X.fStr(15,256,"doc_version="),sVersion=G<0?"malformed":(sVp=X.SA(G,16),"v"+/doc_version=\"(\d*)\"/.exec(sVp)[1])
else if(X.c("'NuRIFFRAFF'",34))sName="Riff Raff module (.RIFF)",bDetected=1,X.isVerbose()&&(E=X.SC(100,256,"CP1252"),p=X.SC(100+E.length+1,256,"CP1252"),l=X.SC(100+E.length+p.length+2,256,"CP1252"),sOptionT(E),sOptionT(p,"by: "),sOptionT(l))
else if(X.c("'RON_KLAREN_SOUNDMODULE!'00",40))sName="Ron Klaren module (.RK)",bDetected=1
else if(X.c("'RTMM '")&&26==X.U8(37)&&X.c("'RTND'",42+X.U16(40)+X.U32(136)))sName="Arnaud Hasenfratz's Real Tracker module (.RTM)",bDetected=1,sVersion="v"+X.SA(55,7)+"/"+Hex(X.U16(38)),X.isVerbose()&&(rtmmxds=X.U32(136),sOptionT(X.SC(5,32,"CP1252")),sOptionT(X.SC(62,32,"CP1252"),"by: "),sOptionT(X.SC(140,32,"CP1252"),"orig.: "),sOption("ch:"+X.U8(96)+" spd0:"+X.U8(102)+" bpm0:"+X.U8(103)+" ord:"+X.U16(98)+" ptn:"+X.U16(100)+" ins:"+X.U8(97)))
else if(X.c("01FF..3EFF32018079FEFF2846320280B7201301FF013E1CED79053E02ED79AF320180C9")&&X.c("21A9843D280E232347237E2BB67820F6232318EF5E23567AB328D22B2224803EFE320E823E08325280C35C80",38))sName="František Fuka/Fuxoft's Samadeus module (.samadeus)",bDetected=1
else if(X.c("00000000 00000200",12)&&X.c("00")&&X.U16(24,_LE)===X.U16(64,_LE)&&X.c("00'ST-Module.'",1207)){for(sName="Oliver 'BSC' Mayer's Amstrad CPC Soundtrakker module (.STK)",bDetected=1,datasz=X.U16(24,_LE),(K=datasz+128)<X.Sz()&&(sVersion="malformed"),crc=0,Y=0;Y<67;Y++)crc+=X.U8(Y);(crc&=65535)!=X.U16(67)&&(sVersion+=""!=sVersion?"!badCRC":"/malformed!badCRC"),X.isVerbose()&&sOptionT(X.SA(1,8)),sOption(outSz(K),"sz:")}else if(X.c("00000000 00000200",12)&&X.c("00")&&X.U16(24,_LE)===X.U16(64,_LE)&&X.SA(1,8)===X.SA(2832,8)){for(sName="Oliver 'BSC' Mayer's Amstrad CPC Soundtrakker 128K module (.128)",bDetected=1,datasz=X.U16(24,_LE),(K=datasz+128)<X.Sz()&&(sVersion="malformed"),crc=0,Y=0;Y<67;Y++)crc+=X.U8(Y)
for((crc&=65535)!=X.U16(67)&&(sVersion+=""!=sVersion?"!badCRC":"/malformed!badCRC"),X.isVerbose()&&sOptionT(X.SA(1,8)),inst=[],ins=0,Y=0;Y<16;Y++)[0,32].indexOf(X.U8(2840+8*Y))||(ins++,inst.push(X.SA(2840+8*Y,8).trim()))
sOption(inst),sOption("ins:"+ins+" sz:"+outSz(K))}else if(X.c("00'ST-Module.'",1079))sName="Oliver 'BSC' Mayer's Amstrad CPC Soundtrakker module (.STK)",bDetected=1,sVersion="headerless"
else if(32<X.Sz()&&/S98[0-3]/.test(X.SA(0,4))&&X.U32(4)<=32&&!X.U32(12)&&(!X.U32(16)||isWithin(X.U32(16),32,8388608))&&X.U32(20)<131072&&(!X.U32(24)||isWithin(X.U32(24),X.U32(20),8388608))&&X.U32(28)<=64){if(sName="Ru³'s S98 chiptune (.S98)",bDetected=1,nv=X.U8(3)-48,sVersion="v"+nv,!(dev=X.U32(28))||2<=nv&&!X.U32(32))sVersion+="#OPNA(YM2608)@7.6MHz"
else for(Y=0,G=32;Y<dev&&X.U32(G);Y++,G+=16)clk=(X.U32(G+4)/1048576).toFixed(1)+"MHz",16<(dt=X.U32(G))?sVersion+="#unk@"+clk:sVersion+="#"+["","PSG(YM2149)","OPN(YM2203)","OPN2(YM2612)","OPNA(YM2608)","OPM(Y2151)","OPLL(YM2413)","OPL(YM3526)","OPL2(YM3812)","OPL3(YMF262)","unk0A","unk0B","unk0C","unk0D","unk0E","PSG(AY-3-8910)","DCSG(SN76489)"][dt]+"@"+clk
if(bad="",(X.U32(20)>X.Sz()||X.U32(24)>X.Sz())&&(bad+="!short"),X.U32(16)>X.Sz()-7&&(bad+="!badmetadata"),bad.length&&(sVersion+="/malformed"+bad),X.isVerbose())switch(p=l=s=g=ti=y="",nv){case 0:case 1:case 2:0<(G=X.U32(16))&&sOptionT(X.SC(G,64,"Shift_JIS").replace("\\","￥")),(pk=X.U32(12))&&(sVersion+=" compressed",sOption("Please send this file over Telegram to @kaens, the detection author! It's unique and needs research"))
break
case 3:if(6<(ptags=X.U32(16))&&X.c("'[S98]'",ptags)){for(ptags+=5,bUTF8=X.c("EFBBBF",ptags),tags=bUTF8?X.SC(ptags,512,"UTF8"):X.SC(ptags,512,"Shift_JIS"),tagl=tags.split("\n"),Y=0;Y<tagl.length;Y++)switch((tag=tagl[Y].split("="))[0]){case"title":case"ｔｉｔｌｅ":ti=tag[1]
break
case"game":case"ｇａｍｅ":g=tag[1]
break
case"system":case"ｓｙｓｔｅｍ":s=tag[1]
break
case"artist":case"ａｒｔｉｓｔ":p=tag[1]
break
case"year":case"ｙｅａｒ":y=tag[1]
break
case"copyright":case"ｃｏｐｙｒｉｇｈｔ":""==p&&(p=tag[1])
break
case"s98by":case"ｓ９８ｂｙ":""==p&&(p=tag[1])
break
case"comment":case"ｃｏｍｍｅｎｔ":l=tag[1]}sOption(ti),sOption(p,"by: "),sOption(y,y.length<4?"y'":"y"),sOption(g,"for: "),sOption(s,"on: "),sOption(l),6<ptags&&X.c("'[S98]'",ptags-5)&&-1<(E=X.fSig(ptags,768,"00"))&&sOption(outSz(E+1),"sz:")}else 6<ptags&&(E=X.SC(ptags,64,"Shift_JIS").replace("\\","￥"))}}else if(X.c("'SAP'0D0A")&&3<=(G=X.fSig(3,TOEOF,"0D0AFFFF"))&&X.U16(G+4)<X.U16(G+6)){if(sName="Adam Bienias's Slight Atari Player chiptune (.SAP)",bDetected=1,X.isVerbose()){if(bad=!1,dt=p=E="",tp="",tm="",5<(taghunk=X.SA(5,G)).length)for(tags=taghunk.split("\r\n"),Y=0;Y<tags.length;Y++)switch(tagdiv=tags[Y].indexOf(" "),tagl=tags[Y].substr(0,tagdiv),tagr=tags[Y].substr(tagdiv+1,tags[Y].length),tagl){case"NAME":'"<?>"'!=tagr&&(E=tagr.substr(1,tagr.length-2))
break
case"AUTHOR":'"<?>"'!=tagr&&(p=tagr.substr(1,tagr.length-2))
break
case"DATE":'"<?>"'!=tagr&&(dt=tagr.substr(1,tagr.length-2))
break
case"TYPE":sVersion="t."+tagr
break
case"TIME":tm=tagr}bad&&(sVersion+="/malformed"),sOption(E),sOption(p,"by: "),sOption(dt,"'"),sOption(tm,"len: "),E=parseAtariBinary(G+2),sOption(E[1].length,"binblks:"),sOption(outSz(E[0]),"sz:")}}else if(X.c("'SC68 Music-file / (c) (BeN)jamin Gerard / SasHipA-Dev  '00'SC68'........'SCFN'")){if(sName="SC 68000 programmatic chiptune (.SC68)",bDetected=1,X.isVerbose()){for(hdrl=X.SA(0,256).length+1,G=hdrl,cp=p=E="",x="",df=-1,k=0,ef=!1,mn=[];G<X.Sz();){switch(hkhd=X.SA(G,4),hksz=X.U32(G+4,_LE),G+=8,hkhd){case"SC68":hksz+hdrl!=X.Sz()&&(sVersion="malformed"),hksz=0
break
case"SCFN":E=X.SC(G,hksz,"CP1252")
break
case"SCDF":df=X.U32(G,_LE)+1
break
case"SCMN":mn.push(X.SC("CP1252",G,hksz)),""!=x&&df!=mn.length||(x=mn[mn.length-1])
break
case"SCAN":p=X.SC(G,hksz,"CP1252")
break
case"SCCN":cp=X.SC(G,hksz,"CP1252")
break
case"SCEF":ef=!0,G=X.Sz()}G+=hksz}sOptionT(E),1<mn.length&&sOption(mn.length,"×"),sOptionT(mn.join(";")),sOptionT(p,"by: "),sOptionT(cp,"(c)"),sOption(outSz(G),"sz:"),ef||(sVersion="malformed!short")}}else if(X.c("'shro'020000"))sName="Mario Paint's Shroom module (.SHO)",bDetected=1,X.isVerbose()&&(sOptionT(X.SA(7,32)),sOptionT(X.SA(39,32),"by: "))
else if(X.c("'PSID'")||X.c("'RSID'")){v1=X.SA(0,1),bDetected=1,sName="P"==v1?"PlaySID programmatic chiptune (.SID, .PSID)":"RealSID programmatic chiptune (.SID, .RSID)",v2=X.U16(4,_BE),sVersion="v"+Hex(v2),bad="",k=X.U16(14,_BE),isWithin(k,1,256)?1<k&&sOption(k,"×"):bad=bad.addIfNone("!badsubsongs"),(startSong=X.U16(16,_BE))>k&&(bad=bad.addIfNone("!badstartsong")),dataOfs=X.U16(6,_BE),(1==v2&&118!=dataOfs||2==v2&&124!=dataOfs)&&(bad=bad.addIfNone("!baddatap")),loadAddr=X.U16(8,_BE),"R"==v1&&isWithin(loadAddr,1,2023)&&(bad=bad.addIfNone("!badloadp")),initAddr=X.U16(10,_BE),"R"!=v1||isWithinRanges(initAddr,[[2024,40959],[49152,53247]])||(bad=bad.addIfNone("!badinitp")),flags=X.U16(118,_BE),"R"==v1&&flags>>1&1&&0<initAddr&&(bad=bad.addIfNone("!badinitp2")),sidn=1,78==v2?sidn+=dataOfs-124>>1:(!(3<=v2)||1&(a2=X.U8(122))||isWithinRanges(a2,[[0,65],[128,223]])||sidn++,!(4<=v2)||1&(a3=X.U8(123))||a2==a3||isWithinRanges(a3,[[0,65],[128,223]])||sidn++)
var R=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
switch(flags>>4&3){case 1:R[0]=1
break
case 2:R[0]=2
break
case 3:R[0]=3}if(3<=v2)switch(flags>>6&3){case 1:R[1]=1
break
case 2:R[1]=2
break
case 3:R[1]=3
break
default:R[1]=R[0]}if(78==v2)for(Y=2,q=124;Y<sidn;Y++,q+=2)switch(X.U16(q,_BE)>>4&3){case 1:R[Y]=1
break
case 2:R[Y]=2
break
case 3:R[Y]=3
break
default:R[Y]=R[0]}else if(4<=v2)switch(flags>>8&3){case 1:R[2]=1
break
case 2:R[2]=2
break
case 3:R[2]=3
break
default:R[2]=R[0]}for(1<sidn&&(sVersion+="/"+sidn+"SID"),sidtt=[0,0,0,0],Y=0;Y<sidn;Y++)sidtt[R[Y]]++
for(Y=0;Y<4;Y++)sidtt[Y]&&(sVersion+=" #"+["unk","6581","8580","6581&8580"][Y]+(1<sidtt[Y]?"×"+sidtt[Y]:""))
switch((12&flags)>>2){case 1:sVersion+="/PAL"
break
case 2:sVersion+="/NTSC"
break
case 3:sVersion+="/PAL&NTSC"}0<bad&&(sVersion+="/malformed"+bad),X.isVerbose()&&("<?>"==(E=X.SC(22,32,"CP1252"))&&(E=""),sOptionT(E),"<?>"==(p=X.SC(54,32,"CP1252"))&&(p=""),sOptionT(p,"by: "),"<?>"==(l=X.SC(86,32,"CP1252"))&&(l=""),sOptionT(l))}else if(X.c("00 FF00FF00 9100FF00 FF008000 92..00967F 01",7)&&X.c("9908",5442))sName="Tony 'Nissimo' Willams' Sound Images module (.SIG)",sVersion="gen.2",bDetected=1
else if(X.c("0100FEFF09000000'ALIM3'"))sName="Ruben Ramos 'baktery' Salvador's Skale Tracker module (.SKM)",bDetected=1,X.isVerbose()&&sOptionT(X.SA(25))
else if(X.c("'<track'")&&0<X.fStr(6,256,"rowhighliohtingminor="))sName="Benjamin 'BeRo' Rousseaux's Picatune module v1 (.SMUFI) or v2 (.PT2)",bDetected=1,X.isVerbose()&&(s=X.SC(0,256,"UTF8"),null!=(E=/.*name="([^"]*)".*/.exec(s))&&sOptionT(E[1]),null!=(p=/.*author="([^"]*)".*/.exec(s))&&sOptionT(p[1],"by: "),spd=/.*speed="([^"]*)".*/.exec(s),bpm=/.*bpm="([^"]*)".*/.exec(s),null!=spd&&(sVersion+=" spd: "+spd[1]),null!=bpm)&&(sVersion+=" bpm: "+bpm[1])
else if(X.c("'SNGs'")&&16<X.Sz()&&X.U8(10)<=X.U8(7)&&X.U8(11)<=30&&isWithin(X.U8(12),0,120)&&isWithin(X.U8(13),1,30)&&isWithin(X.U8(14),1,30))sName="BlueMoon's Sound Club for DOS module (.SN)",bDetected=1,(ord=X.U8(7))||(sVersion="malformed!0ord"),X.isVerbose()&&(sOptionT(X.SA(15,26)),lp=X.U8(10),gvol=5*X.U8(11),tx=X.U8(12),tpb=X.U8(13),bpms=X.U8(14),sOption("rhythm:"+tpb+"/"+bpms+" ord:"+X.U8(7)+" ins:"+X.U8(4)+" gvol:"+gvol+"%"))
else if(X.c("'SN2'")&&isWithin(X.U32(19),0,120)&&isWithin(X.U32(23),1,30)&&isWithin(X.U32(27),1,30)&&X.c("'NAM'",31)&&X.c("'SEQ'",38+X.U32(34))){if(sName="Bluemoon's Sound Club for Windows module (.SN2)",bDetected=1,X.isVerbose()){for(sOptionT(addEllipsis(X.SA(38,X.U32(34)))),K=X.U32(3)+7,lp=X.U32(15),tx=X.U32(19),tpb=X.U32(23),bpms=X.U32(27),tempop=Math.round(200-tx*(4.27246-tx*(.0603477+tx*(1.33871*tx/1e6-453202e-9)))),G=38+X.U32(34),ord=ptn=ins=0,end=!1;!end&&G<X.Sz();){switch(hkhd=X.SA(G,3),hksz=X.U32(G+3),G+=7,hkhd){case"PAT":ptn++
break
case"SEQ":ord=Util.divu64(hksz,4)
break
case"INS":ins++}G+=hksz}sOption("rhythm:"+tpb+"/"+bpms+" tempo: "+tempop+"% ord:"+ord+(lp?" lp:"+lp:"")+" ptn:"+ptn+" ins:"+ins+" sz:"+outSz(K))}}else if(X.c("'SNDH'",12)&&(X.isHeuristicScan()||X.c("6000............6000"))){if(sName="Atari ST Sound Header module (.SND,.SNDH)",sVersion="uncompressed",bDetected=1,X.isVerbose()){for(G=16,F=_=yr="",totaltime=Y=0,k=1;Y<10&&G<X.Sz();){if("TIME"===(E=X.SA(G,4))){for(c=0;c<k;c++)totaltime+=X.U16(G+4+2*c,_BE)
tlen=4+2*k-1,(G+tlen+1)%2&&tlen++}else E=X.SA(G,Math.min(X.Sz()-G),256),tlen=E.length
if(4<=tlen)switch(hd=E.substr(0,4),tag=E.substr(4,tlen),hd){case"TITL":"Unknown"!=tag.substr(0,7)&&(F=tag)
break
case"COMM":"Unknown"!=tag.substr(0,7)&&(_=tag)
break
case"YEAR":yr=tag
break
case"HDNS":Y=8
break
default:/##\d\d/.test(hd)?k=hd.slice(2,4):/#!\d\d/.test(hd)&&(G+tlen+1)%1&&tlen++}G+=tlen+1,Y++}sOptionT(F),"01"<k&&sOption(k,"×"),sOptionT(_,"by: "),sOptionT(yr,"'"),totaltime&&sOption(secondsToTimeStr(totaltime,"time:"))}}else if(X.c("'FMC!'"))sName="Lasse 'Faust' Öörni's Faust Music Creator module (.SNG)",bDetected=1,X.isVerbose()&&sOptionT(X.SA(4,20))
else if(/GTS[25!]/.test(X.SA(0,4))&&X.U8(100)<=32){for(sName="Lasse 'Faust' Öörni's GoatTracker module (.SNG)",bDetected=1,(nV=X.U8(3)-48)<0&&(nV=1),sVersion=2<=nV?"v2."+nV:"v1.x",k=X.U8(100),G=101,ords=[],ptn=mptn=0,bad="",ordc=0;G<X.Sz()&&(q=X.U8(G),X.c("FF",G+q));){for(Y=0,G++;Y<q;Y++)(E=X.U8(G++))<=207&&E+1>mptn&&(mptn=E+1)
ordc++,ords.push(q),G++}for(ch=3,ordc==6*k?(sVersion+=" stereo",ch=6):ordc!=3*k&&(bad=bad.addIfNone("!badordcnt")),bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),ins=2<=nV?X.U8(G++):31,inss=[],Y=0;Y<ins;Y++)(E=X.SC(G+(1<nV?9:8),16,"CP1250").trim()).length&&inss.push(E),1<nV?G+=25:G+=24+2*(X.U8(G+7)>>1)
for(Y=0;Y<(1==nV?0:2==nV?3:4);Y++)G+=1+2*X.U8(G)
for(ptn=X.U8(G++),Y=0;Y<ptn;Y++)G+=1+(1==nV?1:4)*X.U8(G)
if(1==nV&&X.Sz()!=G&&(G+=256),X.isVerbose()){for(sOptionT(X.SC(4,32,"CP1250")),1<k&&sOption(k,"×"),sOptionT(X.SC(36,32,"CP1250"),"by: "),sOptionT(X.SC(68,32,"CP1250")),sOptionT(addEllipsis(inss.join(", "),160),'ins/msg:"','"'),Y=0,ordc=[];Y<ords.length/ch;Y++){for(l=c=0;c<ch;c++)l+=ords[Y*ch+c]
ordc.push(l)}sOption("ch:"+ch+" ord:"+ordc.join("+")+" ptn:"+(ptn==mptn?mptn:"/"+ptn)+" ins:"+ins+" sz:"+outSz(G))}}else if(X.c("'ObsM'"))sName="Jonne Valtonen's SNG Player module (.SNG)",bDetected=1,X.U8(11)&&(sVersion+="compressed"),(len=X.U16(4,_LE))>X.Sz()&&(sVersion+="malformed"),X.isVerbose()&&(start=X.U16(6,_LE),loop=X.U16(8,_LE),delay=X.U16(10,_LE),sOption("len:"+Hex(len)+" start:"+Hex(start)+" loop:"+Hex(loop)+" delay:"+delay))
else if(X.c("'RJP'3.'SMOD'"))sName="Richard Joseph's module (.SNG)",bDetected=1,sVersion="v"+X.SA(3,1)
else if(X.c("'SYNC'")||X.c("'SYNB'"))sName="Synder SNG-player module (.SNG)",bDetected=1,sVersion="ver."+X.SA(3,1),X.isVerbose()&&sOption(X.SA(16,512))
else if(X.c("'SYND'....'S0'"))sName="Synder Tracker module (.SNG)",bDetected=1,sVersion="ver."+X.SA(3,1)
else if(X.c("'SYND'")||X.c("'SYNF'")||X.c("'SYNH'"))sName="Synder SNG-player Stereo module (.SNG)",bDetected=1,sVersion="ver."+X.SA(3,1),X.isVerbose()&&sOption(X.SA(16,512))
else if(isWithin(E=(X.U8(0)+1<<4)+(X.U8(1)+1<<7)+869,870,X.Sz())&&(/df\d:/.test(X.SA(E,4))||/[sS]amples/.test(X.SA(E,7)))){if(sName="AJ [Activas]'s ZoundMonitor module (.SNG + Samples/)",bDetected=1,X.isVerbose()){for(ptn=X.U8(1)+1,ord=X.U8(3)+1,spd=X.U8(4),G=5,smp=0;G<815;G+=54)X.U8(G+4)&&smp++
sOption("spd:"+spd+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" len "+secondsToTimeStr(1+Util.divu64(spd*ord*32,50))+" sz:"+outSz(E+101))}}else if(X.c("'RJP'3. 0000 0000"))sName="Richard Joseph's module instruments (.INS)",bDetected=1,sVersion="v"+X.SA(3,1)
else if(X.c("'SNES-SPC700 Sound File Data'")){if(sName="Nintendo SNES SPC chiptune (.SPC)",bDetected=1,sVersion="v0."+X.U8(36),X.isVerbose()){if(id666inhdr=26==X.U8(35),g=l=p=E="",dumper="",emu="",preferBin=!1,id666inhdr){switch(E=X.SA(46,32),g=X.SA(78,32),dumper=X.SA(110,16),dumpdate=X.SA(158,11),48<=(emu=X.U8(210))&&emu<=57&&(emu-=48),emu){case 1:emu="ZSNES"
break
case 2:emu="Snes9x"
break
case 3:emu="ZST2SPC"
break
case 4:emu="ETC"
break
case 5:emu="SNEShout"
break
case 6:emu="ZSNESW"
break
default:emu=""}l=X.SA(126,32),slen=X.SA(169,3),lp=X.SA(172,4),(slen+lp+dumpdate).length<5?(chnDis=X.U8(209),bin=1==chnDis&&""==emu||preferBin):p=/[0-9/]*/.test(slen+lp+dumpdate)?(songlen=Number(slen),X.SA(177,32)):(bin=!0,songlen=X.U8(169)<<16+X.U8(170)<<8+X.U8(171),X.SA(176,32))}else E=X.SA(48,20)
sOption(E),sOption(g,"for: "),sOption(p,"by: "),sOption(l),""!=emu&&(sVersion+=" "+emu)}}else if(X.c("'STK1.0SONG'")&&0<=[1,2,3].indexOf(X.U8(52))&&X.U8(53)<=X.U8(58)&&X.U8(54)<=X.U8(53)&&X.U8(56)<=63&&X.U8(57)<=5){switch(sName="Julien 'Targhan' Nevo's STarKos module (.SKS)",bDetected=1,bad="",X.U8(57)){case 0:hz=13
break
case 1:hz=25
break
case 2:hz=50
break
case 3:hz=100
break
case 4:hz=150
break
case 5:hz=300
break
default:hz=0,bad=bad.addIfNone("!badRepFreq")}for("-"!=(xpos=X.I8(55).toString())[0]&&(xpos="+"+xpos),spd0=X.U8(56),ord=1+X.U16(58),ptn=-1,rows=ptnxpos=0,G=60,Y=0;Y<4*ord;Y++)Y%4==3?rows+=X.U8(G)+1:(E=X.U8(G),ptn<E&&(ptn=E),X.I8(G+1)>>1&&ptnxpos++),G+=2
ptn++,insns=[]
for(ins=0;G<X.Sz()&&ins<256&&(insn=X.U16(G),G+=2,65535!=insn);ins++)if(ip=G,isz=X.U16(ip),G+=4,iend=1+X.U8(G+2),G+=5,iname=X.SA(G,8).trim(),G+=8,""!=iname&&insns.push(iname),X.isDeepScan()){for(j=0;j<iend;j++)if(k=X.U8(G++))if(128&k)y=X.U8(G++),8&k&&G++,64&y&&G++,2&k&&G++,4&k&&(G+=2),16&k&&(G+=2),32&k&&(G+=2)
else{if(16&k&&64&(y=X.U8(G++))&&(G+=2,96&k)){bad=bad.addIfNone("!badinsflags"),ins=j=65534
break}32&k&&G++,64&k&&(G+=2)}}else G=ip+isz
for(sptn=0;G<X.Sz()&&(curptn=X.U16(G),G+=2,65535!=curptn);sptn++)G+=X.U8(G)
if(X.isDeepScan()&&(notecnt=0),G<X.Sz()&&ins<65534)for(Y=0;Y<=ptn;Y++){if(curptn=X.U16(G),G+=2,255!=curptn&&65535!=curptn&&512<curptn){bad=bad.addIfNone("!badnptn")
break}if(65535==curptn)break
if(pp=G,psz=X.U16(pp),X.isDeepScan()){G+=2
pins=-1
for(var W=0;G<Math.min(X.Sz(),pp+psz);){var H=pfvol=pfpitch=!1
if(255==(k=X.U8(G++)))break
if(128&k)W+=127&k
else if(96<=k)switch(15&k){case 0:if(pfvol=!0,pfpitch=!1,15-X.U8(G++)<0){bad=bad.addIfNone("!badptnvol0"),Y=ptn,G=pp+psz
break}case 1:pfvol=!1,pfpitch=!0,X.U8(G++)
break
case 2:pfvol=pfpitch=!0,15-X.U8(G++)<0&&(bad=bad.addIfNone("!badptnvol2"),Y=ptn,G=pp+psz),X.U8(G++)
break
case 3:H=!0,pnote="rst"
break
case 4:H=!0,pnote="spl",pins=X.U8(G++)}else H=!0,y=X.U8(G++),(pfvol=!(64&y))&&y,!(pins<0)&&32&y||(pins=X.U8(G++)),(pfpitch=16&y)&&X.I8(G++)
H&&notecnt++,W++}}else G=pp+psz}""!=(bad=G>X.Sz()?bad.addIfNone("!short"):bad)&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()&&(sOptionT(X.SA(20,32)),sOptionT(X.SA(10,10),"by: "),sOption("spd0:"+spd0+("+0"!=xpos?" xpos:"+xpos:"")+" ord:"+ord+" ptn:"+ptn+"+"+sptn+" ins:"+ins+(ptnxpos?" ptn.xpos:"+ptnxpos:"")+" smp.ch:"+X.U8(52)+" rep.freq:"+hz+"Hz loop:"+(X.U8(54)?Hex(X.U8(54))+"-":"")+Hex(X.U8(53))+(X.isDeepScan()?" notes:"+notecnt:" rows:"+rows)+" sz:"+G))}else if(!X.U8(0)&&X.c("'SK10'",128)&&0<=[1,2,3].indexOf(X.U8(134))&&0<=[13,25,50,100,150,300].indexOf(X.U16(135))&&X.U16(24)==X.U16(64)){for(sName="STarKos module (.BIN)",sVersion="compiled/ofs:80h",bDetected=1,crc=0,Y=0;Y<67;Y++)crc+=X.U8(Y);(crc&=65535)!=X.U16(67)&&(sVersion+="/malformed!badCRC"),X.isVerbose()&&(sOption(X.SA(1,8).trim()+"."+X.SA(9,3).trim()),sOption(X.U16(135)+"Hz"),sOption(Hex(X.U16(132)),"base:"),sOption(outSz(X.U24(64)+188),"sz:"))}else X.c("'Nu!SOPROL!'",34)&&(sName="Holger Gehrmann's Sound Programming Language/SOPROL module (.SPL)",bDetected=1,X.isVerbose())&&(E=X.SA(88,256),p=X.SA(88+E.length+1,256),l=X.SA(88+E.length+p.length+2,256),sOptionT(E),sOptionT(p,"by: "),sOptionT(l))
if(/SPM[\x01-\x02]/.test(X.SA(0,4))&&(sName="Emmanuel Marty & Michael Lavaire's Stonetracker module (.SPM)",sVersion="v"+X.U8(3),bDetected=1,X.isVerbose())&&sOptionT(decAnsi(4,32,CPAmiga)),/SPS[\x01-\x02]{2}/.test(X.SA(0,5))&&X.c("'psn'",6+32*(smp=X.U8(5)))){if(sName="Emmanuel Marty & Michael Lavaire's Stonetracker sample bank (.SPS)",sVersion="v"+X.U8(3),bDetected=1,X.isVerbose()){for(Y=smpsz=0,smps=[];Y<smp;Y++)(E=decAnsi(32*Y+6,8,CPAmiga).trim()).length&&smps.push(E)
sOption(addEllipsis(smps.join(" ")),'smp/msg:"','"'),sOption("smp:"+smp)}}else if(X.c("'SPU'00")||X.c("'SPU1'")||-1<X.fSig(X.Sz()-6,TOEOF,"1D80FF"))bDetected=1,sName="Eternal SPU chiptune (.SPU)",sVersion=X.c("'SPU'")?X.U8(3)?"v1":"v0":"headerless",X.isVerbose()&&"headerless"!=sVersion&&(game=X.SC(4,64,"Shift_JIS"),F=X.SC(68,64,"Shift_JIS"),sOptionT(F),sOptionT(game,"game: "),_=X.SC(132,32,"Shift_JIS"),sOptionT(_,"by: "),cmt=X.SC(164,3840,"Shift_JIS"),sOptionT(cmt))
else if(X.c("'SPEEDY-SYSTEM'"))bDetected=1,sName="Speedy System module (.SS)",sVersion="v1"
else if(X.c("'ZXAYST11'"))sName="Sound Tracker module (.ST1, .ST11)",bDetected=1,sVersion="v1.1/uncompiled",X.isVerbose()&&(t_=X.U8(23),"Some SoundTracker Song"!=(E=X.SA(24,t_-1).trim()))&&sOption(E)
else if(X.c("'STP3'"))sName="Soundtracker Pro II module (.STP)",bDetected=1
else if(X.c("48E7FFFE 4DFA.... 4A2E")&&isWithin(X.I8(6),-1,6)&&0<=[97,102].indexOf(X.U8(12)))sName="SUNtronic module (.SUN)",bDetected=1
else if(X.c("'SVOX'00000000")){if(sName="SunVox module (.SUNVOX)",bDetected=1,X.isVerbose()){for(G=8,E="",bpm=0,spd=0,tme=0,ptn=0,blk=0;G<X.Sz()&&(hkhd=X.SA(G,4),!(charStat(hkhd).indexOf("allasc")<0));){switch(hksz=X.U32(G+4,_LE),G+=8,hkhd){case"VERS":for(nV=X.U32(G,_LE),aV=[],Y=0;Y<4;Y++)aV[3-Y]=nV>>8*Y&255
sVersion+="v"+aV.join(".")
break
case"BVER":if((nB=X.U32(G,_LE))!=nV){for(aV=[],Y=0;Y<4;Y++)aV[3-Y]=nB>>8*Y&255
sVersion+="/v"+aV.join(".")}break
case"NAME":E=X.SA(G,hksz)
break
case"BPM ":bpm=X.U32(G,_LE)
break
case"SPED":spd=X.U32(G,_LE)
break
case"TIME":tme=X.U32(G,_LE)
break
case"SNAM":blk++
break
case"PDTA":ptn++}G+=hksz}sOptionT(E),0<bpm&&sOption(bpm,"bpm:"),0<spd&&sOption(spd,"spd:"),0<tme&&sOption(tme,"len:"),0<ptn&&sOption(ptn,"ptn:"),0<blk&&sOption(blk,"blk:"),sOption(outSz(G),"sz:")}}else if(X.c("'SymM'")){if(sName="Patrick Meng's Symphonie module (.SYMMOD)",bDetected=1,sVersion="v"+X.U32(4,_BE),X.isVerbose()){for(F="",bpm="?",done=!(G=8),ch=0,len=0,extsmp=!1,pro=!1;G<X.Sz()&&(hkhd=X.I32(G,_BE),hkhx=Hex(X.U32(G,_BE)),hksz=4,!(done||charStat(hkhd).indexOf("allasc")<0));){switch(G+=4,hkhd){case-16:if(pklen=X.U32(G,_BE),hksz+=pklen,o=4,10<=pklen&&X.c(G+o,"'PACK'FFFF")){if(!X.isDeepScan()){G=0
break}for(o+=6,unplen=X.U32(G+o,_BE),o+=4,(maxlen=pklen-10)<=25264513.5?maxlen*=170:maxlen=4294967295,unplen>maxlen&&(unplen=maxlen),done=!1,ofs=0,left=unplen;!done&&o<hksz;)switch(tp=X.I8(G+o),o++,tp){case 0:j=X.U8(G+o),o++,left>=j?(E+=X.SA(G+o,j),o+=j,left-=j):done=!0
break
case 1:if(j=X.U8(G+o),o++,dw=X.SA(G+o,4),o+=4,left>=4*j&&o<pklen)for(left-=4*j;j--;)E+=dw
else done=!0
break
case 2:dw=X.SA(G+o,4),o+=4,left>=4*j&&o<pklen?(unp+=dw+dw,left-=8):done=!0
break
case 3:j=X.U8(G+o),o++,left>=j?left-=j:done=!0
break
case-1:done=!0
break
default:sVersion+="/malformed",done=!0}}else F=X.SC(G+o,hksz,"CP1252")
break
case-1:ch=X.I32(G,_BE)
break
case-2:1024<(len=X.I32(G,_BE))&&(len="malformed")
break
case-3:case-4:case-5:break
case-7:extsmp=!0
break
case 10:case 11:case 12:pro=!0
break
case-6:bpm=Math.round(1.24*Math.min(X.I32(G,_BE),800))
break
case-12:hksz=0
break
case-10:case-11:case-13:case-14:case-15:case-17:case-18:case-19:case-20:case-21:hksz+=X.I32(G,_BE)
break
default:_l2r("symmod",G,hkhd+"/"+hkhx+" ("+Hex(hksz,8)+"): ?!?!?!?!?!")}G+=hksz}sOption(F),sOption("ch:"+ch+" bpm:"+bpm+" len:"+len+(done?"sz:"+outSz(G):"")),extsmp&&sOption("extsmp"),pro&&(sVersion+="/Pro")}}else if(X.c("'Synth'")&&!X.c("'esi'",5))sName="C. 'Mr Soundwave' Herbst & B. MIkic/BrainTrace Design's Synthesis module (.SYN)",bDetected=1,X.c("'Synth'",7950)?(sVersion="v"+X.SA(7955,3),X.isVerbose()&&(sOptionT(X.SA(7986,27)),sOptionT(X.SA(8014,256)))):(sVersion="v"+X.SA(5,3),X.isVerbose()&&(sOptionT(X.SA(36,27)),sOptionT(X.SA(64,256))))
else if(X.c("'SYNTRACKER-SONG:'00"))sName="Bastian 'flink'/'twiCe' Spiegel's SynTracker module (.SYNMOD)",bDetected=1,X.isVerbose()&&(t1=X.SC(20,32,"CP1252"),sOptionT(t1,"title/inst: "),t2=X.SC(52,32,"CP1252"),sOptionT(t2),t3=X.SC(84,32,"CP1252"),sOptionT(t3))
else if(X.c("'T0AST'")){function a(){if(1==nV)G=474
else{if(2!=nV)return
G=842}if(drummode=X.U8(G++),chipmode=X.U8(G++),chs=X.U8(G++),ch=0,16<chs)sVersion+="/malformed"
else{for(Y=0;Y<16;Y++)X.U8(G++)&&(ch++,G+=3)
for(ins=0,Y=0;Y<16;Y++)X.U8(G++)&&(ins++,G+=25)
for(ord=X.U16(G,_LE),G+=2+ord,ptn=0,notes=0,U=0;U<=255;U++)if(X.U8(G++))for(ptn++,Y=0;Y<chs;Y++)for(c=0;c<64;)if(128&(b=X.U8(G++)))if(l=127&b)for(G++;l&&c<64;)notes++,c++,l--
else c++
else if(1&b&&G++,2&b&&G++,4&b&&G++,8&b&&G++,16&b&&G++,32&b&&G++,64&b)for(l=X.U8(G++);l&&c<64;)notes++,c++,l--
else notes++,c++
loop=X.U8(G++),t_=X.U32(G,_LE),G+=4,E=X.SC(G,t_,"CP1252"),G+=t_,a_=X.U32(G,_LE),G+=4,p=X.SC(G,a_,"CP1252"),G+=a_,c_=X.U32(G,_LE),G+=4,l=X.SC(G,c_,"CP1252"),G+=c_,sOption(E),sOption(addEllipsis(p,128),"by: "),sOption(addEllipsis(l,256),'msg:"','"'),sOption("ch:"+ch+" ins:"+ins+" ord:"+ord+" ptn:"+ptn+" notes:"+notes+" loop:"+loop+" sz:"+outSz(G))}}sName="Benjamin 'BeRo' Rousseaux's The 0ok Amazing Synth Tracker module (.T0AST)",bDetected=1,sVersion=X.c("'0OK'",5)?(nV=1,"v1"):X.c("010001",5)?(nV=2,"v2"):(nV=-1,"v.unk"),X.isVerbose()&&-1!=nV&&a()}else if(X.c("'T0ASTINS'"))sName="Benjamin 'BeRo' Rousseaux's The 0ok Amazing Synth Tracker instrument file",bDetected=1,X.isVerbose()&&sOption(outSz(33),"sz:")
else if(X.c("4EF900...... 4EF900...... 4EF900...... 4EF900...... 4EF900...... 4EF900...... 4EF900...... 4EF900")&&X.U32(44,_BE)-X.U32(2,_BE)==160||X.c("601A")&&(X.c("1010",28)||X.c("1012",28))&&0<(E=X.I32(34,_BE))&&E==X.I32(38,_BE)&&E==X.I32(42,_BE)&&E==X.I32(46,_BE))sName="Tim Follin & Mike D.'s Follin Player II module (.TF)",sVersion="f."+(78==X.U8(0)?"0":"1"),bDetected=1
else if(X.c("'TFMD'"))sName="Shiru's TFM Music Maker tune (.TFD)",bDetected=1,X.isVerbose()&&(G=4,E=X.SA(G,512),G=X.fSig(G,512,"00")+1,p=X.SA(G,512),G=X.fSig(G,512,"00")+1,l=X.SA(G,512),sOptionT(E),sOptionT(p,"by: "),sOptionT(l))
else if(X.c("'TFMfmtV2'")){if(sName="Shiru's TFM Music Maker module (.TFE)",bDetected=1,X.isVerbose()){for(k=[],tobuf=!(G=0),b=63,n=G=0,l=X.U8(G++);n<2244057&&G<X.Sz();)if(tobuf&&786<n&&(tobuf=!1),128!=l)b=l,n++,l=X.U8(G++),tobuf&&k.push(b)
else{for(l=X.U8(G++),next=!0,reps=shl=0;next&&shl<57&&G<X.Sz();)next=!(128&l),l&=127,reps|=Util.shlu64(l,shl),shl+=7,l=X.U8(G++)
if(reps){if(--reps,n+=reps,shl=0,tobuf)for(c=0;c<reps;c++)k.push(b)}else tobuf&&k.push(128),n++}for(G--,spd1=k[8],spd2=k[9],intlv=k[10],ord=(ord=k[11])||256,lp=k[12],d1=k[13]+(k[14]<<8),d2=k[15]+(k[16]<<8),saves=k[17]+(k[18]<<8),d1="20"+(127&d1).padStart(2,"0")+"-"+(1+(d1>>7&15)).padStart(2,"0")+"-"+(d1>>11&31).padStart(2,"0"),d2="20"+(127&d2).padStart(2,"0")+"-"+(1+(d2>>7&15)).padStart(2,"0")+"-"+(d2>>11&31).padStart(2,"0"),auth=decEncoding(k.slice(19,82),CP1251),F=decEncoding(k.slice(83,148),CP1251),cmt=decEncoding(k.slice(147,532),CP1251),Y=ptn=0;Y<ord;Y++)k[Y+531]+1>ptn&&(ptn=k[Y+531]+1);(K=2244057==n?G:-1)<0&&(sVersion=sVersion.appendS("malformed:"+Hex(n),"/")),sOptionT(F),sOptionT(auth,"by: "),sOptionT(cmt),sOption("on: "+d1+(d1!=d2?" to "+d2:"")),sOption("spd:"+spd1+"/"+spd2+" ord:"+(lp?lp+"-":"")+ord+" ptn:"+ptn+" intlv:"+intlv+" saves:"+saves+(X.isDeepScan()?" sz:"+outSz(K):""))}}else if(902<=X.Sz()&&isWithin(X.U8(37),1,4)&&0<(bin=parseAtariBinary())[0]&&X.c("0E158D",6)&&X.c("8D150E",26)&&X.U16(29)==bin[1][0][1]&&(X.c("'TMC SONG FILE 2.0'",9)||X.c("D4CDC3A0 D3CFCEC7A0 C6C9CCC5A0 B2AEB0",9))){for(sName="Marcin 'Jaskier' Lewandowski's Theta Music Composer (.TM2)",sVersion="v2.0",bDetected=1,bad="",ins=0,p0=65536,G=134;G<262&&!((E=(X.U8(G+640)<<8|X.U8(G))-X.U16(2)+6)<0);G++)0<E&&(isWithin(E,896,bin[1][0][1]+6)?(p0>E&&(p0=E),255!=X.U8(E)&&ins++):bad=bad.addIfNone("!badinsp"))
for(ptn=0,G=262;G<518&&!((E=(X.U8(G+256)<<8|X.U8(G))-X.U16(2)+6)<0);G++)0<E&&(isWithin(E,896,bin[1][0][1])?(p0>E&&(p0=E),255!=X.U8(E)&&ptn++):bad=bad.addIfNone("!badptnp"))
for(ord=(p0-902)/17,G=902,pt=-1;G<p0;G+=17){for(q=G+1;q<G+17;q+=2)X.U8(q)>=pt&&(pt=X.U8(q)+1)
if(isWithin(X.U8(G+16),65,127)&&(bad=bad.addIfNone("!badord")),X.I8(G+16)<=0)break}if(bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose()){for(G=38,E="";G<134;G+=32)E=E.appendS(decAnsi(G,32,CPATASCII,0,Chars0to1FATASCII).trim()," | ")
sOption(E),E=(E=X.U8(31))?isWithin(E,1,63)?"stereo":isWithin(E,64,127)?"RMT stereo":"quadro":"mono",sOption("ch:"+E+" spd0:"+X.U8(36)+" ticks:"+X.U8(37)+" ord:"+ord+" ptn:"+ptn+(pt!=ptn?"/"+pt:"")+" ins:"+ins+" sz:"+outSz(bin[0]))}}else if(X.c("0000050F0000050F0000050F0000050F0000050F0000050F0000050F0000050F0000050F0000050F0000050F0000050F",20)&&X.c("FFFF001000000030000000",385))sName="N.J. Luuring Jr.'s The Musical Enlightenment module (.TME)",bDetected=1
else if(12288<=X.Sz()&&X.c("'TRK01/TV.ES.'")){if(sName="Adam Davidson & Ramjet & Toxic Volume's RamTracker module (.TRK)",bDetected=1,X.isVerbose()){for(sOptionT(X.SC(15,32,"CP850")),sOptionT(X.SC(47,32,"CP850"),"by: "),G=1107,ptn=-1,ord=0;!(254<=(E=X.U8(G++))||G>X.Sz());)ord++,ptn<E&&(ptn=E)
ptn++,sOption("ord:"+ord+" ptn:"+ptn)}}else if(X.c("'S'8F'NG.'")&&/[BW][48]/.test(X.SA(5,2))&&0<(pp=X.fSig(8,128*(ch=X.U8(6)-48),"DD48"))&&!(pp%2)){if(sName="Unique Development/BladePacker's module (UDS.+SMP.)",bDetected=1,X.isVerbose()){for(ptn=mptn=0,maxp=Math.min(X.Sz(),65536),bw="B"==X.SA(5,1)?1:2,ord=pp-8>>bw+1,G=8;G<pp;G++)(E=X.U8(G)+1)>mptn&&(mptn=E)
if(G+=2,E=0,1==bw)for(;55537!=X.U16(G,_BE)&&G<maxp;)(q=X.U8(G++))>E&&(E=q),(q=X.U8(G++))>E&&(E=q)
else for(;55537!=(q=X.U16(G,_BE))&&G<maxp;G+=2)q>E&&(E=q)
ptnp=G,ptn=G-pp-2>>bw+5,K=G+=2+(E+1<<2),G=o=k=0,a2=pp+2
s:for(;G<maxp&&(G=8+o*ch)!=pp;){a0ch=a0=G+ch,o++
e:for(;G<maxp;)for(a0=pp+2+(X.U8(G++)<<bw+5),d6=64;d6&&G<maxp;){if(1==bw?d1=X.U8(a0++):(d1=X.U16(a0,_BE),a0+=2),d1<<=2,0<=[44,32].indexOf(X.U8(ptnp+4+d1))){k++
continue s}if(!--d6){if(G!=a0ch)continue e
continue s}}}1<(k=k||1)&&sOption(k,"×"),sOption("ch:"+ch+" ord:"+ord+" ptn:"+(mptn==ptn?"":mptn+"/")+ptn+" sz:"+outSz(K))}}else if(307<X.Sz()&&X.c("'MAS_UTrack_V00'")&&isWithin(X.U8(14),49,52)&&X.Sz()>32*X.U8(47)+80){for(sName="Marc 'MAS' Schallehn's UltraTracker module (.ULT)",bDetected=1,nV=X.U8(14)-48,sVersion="v"+["<1.4","1.4","1.5","1.6"][nV-1],bad="",msgn=X.U8(47),G=48+32*msgn,smp=X.U8(G++),smpsz=0,smps=[],Y=0;Y<smp;Y++)""!=(E=X.SC(G,32,"CP437").trim())&&smps.push(E),(A=X.U32(G+56)-X.U32(G+52))<0?bad=bad.addIfNone("!badsmpsz"):smpsz+=(4&X.U8(G+61)?2:1)*A,4<=nV?G+=66:G+=64
for(Y=ord=mp=0;Y<256;Y++)(o=X.U8(G++))<254&&(ord++,mp<o)&&(mp=o)
for(ch=X.U8(G++)+1,ptn=X.U8(G++)+1,mp++,G+=ch,l=notes=0;l<ch;l++)for(E=0;E<ptn&&G<X.Sz();E++)for(row=0;row<64&&(rp=1,252==(b=X.U8(G++))&&(rp=X.U8(G++),b=X.U8(G++)),note=isWithin(b,1,96),G+=4,rp=64<rp+row?64-row:rp);)row+=rp,note&&(notes+=rp)
if(G>X.Sz()&&(bad=bad.addIfNone("!short")),K=G+smpsz,""!=bad&&(sVersion=sVersion.appendS("/malformed"+bad,"/")),X.isVerbose()){for(sOptionT(X.SC(15,32,"CP437")),specialmsg=23==msgn&&297221==K&&7==ch&&20==ord&&29==ptn&&17==smp&&1572==notes,G=48,Y=0,r=[];Y<msgn;Y++)E=decAnsi(G,32,CP437,Chars0to1F),""!=(E=specialmsg?E:E.trim())&&r.push(E),G+=32
r=addEllipsis(r.join(specialmsg?"\n":" "),specialmsg?8192:192,specialmsg?8192:160),sOption(r,"msg:"+(specialmsg?"\n":'"'),specialmsg?"\n":'"'),r.length||sOption(addEllipsis(smps.join(","),128,96),'smp/msg:"','"'),sOption("ch:"+ch+" ord:"+ord+" ptn:"+mp+(ptn!=mp?"/"+ptn:"")+" smp:"+smp+" notes:"+notes+" sz:"+outSz(K))}}else if(X.c("'VGEfmtV'")&&isWithin(nV=X.U8(7)-48,1,3)){if(sName="Shiru's VGM Music Maker module (.VGE)",bDetected=1,sVersion="v"+nV,ord=-1,X.isVerbose()){if(ptn=1,n=next=G=0,tobuf=!0,k=[],1<nV)for(l=X.U8(G++);n<7231953&&G<X.Sz();)if(tobuf&&807<n&&(tobuf=!1),128!=l)b=l,n++,l=X.U8(G++),tobuf&&k.push(b)
else if(l=X.U8(G++),1!=nV||l){for(next=!0,reps=shl=0;next&&shl<57&&G<=X.Sz();)next=!(128&l),l&=127,reps|=Util.shlu64(l,shl),shl+=7,l=X.U8(G++)
if(reps){if(reps--,n+=reps,shl=0,tobuf)for(Y=0;Y<reps;Y++)k.push(b)}else tobuf&&k.push(128),n++}else k.push(128),n++,l=X.U8(G++)
else G=1
switch(G--,nV){case 2:spd1=k[16],spd2=k[17],intlv=k[18],d1=k[20]+(k[21]<<8),d2=k[22]+(k[23]<<8),saves=k[24]+(k[25]<<8),ord=k[27],lp=k[28]
break
case 3:spd1=k[26],spd2=k[27],intlv=k[28],ord=k[37],lp=k[38],d1=k[31]+(k[32]<<8),d2=k[33]+(k[34]<<8),saves=k[35]+(k[36]<<8)}if(1!=nV){if(1<ord)for(Y=0;Y<255;Y++)(E=k[551+Y])+1>ptn&&(ptn=E+1)
d1="20"+(127&d1).padStart(2,"0")+"-"+(1+(d1>>7&15)).padStart(2,"0")+"-"+(d1>>11&31).padStart(2,"0"),d2="20"+(127&d2).padStart(2,"0")+"-"+(1+(d2>>7&15)).padStart(2,"0")+"-"+(d2>>11&31).padStart(2,"0")}else d1=d2=spd1=spd2=intlv=saves="?",lp=0
auth=decEncoding(k.slice(39,103),CP1251),F=decEncoding(k.slice(103,167),CP1251),cmt=decEncoding(k.slice(167,551),CP1251),K=7231953==n?G:-1,sOptionT(F),sOptionT(auth,"by: "),sOptionT(cmt),sOption("on: "+d1+(d1!=d2?" to "+d2:"")),sOption("spd:"+spd1+"/"+spd2+" ord:"+(lp?lp+"-":"")+ord+" ptn:"+ptn+" intlv:"+intlv+" saves:"+saves+" sz:"+outSz(K))}}else if(X.c("'Vgm '")&&X.Sz()>=(eof=X.U32(4)+4)&&(nV=X.U32(8))&&nV<768&&(!X.U32(20)||X.c("'Gd3 '",X.U32(20)+20))){if(bDetected=1,bad="",nV=1e3*(nV>>12)+100*(nV>>8&15)+10*(nV>>4&15)+(15&nV),sName="Video Game Music chiptune stream (.VGM)",eoh=X.U32(52)+52,(nV<150||52==eoh)&&(eoh=64),150<=nV&&eoh<64&&(bad="!dataofs"),sVersion="v"+(nV/100).toFixed(2),X.isVerbose()){if(tags=[],20<(gd3p=X.U32(20,_LE)+20)&&"Gd3 "===X.SA(gd3p,4)){for(sVersion+="/Gd3 v"+X.readBytes(gd3p+4,4).join("")/100,taglen=X.U32(gd3p+8,_LE),(gd3p+=12)+taglen>X.Sz()&&(bad=bad.addIfNone("!tagsz")),Y=0;Y<11&&gd3p<=X.Sz();)0<=(tpos=X.fSig(gd3p,TOEOF,"0000"))?(tags[Y]=X.SU16(gd3p,taglen),gd3p+=2*tags[Y].length+2):(tags[Y]="",gd3p+=2),Y++
Y<11?bad=bad.addIfNone("!tagnum"):tagn=Math.max(0,Y-1),sOption(slashTag(tags[0],tags[1])),sOption(slashTag(tags[6],tags[7]),"by: "),sOption(slashTag(tags[2],tags[3]),"for: "),sOption(slashTag(tags[4],tags[5]),"on: "),sOption(tags[8],"date: "),sOption(tags[9],"ripper: "),sOption(tags[10],"notes: ")}for((smp=X.U32(24))||(bad=bad.addIfNone("!badlen")),lp=X.U32(28)+28,lpsmp=X.U32(32),(lp>=eof||lpsmp>smp)&&(lp=0,bad=bad.addIfNone("!badloop")),rate=X.U32(36),100<nV&&(rate?50==rate?rate+="Hz(PAL)":60==rate?rate+="Hz(NTSC)":rate+="Hz":rate="n/a"),chips=[[12,"SN76489",0],[16,"YM2413",0],[44,"YM2612",110],[48,"YM2151",110],[56,"SegaPCM",151],[64,"RF5C68",151],[68,"YM2203",151],[72,"YM2608",151],[76,"YM2610/B",151],[80,"YM3812",151],[84,"YM3526",151],[88,"Y8950",151],[92,"YMF262",151],[96,"YM278B",151],[100,"YMF271",151],[104,"YMZ280B",151],[108,"RF5C164",151],[112,"PWM",151],[116,"AY8910",151],[128,"GameBoyDMG",161],[132,"NES_APU",161],[136,"MultiPCM",161],[140,"uPD7759",161],[144,"OKIM6258",161],[152,"OKIM6295",161],[156,"K051649/K052539",161],[160,"K054539",161],[164,"HuC6280",161],[168,"C140",161],[172,"K053260",161],[176,"Pokey",161],[180,"QSound",161],[184,"SCSP",171],[192,"WonderSwan",171],[196,"VSU",171],[200,"SAA_1099",171],[204,"ES5503",171],[208,"ES5505/ES5506",171],[216,"X1-010",171],[220,"C352",171],[224,"GA20",171],[228,"Mikey/Atari_Lynx",172]],chipn=0,xhdr=0,170<=nV&&(E=X.U32(188),xhdr=E?E+188:xhdr)&&!(xhdsz=X.U32(xhdr))&&(xhdr=0,bad=bad.addIfNone("!badxhdr")),Y=0;Y<chips.length&&!(chips[Y][0]>=eoh||xhdr&&chips[Y][0]>xhdr);Y++)if(clk=X.U32(chips[Y][0]),b30=Util.shru64(clk,30),b31=b30>>1,b30&=1,clk&=1073741823,!(nV<chips[Y][2])&&clk){switch(chipn++,chip=chips[Y][1],chips[Y][0]){case 12:b30&&b31&&(chip="T6W28"),nV<=151&&!(4&X.U8(43))&&(chip+="/GGStereo")
break
case 16:nV<=101&&5e6<clk&&(chip="YM2612")
break
case 44:151<=nV&&b31&&(chip="YM3438"),nV<=101&&5e6<(clk1=1073741823&X.U32(16))&&(clk=clk1)
break
case 48:151<=nV&&b31&&(chip="YM2164"),nV<=101&&(clk1=1073741823&X.U32(16))<5e6&&(clk=clk1)
break
case 76:chip=b31?"YM2610B":"YM2610"
break
case 116:switch(X.U8(120)){case 0:break
case 1:chip="AY8912"
break
case 2:chip="AY8913"
break
case 3:chip="AY8930"
break
case 4:chip="AY8914"
break
case 16:chip="YM2149"
break
case 17:chip="YM3439"
break
case 18:chip="YMZ284"
break
case 19:chip="YMZ294"
break
default:chip+="-ish"}break
case 132:b31&&(chip+="/FDS")
break
case 144:8&X.U8(148)?chip+="12bit":chip+="10bit"
break
case 156:chip=b31?"K052539":"K051649"
break
case 168:switch(X.U8(150)){case 0:chip="C140+NamcoSystem2"
break
case 1:chip="C140+NamcoSystem21"
break
case 2:chip="219_ASIC+NamcoNA-1/2"
break
default:chip+="-ish"}break
case 204:chip+=":"+X.U8(212)+"ch"
break
case 208:chip=b31?"ES5506":"ES5505",chip+=":"+X.U8(213)+"ch"}sVersion=sVersion.appendS(chip,"#")}volmod=-1,124<eoh&&(192<(volmod=X.U8(124))&&(volmod-=256),volmod=100*(2^(volmod=-63==volmod?-64:volmod)/32),volmod=Math.round(volmod)+"%"),2<chipn&&(bad=bad.addIfNone("!toomanychips")),eof<X.Sz()&&("Vgm "==X.SA(eof,4)?sOption("multisong"):sOption("+extra data")),sOption("rate: "+rate+" len: "+secondsToTimeStr(Util.divu64(smp+22e3,44100))+(lp?" looped":"")+(-1!==volmod&&" 100%"!==volmod?" vol: "+volmod:"")+(xhdr?" xhdr":"")+" sz:"+outSz(eof))}""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/"))}else if(2242<X.Sz()&&X.c("0033'T1'")&&[1,2].includes(X.U8(4))&&X.U8(5)<=1&&X.U8(6)<=10&&!X.U16(7)&&X.U8(9)&&X.U8(12)<=X.U8(11)){if(sName="Daniel Kahlin's VIC-TRACKER module (.VT)",bDetected=1,X.isVerbose()){for(sOptionT(X.SA(414,16)),minst=4095,maxed=k=0,G=10;G<66;G+=4)X.U8(G+1)&&(minst=Math.min(minst,X.U8(G)),maxed=Math.max(maxed,X.U8(G+1)),k++)
for(ptn=0,G=962;G<1986;G++)ptn=Math.max(X.U8(G),ptn)
ptn++,1<k&&sOption(k,"×"),sOptionT(X.SA(430,16),"by: "),sOptionT(X.SA(446,16),"'"),sOption("ptn:"+ptn+" sz:"+outSz(2242+64*ptn))}}else if(-1<X.fSig(X.Sz()-32,TOEOF,"'VSS0'00"))sName="Tomas Partl's Voodoo Supreme Synthesizer audio (.VSS)",bDetected=1
else if(X.c("6000")&&X.c("48E7FFFE610000",4)&&X.c("4CDF7FFF'Nu'",12))sName="Wally Beben's module (.WB)",bDetected=1
else if(X.c("'WSRF'",X.Sz()-32)&&X.c("EA",X.Sz()-16)){if(sName="WonderSwan R programmatic chiptune (.WSR)",bDetected=1,G=X.Sz()-32,sVersion="v"+X.U8(G+4),X.isVerbose()){switch(sOption(Hex(X.U8(G+24)),"CartID:"),pub=X.U8(G+22)){case 0:sOption("(invalid publisher)")
break
case 1:sOption("Bandai")
break
case 2:sOption("Taito")
break
case 3:sOption("Tomy")
break
case 4:sOption("Koei")
break
case 5:sOption("Data East")
break
case 6:sOption("Asmik Ace")
break
case 7:sOption("Media Entertainment")
break
case 8:sOption("Nichibutsu")
break
case 10:sOption("Coconuts Japan")
break
case 11:sOption("Sammy")
break
case 12:sOption("Sunsoft")
break
case 13:sOption("Mebius")
break
case 14:sOption("Banpresto")
break
case 16:sOption("Jaleco")
break
case 17:sOption("Imagineer")
break
case 18:sOption("Konami")
break
case 22:sOption("Kobunsha")
break
case 23:sOption("Bottom Up")
break
case 24:sOption("Kaga Tech")
break
case 25:sOption("Sunrise")
break
case 26:sOption("Cyber Front")
break
case 27:sOption("Mega House")
break
case 29:sOption("Interbec")
break
case 30:sOption("Nihon Application")
break
case 31:sOption("Bandai Visual")
break
case 32:sOption("Athena")
break
case 33:sOption("KID")
break
case 34:sOption("HAL Corporation")
break
case 35:sOption("Yuki Enterprise")
break
case 36:sOption("Omega Micott")
break
case 37:sOption("Layup")
break
case 38:sOption("Kadokawa Shoten")
break
case 39:sOption("Shall Luck")
break
case 40:sOption("Squaresoft")
break
case 43:sOption("Tom Create")
break
case 45:sOption("Namco")
break
case 46:sOption("Movic(?)")
break
case 47:sOption("E3 Staff(?)")
break
case 49:sOption("Vanguard")
break
case 50:sOption("Megatron")
break
case 51:sOption("Wiz")
break
case 52:sOption("Capcom")
break
default:sOption("(unknown publisher)")}sOption(X.U8(G+5),"1sttrk: ")}}else if(X.c("3026b2758e66cf11a6d900aa0062ce6c"))sName="Windows Media (.WMV/WMA)",bDetected=1
else if(X.c("'XAD!'"))sName="Riven the Mage's Exotic AdLib module (.XAD)",bDetected=1,X.isVerbose()&&(sOptionT(X.SA(4,36)),sOptionT(X.SA(40,36),"by: "))
else if(X.c("'Extended Module: '")&&X.c("1A",37)&&isWithin(X.U16(72),1,256)){V=X.U16(58),charset="CP437",sName="Fast Tracker 2 Extended module (.XM)",bDetected=1,text=tracker=mVlsw=bad="",insns=[],smpns=[],hdrp=60,hdrsz=X.U32(hdrp),restartp=X.U16(hdrp+6),flags=X.U16(hdrp+14),linearSlides=1&flags,xFilter=4096&flags,ord=X.U16(hdrp+4),chn=X.U16(hdrp+8),ptn=X.U16(hdrp+10),ins=X.U16(hdrp+12),tmp0=X.U16(hdrp+16),bpm0=X.U16(hdrp+18)
G=hdrp+hdrsz
if(260<=V)for(Y=0;Y<ptn;Y++)G+=X.U32(G)+X.U16(G+7)
var bs=128,J=256,Z=isOMPTMade=isOXM=mixlevCompatFT2=!1
for(madewith=0,X.c("'FastTracker v2.00   '",38)&&276===hdrsz?madewith=V<260?48:0<=(E=X.fSig(17,20,"00"))?restartp?2178:36==E?2434:firstNotOf(E+1,36-E,32)<0?272:2178:restartp?34:290:X.c("'FastTracker v 2.00  '",38)?madewith=1:(madewith=16,tracker=X.SC(38,20,charset).trim(),X.c("'OpenMPT '",38)?madewith=2072:X.c("'MilkyTracker '",38)?X.c("'       '",50)||(mixlevCompatFT2=!0):X.c("'Fasttracker II clone'",38)?madewith=48:X.c("'MadTracker 2.0'00",38)?(Z=!0,tracker=X.c("00000000",53)?"MadTracker 2":"MadTracker 2 (registered)"):X.c("'*Converted '",38)&&X.c("'-File*'",52)&&(madewith=528,tracker="Digitrakker")),xFilter&&2&madewith&&(madewith=2194),smp=smpReserved=0,insp=G,anyADPCM=anyInsSmp=!1,sflags=[],smpsz=lastsmphdsz=lastinstp=lastsmpreserved=-1,ord,Y=0;Y<ins;Y++){if(G+4>X.Sz()){bad=bad.addIfNone("!short")
break}if(ihdsz=(ihdsz=X.U32(G))||263,instp=X.U8(G+26),(inst=X.SC(G+4,22,"CP437").trim()).length&&insns.push(inst),smpn=X.U16(G+27),smphdsz=X.U32(G+29),1==madewith?(madewith|=16,245==ihdsz?(mVlsw="1.00.00.A5",tracker="ModPlug Tracker 1.0 alpha"):263==ihdsz?(mVlsw="1.00.00.B3",tracker="ModPlug Tracker 1.0 beta"):madewith=16):smpn||(263==ihdsz&&!smphdsz&&2&madewith?madewith|=16:29!=ihdsz&&512&madewith?madewith&=-513:160&madewith&&33!=ihdsz&&(madewith=0),33!=ihdsz?madewith&=~J:40<smphdsz&&madewith&J&&((anyInsSmp||-1!=lastsmphdsz&&smphdsz!=lastsmphdsz)&&(madewith=272),lastsmphdsz=smphdsz)),-1==lastinstp?lastinstp=instp:lastinstp!=instp&&32&madewith&&(madewith=-33&madewith|bs),vls=X.U8(G+40+195),vle=X.U8(G+40+196),vef=X.U8(G+40+200),pls=X.U8(G+40+198),ple=X.U8(G+40+199),pef=X.U8(G+40+201),midichecks=X.U8(G+40+208)|X.U8(G+40+209)|X.U16(G+40+210)|X.U8(G+40+214),G+=ihdsz,smp+=smpn,G>X.Sz()){bad=bad.addIfNone("!short")
break}260<=V&&(sflags=[])
var Us=0
if(smpn){for(anyInsSmp=!0,midichecks&&(madewith&=-260),263==ihdsz&&!instp||(madewith&=~J),16&madewith||!(madewith&J)||(4&vef||255!=vls||255!=vle)&&(4&pef||255!=pls||255!=ple)||(madewith=-3&madewith|16),c=0;c<smpn;c++){slen=(c,X.U32(G))
var us=X.I8(G+13),I=X.U8(G+14),Q=X.U8(G+15),$=X.U8(G+17),hs=(C=X.SC(G+18,22,"CP437")).trim()
smpReserved|=$,smpns.push(hs),isADPCM=173===$&&!(48&I),$&&173!=$&&(madewith&=-12),-1==lastsmpreserved?lastsmpreserved=$:lastsmpreserved!=$&&(madewith&=~J),128!=Q&&(madewith&=~J),15&us&&127!=us&&(madewith&=~J),sflags.push([I,isADPCM]),isADPCM&&(anyADPCM=!0),Us+=isADPCM?16+(slen+1>>1):slen,G+=40,160&madewith&&258&madewith&&!(16&madewith)&&(22<$||C.slice($).indexOf(" ")<0)&&(madewith=-33&madewith|144),3==(3&I)&&2&madewith&&(madewith|=4)}smpsz+=Us,260<=V&&(X.c("'OggS'",G)&&(isOXM=!0),G+=Us)}}if(!smpReserved&&2&madewith&&-1<X.fSig(17,20,"00")&&(madewith|=16),V<260){for(Y=0;Y<ptn;Y++)G+=X.U32(G)+X.U16(G+(258==V?6:7))
X.c("'OggS'",G)&&(isOXM=!0),G+=smpsz}for(basesz=G,""==tracker&&(tracker=512&madewith&&!smpReserved&&-1==(lastinstp||-1)?"Digitrakker":32&madewith?"FastTracker 2 or compatible":"Unknown"),fx=0,xt="";G+6<X.Sz()&&(E=X.SA(G,4),!(it=X.U32(G))||!X.U16(G+4)||!("228"===E||2155905152&it)&&1616928864&it);)if("text"===E)E=X.U32(G+4),G+=8,xt=xt.append("t"),text=X.SC(G,E,"CP437").trim(),G+=E,madewith=madewith&~J|16
else if(/F[0-9X]\d\d/.test(E))E=X.U32(G+4),G+8+E<=X.Sz()&&(G+=8+E,fx++),madewith|=16
else if("MIDI"===E)E=X.U32(G+4),madewith=madewith&~J|16,G+8+E<=X.Sz()&&(G+=8+E,xt=xt.append("m"))
else if("CHFX"===E||"CNAM"===E||"PNAM"===E)E=X.U32(G+4),G+8+E<=X.Sz()&&(G+=8+E),madewith=madewith&~J|16
else if("XTPM"===E)for(G+=4,xt=xt.append("x"),madewith=madewith&~J|16,isOMPTMade=!0,E=X.SA(G,4);G+7<X.Sz();){if(!X.U8(G)){G++
break}if(code=X.SA(G,4),icode=X.U32(G),"STPM"===code||"228"===code||2155905152&icode||!(1616928864&icode))break
for(prsz=X.U16(G+4),G+=6,Y=0;Y<ins;Y++)G+=prsz}else{if("STPM"!==E)break
for(G+=4,xt=xt.append("s"),madewith=madewith&~J|16;G+6<X.Sz();){if(!X.U8(G)){G++
break}if(X.c("'VWSL'",G)){switch(v=0,X.U16(G+4)){case 1:v=X.U8(G+6)
break
case 2:v=X.U16(G+6)
break
case 3:v=X.U24(G+6)
break
case 8:v=X.U64(G+6)
break
default:v=X.U32(G+6)}v&&(mVlsw=(t=v.toString(16).toUpperCase().padStart(7,"0")).slice(0,1)+"."+t.slice(1,3)+"."+t.slice(3,5)+"."+t.slice(5,7))
break}G+=6+X.U16(G+4)}}16&madewith&&(4&madewith?(mVlsw="1.11",tracker="ModPlug Tracker 1.0-11"):2&madewith&&!(madewith&J)?(mVlsw="1.16",tracker="ModPlug Tracker 1.0-16"):2&madewith&&madewith&J?(mVlsw="1.16",tracker="ModPlug Tracker 1.0-16 / PlayerPRO"):!(2&madewith)&&madewith&J&&(tracker="PlayerPRO")),X.c("'OpenMPT '",38)&&(mVlsw=X.SA(46,12).trim(),madewith=24),"1.17"<=(mVlsw=isOMPTMade&&mVlsw<"1.17"?"1.17":mVlsw)&&(tracker="OpenMPT v"+mVlsw),K=G,charset=""!=mVlsw||Z?"CP1252":"CP437",X.isVerbose()&&(sOptionT(X.SC(17,20,charset)),sOptionT(tracker,"in:"),isOXM&&sOption("OggMod FastTracker 2 (.OXM)","via:"),text.length&&sOption(addEllipsis(text,256)),insns.length&&sOption(addEllipsis(insns.filter(funSampleName).join(" "),256),'ins/msg:"','"'),smpns.length&&sOption(addEllipsis(smpns.filter(funSampleName).join(" "),256),'smp/msg:"','"'),a="chn:"+chn+" ord:"+ord+" ptn:"+ptn+" ins:"+ins+" smp:"+smp,fx&&(a+=" fx:"+fx),xt.length&&(a+=" xt:"+xt),K!=basesz&&(a+=" base_sz:"+basesz),a+=" sz:"+outSz(K),sOption(a)),sVersion="v"+(V>>8)+"."+(255&V)+bad+(anyADPCM?"/ADPCMpacked":"")}else if(X.c("'FORM' 0000000E 'XDIRINFO'  00000002 .... 'CAT ' ........ 'XMIDFORM' ........ 'XMID'"))bDetected=1,sName="Extended MIDI chiptune (.XMI,.C55,.PCS)",X.isVerbose()&&(1<(k=X.U8(20))&&sOption(k,"×"),sOption(outSz(30+X.U32(26,_BE)),"sz:"))
else if(X.c("'ofTAZ!'"))sName="Davey W. Taylor's Extra Simple Music module (.XSM)",bDetected=1
else if(/YM\d!/.test(X.SA(0,4))||X.c("'YM3b!'")||/YMT\dLeOnArD!/.test(X.SA(0,12))||X.c("'MIX1LeOnArD!'")){switch(bDetected=1,bad="",frm=smp=voc=loop=ddn=0,sName="ST-Sound chiptune stream (.YM)",sV=X.SA(0,4).replace(/!/g,"")){case"YM1":sVersion="YM1"
break
case"YM2":sVersion="MADMAX specific"
break
case"YM3":sVersion="YM-Atari"
break
case"YM3b":sVersion="YM-Atari+loopinfo",loop=X.U32(X.Sz()-4,_LE)
break
case"YM4":sVersion="YM-Atari extended"
break
case"YM5":case"YM6":sVersion="Generic YM2149 extended"
break
case"MIX1":sVersion="Atari Remix digital"
break
case"YMT1":case"YMT2":sVersion="YM-Tracker"}if(0<=["YM2","YM3","YM3b"].indexOf(sV)&&(frm=Util.divu64(X.Sz()-4,14)),0<=["YM5","YM6","YMT1","YMT2","MIX1"].indexOf(sV)){if("LeOnArD!"!=X.SA(4,8)&&(bad=bad.addIfNone("!badsig")),0<=["YM6!","YMT1","YMT2"].indexOf(sV)&&"End!"!=X.SA(X.Sz()-4)&&(bad=bad.addIfNone("!badfilesz")),0<=["YM5","YM6"].indexOf(sV)){for(ddn=X.U16(20,_BE),loop=X.U32(28,_BE),G=X.U16(32,_BE)+34,Y=0;Y<ddn;Y++)if(ds=X.U16(G,_BE),(G+=2+ds)>=X.Sz()){bad=bad.addIfNone("!tooshort")
break}}else if("MIX1"===sV)for(G=24,smp=X.U32(16,_BE),mixblk=X.U32(20,_BE),Y=0;Y<mixblk;Y++)G+=12
else 0<=["YMT1","YMT2"].indexOf(sV)&&(ddn=X.U16(24,_BE),voc=X.U16(13,_BE),frm=X.U32(16,_BE),G=30)
G>=X.Sz()?bad=bad.addIfNone("!nodata"):(E=G,0<=(t_=X.fSig(G,TOEOF,"00")-G)&&(G+=t_+1,p=G,a_=X.fSig(G,TOEOF,"00")-G,G+=a_+1,l=G,c_=X.fSig(G,TOEOF,"00")-G,G+=c_+1,0<=["YM5","YM6"].indexOf(sV))&&(X.c("'End!'",G+((frm=X.U32(12,_BE))<<4))||(bad=bad.addIfNone("!badframes"),sOption("frm/frames: "+(frm<<4)+"/"+(X.Sz()-G-4))))),X.isVerbose()&&(sOptionT(X.SA(E,t_)),sOptionT(X.SA(p,a_),"by: "),sOptionT(X.SA(l,c_)))}X.isVerbose()&&(voc&&sOption(voc,"voc:"),smp&&sOption(outSz(G+smp),"sz:"),ddn&&sOption(ddn,"digidrums:"),frm)&&sOption("len:"+frm+" sz:"+outSz(G+(frm<<4)+4)),""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/"))}else if(X.c("'YMST'")&&(sName="Nicolas 'Mr.Styckx' Pomarede's MYST ST-YM module (.YMST,.YM)",bDetected=1,X.isVerbose())){for(Y=0,G=4;Y<48&&(G+=8,X.U16(G-8,_BE));Y++);E=G,0<=(t_=X.fSig(G,TOEOF,"00")-G)&&(G+=t_+1,p=G,a_=X.fSig(G,TOEOF,"00")-G,G+=a_+1,l=G,c_=X.fSig(G,TOEOF,"00")-G,X.isVerbose())&&(sOptionT(X.SA(E,t_)),sOptionT(X.SA(p,a_),"by: "),sOptionT(X.SA(l,c_)))}if(!bDetected&&(function(){if(X.c("'ZXAYAMAD'")&&!(3<X.U8(9))&&(authp=12+X.I16(12,_BE))<X.Sz()&&(auth=authp?X.SA(authp,256):"",(miscp=14+X.I16(14,_BE))<X.Sz())&&(misc=miscp?X.SA(miscp,256):"",k=X.U8(16)+1,!((G=18+X.I16(18,_BE))>X.Sz()))){for(titles=[],Y=0;Y<k;Y++,G+=4)if(E=G+X.I16(G,_BE)){if(!(E<X.Sz()))return
titles.push(X.SA(E,256).trim())}return 1}})()&&(sName="František Fuka/Fuxoft's AY Amadeus module (.AMAD)",sVersion=[X.U8(8)?"Rel "+X.U8(8):"",X.U8(9)?"Plr "+X.U8(9):""].join(" ").trim(),X.isVerbose())&&(sOptionT(titles.join(",")),1<k&&sOption(k,"×"),authp&&sOptionT(auth,"by: "),miscp)&&sOptionT(misc),!bDetected&&(function(){if(X.c("'ZXAYEMUL'")&&!(3<X.U8(9))&&(authp=12+X.I16(12,_BE))<X.Sz()&&(auth=authp?X.SC(authp,256,"CP1250"):"",(miscp=14+X.I16(14,_BE))<X.Sz())&&(misc=miscp?X.SC(miscp,256,"CP1250"):"",k=X.U8(16)+1,!((G=18+X.I16(18,_BE))>X.Sz()))){for(titles=[],Y=0;Y<k;Y++,G+=4)if(E=G+X.I16(G,_BE)){if(!(E<X.Sz()))return
titles.push(X.SC(E,256,"CP1250").trim())}return 1}})()&&(sName="Sergej Bulba's AY Emul chiptune (.EMUL)",bDetected=1,sVersion=[X.U8(8)?"Rel "+X.U8(8):"",X.U8(9)?"Plr "+X.U8(9):""].join(" ").trim(),X.isVerbose())&&(sOptionT(titles.join(",")),1<k&&sOption(k,"×"),authp&&sOptionT(auth,"by: "),miscp)&&sOptionT(misc),!bDetected&&(function(){if(X.c("'CBMF'")){notes=ins=0
var s=!(G=4),e=Math.min(X.Sz(),65536),t=[]
for(Y=0;Y<16;Y++)t[Y]=!1
for(;!s&&G<e;)for(;!s&&(b=X.U8(G++))<128&&G<e;){if(isWithin(b,1,15)||isWithin(b,64,79)||isWithin(b,113,126))return
switch(b>>4){case 0:X.isHeuristicScan()||(s=!0)
break
case 1:if(!t[b-16])return
G++,notes++
break
case 2:break
case 3:t[b-48]=!0,G+=11
break
case 5:break
case 6:G++}}if(!X.isHeuristicScan()){if(!s&&e<X.Sz()||notes<16)return
for(Y=0;Y<16;Y++)t[Y]&&ins++
if(!ins)return}return 1}})()&&(sName="Bob's Adlib Music module (.BAM)",bDetected=1,sOption("ch:"+ins+" notes:"+notes+" sz:"+outSz(G))),!bDetected&&(function(){if(X.c("'CTMF'")&&isWithin(X.U16(4),256,257)&&isWithin(X.U16(8),37,X.Sz()-1)){for(nV=X.U16(4,_LE),ic=0,bad="",pins=X.U16(6,_LE),(pmus=X.U16(8,_LE))<=pins&&(ic++,bad=bad.addIfNone("!badptr")),ins=257<=nV?(G=40,X.U16(36)):(G=37,X.U8(36)),(E=Util.divu64(pmus-pins,16))!=ins&&(ic++,bad=bad.addIfNone("!inconsistentinscnt"+E)),(tp=X.U16(14,_LE))&&!isWithin(tp,G,pins-1)&&(tp=0,ic++,bad=bad.addIfNone("!badptr")),(ap=X.U16(16,_LE))&&!isWithin(ap,G,pins-1)&&(ap=0,ic++,bad=bad.addIfNone("!badptr")),(cp=X.U16(18,_LE))&&!isWithin(cp,G,pins-1)&&(cp=0,ic++,bad=bad.addIfNone("!badptr")),ch=0,Y=20;Y<36;Y++)1==(E=X.U8(Y))?ch++:1<E&&ic++
return ch||ic++,(K=X.fSig(pmus,Math.min(65536,X.Sz()),"FF2F00"))<0&&(K=X.fSig(pmus,Math.min(65536,X.Sz()),"FF2FFE"),bad=bad.addIfNone("!badeof")),0<K&&(K+=3),ic<5}})()&&(sName="Creative Labs' Creative Music Format chiptune (.CMF)",bDetected=1,sVersion="v"+(nV>>8)+"."+(255&nV),""!=bad&&(sVersion+="/malformed"+bad),X.isVerbose())&&(tp&&sOptionT(addEllipsis(X.SC(tp,256,"CP437"))),ap&&sOptionT(addEllipsis(X.SC(ap,256,"CP437")),"by: "),cp&&sOptionT(addEllipsis(X.SC(cp,256,"CP437"))),257<=nV&&255==X.U8(K)&&K++,sOption("ch:"+ch+" ins:"+ins+" sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<90||!X.c("02011313 1412010B")||1<X.U8(8)||!isWithin(ch=X.U8(9),1,8)||4096<(ord=X.U16(10))||4096<(ptn=X.U16(12)))){X.U24(14)
for(smp=0,G=17,Y=0;Y<63;Y++,G++)Y,X.U8(G),128&X.U8(G)||(smp++,Y,X.U24(G+1),G+=3)
F=X.UCSD(G),G+=1+X.U8(G)
X.readBytes(G,8)
return(G+=8)>X.Sz()?void 0:1}})()&&(sName="Oregan Developments' Digital Symphony module (.DSYM)",sVersion="v"+X.U8(8),bDetected=1,X.isVerbose())&&(sOptionT(F),sOption("ch:"+ch+" ord:"+ord+" ptn:"+ptn+" smp:"+smp)),!bDetected&&(function(){if(!(!X.c("'DFM'1A")||1<X.U8(4)||[0,1,99].indexOf(X.U8(5))<0||32<X.U8(6))&&isWithin(tmp0=X.U8(39),5,31)){for(inss=[],Y=0,G=40;Y<32;Y++,G+=12){if(11<X.U8(G))return
inss.push(X.UCSD(G))}for(G+=352,ord=ptn=Y=0;Y<128&&128!=X.U8(G+Y);Y++,ord++)ptn=Math.max(ptn,X.U8(G+Y)+1)
for(Y++;Y<128;Y++)if(X.U8(G+Y))return
for(G+=128,optn=X.U8(G++),rptn=next=0;rptn<optn&&G<X.Sz();rptn=next+1)for(next=X.U8(G++),Y=0;Y<576;Y++)128&X.U8(G++)&&G++
return 1}})()&&(sName="Rene Verhaag's Digital-FM module (.DFM)",sVersion="v"+X.U8(4)+"."+X.U8(5).padStart(2,"0"),bDetected=1,X.isVerbose())&&(sOptionT(X.SC(7,32,"CP1252")),sOptionT(addEllipsis(inss.filter(funSampleName).join(" ")),'ins/msg:"','"'),sOption("ch:"+X.U8(6)+" tmp0:"+tmp0+" ord:"+ord+" ptn:"+(ptn!=optn?ptn+"/":"")+(rptn!=optn?rptn+"/":"")+optn+" sz:"+outSz(G))),!bDetected&&(function(){if(X.c("'DBRAWOPL'")&&(4278255360&(E=X.U32(8))?(sVersion="v0",mV=MV=0):65535&E?(MV=X.U16(8),mV=X.U16(10)):(mV=X.U16(8),MV=X.U16(10)),!(3<MV))){switch(MV&&(sVersion="v"+MV+"."+mV.padStart(2,"0")),db="",MV){case 0:db="DOSBox 0.62",lenMS=X.U32(8),dtsz=X.U32(12),hw=X.U8(16),dtofs=17
case 1:1==MV&&(db="DOSBox 0.63",lenMS=X.U32(12),dtsz=X.U32(16),hw=(E=X.U32(20))<=255?E:255,dtofs=24),1==hw?hw=2:2==hw&&(hw=1),fmt=0,co=0
break
case 2:if(db="DOSBox 0.73",dtsz=X.U32(12)<<1,lenMS=X.U32(16),hw=X.U8(20),fmt=X.U8(21),co=X.U8(22),ds=X.U8(23),dl=X.U8(24),regcmdcnt=X.U8(25),dtofs=26+regcmdcnt,128<regcmdcnt&&(regcmdcnt=128),regmap=X.readBytes(26,regcmdcnt),1==hw){for(G=dtofs,opl3on=0,reginit=[],Y=0;Y<512;Y++)reginit[Y]=!1
for(;G<X.Sz()&&(E=X.U8(G))!=ds&&E!=dl&&!((127&E)>=regcmdcnt);)creg=(128&E)<<1|regmap[127&E],reginit[creg]=!0,261==creg&&(opl3en=X.U8(G+1)),G+=2
reginit[261]&&1&opl3en&&(hw=2)}-1===(hw=["YM3812 (OPL2)","YM3812 (Dual OPL2)","YMF262 (OPL3)"].indexOf(hw))&&(hw="YMF262(portshift)")}return 1}})()&&(sName="DOSBox Raw OPL chiptune (.DRO)",sVersion=sVersion.appendS(hw,"#"),bDetected=1,X.isVerbose())&&sOption("len: "+secondsToTimeStr(Util.divu64(lenMS+500,1e3))+" via: "+db+" packed:"+co+" sz:"+outSz(dtofs+dtsz)),!bDetected&&(function(){if(!(X.Sz()<2303)&&X.c("'Funk'")&&(K=X.U32(8),isWithin(K,2303,1048576))){switch(E=X.U32(4),sV=X.SA(12,4),bad="",sus=0,sversion=/F2\d\d/.test(sV)?"R2 GOLD "+(1980+(E>>9&127))+"-"+(E>>5&15).padStart(2,"0")+"-"+(31&E).padStart(2,"0")+" ":"R1",/F[2vk]\d\d/.test(sV)?ch=X.SA(14,2):(sversion+="b",ch=8,sus++),E>>20&15){case 1:case 2:E="IBM"
break
case 3:E="Intel 386"
break
case 4:E="Intel 486"
break
case 5:E="Pentium"
break
case 6:E="Linux"
break
case 7:E="FreeBSD"
break
case 8:E="N/A"
break
default:E="unk.system"}switch(sversion+="#"+E,E>>16&15){case 0:E="SB 2.0"
break
case 1:E="SB Pro"
break
case 2:E="GUS+ch.pan"
break
case 3:E="SB compatible"
break
case 4:E="SB 16"
break
case 5:E="GUS"
break
case 6:E="conversion"
break
case 7:E="Pro Audio Spectrum"
break
case 8:E="Voxware /dev/dsp 8 bit"
break
case 9:E="Voxware /dev/dsp 16 bit"
break
case 15:E="unk.soundcard"
break
default:E="soundcard N/A"}for(sversion+=":"+E,!X.isVerbose()&&X.Sz()<K&&(bad=bad.addIfNone("!short")),ord=0,ptn=-1,Y=0;Y<256&&255!=(E=X.U8(17+Y));Y++)if(ord++,121<E){if(!X.isHeuristicScan())return
bad=bad.addIfNone("!badord")}else E>ptn&&(ptn=E)
for(ptn++,255!=(lp=X.U8(16))&&lp>ord&&(bad+="!badloop"),smp=sus=0,smps=[],Y=400;Y<2239;Y+=32){if(!isWithin(X.U8(Y),1,79))return
if(X.U32(Y+24)&&smp++,charStat(X.readBytes(Y+1,19),1).indexOf("allasc")<0&&sus++,3<sus)return
smps.push(X.SC(Y+1,19,"CP437").trim())}return 1}})()&&(sName="Jason Nunn's Funktracker module (.FNK,.Funk)",sVersion=sversion,bDetected=1,""!=bad&&(sVersion+="/malformed"+bad),X.isVerbose())&&(bpm=X.U8(4),bits=1&bpm?16:8,Z=(bpm>>=1)>>6,bpm&=63,bpm=Z?125-bpm:125+bpm,sOptionT(addEllipsis(smps.filter(funSampleName).join(" ")),'smp/msg:"','"'),sOption("ch:"+ch+" bpm0:"+bpm+" ord:"+(255!=lp?lp+"~":"")+ord+" ptn:"+ptn+" smp:"+smp+" "+bits+"bit sz:"+outSz(K))),!bDetected&&(function(){if(X.c("'PRT'")&&isWithin(ins=X.U8(64),1,64)&&isWithin(nV=X.U8(3),10,50)&&(!(nV<30)||(ptn=[X.U8(61)])[0]&&(ord=[X.U8(62)])[0]&&!((lp=[X.U8(60)])[0]>ord[0]))&&(k=1,G=90,ptnp=[],k=30<=nV?X.U8(G++):k)){30<=nV&&(ord=[],lp=[],ptn=[])
var s,e=[]
for(Y=0;Y<k;Y++){for(lp.push(X.U8(G++)),ptn.push(X.U8(G++)),e.push(X.U8(G++)),ord.push(X.U8(G++)),ptnp.push(X.U32(G,_BE)),G=(G+=4)+4*ord[Y]*2,Y=0;Y<k;Y++)ptnp[Y]+=G
mpp=(s=void 0,s=ptnp.indexOf(Math.max.apply(null,ptnp)),[ptnp[s],e[s]])}return X.Sz()>G}})()&&(sName="Manfred 'Pink' Linzner's PreTracker module (.PRT)",bDetected=1,sVersion=nV<25?"v<0.3":25==nV?"v0.3~0.866":26==nV?"v0.87~0.92":isWithin(nV,27,29)?"v.[0.93~1.5)":30==nV?"v1.5+":"v.TODO",X.isVerbose())&&(sOptionT(X.SA(20,20)),1<k&&sOption(k,"×"),sOptionT(X.SA(40,20),"by: "),sOption("ord:"+(lp?lp+"-":"")+ord+" ptn:"+ptn+" ins:"+ins+" wf:"+(wf=X.U8(65)))),bDetected||X.Sz()<100||!X.c("'CBT'")||!isWithin(nV=X.U8(3),1,12)||(sName="Manfred 'Pink' Linzner's Comeback Tracker module (.CBT)",bDetected=1,sVersion="v"+nV+"β"),!bDetected&&X.c("'psm1'00",8)&&(sus=0,bad="",((posp=X.U16(0))<13||posp>X.Sz())&&(sus++,bad+="!badpos"),((smpp=X.U16(2))<13||smpp>X.Sz())&&(sus++,bad+="!badsmp"),((ornp=X.U16(0))<13||ornp>X.Sz())&&(sus++,bad+="!badorn"),((ptnp=X.U16(0))<13||ptnp>X.Sz())&&(sus++,bad+="!badptn"),sus<2)&&(sName="Denis 'Dexus' Dratov's Pro Sound Maker module (.PSM)",sVersion="compiled",bDetected=1,sus&&(sVersion+="/malformed"+bad+"/sus"+sus),X.isVerbose())){for(E=posp,smpp<E&&(E=smpp),ornp<E&&(E=ornp),(E=ptnp<E?ptnp:E)-13&&sOptionT(X.SA(13,Math.min(E-13,128)),'msg: "','"'),ord=0,E=E=posp;X.U8(E)<255&&E<X.Sz();E+=2)ord++;(loop=255)==X.U8(E)?loop=X.U8(E+1):bad=5,255==loop&&(loop="none"),sOption("ord:"+ord+" loop:"+loop)}if(!bDetected&&(function(){if(X.c("'FORM'........ 'MODLVERS'00000016")&&X.c("'INFO'00000048",30)&&X.c("'CMNT'000001A4",102)&&X.c("'PTDT'",522))for(a=cmt=dt=pt=sv="",smp=ord=ptn=tmp0=0,K=X.U32(4,_BE)+8,maxsz=Math.min(K,X.Sz()),G=30;!bDetected&&G<maxsz&&(hkhd=X.SA(G,4),hksz=X.U32(G+4,_BE),!(charStat(hkhd,1).indexOf("allasc")<0));){switch(hkhd){case"INFO":a=decAnsi(G+8,32,CPAmiga).trim(),smp=X.U16(G+40,_BE),ord=X.U16(G+42,_BE),ptn=X.U16(G+44,_BE),bpm0=X.U16(G+48,_BE)
var s=X.U16(G+52,_BE)
if(!isWithin(s,1,31))return
var e=X.U16(G+54,_BE)
if(!isWithin(e,0,12))return
var t=X.U16(G+56,_BE)
if(isWithin(t,30,88))return
dt=1900+t+"-"+e.padStart(2,"0")+"-"+s.padStart(2,"0")+" "+X.U16(G+58,_BE).padStart(2,"0")+":"+X.U16(G+60,_BE).padStart(2,"0")+":"+X.U16(G+62,_BE).padStart(2,"0"),pt=secondsToTimeStr(3600*X.U16(G+64,_BE)+60*X.U16(G+66,_BE)+X.U16(G+68,_BE))
break
case"CMNT":"UNNAMED AUTHOR"===(auth=decAnsi(G+8,32,CPAmiga).trim())&&(auth=""),cmt=decAnsi(G+40,hksz-32,CPAmiga).trim()
break
case"PTDT":return 1}G+=hksz}})()&&(sName="ProTracker IFF-wrapped module (.PTM)",bDetected=1,(sv=X.SA(24,6).trim()).length||(sv="v3.6"),sVersion=sv,X.isVerbose())&&(sOption(a),sOption(auth,"by: "),sOption(cmt),sOption(dt,"on "),sOption(pt,"len "),sOption("bpm0:"+bpm0+" ord:"+ord+" ptn:"+ptn+" smp:"+smp),sOption(outSz(K),"sz:")),!bDetected&&(function(){if(!(!X.c("'SCRM'",44)||!X.c("10",29)||[1,2].indexOf(X.U8(42))<0||X.Sz()<96)){for(keepmidims=fmttrkstr=trknc=ss=isSchism=!1,tracker=lswv=bad="",sus=0,X.c("1A",28)||(sus++,bad=bad.addIfNone("!badsig1a")),(z1=X.U16(30))&&(sus++,bad=bad.addIfNone("!badsig0")),1&(ord=X.U16(32))&&(sus++,bad=bad.addIfNone("!oddord")),smp=X.U16(34),ptn=X.U16(36),fl=X.U16(38),cwtv=X.U16(40),tv=cwtv>>12,wtv=4095&cwtv,fmtv=X.U16(42),gvol=X.U8(48),spd=X.U8(49),tmp=X.U8(50),mvol=X.U8(51),uc=X.U8(52),usept=0<(X.U8(53)&&252),r2=X.U16(54),special=X.U16(62),ch=4,Y=0;Y<32;Y++)255!=X.U8(64+Y)&&(ch=Y+1)
switch(E=Hex(cwtv),sv=E.substr(1,1)+"."+E.substr(2,2).padStart(2,"0"),tv){case 520&tv:tracker="Akord"
break
case 1:X.c("'SCLUB2.0'",54)?tracker="Sound Club 2":4896!=cwtv||special||15&ord||uc||-81&fl||!usept?4896!=cwtv||special||uc||fl||usept?4896!=cwtv||special||uc||8!=fl||usept?(ss=!0,4896==cwtv?tracker="Psi's Scream Tracker 3.20-21":(tracker="Psi's Scream Tracker",fmttrkstr=!0)):tracker="J.Lim's Impulse Tracker < 1.03":tracker=64==gvol&&48==mvol?"PlayerPRO":"Velvet Studio":(tracker=mvol?(lswv="1.16","ModPlug Tracker/OpenMPT 1.17"):(lswv="1.00.00.A0","ModPlug Tracker 1.0 alpha"),keepmidims=trknc=!0)
break
case 2:fmttrkstr=8211!=cwtv,tracker=fmttrkstr?"Imago Orpheus":"PlayerPRO",trknc=!0
break
case 3:tracker=13088==cwtv?"Impulse Tracker 1.03":532<r2?"Impulse Tracker 2.15":isWithin(wtv,533,535)?"Impulse Tracker 2.14p"+(533==wtv?"1-2":534==wtv?"3":"4-5"):"Impulse Tracker "+((3840&wtv)>>8)+"."+(255&wtv).toString(16).padStart(2,"0"),trknc=!0
break
case 4:var s,e
tracker=16640==cwtv?"BeRoTracker":(isSchism=!0,(s=(e=734016+(wtv<4095?wtv-80:r2))-(365*(t=Util.div64(1e4*e+14780,3652425))+Util.div64(t,4)-Util.div64(t,100)+Util.div64(t,400)))<0&&(s=e-(365*--t+Util.div64(t,4)-Util.div64(t,100)+Util.div64(t,400))),e=Util.div64(100*s+52,3060),"Schism Tracker "+(t+Util.div64(e+2,12)).padStart(4,"0")+"-"+((e+2)%12+1).padStart(2,"0")+"-"+(s-Util.div64(306*e+5,10)+1).padStart(2,"0")),trknc=!0
break
case 5:cwtv>>8==87?(tracker="NESMusa",fmttrkstr=!0):r2||16!=uc||1==X.U8(65)?tracker=21575!=cwtv?(19464192<=(v=wtv<<16)&&(v|=r2),"OpenMPT "+(lswv=(t=v.toString(16).toUpperCase().padStart(7,"0")).slice(0,1)+"."+t.slice(1,3)+"."+t.slice(3,5)+"."+t.slice(5,7))):"Dumbo's Graoumf Tracker":(tracker="Liquid Tracker",fmttrkstr=!0)
break
case 6:tracker="BeRoTracker"
break
case 7:tracker="BeRo's CreamTracker"
break
default:51712==cwtv&&(tracker="Camoto")}var t
if(!(2<=sus)){for(fmttrkstr&&(tracker+=" "+sv),charset=""!=lswv?"CP1252":"CP437",G=96+ord+2*smp,max=K=0,Y=0;Y<ptn;Y++){var r=X.U16(G+2*Y)<<4
r&&r>max&&(max=r,K=max+X.U16(r))}if(K%16&&(K+=16-K%16),usept){var i=!1
for(G+=2*ptn,Y=0;Y<ch;Y++)ss&&isWithin(X.U8(64+(255&Y)),16,29)&&X.U8(G+Y)<16&&(i=!0)
ch<32&&0<=lswv.indexOf("1.16")&&(tracker=i?"ModPlug Tracker 1.16/OpenMPT 1.17":"ModPlug Tracker")}for(G=96+ord,anysmp=anyADPCM=!1,gus=0,smps=[],Y=0;Y<smp;Y++)(si=X.U16(G+2*Y)<<4)&&(si>X.Sz()?bad=bad.addIfNone("!short"):(x=X.U8(si),A=X.U32(si+16),""!=(E=X.SC(si+48,28,charset).trim())&&smps.push(E),x<2&&(A&&(anysmp=!0,I=X.U8(31),anyADPCM||4!=X.U8(si+20)||6&I||(anyADPCM=!0)),gus|=X.U16(si+40)),1===X.U8(si)&&(sofs=X.U16(si+14)<<4)>max&&(4&I&&(A*=2),max=sofs,K<max+A)&&(K=max+A)))
return usegus=1<gus,ss&&anysmp&&!gus&&4864!=cwtv?(ss=!1,tracker="Unknown",4865!=cwtv||uc||(!(-81&fl)&&128&mvol&&usept?tracker="Laurent Clévy's UNMO3":fl||48!=gvol||176!=mvol||150!=tmp||usept?fl||64!=gvol||48!=(127&mvol)||6!=spd||125!=tmp||usept||(tracker="Zab/Kosmic's To-S3M"):tracker="Slixter's deMODifier")):ss&&(tracker+=usegus?" (GUS)":" (SB)"),anyADPCM&&(tracker+=" (ADPCM packed)"),1}}})()&&(sName="Sami 'Psi' Tammilehto's ScreamTracker 3 module (.S3M)",bDetected=1,sus&&(sVersion=sVersion.appendS("malformed"+bad+" sus"+sus,"/")),X.isVerbose())&&(sOptionT(X.SC(0,28,charset)),sOption(tracker,"in:"),sOption(addEllipsis(smps.join(" "),160),'smp/msg:"','"'),sOption("ch:"+ch+" tempo0:"+tmp+" spd0:"+spd+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" gvol:"+gvol+" smpvol:"+(127&mvol)+(128&mvol?"/mono":"/stereo")+" sz:"+outSz(K))),!bDetected&&(function(){if(X.c("'MAD+'")){for(ord=X.U8(185),ptn=X.U8(186),tmr=X.U8(187),Y=0,G=188;Y<32*ptn*9;Y++)if(isWithin(X.U8(G++),96,253))return
for(Y=0;Y<ord;Y++)if(!isWithin(X.U8(G++),1,ptn))return
return 1}})()&&(sName="Mlat Adlib Tracker module (.MAD)",bDetected=1,X.isVerbose())&&sOption("ord:"+ord+" ptn:"+ptn+" sz:"+outSz(G)),!bDetected&&(function(){if(X.c("'SONG'")&&(K=X.U32(4,_LE),G=8,v=X.U8(G++),trk=1<=v?X.U8(G++):4,fxprm=17<=v?X.U8(G++):1,fxc=17<=v?X.U8(G++):0,F=X.SC(G,4096,"CP1250"),G+=F.length+1,ptnr=X.U8(G++)+1,seqr=X.U8(G++)+1,ptnr)&&seqr){for(mcr=0,Y=eof=0;G<X.Sz()&&!eof;G+=X.U32(G+4))switch(X.SA(G,4)){case"SEQU":if(X.U8(G+8)>seqr)return
Y|=1
break
case"PATT":Y|=16
break
case"MACR":Y|=256,mcr=X.U8(G+8)
break
default:if(Y<17)return
eof=1}return K=G,1}})()&&(sName="Tero 'kometbomb' Lindeman's ProtoTracker module (.SONG)",bDetected=1,sVersion=sVersion="v"+v,X.isVerbose())&&(sOption(F),sOption("trk:"+trk+(fxc?" fx:"+fxc:"")+(mcr?" mcr:"+mcr:"")+" sz:"+outSz(K))),!bDetected&&(function(){if(X.c("'+SNT'")){for(Y=smp=0,G=4;Y<32;Y++){if(7<X.U8(G))return
if(1&X.U8(G++)){var s=X.U24(G),e=(G+=3+2*s,X.U24(G)),t=X.U24(G+3)
if(G+=6,s<e||s<t||t<e)return
s&&smp++}}for(vs=[],Y=ins=0;Y<16&&G<X.Sz();Y++){var r=X.U8(G++)
for(G+=r,r&&ins++,c=0;c<r&&G<X.Sz();c++){if(G+=2,!a())return
if(G+=1+55*X.U8(G),8<X.U8(G))return
if(!a())return
G+=10}if(1<(E=X.U8(G++)))return
if(E&&!n())return
if(1<(E=X.U8(G++)))return
E&&(G+=193)}for(G+=320,Y=0;Y<3;Y++){if(1&(fl=X.U8(G++))&&!n())return
if(2&fl&&!n())return
if(4&fl&&!n())return}if(X.c("'-SNT'",G)&&(G+=4,X.c("'GOAT'",G))){bad="",nv=X.U16(G+4),ch=X.U8(G+6),ptn=X.U8(G+7),ins=X.U8(G+8),bpm0=(bpm0=X.U8(G+9))||125,G+=12
for(ord=0,Y=0;Y<ch;Y++){X.U8(G++)
for(258==nv?E=X.U8(G++):(E=X.U16(G),G+=2),ord=Math.max(E,ord),c=0;c<E;c++)if(f=X.U16(G),G+=2,256<f&&(bad=bad.addIfNone("!badchnum")),f)for(U=256;U;U>>=1)f&U&&G++}var i
for(Y=0;Y<ptn;Y++){X.U8(G++)
for(258==nv?i=X.U8(G++):(i=X.U16(G),G+=2),i||(bad=bad.addIfNone("!badptnrows")),c=0;c<i;c++)if(f=X.U32(G),G+=4,f)for(U=65536;U;U>>=1)f&U&&(G+=4)}return 1}}function n(){switch(X.U8(G++)){case 1:if(1<X.U8(G+11)||!isWithin(X.F32(G+3),-.1,1.1))return
G+=12
break
case 2:if(1<X.U8(G+1)||1<X.U8(G+7))return
G+=14
break
case 3:G+=5
break
case 4:if(1<X.U8(G+9))return
G+=55
break
case 5:if(1<X.U8(G+1))return
G+=29
break
case 6:G+=9
break
case 7:G+=24
break
case 8:if(1<X.U8(G+24))return
G+=25
break
default:return}return 1}function a(){for(var s=X.U8(G++),e=0;e<s&&G<X.Sz();e++)if(!n())return
return 1}})()&&(sName="Fredrik 'Gnilk' Kling & Stefan 'Steffo' Hållén & Zyrax's Beaver Sweeper module (.GTK)",sVersion="v"+nv.toString(16).padStart(4,"0"),bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),bDetected=1,X.isVerbose())&&sOption("ch:"+ch+" bpm0:"+bpm0+" ord:"+ord+" ptn:"+ptn+(ins?" ins:"+ins:"")+" smp:"+smp+" sz:"+outSz(G)),bDetected||!X.c("'mpl'")||(G=X.U32(4,_BE))>X.Sz()||1&G||(songp=G+8,!X.c("'mdt'",G))||((G+=X.I32(G+4,_BE))>X.Sz()||1&G)||!X.c("'msm'",G)||(G+=X.I32(G+4,_BE))<X.Sz()||(K=G,smpp=songp+X.I32(songp-4,_BE),smpsz=X.I32(smpp-4,_BE),smp=X.I16(songp+20,_BE)-X.I16(songp+18,_BE)>>2,songsz=songp-8,k=X.I16(songp+4,_BE)-X.I16(songp+2,_BE)>>2,G=X.I16(songp,_BE),ord=X.I16(songp+6,_BE)-G-X.I32(songp+G+12,_BE),!1)||(sName="Anders 'Zonix' 0land's Music & Player module (.HOT)",bDetected=1,sVersion="v"+X.SA(3,1),X.isVerbose()&&(1<k&&sOption(k,"×"),sOption("ord:"+ord+" smp:"+smp+" songsz:"+Hex(songsz)+" smpsz:"+Hex(smpsz)),sOption(outSz(K),"sz:"))),!bDetected&&(function(){var s,e
if(/(UN0[4-6].*|APUN\x01[1-6])/.test(X.SA(0,6))&&(G=4,voc=0,"N"!=X.SA(3,1)?6<(s=X.U8(3)-48)&&(s=X.U16(4,_BE)):s=256,6<=s?(e=_BE,6==s?G++:(s=X.U16(G,e),G+=2),flg=X.U16(G,e),G+=2,ch=X.U8(G++),voc=X.U8(G++),ord=X.U16(G,e),ptn=X.U16(G+2,e),trk=X.U16(G+4,e),ins=X.U16(G+6,e),smp=X.U16(G+8,e),reppos=X.U16(G+10,e),G+=12,spd0=X.U8(G++),tmp0=X.U8(G++),vol0=X.U8(G++),262<=s?(bpmlimit=X.U16(G,e),G+=2):bpmlimit=32):(e=_LE,ch=X.U8(G++),ord=X.U16(G,e),G+=2,5==s?(lp=X.U16(G,e),G+=2):lp=0,ptn=X.U16(G,e),trk=X.U16(G+2,e),ins=X.U16(G+4,e),G+=6,smp=0,spd0=X.U8(G++),tmp0=X.U8(G++),G+=288,flg=X.U8(G++),bpmlimit=32),sv="N"==X.SA(3,1)?"v.APlayer":"v"+Hex(s),!(s<6&&!isWithin(ch,1,32)&&!isWithin(ord,1,256)||lp>ord))&&trk&&ptn&&isWithin(ins,1,256)&&spd0&&tmp0){if(titlesz=X.U16(G,_LE),titlep=G+2,G+=2+titlesz,s<258?(origssz=X.U16(G,_LE),origsp=G+2,G=p1=G+2+origssz,G=origsp+origssz):origssz=0,cmtsz=X.U16(G,_LE),cmtp=G+2,G+=2+cmtsz,6<=s&&(G=(G+=256<=s?2*ord:ord)+3*ch),smps=[],inss=[],smpsz=0,6<=s){for(Y=0;Y<smp;Y++)smpsz+=X.U32(G+7,e),E=X.U16(G+35,_LE),G+=37,smps.push(X.SC(G,E,"CP437").trim()),G+=E
for(Y=0;Y<ins;Y++)G+=13,pt=X.U8(G+1),G+=6+4*(256<=s?32:pt),pt=X.U8(G+1),G+=6+4*(256<=s?32:pt),pt=X.U8(G+1),G=(G+=6+4*(256<=s?32:pt))+(259<=s?240*smp:120*smp),E=X.U16(G,_LE),G+=2,inss.push(X.SC(G,E,"CP437").trim()),G+=E}else for(Y=0;Y<ins;Y++)for(smpn=X.U8(G),smp+=smpn,G+=209,E=X.U16(G,_LE),G+=2,E&&(inss.push(X.SC(G,E,"CP437").trim()),G+=E),c=0;c<smpn;c++)smpsz+=X.U32(G+5,e),E=X.U16(G+19,_LE),G+=21,E&&(smps.push(X.SC(G,E,"CP437").trim()),G+=E)
for(G+=2*ptn+2*ch*ptn,Y=0;Y<trk;Y++)G+=X.U16(G,e)+2
return K=G+smpsz,1}})()&&(sName="Otto Chrons/libmikmod UNIMOD/UNITRK module (.UNI)",sVersion=sv,bDetected=1,X.isVerbose())&&(sOptionT(X.SC(titlep,titlesz,"CP437")),origssz&&sOptionT(X.SA(origsp,origssz),"orig: "),sOptionT(X.SC(p1+2,X.U16(p1),"CP437")),sOption(addEllipsis(inss.filter(funSampleName).join(" ")),'ins/msg:"','"'),sOption("ch:"+ch+(voc?"/"+voc:"")+" spd0:"+spd0+" tmp0:"+tmp0+" trk:"+trk+" ord:"+(lp?lp+"~":"")+ord+" ptn:"+ptn+" ins:"+ins+(smp?" smp:"+smp:"")+" sz:"+outSz(K))),!bDetected&&X.isDeepScan()&&(function(){if(!(X.Sz()<40||65535<=X.Sz())){if(X.c("0001.... 000D00")&&X.c("FFFF",11))nV=0
else{if(!X.c("01..01.. 000F00")||!X.c("FFFF",13))return
nV=1}if(!((seqp=X.U16(3,_LE))<13||seqp>X.Sz())){for(k=1,seqtest=X.fSig(seqp+18+9,TOEOF,"0000000000 FFFF")-seqp;32<seqtest;)if(k++,seqtest-=32,!X.c("0000000000",seqp+seqtest))return
if(trkp=E=X.U16(5,_LE),X.c("FFFF",trkp-2)&&!(trkp<13)&&(insp=X.U16(7,_LE),X.c("FFFF",insp-2))&&!(insp<13)&&(K=X.U16(9,_LE),X.c("FFFF",K-2))&&!(K<13)&&(1!=nV||(sfxp=X.U16(11,_LE),X.c("FFFF",sfxp+8)))&&!(Math.abs(trkp-seqp)<20||Math.abs(trkp-insp)<20||Math.abs(seqp-insp)<20)){for(oldp=trkp,G=X.U16(trkp,_LE),ip=0,once=0;E<trkp+18&&trkp<X.Sz();){if((G=E===trkp?oldp=E:G)&&(oldp=G),!(G=X.U16(E,_LE))||G<trkp||G>X.Sz())return
if(!X.c("FFFF",G-2)&&1<++once)return
if(G<oldp&&2<++ip)return
for(q=G;!X.c("FFFF",q)&&q<X.Sz();)q+=2
if(!X.c("FFFF",q))return _log("D00nohdr: boh. t="+Hex(E)+" p="+Hex(G)+" q="+Hex(q)),0
E+=2}return r="",0<(E=X.fSig(K,512,"FFFF"))?(r=X.SC(K,E-K,"CP437").trim(),K=E+2):(r=X.readBytes(K,Math.min(K+256,X.Sz())-K),l=charStat(r,1),r=0<=l.indexOf("allxsc")?(r=decEncoding(r,CP437),K+=r.length,r.trim()):""),1}}}})()&&(sName="Jens Christian 'JCH/Vibrants' Huus's Edlib Tracker module (.D00)?",sVersion="old v"+X.U8(0),bDetected=1,X.isVerbose())&&(1<k&&sOption(k,"×"),sOptionT(addEllipsis(r,256,128),'msg:"','"'),sOption("sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<1084)){var s=X.readBytes(1080,4),e=X.SA(1080,4),t=1084,r=isGenericMCh=isMdKd=maybeWOW=isHMNT=isInconexia=isNoiseTracker=setMODVBlankTiming=hasLongSmp=hasEmptySmpwVol=hasRepLen0=!1,i=0,n=40
if(/(M\.K\.|M!K!|PATT|NSMS|LARD)/.test(e))chn=4,tracker="generic Protracker-compatible","M.K."===e&&(isMdKd=!0,maybeWOW=!0)
else if(/(M&K!|FEST|N\.T\.)/.test(e))chn=4,"N.T."===e?tracker="Pex 'Mahoney' Tufvesson & Anders 'Kaktus' Berkeman's NoiseTracker":(tracker="Pex 'Mahoney' Tufvesson & Anders 'Kaktus' Berkeman's His Master's NoiseTracker",isHMNT=!0),isNoiseTracker=!0
else if(/O[KC]TA/.test(e))chn=8,tracker="Armin Sander's Oktalyzer"
else if(/CD[68]1/.test(e))chn=s[2]-48,tracker="Christian Dahl et al.'s Octalyser STE (Atari)"
else if(compareArrays(s,[77,0,0,0])||compareArrays(s,[56,0,0,0]))chn=56===s[0]?8:4,n=1,tracker="Inconexia demo",isInconexia=!0
else if(/FA0[4-8]/.test(e))chn=s[3]-48,tracker="Digital Tracker",t=1088
else if(/(FLT|EXO)[48]/.test(e))4==(chn=s[3]-48)&&i++,r=setMODVBlankTiming=!0,tracker="Startrekker"
else if(/[1-9]CHN/.test(e))chn=s[0]-48,isGenericMCh=!0,tracker="generic MOD-compatible"
else if(/[1-9][0-9]C[HN]/.test(e))chn=10*s[0]+s[1]-528,isGenericMCh=!0,tracker="generic MOD-compatible"
else if(/TDZ[1-3]/.test(e))chn=s[3]-48,tracker="Twaddler and Dr. Zon's TakeTracker"
else{if(!/WARD/.test(e))return
chn=8,isGenericMCh=!0,tracker="generic MOD-compatible"}if(chn){for(restartpos=X.U8(951),G=20,wowsmpsz=ib=0;G<950;G+=30){var a=X.U16(G+22,_BE)<<1,o=(wowsmpsz+=a,!isHMNT&&!hasLongSmp&&131072<=a&&(hasLongSmp=!0),X.U8(G+24)),p=X.U8(G+25),d=X.U16(G+26,_BE)<<1,c=X.U16(G+28,_BE)<<1
if((o||a&&64!=p)&&(maybeWOW=!1),15<o&&ib++,64<p&&ib++,a||64!=p||(hasEmptySmpwVol=!0,i&&!d&&c<=2&&i++),a<d&&ib++,hasRepLen0||!a||c||(hasRepLen0=!0),ib>n)return}isFLT8=r&&8==chn
wowsmpsz
if((maybeWOW=restartpos?!1:maybeWOW)||(wowsmpsz=0),2<=i&&(tracker+="/Audio Sculpture"),ord=X.U8(950)){if(ol=X.readBytes(952,128),128<ord)ord=128
else if(!ord)for(ord=128;1<ord&&!ol[ord-1];)ord--
for(ptn=iptn=optn=0,Y=952,Y=0;Y<128;Y++){isFLT8&&(ol[Y]/=2)
var m=ol[Y]
m<128&&m>=ptn&&(ptn=m+1,Y<ord)&&(optn=ptn),ptn>=iptn&&(iptn=ptn+1)}var s=-2&X.Sz(),f=(wowsmpsz&&wowsmpsz+t+8*ptn*256==s?h(t+4*ptn*256)<16&&(chn=8):ptn!=optn&&64<h(t+optn*chn*256)&&(ptn=optn),iptn>ptn&&t+a+iptn*chn*256==s&&(ptn=iptn),maybeWOW&&8===chn&&(tracker="Mod's Grave",isGenericMCh=!0),(restartpos>=ord||120==restartpos&&4===chn)&&(restartpos=0),!0)
leftPan=extPan=maxPan=0
if(!isNoiseTracker){for(isNoiseTracker=isMdKd&&!hasEmptySmpwVol&&!hasLongSmp,G=t,m=0;m<ptn;m++)for(var l=0;G<m*chn*256;G+=4){var b=X.readBytes(G,4),S=(15&b[0])<<8|b[1],S=(S&&4095!=S&&f&&(S<113||856<S)&&(f=isNoiseTracker=!1),15&b[2]),b=b[3];(6<S&&S<10||14==S&&1<b||15==S&&31<b||13==S&&1<++l)&&(isNoiseTracker=!1),8==S&&(b>maxPan&&(maxPan=b),b<128?leftPan=!0:143<b&&164!=b&&(extPan=!0))}leftPan&&!extPan&&maxPan}if(f&&!hasRepLen0&&0<=["M.K.","M!K!","PATT"].indexOf(e)||!f&&127==restartpos&&isMdKd&&restartpos+2>=ord&&(tracker="Sami 'Psi/Future Crew' Tammilehto's Scream Tracker"),!((K=t+ptn*chn*256)>X.Sz())){G=20,smp=0,songsz=K,ib=0,smps=[]
for(var U=0;G<950;G+=30)isHMNT||(E=X.readBytes(G,22,!0),(E=decEncoding(E,CPAmiga).trim()).length&&smps.push(E)),(a=2*X.U16(G+22,_BE))&&smp++,X.c("'ADPCM'",K)&&(U++,a=5+(a+1>>1)+16),K+=a
if(X.c("8BBEB4BA 8BADBEBC B4BAAD",K)){for(var u=[];K<X.Sz()&&isWithin(223^X.U8(K),10,127);)u.push(223^X.U8(K++))
r=decEncoding(u,CP437),tracker="Twaddler and Dr. Zon's TakeTracker",/\ version\ \d+\./.test(r)&&(tracker+=" v"+/\ version\ (\d[^!]+)/.exec(r)[1])}else isMdKd&&X.c("001155332211",K)&&(tracker="Tetra Music Editor:"+X.U24(K+6,_BE).padStart(6,"0"),K+=9)
return U&&!isInconexia&&(tracker+=" (ADPCM packed: "+U+")"),1}}}}function h(s){var e=0
for(Y=0;Y<64*chn;Y++)224&X.U8(s+(Y<<2))&&e++
return e}})()&&(sName="Amiga Freelancers' Protracker module (.MOD)",bDetected=1,sVersion=X.SA(1080,4),X.isVerbose())&&(sOptionT(decAnsi(0,20,CPAmiga)),sOption(tracker,"in: "),sOptionT(addEllipsis(smps.filter(funSampleName).join(" "),200),'smp/msg:"','"'),sOption("ch:"+chn+" ord:"+ord+" ptn:"+(optn!=ptn?optn+"/":"")+ptn+(iptn!=ptn?"("+iptn+")":"")+" smp:"+smp+" sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<2240)&&X.c("'KRIS'",952)&&!(128<(ord=X.U8(956))||127<(loop=X.U8(957))||loop<127&&loop>=ord)){G=22
var s=ib=0
smp=synwf=0,smps=[]
for(var e=0;e<31;G+=30,++e)if(X.U8(G)){""!=(E=X.SC(G,20,"IBM850").trim())&&""!=E&&smps.push(E)
var t=2*X.U16(G+22,_BE)
if(s+=t,240&X.U8(G+24)&&ib++,64<X.U8(G+25)&&ib++,2*X.U16(G+26,_BE)>t&&ib++,40<ib)return
smp++}else{t=Math.max(X.U8(G+1),X.U8(G+5),X.U8(G+10),X.U8(G+19))
t&&t>=synwf&&(synwf=t+1)}for(ptn=0,G=958,ord=X.U8(956),e=0;e<ord<<2;e++,G+=2)ptn<X.U8(G)&&(ptn=X.U8(G))
return ptn++,K=1984+(synwf<<6)+(ptn<<8)+s,1}})()&&(sName="Krister Wombell's ChipTracker module (.KRIS,.MOD)",bDetected=1,X.isVerbose())&&(sOption(X.SA(0,16)),sOptionT(addEllipsis(smps.join(" "),200),'smp/msg:"','"'),sOption("ord:"+(loop&&loop<127?loop+"-":"")+ord+" ptn:"+ptn+" smp:"+smp+(synwf?" synwf:"+synwf:"")+" sz:"+outSz(K))),!bDetected&&(function(){if(X.c("'MTN'000000",1464))tracker="MnemoTroN's SoundTracker"
else{if(!X.c("'IT10'00",1464))return
tracker="Icepic's IceTracker 1.0~2'"}for(smp=smpsz=0,smps=[],G=20;G<950;G+=30)""!=(E=decAnsi(G,22,CPAmiga).trim())&&smps.push(E),(A=X.U16(G+22,_BE))&&smp++,smpsz+=A
if(ord=X.U8(G++),ptn=X.U8(G++),!(128<ord)){for(Y=0;Y<512;Y++)if(X.U8(G++)>ptn)return
return K=1468+64*ptn*4+smpsz,1}})()&&(sName=tracker+" module (.ST26,.ICE)",sVersion="v2.6",bDetected=1,X.isVerbose())&&(sOptionT(decAnsi(0,20,CPAmiga)),sOptionT(addEllipsis(smps.join(" "),128),'smps/msg:"','"'),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+K)),!bDetected&&(function(){if(X.c("'MVM'00")&&X.U8(4)&&X.U8(5)&&!(1e4<X.U32(6))&&X.U8(10)){var s=[],e=[],t=[]
for(G=10,mach=X.U8(G++),Y=0;Y<mach;Y++)s.push(X.U8(G++))
for(Y=0;Y<mach;Y++){if(E=X.U8(G++),0<=e.indexOf(E))return
e.push(E),t.push(Y)}var r=X.U8(G++)
for(Y=0;Y<r;Y++){var i=X.U8(G++),n=X.U8(G++)
if(G++,i>mach||n>mach||i==n)return
t=t.filter(function(){return t.indexOf(i)<0&&t.indexOf(n)<0})}return t.length?void 0:1}})()&&(sName="Gargaj/Conspiracy's MVX Module (.MVM)",bDetected=1,X.isVerbose())&&sOption("bpm0:"+X.U8(4)+" ticks:"+X.U8(5)+" rows:"+X.U32(6)+" machines:"+mach),!bDetected&&(function(){if(/MED[\x02-\x04]/.test(X.SA(0,4))){switch(nV=X.U8(3)){case 2:sVersion="v1.12"
break
case 3:sVersion="v2.00"
break
case 4:sVersion="v2.10+"}if(k=1,G=K=ptn=ord=trk=midi=syhy=smp=realsmp=0,smps=[],cs=bad="",!(nV<3)){var s=X.U8(4)
for(G=5;s;){if(1&s)for(var e=X.U8(G++);e;)smp+=1&e,e>>=1
s>>=1}for(Y=0;Y<smp;Y++){if(fl=X.U8(G++),smpnl=X.U8(G++),smps.push(X.SA(G,smpnl)),G+=smpnl,1&fl||(G+=2),2&fl||(G+=2),4&fl||G++,8&fl||G++,64<(T=48&fl?T:X.U8(G++)))return
64&fl||G++}for(Y=62;0<=Y;Y--)if(smps[Y]&&smps[Y].length){realsmp=Y+1
break}if(ptn=X.U16(G,_BE),!(ord=X.U16(G+2,_BE))||256<ord)return
for(G+=4,Y=0;Y<ord;Y++)if(X.U8(G++)>ptn)return
for(extsmp=!(8&X.U8(G+3)),tmp0=X.U16(G,_BE)+"//"+X.U16(G+4,_BE),G+=26,Y=0;Y<16;Y++)if(64<X.U8(G++))return
if(64<(mvol=X.U8(G++)))return
if(G>X.Sz())return
function t(){var s=X.U32(G,_BE)
G+=4
for(var e=0;e<32;e++)2147483648&(s=s<0?-s:s)&&(midi++,G++),s<<=1}for(3===nV&&(t(),t()),Y=0;Y<ptn;Y++){var r=X.U8(G++),i=X.U8(G),n=(trk<i&&(trk=i),X.U8(G+1),X.U16(G+2,_BE))
G+=r+n}if(!extsmp){var a=new BitReader(G,_BE),o=0
for(a.read(1),Y=0;Y<realsmp;Y++)o+=a.read(1)
for(a=void 0,G+=8,Y=0;Y<o;Y++)n=X.U32(G,_BE),hktp=X.U16(G+4,_BE),G+=6,65535!=hktp&&65534!=hktp||syhy++,G+=n}if(X.c("'MEDV'",G))for(;G+8<=X.Sz()&&/[A-Z]{4}/.test(X.SA(G,4));){switch(hkhd=X.SA(G,4),n=X.U32(G+4,_BE),G+=8,hkhd){case"MEDV":sVersion="v"+X.U8(G+2)+"."+X.U8(G+3).padStart(2,"0")
break
case"ANNO":cs=X.SC(G,n,"CP1252")
break
case"HLDC":break
default:_log("Unknown MED header: "+hkhd)}G+=n}}return(K=G)>X.Sz()&&(bad="!short"),1}})()&&(sName="OctaMED module (.MED)",bDetected=1,""!=bad&&(sVersion+="/malformed"+bad),X.isVerbose())){for(sOptionT(cs);""==smps[smps.length];)delete smps[smps.length]
smps.length&&sOption("["+smps.join(",")+"]","smps:"),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+(realsmp!=smp?"("+realsmp+")":"")+(extsmp?"(ext.)":"")+(syhy?" synth+hybrid:"+syhy:"")+(midi?" midi:"+midi:"")+" trk:"+trk+" tmp0:"+tmp0+" mvol:"+mvol+" sz:"+outSz(K))}if(!bDetected&&(function(){if(X.c("'MMD'")&&!((nV=X.U8(3)-48)<0||3<nV)){switch(nV){case 0:C="MED module (.MED,.MMD0)",sversion="v2.1 Med MoDule 0"
break
case 1:C="OctaMED Professional module (.MED,.MMD1)",sversion="v.3.00-4.x"
break
case 2:C="OctaMED Professional module (.MED,.MMD2)",sversion="v5.x"
break
case 3:C="OctaMED Professional module (.MED,.MMD3)",sversion="v6.x?"}if(!((ptnsp=X.U32(16,_BE))<52||(smpsp=X.U32(24,_BE))&&smpsp<52||(expp=X.U32(32,_BE))>X.Sz()||(sec=G=0,(sngp=X.U32(G+8,_BE))<52)||4294966535<sngp||X.Sz()<Math.max(sngp+504+256,ptnsp,smpsp||52,expp+52))){songname=anno=iinfo="",ch=4,xsngs=X.U8(51),k=expp?xsngs+1:1,expp&&((psongname=X.U32(expp+44,_BE))&&(songnamelen=X.U32(expp+48,_BE))&&(songname=X.SC(psongname,songnamelen,"CP1252")),0<(pannotxt=X.U32(expp+12,_BE))&&(annolen=X.U32(expp+16,_BE),anno=X.SC(pannotxt,annolen,"CP1252")),0<(pMMDInstrInfo=X.U32(expp+20,_BE)))&&(iinfo=X.SC(expp,40,"CP1252")),ptn=0,ord=[]
var s=X.U32(16,_BE)
for(Y=0;Y<k;Y++){for(G=sngp+504,32767<(ptn1=X.U16(G,_BE))&&(ch=4),ptn+=ptn1,c=0;c<ptn1;c++)(pj=4*c+s)>X.Sz()||(pj=X.U32(pj,_BE))>X.Sz()||(pj=nV<1?X.U8(pj+4):X.U16(pj+4,_BE))>ch&&(ch=pj)
if(nV<2){if(ord[0]=X.U16(G+2,_BE),256<ord[0])return}else{if(sec=X.U16(G+2,_BE),!(trk=X.U16(G+16,_BE))||64<trk)return
if((sectp=X.U32(G+8,_BE))+2*sec>X.Sz())continue
for(playseqtp=X.U32(G+4,_BE),nplayseq=X.U16(G+18,_BE),secs=[],c=0;c<sec;c++)secs.push(X.U16(sectp+2*c,_BE))
for(c=0;c<secs.length;c++)c<=nplayseq&&ord.push(X.U16(X.U32(playseqtp,_BE)+40,_BE))}if((expp=X.U32(sngp+32,_BE))&&(X.U32(expp,_BE)<sngp||expp>X.Sz())){k=Y+1
break}sngp=X.U32(expp,_BE)}return 63<(smp=X.U8(G+283))?void 0:1}}})()&&(sName=C,sVersion=sversion,bDetected=1,X.isVerbose())&&("<unnamed>"!=songname&&"<ohne Namen>"!=songname&&sOption(songname),sOptionT(anno),sOptionT(iinfo,"ins0:"),1<k&&sOption(k,"×"),sOption((X.isDeepScan()?"ch:"+ch+" ":"")+"ord:"+ord.join("+")+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(X.U32(4,_BE)))),!bDetected&&(function(){if(!(X.Sz()<30)){if(X.c("'THX'0."))fmt="ahx"
else{if(!X.c("'HVL'0."))return
fmt="hvl"}bad=0
var s=X.U8(6)
switch(trk0saved=s>>7,s>>4&7){case 0:spd="50Hz"
break
case 1:spd="100Hz"
break
case 2:spd="150Hz"
break
case 3:spd="200Hz"
break
default:bad++,spd="?Hz"}if(999<(ord=4095&X.U16(6,_BE))&&bad++,(!ord||1024<ord)&&bad++,"ahx"===fmt?(lp=X.U16(8,_BE))>=ord&&bad++:chn=4+(X.U8(8)>>2),!(1<bad)&&(trl=X.U8(10))&&!(64<trl)&&(trk=X.U8(11),!(63<(ins=X.U8(12))))){if(sub=X.U8(13),"ahx"===fmt)for(K=14+2*sub+8*ord+trk*trl*3,trk0saved||(K+=3*trl),Y=0;Y<ins;Y++){var e=X.U8(K+21)
K+=22+4*e}else{for(K=16+2*sub+ord*chn*2,Y=trk0saved?1:0;Y<=trk;Y++)for(c=0;c<trl;c++)63==X.U8(K)?K++:K+=5
for(Y=0;Y<ins;Y++){e=X.U8(K+21)
K+=22+5*e}}for(F="",Y=0;Y<=ins;Y++){for(var t=K;X.U8(K)&&K<X.Sz();)K++
Y||(F=X.SA(t,K-t)),K++}return K>X.Sz()&&bad++,1}}})()&&("ahx"===fmt?(sName="Abyss' Highest eXperience module (.AHX)",sVersion=X.U8(3)?"v2.0+":"v1.00~1.27"):sName="Hively Tracker module (.HVL)",bDetected=1,bad&&(sVersion+="/malformed"+bad),X.isVerbose())){for(""!=F&&sOption(F),sub&&sOption(sub,"×"),n=0,G=14+2*sub+8*ord,l=trk*trl,trk0saved||(l+=trl),hp=!1,Y=0;Y<l;Y++)(note=X.U8(G+3*Y)>>2)&&n++,60<note&&"ahx"==fmt&&(hp=!0)
hp&&(sVersion+="/hi-pitch!"),"ahx"===fmt?sOption("spd:"+spd+" ord:"+ord+" lp:"+lp+" trk:"+trk+" ins:"+ins+" notes:"+n+" sz:"+outSz(K)):sOption("ch:"+chn+" spd:"+spd+" ord:"+ord+" trk:"+trk+" ins:"+ins+" notes:"+n+" sz:"+outSz(K))}if(!bDetected&&(function(){if(!(X.Sz()<960)&&X.c("000003C0",8)){ins=0,smp=[]
var s=olds=0
for(G=0;G<434;G+=14){if(64<X.U8(G+3)||(A=X.U16(G,_BE))<X.U16(G+4,_BE))return
if(!isWithin(sofs=X.U32(G+8,_BE),960,X.Sz())||sofs%2)return
if(s+=A<<1,X.U16(G,_BE)&&ins++,smp.includes(sofs)||smp.push(sofs),G&&2<Math.abs(sofs-olds))return
olds=sofs+(A<<1)}if(smp=smp.length,isWithin(s,3,2031585)){var e=0,t=4294967295
for(ptn=[],G=448;G<960;G+=4){if((E=X.U32(G,_BE))+2<s+960||E>X.Sz())return
e=Math.max(e,E),t=Math.min(t,E),ptn.includes(E)||ptn.push(E)}if(!(t%2||2<Math.abs(960+s-t))){for(ord=127,G=952;448<G&&X.U32(G,_BE)==E;G-=4,ord--)E=X.U32(G,_BE)
for(ptn=ptn.length,G=e,Y=0;Y<256;Y++)192<=X.U8(G)?(Y+=254-X.U8(G+1),G+=2):G+=4
return K=G,1}}}})()&&(sName="Azatoth/Phenomena's Pha Packer module (.PHA)",bDetected=1,X.isVerbose())&&sOption("ord:"+ord+" ptn:"+ptn+" ins:"+ins+" smp:"+smp+" sz:"+outSz(K)),!bDetected&&zs()&&(sName=tracker+" (."+ext+")",bDetected=1,X.isVerbose())&&(sOptionT(X.SC(0,20,"CP437")),sOptionT(addEllipsis(smpn.filter(funSampleName).join(" ")),'smp/msg: "','"'),sVersion="STM"===ext?"v"+X.U8(30)+"."+nVm:"v1."+fmt,tmp0=X.U8(32),gvol=X.U8(34),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" gvol:"+gvol+" sz:"+outSz(K))),!bDetected&&Es()&&(sName="it"===type?"Impulse Tracker module (.IT)":"OpenMPT module (.MPTM)",bDetected=1,"?"!=sV&&(sVersion="v."+sV),""!=bad&&(sVersion+="/malformed"+bad),X.isVerbose())&&(sOptionT(decAnsi(4,26,charset)),X.isDeepScan()&&(sOption(tracker,"in: "),sOptionT(auth,"by: "),sOption(addEllipsis(extsmp.join(", "),64,48),'ext.smp: "','"'),sOption(addEllipsis(chnm.join(", "),80,48),'ch.names: "','"')),1&special&&sOptionT(addEllipsis(X.SC(msgofs,Math.min(msglen,256),"CP437"),192),'msg: "','"'),sOption(addEllipsis(insnlst.filter(funSampleName).join(" "),128,48),'ins/msg: "','"'),sOption(addEllipsis(smpnlst.filter(funSampleName).join(" "),128,48),'smp/msg: "','"'),X.isDeepScan()?sOption("bpm0:"+tmp0+" spd0:"+spd0+" ch:"+ch+" ord:"+ord+(ord!=cord?"("+cord+")":"")+" ptn:"+ptn+" ins:"+ins+" smp:"+smp+(tunings?"tunings:"+tunings:"")+" sz:"+outSz(K)):sOption("bpm0:"+tmp0+" spd0:"+spd0+" ch:"+ch+" ord:"+ord+" ptn:"+ptn+" ins:"+ins+" smp:"+smp)),!bDetected&&(function(){if(X.c("'RIFF'........'AM  '"))align=1
else{if(!X.c("'RIFF'........'AMFF'"))return
align=0}if(X.c("C5",88)){for(K=X.U32(4,_LE)+8,G=12,ok=ord=ptn=smp=ins=0,mptn=-1,insts=[],E="";G<K&&G<X.Sz();){switch(hkhd=decAnsi(G,4,"CP437",!1),hksz=X.U32(G+4,_LE),G+=8,hkhd){case"INIT":case"MAIN":ok=1
break
case"ORDR":for(ord=hksz,loop=X.U8(G),Y=G+1;Y<G+hksz;Y++)mptn<X.U8(Y)&&(mptn=X.U8(Y))
mptn++
break
case"PATT":ptn++
break
case"RIFF":smp++
break
case"INST":for(ins++,E=X.readBytes(G+2,25,!0),""!=(E=decEncoding(E,"CP437").trim())&&insts.push(E.trim()),insn=X.U8(G+1),subsmp=X.U16(G+30,_LE),q=G+225;q<G+hksz;)hhd=decAnsi(q,4,CP437),hsz=X.U32(q+4),q+=8,"SAMP"==hhd&&smp++,t_=decAnsi(q,256,CP437),q+=hsz,0<debug&&q<G+hksz&&["SAMP","INST"].indexOf(decAnsi(q,4,"CP437"))<0&&_log(" | ^WTF J2B @"+Hex(q-hsz)+"->"+Hex(q))}G+=hksz+align*(1&hksz)}return!(K<G)&&ok&&ord&&ptn&&(smp||ins)?1:void 0}})()&&(sName="Jazz Jackrabbit 2/Galaxy Sound System module (.J2B)",sVersion="v."+(align?"__":"FF"),bDetected=1,X.isVerbose())&&(sOptionT(X.SA(20,64)),sOptionT(addEllipsis(insts.join("\n"),256,160),'msg:"','"'),sOption("ord:"+ord+" loop:"+loop+" ptn:"+mptn+(mptn!=ptn?"/"+ptn:"")+(ins?" ins:"+ins:"")+(smp?" smp:"+smp:"")+" sz:"+outSz(K))),!bDetected&&(function(){if(X.c("00407F40 00C081C0")&&X.c("41FAFFEE",56)){G=180
for(var s=Math.min(65536,X.Sz());E=X.U16(G,_BE),(G+=2)<s&&20085!=E;);if(!(s<G)){for(playp=G;E=X.U16(G,_BE),(G+=2)<s&&57340!=E;);if(!(s<G)){for(endp=G+=4;E=X.U16(G,_BE),(G+=2)<s&&20085!=E;);if(!(s<G)){for(;E=X.U16(G,_BE),(G+=2)<s&&32258!=E;);if(!(s<G)){for(songp=G+X.U16(G+2,_BE)+2,d0=X.U32(songp,_BE)>>2,k=d0/3,a1=G=songp,d5=0;d0--;)for(G=songp+X.U32(a1,_BE),a1+=4;G<s&&(E=X.U32(G,_BE),G+=4,E);)E>d5&&(d5=E)
for(K=songp+d5;135!=(E=X.U8(K++)););return 1}}}}}})()&&(sName="Rob Hubbard ST module (.RHO)",sVersion="v1.1",bDetected=1,X.isVerbose())&&(1<k&&sOption(k,"×"),sOption(outSz(K),"sz:")),!bDetected&&(function(){if(!(X.Sz()<9||(ptntp=X.U16(2,_LE),ord=X.U8(8),ptntp-ord!=9&&ptntp-ord!=72)||(smptp=X.U16(4,_LE))>X.Sz()||(orntp=X.U16(6,_LE))>X.Sz()||64!=X.U16(smptp,_LE)||64!=X.U16(orntp,_LE))){for(ptn=0,Y=0;Y<ord;Y++)G=X.U8(9+Y),ptn<G&&(ptn=G)
if(ptn++,X.U16(ptntp,_LE)==6*ptn){for(c=X.U16(orntp+64-2,_LE)+orntp;c<X.Sz()&&c<65535&&!(64&X.U8(c));)c+=2
if(bad="",65534<c||c>=X.Sz()){if(!X.isHeuristicScan())return
bad="/malformed!short"}return K=c+2,delay=X.U8(0),loop=X.U8(1),1}}})()&&(sName="A.'Andrew Strikes Code' Sendetskii/Power of Sound's ASC/Advanced Sound Master module (.ASC)",sVersion="v1.x-2.x"+bad,bDetected=1,X.isVerbose())&&(8<(pt=X.fSig(8,128,"'ASM COMPILATION OF '")+19)&&(pa=X.fSig(pt+19,32,"' BY '"),sOptionT(X.SA(pt,pa-pt)),sOptionT(X.SA(pa+4,20),"by: ")),sOption("ord:"+ord+" ptn:"+ptn+" delay:"+delay+" loop:"+loop+" sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<8||(ptntp=X.U16(1,_LE),ord=X.U8(7),ptntp-ord!=8&&ptntp-ord!=71)||(smptp=X.U16(3,_LE))>X.Sz()||(orntp=X.U16(5,_LE))>X.Sz()||64!=X.U16(smptp,_LE)||64!=X.U16(orntp,_LE))){for(ptn=0,Y=0;Y<ord;Y++)G=X.U8(8+Y),ptn<G&&(ptn=G)
if(ptn++,X.U16(ptntp,_LE)==6*ptn){for(c=X.U16(orntp+64-2,_LE)+orntp;c<X.Sz()&&c<65535&&!(64&X.U8(c));)c+=2
if(bad="",65534<c||c>=X.Sz()){if(!X.isHeuristicScan())return
bad="/malformed!short"}return K=c+2,delay=X.U8(0),1}}})()&&(bDetected=1,sVersion="v0.x"+bad,sName="Andrei 'Andrew Strikes Code' Sendetskii/Titus's Advanced Sound Master module (.AS0)",X.isVerbose())&&(7<(pt=X.fSig(7,128,"'ASM COMPILATION OF '")+19)&&(pa=X.fSig(pt+19,32,"' BY '"),sOptionT(X.SA(pt,pa-pt)),sOptionT(X.SA(pa+4,18),"by: ")),sOption("ord:"+ord+" ptn:"+ptn+" delay:"+delay+" sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<296)){G=41
var s,e=X.U16(5),t=X.U16(G-2)-e
for(Y=0;Y<14;Y++){if((s=X.U16(G)-e)-t<6||(s-t-2)%4||s>X.Sz())return
G+=2,t=s}for(t=X.U16(G)-e,G+=2,Y=0;Y<15;Y++){if((s=X.U16(G)-e)-t<3||s>X.Sz()||s-t!=2+X.U8(t+1))return
G+=2,t=s}for(K=s+2+X.U8(s+1),t=X.U16(G)-e,G+=2,Y=1;Y<96;Y++){if((s=X.U16(G)-e)-t<3||s>X.Sz())return
G+=2,t=s}if(ord=X.U8(G++),!((lp=X.U8(G++))>ord)){for(Y=0;Y<ord;Y++)if(X.U8(G++)%6)return
return X.U16(101)==G?1:void 0}}})()&&(sName="Doctor Max/Global Corp.'s' Global Tracker module (.GTR)",bDetected=1,sVersion="v"+(X.U8(4)>>4)+"."+(15&X.U8(4)),X.isVerbose())&&(dly=X.U8(0),ptn=X.U8(293),lp=X.U8(294),sOptionT(X.SA(7,32)),sOption("ord:"+(0<lp?lp+"-":"")+ord+" ptn:"+ptn+" delay:"+dly+" sz:"+outSz(K))),!bDetected&&X.isDeepScan()&&(function(){if(!(X.Sz()<512)){if(old=!1,bad="",!/V\.\d/.test(X.SA(26,3))){if(!X.c("'BPSM'",26))return
old=!0}if(!(525+16*(ord=X.U16(30,_BE))>X.Sz())){for(B=smp=0,Y=0;Y<15;Y++)if(255!=X.U8(32+32*Y)){if(sn=X.readBytes(32+32*Y,24),charStat(sn,CS_ALL).indexOf("xsc")<0)return
if(slen=X.U16(56+32*Y,_BE)<<1,lp=X.U16(58+32*Y,_BE),lpl=X.U16(58+32*Y,_BE),T=X.U16(62+32*Y,_BE),lpl>slen||lp-1>slen||lpl-1>slen)return
if(96<T)return
64<T&&(bad=bad.addIfNone("!badvol")),B+=slen,slen&&smp++}for(K=512+B+16*ord,old||(K+=64*X.U8(29)),ptn=0,Y=0;Y<16*ord;Y+=4)(G=X.U16(512+Y,_BE))>ptn&&(ptn=G)
return K+=48*ptn,1}}})()&&(bDetected=1,sName="Brian Postma's SoundMon module (.BP)",sVersion=old?"old":"v"+X.SA(28,1),""!=(bad=X.Sz()<K?bad.addIfNone("!short"):bad)&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose())&&(sOptionT(X.SA(0,26)),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<192)&&X.c("'SONG'",192)&&X.c("'INST'",200+X.U32(196,_BE))&&!((B=X.U32(10,_BE))<=2||1048560<=B)){for(smpdescs=0,smp=0,Y=0;Y<16;Y++){if((A=X.U16(14+2*Y,_BE))&&smp++,lpst=X.U16(78+2*Y,_BE),A<lpst)return
if(64<X.U8(46+2*Y))return
smpdescs+=A}if(!(smpdescs<=2||smpdescs>B)&&(ord=X.U8(111))&&!(40<ord)){for(ptn=0,Y=0;Y<40;Y++){if(40<(pt=X.U8(113+2*Y)))return
pt>ptn&&(ptn=pt)}return ptn++,(U=1024*ptn)+204>X.Sz()?void 0:(K=smpdescs+U+204,1)}}})()&&(sName="Andreas Fuchs's FuchsTracker module (.FUCHS)",bDetected=1,X.isVerbose())&&sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K)),!bDetected&&(function(){if(!(X.Sz()<444)&&X.c("000000",240)){for(smps=[],U=G=c=B=0;U<15;U++,G+=16){if(8388607<(o=X.U32(G,_BE))||1&o)return
if(65535<(j=X.U16(G+4,_BE)<<1))return
if(X.U8(G+6))return
if(64<X.U8(G+7))return
if(8388607<(p=X.U32(G+8,_BE))||1&p)return
if(2<(n=X.U16(G+12,_BE))&&n>j)return
if(1&X.U16(G+14,_BE))return
B+=j,j&&smps.push([o,j])}if(!(B<=4)){for(smps.sort(function(s,e){return s[0]-e[0]}),U=0;U<smps.length-1;U++)if(smps[U][0]+smps[U][1]>smps[U+1][0])return
if(ord=X.U8(243),isWithin(ord,1,100)){for(ptn=0,ords=[],Y=0;Y<100;Y++){if(1023&(G=X.U16(244+2*Y,_BE)))return
Y<ord&&(G>>=10)>ptn&&63!=G&&(ptn=G)}if(!(64<++ptn||(m=notes=badnotes=badled=0,end=!1,nps=[],(G=444)+1024*ptn>Math.min(X.Sz(),65532)))){for(Y=0;Y<ptn&&!end;Y++){for(badnotes=badled=0,c=0;c<256&&!end;c++,G+=4){if(d=X.readBytes(G,4),(np=(d[0]<<8)+d[1])&&65534!=np&&(isWithin(np,113,856)?(notes++,nps.includes(np)||nps.push(np),100<notes&&!X.isDeepScan()&&(end=!0)):badnotes++),d[2]&=15,3==d[2]&&64<d[3]&&badnotes++,4==d[2]&&99<d[3])return
if(5==d[2]&&d[3]>ord+1)return}if(16<badnotes)return 0<debug&&_log("GMCFault: over 16 bad notes"),0}return nps=nps.length,notes?(!(nps<=2)||X.isHeuristicScan())&&(K=444+1024*ptn+B,1):void 0}}}}})()&&(bDetected=1,sName="Andreas Tadic's Game Music Creator module (.GMC)",X.isVerbose())&&(sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smps.length+(X.isDeepScan()||notes<100?" notes:"+notes+"("+nps+" diff.)":"")+" sz:"+outSz(K)),X.Sz()<K)&&(sVersion="malformed!short"),!bDetected&&(function(){if(!(X.Sz()<377||(ord=X.U8(0),ofs=unpsz=0,220<ord&&ord<255))){for(255==ord?(ofs=1,ord=200):ord++,Y=0;Y<32;Y++)if(22<X.U8(163+ofs+Y))return
if(tmp0=X.U8(ofs+205)){for(G=ofs+376+ord,ptn=-1,Y=ofs+376;Y<G;Y++)(E=X.U8(Y))>ptn&&(ptn=E)
if(!(ptn<1||(ptnp=G+ofs,(ptn1=oldp=X.U16(ptnp))>X.Sz()))){for(Y=0;G<X.Sz()&&Y<ptn;Y++){if(G=X.U16(ptnp+2*Y),Y||(unpsz=G),G<ptnp+2*Y||G>X.Sz())return
if(Y&&256<G-oldp)return
oldp=G}if(ofs)G=ptn1
else if(G=ptnp+2*Y,unpsz!=G||G>X.Sz())return
for(;G<X.Sz()&&(l=X.U8(G++));)l<=242?unpsz++:unpsz+=l-242
return isWithin(G,376,15808)?(K=G,1):void 0}}}})()&&(sName="Remco Schrijvers et al.'s MSX MoonBlaster for MoonSound module (.MBM)",bDetected=1,ofs&&(sVersion="200-pos.ver."),"NONE"!=(drumkit=X.SA(ofs+320,8).trim())&&(sVersion=sVersion.appendS("+"+drumkit+".MBK","/")),X.isVerbose())&&(sOption(X.SA(ofs+207,40).trim()),sOption("tempo0:"+tmp0+" ord:"+ord+" ptn:"+ptn+" unpsz:"+unpsz+" sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<102)&&(tempo=X.U8(0),isWithin(tempo,2,15))&&!((ptntp=X.U16(67))>=X.Sz())){for(numofpos=X.U8(1),loop=X.U8(2),j1=65535,Y=c=0;Y<16;Y++){if((Q=X.U16(3+2*Y))>X.Sz())return
if(c<Q&&(c=Q),(op=X.U16(35+2*Y))>X.Sz())return
op&&j1>op&&(j1=op)}if(!(j1<103||c<103||65534<c||c>X.Sz()||c+3*X.U8(c)+2!=j1)){for(Y=c=0;Y<16;Y++){if((op=X.U16(35+2*Y,_LE))>X.Sz())return
c<op&&(c=op)}if(!(c<103||65536<(len=c+64)||len>X.Sz()+1)){for(c=99;c<=ptntp&&X.U8(c)<255;)c++
return c+1==ptntp?(ord=c-99,!(loop>ord)):void 0}}}})()&&(sName="Golden Disk ProTracker module (.PT1)",sVersion="v1.x/compiled",bDetected=1,X.isVerbose())&&(sOptionT(X.SA(69,30)),sOption("tempo:"+tempo+" ord:"+ord+" len:"+len)),!bDetected&&(function(){if(!(X.Sz()<132)&&(tmp=X.U8(0),isWithin(tmp,2,15))){var s=X.Sz()+512*X.isHeuristicScan()
if(ord=X.U8(1),lp=X.U8(2),!(!ord||lp>ord||131+ord>s-2)&&(smp0=X.U16(3),!((orn0=X.U16(67))-smp0>s+2||orn0<smp0))&&(ptnp=X.U16(99),isWithin(ptnp,101,orn0))){for(smp=orn=0,Y=mps=0,G=3;Y<32;Y++,G+=2){if((E=X.U16(G))&&(smp++,!isWithin(E,101,s-2)))return
E>mps&&(mps=E)}for(mp=0;Y<48;Y++,G+=2)if((E=X.U16(G))>mp&&(mp=E),E&&++orn<=2&&!isWithin(E,Math.max(mps,orn0),s))return
for(G=131,ptn=Y=0;Y<=255;Y++,G++){if(G>X.Sz()-2)return
if(255==(o=X.U8(G)))break
o>ptn&&(ptn=o)}if(ptn++,G++,ord==Y&&ptnp==G){for(rptn=0;G<X.Sz()&&(E=X.U16(G));rptn++,G+=2)if(!isWithin(E,ptnp+6*ptn,X.Sz()))return
return rptn==3*ptn?(K=mp+2+X.U8(mp),1):void 0}}}})()&&(sName="Golden Disk ProTracker module (.PT2)",sVersion="v2.x",bDetected=1,X.isVerbose())&&(0<=(nc=charStat(E=X.readBytes(101,30),1)).indexOf("allxsc")?sOptionT(decEncoding(E,CPSpeccy)):sOption("<broken title>"),sOption("tmp:"+tmp+" ord:"+(lp?lp+"-":"")+ord+" ptn:"+ptn+" smp:"+smp+" orn:"+orn+" sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<202)){G=0
var s=Math.min(65535,X.Sz()+512*X.isHeuristicScan()),e=[],t=[],r=[],i=[]
if(bad="",4<(ttn=X.U8(99))){if(!X.isHeuristicScan())return
bad=bad.addIfNone("!badtuning")}if(tmp=X.U8(100)){if(ord=X.U8(101),(ptnp=202+ord)!=X.U16(103)||ptnp>X.Sz()-2)return p("!badptnp+"+Hex(ptnp)),0
if((lp=X.U8(102))>ord-1)return p("!badlp"),0
for(orn=smp=mp=0,G=105;G<169;G+=2)X.U16(G)&&smp++
for(;G<201;G+=2)X.U16(G)&&orn++
for(ptn=Y=0,G=201;Y<=255&&255!=(o=X.U8(G++));Y++){if(o%3)return
i.indexOf(o/3)<0&&i.push(o/3),o/3>ptn&&(ptn=o/3)}if(ptn++,!Y||Y!=ord)return p("!realord:"+Y+" != ord:"+ord),0
for(E=X.readBytes(0,10),tracker="",nv=0<=charStat(E,1).indexOf("allasc")?"ProTracker"==(E=decEncoding(E,CPSpeccy))?(tracker="Pro Tracker",sv="v"+X.SA(11,4).trim(),X.U8(13)-48):(sv="Vortex Tra"==E?(tracker="Vortex Tracker ][","v"+X.SA(18,4).trim()):(tracker='"'+X.SA(0,14)+'"',"v3.x"),7):(tracker="hacked Pro Tracker",sv="v3.x",7),Y=notes=0;Y<3*ptn&&G<s;Y++,G+=2){if(!isWithin(E=X.U16(G),G,s))return p("!badptnp2:"+Hex(E)),0
if(!(i.indexOf(Util.divu64(Y,3))<0)&&!d(r,trk=[E,0])){for(var n=0,a=!1;!a&&n<256&&E<s;){for(eol=!1,z=0;!eol&&E<X.Sz();)0==(k=X.U8(E++))?eol=a=!0:1==k||8==k?z+=3:2==k?z+=5:0<=[3,4,6,9].indexOf(k)?z++:5==k?z+=2:7==k?bad=bad.addIfNone("!badcmd07h"):16==k?(k=X.U8(E++),y=X.U16(105+k),e.indexOf(k)<0&&(y&&!isWithin(y,ptnp,s)&&(bad=bad.addIfNone("!badsmp")),e.push(k))):k<32?(E+=2,k=X.U8(E++),y=X.U16(105+k),e.indexOf(k)<0&&(y&&!isWithin(y,ptnp,s)&&(bad=bad.addIfNone("!badsmp")),e.push(k))):k<64||(k<80?(k&=15,t.indexOf(k)<0&&(t.push(k),mp<(y=X.U16(169+2*k)))&&(mp=y)):k<176?(notes++,eol=!0):176!=k&&(177==k?n+=X.U8(E++):k<192?E+=2:192==k?eol=!0:k<208||(208==k?eol=!0:(y=(k=k<240?(31&k)<<1:(k&=15,t.indexOf(k)<0&&(t.push(k),mp<(y=X.U16(169+2*k)))&&(mp=y),X.U8(E++)),X.U16(105+k)),e.indexOf(k)<0&&(y&&!isWithin(y,ptnp,s)&&(bad=bad.addIfNone("!badsmp")),e.push(k))))))
if(n++,E+=z,z=0,256<n){if(!X.isHeuristicScan())return p("!badlines"),0
bad=bad.addIfNone("!badlns")}}trk[1]=E-trk[0],d(r,trk)||r.push(trk),mp<E&&(mp=E)}}if(E=findIntersections(r,!0).length){if(!X.isHeuristicScan()||5<E)return p("trackintersections"),0
bad=bad.addIfNone("!trkxsec")}if(E=findGaps(r,0).length){if(!X.isHeuristicScan()||5<E)return p("trackgaps"),0
bad=bad.addIfNone("!trkgap")}return(rsmp=e.length,rorn=t.length,!(rptn=i.length)||32<rsmp)?(p("!rptn="+rptn+",rsmp="+rsmp),0):X.fStr("compilation of",10,20)<0&&!rsmp?(p("!nosmp"),0):(K=mp+2+X.U8(mp+1),1)}}function p(s){1<debug&&_l2r("pt3",G,s)}function d(s,e){for(var t=0;t<s.length;t++)if(s[t][0]==e[0])return 1}})()&&(sName="Golden Disk ProTracker module (.PT3)",sVersion=sv,bDetected=1,(tsmode=7<=nv&&(32!=X.U8(98)||X.c("'Vortex Tra'",K)||X.c("'ProTracker v'",K)))&&(sVersion+=" TurboSound"),bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose())){switch(X.c("'by ",63)&&(sOptionT(decAnsi(30,32,CPSpeccy)),sOptionT(decAnsi(66,32,CPSpeccy),"by: ")),sOptionT(tracker,"in: "),ttn){case 0:sOption("tuning 0: 1625000Hz PT3.3")
break
case 1:sOption("tuning 1: Sound Tracker")
break
case 2:sOption("tuning 2: ASM/PSC 1.75MHz")
break
case 3:sOption("tuning 3: RS 1625000Hz")
break
case 4:sOption("tuning 4: Ivan Roshchin's Natural Cmaj/Am")
break
default:sOption("tuning "+ttn+"/custom")}sOption((tsmode?"1st chip info: ":"")+"tmp0:"+tmp+" ord:"+(lp?lp+"-":"")+ord+" ptn:"+(rptn!=ptn?rptn+"/":"")+ptn+" smp:"+(rsmp!=smp?rsmp+"/":"")+smp+" orn:"+(rorn!=orn?rorn+"/":"")+orn+" notes:"+notes+" sz:"+outSz(K))}if(bDetected||!ks(1)&&!ks(0)||(sName="Viktor 'KVA' Kuźmin's Pro Sound Creator module (.PSC)",sVersion=sv+"/compiled",bDetected=1,X.isVerbose()&&(ftitle&&sOptionT(decAnsi(25,20,CPSpeccy,!1,Chars0to1FSpeccy)),fby&&sOptionT(decAnsi(49,20,CPSpeccy,!1,Chars0to1FSpeccy),"by: "),sOption("ord:"+(0<lp?"("+lp+"-)":"")+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K)))),!bDetected&&(function(){if(!(X.Sz()<215)){var s=Math.min(65536,X.Sz())
switch(X.U8(50)){case 59:notet=0
break
case 1:notet=1
case 2:notet=2
default:return}if(!((ptnp=X.U16(75))>=X.Sz()||X.U16(146)<=X.U16(82))){for(G=212,ptn=0;G<468&&G<X.Sz()&&X.U8(G)<128;G+=2,ord++)ptn=Math.max(ptn,X.U8(G)+1)
if(lp=X.U8(70),!(468<=G||lp>ord)){var e=X.U16(ptnp)-(6*ptn+ptnp+2)
if(!(e<0||X.U16(82)-e>=X.Sz()||ptnp>=X.U16(82)-e||X.U16(146)-e>=X.Sz())){var t=65535,r=0,i=0
for(G=82;G<146;G+=2)i=Math.max(i,X.U16(G))
for(;G<212;G+=2)t=Math.min(t,X.U16(G)),r=Math.max(r,X.U16(G))
return i-e>=Math.min(65534,X.Sz())||s<=t-e||s<=r-e||i<=ptnp||i+3+5*(X.U8(i-e+2)+1)!=t?void 0:!((K=i+3+2*(X.U8(i-e+2)+1)-e)<ptnp)}}}}})()&&(sName="S.'Orion' Matveev & A.'Sand' Plużnikov's Fast Tracker module (.FTС)",bDetected=1,X.isVerbose())&&(sOptionT(X.SA(8,42)),sOption("ord:"+(0<lp?"("+lp+"-)":"")+ord+" ptn:"+ptn+(ofs?" ofs:"+Hex(ofs):"")+" sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<3585)){for(G=smp=0;smp<15;smp++){for(Y=0;Y<32;Y++)if(15<X.U8(G++))return
for(Y=0;Y<32;Y++)if(32&X.U8(G++))return
for(Y=0;Y<32;Y++)if(G++,31<X.U8(G++))return
for(Y=0;Y<2;Y++)if(31<X.U8(G++))return}for(Y=0;Y<256;Y++){if(!isWithin(X.U8(G),1,32))return
G+=2}return 128&X.U8(G++)?void 0:(G+=544,dly=X.U8(G++),isWithin(dly,1,15)&&(pts=X.U8(G),!!isWithin(pts,1,64)))}})()&&(sName="Stanislav 'KSA' Kuzin's Sound Tracker Pro module (.STF,.F)",sVersion="uncompiled/packed",bDetected=1,X.isVerbose())&&sOption("dly:"+dly+" pts:"+pts),!bDetected&&(function(){if(tmp=X.U8(0),isWithin(tmp,1,50)){var s=X.Sz()-2,e=X.U16(1,_LE)
if(ord=X.U8(e),lp=X.U8(e+1),isWithin(e,10,s)&&!(lp>ord)&&ord){var t=X.U16(3,_LE)
if(isWithin(t,e+2+2*ord,s)){var r=X.U16(5,_LE)
if(isWithin(r,10,s)){var i=X.U16(7,_LE)
if(isWithin(i,10,s)&&!((K=i+30)>X.Sz())){var n=[],a=[]
for(Y=0;Y<ord;Y++){if(X.U8(e+2+2*Y)%6||!isWithin(E=X.U16(t+2*Y,_LE),10,s))return
n.indexOf(E)<0&&n.push(E)}for(Y=0;Y<15;Y++){if(!isWithin(E=X.U16(i+2*Y),10,s))return
a.indexOf(E)<0&&a.push(E)}return ptn=n.length,smp=a.length,ptn?1:void 0}}}}}})()&&(sName="Stanislav 'KSA' Kuzin's Sound Tracker Pro module (.STP)",sVersion="compiled",bDetected=1,X.isVerbose())&&(X.c("'KSA SOFTWARE COMPILATION OF '",10)&&sOptionT(X.SC(38,25,"CP1251")),sOption("tmp:"+tmp+" ord:"+(lp?lp+"-":"")+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<17)&&(K=X.U16(0),!(X.Sz()<K))&&!((smptp=X.U16(2))<10)&&(orntp=X.U16(4),ptntp=X.U16(6),postp=X.U16(8),lpp=X.U16(10),!(orntp<=smptp+1))&&!(ptntp<orntp)&&!(postp<=ptntp)&&!(lpp<postp)&&(membase=smptp-10,!(lpp-membase>=K))&&(Y=postp-membase,b=X.U8(Y))){for(ord=0,ptn=0;b;){if(K<=Y+7)return
ord++,ptn<(E=127&b)&&(ptn=E),Y+=2,b=X.U8(Y),ptn<(E=127&b)&&(ptn=E),Y+=2,b=X.U8(Y),ptn<(E=127&b)&&(ptn=E),Y+=3,b=X.U8(Y)}if(ptn++,(G=X.U16(smptp-membase+2))-ptntp==2*ptn&&(G=12,(len=Y+7)==K)){for(E=X.U16(12),Y=1;Y<=orntp-smptp>>1;Y++){if(G+=2,(j3=X.U16(G))-E!=98&&(1337!=K||10!=ord||11!=ptn))return
E=j3}for(Y=1;Y<=ptntp-orntp>>1;Y++){if(G+=2,(j3=X.U16(G))-E!=34)return
E=j3}return 1}}})()&&(sName="Jiří 'George' Koudelka's Scalex Qjeta Tracker module (.SQT)",sVersion="compiled",bDetected=1,sOption("ord:"+ord+" ptn:"+ptn+" sz:"+outSz(K))),!bDetected&&X.isDeepScan()&&(function(){if(!(X.Sz()<6||0==(tempo=X.U8(0))||32<tempo||(postp=X.U16(1,_LE))<126||postp>X.Sz()||(orntp=X.U16(3,_LE))<126||orntp>X.Sz()||(ptntp=X.U16(5,_LE))<126||ptntp>X.Sz()||(ord=X.U8(postp)+1,0==(j2=ptntp-orntp)))){if(fID=!1,0<j2){if(0<j2%33)return}else if(0<j2%33){if(j1<55||0<(j1-55)%33)return
fID=!0}if(c=2*X.U8(postp)+3,j2<0){if(c+j2!=0)return}else if(c+postp-orntp!=0){if(ptntp<82||c+postp-ptntp+55!=0)return
fID=!0}if(!(65535<(c=orntp+33)||c>X.Sz())){for(;c;){if(c--,0<X.U8(c))return
if(c==orntp)break}for(c=ptntp,j1=0,j2=0,ptn=0;c+6<=X.Sz()&&c+6<65536&&X.U8(c)<255;)c++,j2=X.U16(c,_LE),j1<j2&&(j1=j2),c+=2,j2=X.U16(c,_LE),j1<j2&&(j1=j2),c+=2,j2=X.U16(c,_LE),j1<j2&&(j1=j2),c+=2,ptn++
if(!(X.U8(c)<255||j1>X.Sz()||X.U8(j1-1)<255)){for(bad=0;;){if(131<=X.U8(j1)<=142&&j1++,65535<++j1)return
if(j1>X.Sz()){if(X.isHeuristicScan()){bad=1
break}return}if(255==X.U8(j1)||j1==X.Sz())break}return len=255==X.U8(j1)?j1+1:X.Sz(),fID&&"SOUND TRACKER COMPILATION OF "!=X.SA(ptntp-55,29)&&"KSA SOFTWARE COMPILATION OF "!=X.SA(ptntp-55,28)?void 0:1}}}})()&&(sName="Jarosław 'BZYK' Burczyński's Sound Tracker module (.STC,.ZXS)",sVersion="v1.x",bDetected=1,bad&&(sVersion+="/malformed"+bad),K=X.U16(25,_LE),i_d=X.SA(7,18),r=0<=["SONG BY ST COMPILE","SONG BY MB COMPILE","SONG BY ST-COMPILE","SOUND TRACKER v1.1","S.T.FULL EDITION  ","SOUND TRACKER v1.3"].indexOf(i_d)?"":i_d,K!=X.Sz()&&(K=len,X.isVerbose()&&sOption("ord:"+ord+" ptn:"+ptn),32<=(255&K)<=127)&&(r+=String.fromCharCode(255&K),32<=K>>8<=127)&&(r+=String.fromCharCode(K>>8)),X.isVerbose())&&(sOptionT(r,"msg: "),sOption("ord:"+ord+" ptn:"+ptn+" sz:"+outSz(K))),!bDetected&&X.isDeepScan()&&ss()&&(sName="S.T. Music's Recompiler v2 rebuilt STC module (.ST3)",sVersion="v3.0",bDetected=1,bad&&!X.isVerbose()&&(sVersion+="/malformed"+bad),X.isVerbose())&&(fID&&(sOptionT(decAnsi(9,55,CPSpeccy,!1,Chars0to1FSpeccy)),X.c("'KSA SOFTWARE COMPILATION OF '",9)||sOption(X.SA(9,28),"in: ")),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" delay:"+X.U8(0)+" @"+Hex(base)+" sz:"+outSz(K))),!bDetected&&X.isDeepScan()&&(function(){if(!((a0=X.fSig(0,65535,"41FA.... ....FFD4 43FA.... 228841FA ....D1E8 FFD843FA"))<0||1&a0||a0>X.Sz())&&(bad="",G=X.U16(a0+2,_BE),!((msgp=a0+G+2)<a0+16||msgp>X.Sz()))&&!((playp=X.fSig(a0+16,a0+msgp-6,"4E7548E7FFFE"))<0||1&playp)&&(smpd=X.U16(a0+2+G-2,_BE),ordp=X.U16(a0+2+G-6,_BE),ptnp=X.U16(a0+2+G-10,_BE),smpd)&&ordp&&ptnp&&!(a0+2+G+smpd>X.Sz()||a0+2+G+ordp>X.Sz()||smpd<=ordp&&1!=smpd)){if(ptn=ordp-ptnp>>6,ord=0,smps=[],1==smpd){if(ord++,(pt=a0+2+G+ordp)+4>X.Sz())return K=pt,1
for(pt+=4,E=1,K=ordp-ptnp;E<K;){if(E=X.U32(K,_BE),K+4>X.Sz()||!E)return 1
K+=4}K-=4,ord--}else{if(ord=smpd-ordp>>2,smpd+=a0+2+G,sdsz=X.U16(smpd+2,_BE),smp=sdsz>>5,smpd+sdsz>X.Sz()||sdsz%32)return
if(!sdsz)for(;;sdsz+=32){if(sdsz+36>X.Sz())return
if(stp=X.U32(smpd+sdsz+4,_BE),U=X.U32(smpd+sdsz+8,_BE),endp=X.U32(smpd+sdsz+12,_BE),stp>U||U>=endp)break
smp++,""!=(E=decAnsi(smpd+sdsz+16,16,CPAmiga).trim())&&smps.push(E)}for(mendp=0,Y=0;Y<smp;Y++)(endp=X.U32(smpd+32*Y+12,_BE))>mendp&&(mendp=endp),""!=(E=decAnsi(smpd+32*Y+16,16,CPAmiga))&&smps.push();(K=smpd+sdsz+4+mendp)>X.Sz()&&(bad=bad.addIfNone("!short"))}return 1}})()&&(sName="SIDMon module (.SID1,.SMN,.SID)",sVersion="v1",bDetected=1,""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose())&&("SID-MON BY R.v.VLIET  (c) 1988"!=(E=decAnsi(msgp,256,CPAmiga).trim())&&sOptionT(E),sOptionT(addEllipsis(smps.join(","),200),"smps:"),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<90)&&X.c("'SIDMON II - THE MIDI VERSION'",58)&&(ord=X.U8(2)+1,spd0=X.U8(3),smp=X.U16(4,_BE),ofs=58+X.U32(6,_BE),songlenlen=X.U32(10,_BE),90==(ofs+=songlenlen))){for(G=14,Y=0;Y<10;Y++){if(1048575<(E=X.U32(G,_BE))||!E)return
switch(Y){case 0:var s=[ofs,E]
break
case 1:if(E!=s[1])return
var e=[ofs,E]
break
case 2:if(E!=e[1])return
break
case 3:if(E%32)return
break
case 7:if(E!=smp)return
var t=[ofs,E]
break
case 8:trk=E>>1
break
case 9:var r=[ofs,E]}if(G+=4,(ofs+=E)>X.Sz())return}for(1&(ofs=r[0]+r[1])&&ofs++,smpsz=0,smps=[],G=t[0];G<t[0]+t[1];G+=64)smpsz+=X.U16(G+4,_BE)<<1,""!=(E=decAnsi(G+32,32,CPAmiga).trim())&&smps.push(E)
return K=ofs+smpsz,smp>>=6,1}})()&&(sName="SIDMon II module (.SID2)",bDetected=1,X.isVerbose())&&(sOptionT(X.SA(7,32)),sOptionT(X.SA(39,32),"in: "),sOptionT(addEllipsis(smps.join(","),256),'smp/msg:"','"'),sOption("trk:"+trk+" ord:"+ord+" smp:"+smp+" sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<17||31<(smp=X.U16(0,_BE))||(ordp=X.U32(2,_BE))<8*smp+2||128<(ptndp=X.U32(6,_BE))-ordp||255!=X.U8(ptndp-1)||65535<(smpdp=X.U32(10,_BE))||ptndp<=ordp+1||smpdp<=ordp||ordp>X.Sz()||ptndp>X.Sz())){for(c=B=0;c<smp;c++){if(65535<(A=X.U16(8*c+14,_BE)<<1))return
if((lst=X.U16(8*c+18,_BE)<<1)>A)return
if((lsz=X.U16(8*c+20,_BE)<<1)>A+2||lst+lsz>A+2||lst&&lsz<=2)return
if((lst||2<lsz)&&!A)return
if(15<X.U8(16+8*c)||64<X.U8(17+8*c))return
B+=A}if(!(B<=2)){for(Y=ordp,ptn=0;Y<ptndp-1;Y++){if(128<(E=X.U8(Y)))return
E>=ptn&&(ptn=E+1)}return K=B+smpdp,1}}})()&&(sName="Digital Illusions Creative Entertainment packed module (.DI)",bDetected=1,K>X.Sz()&&!X.isVerbose()&&(sVersion="malformed!short"),X.isVerbose())&&sOption("ord:"+(ptndp-ordp-1)+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K)),!bDetected&&(function(){if(X.c("'IM10'",60)&&!(256<X.U16(32)||256<X.U16(34)||255<X.U16(36)||!X.U8(48)||X.U8(49)<32||64<X.U8(50)||X.I8(51)<4)){var s,e,t,r,i,n
for(ord=X.U16(32),ptn=X.U16(34),ins=X.U16(36),spd=X.U8(48),bpm=X.U8(49),ch=chon=0,chns=[],G=64;G<576;Y++,G+=16)X.isVerbose()&&(s=X.SC(G,12,"CP437").trim()).length&&chns.push(s),X.U8(G+15)<=1&&ch++,X.U8(G+15)||chon++
if(ch){for(notes=Y=0,G=832;Y<ptn&&G<X.Sz();Y++){if(r=X.U16(G)-4,256<(e=X.U16(G+2)))return
if(G+=4,X.isDeepScan())for(;0<=--r&&G<X.Sz();)if(0==(i=X.U8(G++))){if(e<=++t)return}else 32&i&&([160,255].indexOf(X.U8(G++))<0&&notes++,G++,r-=2),128&i&&(G+=2,r-=2),64&i&&(G+=2,r-=2)
else G+=r}if(!(G>X.Sz())){for(inss=[],smps=[],smp=Y=0;Y<ins;Y++){if(X.isVerbose()&&(s=X.SC(G,32,"CP437").trim()).length&&inss.push(s),G+=384,255<(n=X.U16(G-6)))return
if(!X.c("'II10'",G-4)&&X.U32(G-4))return
for(c=0;c<n;c++,smp++){X.isVerbose()&&smps.push(X.SC(G,13,"CP437").trim())
var a=X.U32(G+16),o=X.U32(G+20),p=X.U32(G+24)
X.U8(48)
if(1048576<a||1048576<o||1048576<p)return
if(64<X.U8(G+36))return
if(G+=64,!X.c("'IS10'",G-4)&&!X.c("'IW10'",G-4))return
G+=a}}return 1}}}})()&&(sName="Imago Orpheus module (.IMF)",bDetected=1,X.isVerbose())&&(sOptionT(X.SC(0,32,"CP437")),sOptionT(addEllipsis(inss.join(" ")),'insts/msg:"','"'),sOptionT(addEllipsis(smps.filter(funSampleName).join(" ")),'smps/msg:"','"'),sOption("spd0:"+spd+" bpm0:"+bpm+" ch:"+chon+(ch==chon?"":ch)+" ord:"+ord+" ptn:"+ptn+" ins:"+ins+" smp:"+smp+(notes?" notes:"+notes:"")+" sz:"+outSz(G))),!bDetected&&(function(){if(!(X.Sz()<37)&&isWithin(nV=X.I8(0),-1,2)){if(26==X.U16(1))var s=13
else{if(24!=X.U16(1))return
s=12}var e,t=[]
for(Y=0,oldchn=X.U16(1);Y<s;Y++){if(G=X.U16(1+2*Y),!isWithin(G,26,X.Sz()-1))return n(G,"!badtrkp"),0
if(t.push(Hex(G+1)+": "+((e=Y)<0?"??":e<6?"FM "+(e+1):e<9?"SSG "+(e-5):9===e?"OPNA ADPCM B":10===e?"OPNA Rhythm":11===e?"Rhythm Subs":12===e?"FM insts":"??")),isWithin(Y,1,11)&&128!=X.U8(G))return n(G,"!badtrkend"+X.U8(G)),0
if(isWithin(Y,1,10)&&G<=oldchn)return n(G,"!badtrkp"),0
if(!Y&&198==X.U8(G))for(c=G+1;c<G+9;c+=2)if((E=X.U16(c))&&!isWithin(E,G,X.Sz()-1))return n(G,"!badC6trkp"),0
oldchn=G}rhosz=X.U16(23)-X.U16(21)-1,rhysz=X.U16(25)-X.U16(23)-2>>1,rho=rhy=0
var r=oldrhy=0,i=16777215
if(0<rhosz)for(q=X.U16(21)+1;q<X.U16(23)+1&&128!=(E=X.U8(q));q++)E>=rhy&&E<128&&(rhy=E+1),rho++
if(0<rhysz&&0<rhosz)for(q=X.U16(23)+1;q<i&&q<X.U16(25)-1&&r<rhy&&(E=X.U16(q)+1,isWithin(E,q,X.Sz()))&&(r||(i=E),!(65024<=E||X.U16(25)-q<2));q+=2)r++,oldrhy=E
if(bad="",ttype="",extra=-1,sV="",4<=rhysz)if(extrap=G-3,extra_type=X.U8(extrap+2),isWithin(extra_type,64,79)||(bad=bad.addIfNone("!badxtype"+Hex(extra_type))),ttype=extra_type<66?"PCP/P86":extra_type<72?"PPS":-1==nV?"FM Towns":"PPZ",extra=X.U16(extrap,_LE)+1,isWithin(extra,1,X.Sz()))for(Y=0;Y<4;Y++)((G=X.U16(extra+2*Y,_LE))<27||G+1>X.Sz())&&(bad=bad.addIfNone("!extrapOOB"+Hex(extra)))
else bad=bad.addIfNone("!"+Hex(extra)+" out of "+Hex(extrap-1))
return 1}function n(s,e){return 1<debug&&_l2r("pmd",s,e),!1}})()&&(bDetected=1,sName="Masahiro 'Kajapon' Kajihara's Professional Music Driver module (.M,.M2)",sVersion=(sVersion=0<=nV?"v"+nV+"/"+["OPN/OPNA","OPM","OPL2",,,,,,,,,,,,,,][nV]:"").appendS(ttype," "),bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose())&&(fnames=[],0<extra&&(72<=extra_type&&(n=X.SC(X.U16(extra,_LE)+1,256,"Shift_JIS"),extra+=2,""!=n)&&fnames.push("PPZ:"+n),66<=extra_type&&(n=X.SC(X.U16(extra,_LE)+1,256,"Shift_JIS"),extra+=2,""!=n)&&fnames.push("PPS:"+n),n=X.SC(X.U16(extra,_LE)+1,256,"Shift_JIS"),extra+=2,""!=n&&fnames.push("PPC/P86:"+n),""==(F=X.SC(X.U16(extra,_LE)+1,256,"Shift_JIS"))&&(F=""),""==(_=X.SC(X.U16(extra+2,_LE)+1,256,"Shift_JIS"))&&(_=""),""==(arenji=X.SC(X.U16(extra+4,_LE)+1,256,"Shift_JIS"))&&(arenji=""),""==(rem=X.SC(X.U16(extra+6,_LE)+1,256,"Shift_JIS"))&&(rem=""),sOption(F),sOption(_,"by: "),sOption(arenji,"mixed by: "),sOption(rem),sOption(fnames.join(", "),"fn: ")),E=X.U8(X.U16(21)+1),sOption("rhyord:"+rho+(rho?(E?"×"+E:"")+" rhy:"+rhy:""))),!bDetected&&(function(){function s(s,e){return 1<debug&&_l2r("muap",s,e),!1}if(!(X.Sz()<Math.max(X.U16(32),38))){var e
for(ch=notes=K=sus=0,r="",Y=oldp=0;Y<17;Y++){if(e=X.U16(2*Y),!isWithin(e,Math.max(24,oldp),X.Sz()))return s(2*Y,"!ptr#"+Y+"OOB "+outArray([e,oldp,X.Sz()],16)),0
if(Y&&252!=X.U8(e-1))return s(e-1,"!FC@"),0
if(252!=X.U8(e)){var t=parseMUAP98(e,X.isDeepScan()?BCParseToEoF:BCParseToReasonable,Y)
if(t[0]==BCInvalidFormat)return
notes+=t[0],r=r.appendS(t[3],"\n"),ch++,K<t[4]&&(K=t[4]),sus+=t[5]}else K<e+1&&(K=e+1)
oldp=e}return sus>3*ch?void 0:(bad=sus?"suspicious"+sus:"",1)}})()&&(sName="Packen/ぱっくん Software MUAP98/みゅあっぷ Object chiptune (.O,.OX+TONES.DTA)",bDetected=1,bad.length&&(sVersion=bad),X.isVerbose())&&(sOptionT(r),sOption("ch:"+ch+(X.isDeepScan()?" notes:"+notes+" sz:"+outSz(K):""))),!bDetected&&X.isDeepScan()&&(function(){if(X.c("6000.... 6000.... 6000.... 6000.... 6000....  41FA.... ........ 4E7541FA")){for(a2=64,d4=8;9240!=X.U16(a2,_BE)&&(a2+=2,--d4););if(d4){for(smp=d3=X.U8(a2-1)+1,a2=54,d4=5;16890!=X.U16(a2,_BE)&&(a2+=2,--d4););if(d4){a2+=2,a4=a2,d4=a2+X.U16(a2,_BE)+2,53756==X.U16(a4+2,_BE)&&(d4+=64),a3=d4-2,d5=0,a2=a3
do{if(65536<(d1=X.U32(a3,_BE)))return}while(d1+=6,d5+=d1,a3+=d1,--d3)
if(20081==X.U16(a3,_BE)){a3=0,a0=130+a3,d0=10
do{if(16875==X.U16(a0,_BE)){a0+=2
break}}while(a0+=2,--d0)
if(d0){for(d1=0,d2=X.U16(a0,_BE),a3+=d2;a3+=18,d1++,X.U16(a3,_BE););d2=a2-a3
do{if(132!=(b=X.U8(a3))&&133!=b){if(a3++,--d2<0)break}else d0++,a3++,d2--}while(0<=d2)
return songsz=d4,K=d4+d5,steps=d0,k=d1,1}}}}}})()&&(sName="Rob Hubbard's module (.RH)",sVersion="v1.4",bDetected=1,X.isVerbose())&&(1<k&&sOption(k,"×"),sOption("smp:"+smp+" steps:"+steps+" songsz:"+songsz+" sz:"+outSz(K))),!bDetected&&(function(){if(!(256<(ord=X.U16(12,_BE)+1))&&(ptn=X.U16(14,_BE))&&!(128<ptn)&&(synsmp=X.U16(16,_BE),isWithin(synsmp,1,32))&&(loop=X.U16(18,_BE),bad="",loop>=ord&&(bad=bad.addIfNone("!badloop")),!(charStat(X.readBytes(0,12),1).indexOf("allxsc")<0))){for(G=80,Y=mp=0;Y<ord&&G<X.Sz();G+=14,Y++)for(l=0;l<4;l++){if(128<=(pt=X.U8(G+3*l))||!isWithin(X.I8(G+3*l+2),-48,48))return
pt>mp&&(mp=pt)}if(!(Y<ord||(mp++,(minsz=G+8*ptn+4+16*synsmp+4)>=X.Sz()))){for(Y=0;Y<ptn;Y++){if(!X.c("'patt'",G))return
for(G+=4,row=0;row<32;G+=4){var s=X.readBytes(G,4)
if(s[0]%2||!isWithin(s[3],1,32-row))return
row+=s[3]}}if(X.c("'patt'",G)){for(G+=4,smp=msmpp=mssz=evc=0,plim=Math.min(X.Sz(),1048576),Y=0;Y<10;Y++)if(smpp=X.U32(20+4*Y,_BE)){if(1&(A=X.U16(60+2*Y,_BE))&&A--,A<<=1,smpp<minsz||1048576<smpp)return
smpp>msmpp&&(msmpp=smpp,mssz=A),smp++}for(Y=0;Y<synsmp&&G<X.Sz();Y++){if(!X.c("'inst'",G))return
if(G+=4,!e(!0))return
if(!X.c("'insf'",G))return
if(G+=4,!e(!1))return}return X.c("'inst'",G)?((G+=4)>X.Sz()?(K=-1,bad=bad.addIfNone("!short")):K=Math.max(msmpp+mssz,G),1):void 0}}}function e(s){for(var e=!0;G+4<X.Sz();){var t=X.readBytes(G,4)
if(G+=4,e&&s&&192!=t[0])return
switch(t[0]){case 160:evc++
break
case 176:return evc++,!(3&t[1])
case 192:if(!s)return
evc++
break
case 208:if(s)return
evc++,1&t[1]&&(bad=bad.addIfNone("!oddpitch"))
break
case 224:return evc++,1
default:return s||"inst"!==decEncoding(t,CPAmiga)?void 0:(G-=4,0<evc)}e=!1}return 0<evc}})()&&(sName="PumaTracker module (.PUMA)",sVersion="v1.1",bDetected=1,""!=bad&&(sVersion=sVersion.appendS("/malformed"+bad,"/")),X.isVerbose())&&(sOption(decAnsi(0,12,CPAmiga).trim()),sOption("ord:"+ord+" ptn:"+mp+(mp!=ptn?"/"+ptn:"")+(smp?" wf.smp:"+smp:"")+" syn.smp:"+synsmp+(loop?" lp:"+loop:"")+" events:"+evc+" sz:"+outSz(K))),!bDetected&&(function(){if(X.c("0FFF0FE2")||X.c("10000FE2")){if(!X.c("0FC40FA7 0F8B0F6E",4))return
G=292,a0=8}else{if(!X.c("0F1C0F0E 0F000EF2 0EE40ED6"))return
G=452,a0=168}do{if(!(E=X.U32(G,_BE)))return
if((G+=2)>X.Sz())return}while([17914,17401,16889].indexOf(E>>16)<0)
for(initp=G-2,a0+=284,d1=0;d1<128;d1++){if(X.c("7F7F7F7F",a0)||X.c("FFFF",a0))return
a0+=2}k=IntAddress=0,Twin=!1
do{if(E=X.U16(G,_BE),(G+=2)>X.Sz())return}while([28672,29184].indexOf(E)<0)
if(28672===E)k=1
else{for(;!k&&G<X.Sz();){if(X.c("00000000",G))return
X.c("21C80070",G)?(G+=2,X.c("00003B76",588)&&(Twin=!0)):X.c("43FA",G)?(E=G+2+X.I16(G+2,_BE),k=X.I16(E,_BE)-E>>3):X.c("43EA",G)?(E=X.I16(G+2,_BE),k=X.I16(E,_BE)-E>>3):G+=2}if(!k||G>=X.Sz())return}return 1})()&&(sName="Sean Conran module (.SCR)",sVersion="v1.2",bDetected=1,Twin&&(sVersion+="/Megatwins"),X.isVerbose())&&1<k&&sOption(k,"×"),!bDetected&&X.isDeepScan()&&(function(){if(X.c("6000....6000.... ....6000")&&!((d1=X.I16(2,_BE))<=0||1&d1||d1>X.Sz())&&(a0=a1=a3=d1+2,!((d1=X.I16(6,_BE))<=0||1&d1||d1>X.Sz()))&&!((d1=X.I16(12,_BE))<=0||1&d1||d1>X.Sz())&&X.c("3F006100",a1)&&X.c("3D7C",a1+6)&&X.c("41FA",a1+12)){for(d0=127;d0;){if(X.c("D040D040 D04041FA",a0)){a0+=8,a1=a0+X.I16(a0,_BE)
break}if(a0+=2,!--d0||a0>X.Sz())return}k=0
s:for(;;){for(d2=4;d2;){if(d0=64512&X.U16(a1,_BE),(a1+=2)>X.Sz())return
if(d0){k--
break s}d2--}k++}for(k++,d5=d6=0,d0=128;d0;){if(E=X.U16(a0,_BE),(a0+=2)>X.Sz())return
if(16890===E)break
d0--}if(d0){for(smpi1=a0+X.U16(a0,_BE),a0=12+X.I16(12,_BE),d0=128;d0&&(d0--,!X.c("D040D040 41FA",a0));)if((a0+=2)>X.Sz())return
for((!d0||(a0+=6,1&(d0=X.I16(a0,_BE)))||(a0+=d0,X.I16(a0,_BE)))&&(a0=0),smpi2=a0,a0=smpi1;;){if(d0=X.U32(a0,_BE),(a0+=4)>X.Sz())return
if(!d0)break
if(d0>>16){a0-=4
break}}if(a0-=8,smp1=a0-smpi1>>2,d0=smpi2){for(a0=d0;;){if(d0=X.U32(a0,_BE),(a0+=4)>X.Sz())return
if(!d0)break
if(d0>>16){a0+=4
break}}a0-=8,smp2=a0-smpi2>>2}else smp2=0
d3=smp1,a2=smpi1+X.I32(smpi1,_BE),d1=X.I32(a2,_BE),d2=X.U16(a2+8,_BE),Y=d4=0
do{if(++Y===smp1)break
if((a2=smpi1+X.I32(smpi1+(Y<<2),_BE))<20||a2>X.Sz())return
if(d4=X.I32(a2,_BE),!(d1>d4)){if(d1!=d4)d6=d4!=X.I32(a2+4,_BE)?X.U16(a2+10,_BE):0,d5=X.U16(a2+8,_BE)
else if(d5=X.U16(a2+8,_BE),d2>d5)continue
d1=d4,d2=d5}}while(Y<smp1)
if(d2+=d6,K=smpi1+d1+(d2<<1),smpi2){d3=smp2<<2,a2=smpi2+X.I32(smpi2,_BE),d1=X.I32(a2,_BE),d2=X.U16(a2+8,_BE),Y=d6=0
do{if((Y+=4)===d3)break
if((a2=smpi2+X.I32(smpi2+Y,_BE))<20||a2>X.Sz())return
if(d4=X.I32(a2,_BE),!(d1>d4)){if(d1!=d4)d6=d4!=X.I32(a2+4,_BE)?X.U16(a2+10,_BE):0,d5=X.U16(a2+8,_BE)
else if(d5=X.U16(a2+8,_BE),d2>d5)continue
d1=d4,d2=d5}}while(Y<d3)
d2+=d6,a1=smpi1+d1+(d2<<1),K<a1&&(K=a1)}return 1}}})()&&(sName="Ben Daglish's module (.BD)",sVersion="v1.2",bDetected=1,X.isVerbose())&&(1<k&&sOption(k,"×"),sOption("smp:"+smp1+"+"+smp2+" sz:"+outSz(K))),!bDetected&&X.isDeepScan()&&(function(){if(X.c("'BANK'")){for(Y=0;Y<20;Y++)if(2097152<=X.U32(4+(Y<<2),_BE))return
for(Y=0;Y<40;Y++)if(65536<=X.U32(84+(Y<<2),_BE))return
for(G=84,q=4,smp=0,smpt=[],s=484,Y=0;Y<20;Y++)E=X.U32(q,_BE),q+=4,E&&(smpt.push(X.SA(s,16).trim()),smp++,s+=16+X.U32(G,_BE)),G+=4
for(smpsz=s,bad=!1;s<X.Sz()&&(E=X.U8(s),s+=1,255!==E););if(s>X.Sz()){if(!X.isHeuristicScan())return
bad=!0}return 47===X.U8(s)?(K=s+1,songsz=K-smpsz):(K=s,bad=!0),1}})()&&(sName="Andrew Parton's module (.BYE)",sVersion="v1.2",bDetected=1,bad&&(sVersion+="/malformed"),X.isVerbose())&&sOption("smp:"+smp+" songsz:"+songsz+" smpsz:"+smpsz+" sz:"+outSz(K)),!bDetected&&X.isDeepScan()&&(function(){for(Y=G=0;Y<4;Y++){if(!X.c("6000",G))return
if(G+=2,(d2=X.I16(G,_BE))<=0||1&d2)return
G+=2}if(X.c("6000",G)){if(G+=2,(d2=X.I16(G,_BE))<=0||1&d2)return
if(G+=2,!X.c("6000",G))return
if(G+=2,(d2=X.I16(G,_BE))<=0||1&d2)return
if(G+=d2,!X.c("48E7FFFE 6100",G))return
if(G=(G+=6)+X.I16(G,_BE),!X.c("4DF9 00DFF000",G))return
sV="new"}else{if(!X.c("303C0000 662233C0",G))return
sV="old"}if("new"===sV){for(a2=special=28,a0=X.I16(2,_BE),F=X.SA(special,X.fStr(special,a0-a2,"  ")-a2).trim();E=X.U16(a0,_BE),a0+=2,17914!=E||a0>X.Sz(););if(a2=a0,(a0+=X.I16(a0,_BE))>X.Sz()-2){if(!X.isHeuristicScan())return
bad=!0}d0=X.I16(a0,_BE),k=d0>>2,a0+=d0+X.I16(a0-2,_BE)
do{if(a0>X.Sz()-2){if(!X.isHeuristicScan())return
bad=!0}}while(E=X.I16(a0,_BE),a0+=2,1010!=E)
K=a0,a='title: "'+F+'" sz:'+outSz(K)}else{for(special=0,a2=16,a0=2,a0+=X.U16(a0,_BE);E=X.I16(a0,_BE),a0+=2,6512!=E||a0>X.Sz(););for(a1=a0-4,a1+=X.I16(a1,_BE);E=X.I16(a0,_BE),a0+=2,16890!=E||a0>X.Sz(););for(a0+=X.I16(a0,_BE),k=a1-a0>>4;E=X.U16(a2,_BE),a2+=2,49916!=E||a0>X.Sz(););for(a2+=4,smpip=a2+X.U16(a2,_BE);E=X.U16(a2,_BE),a2+=2,18426!=E||a0>X.Sz(););for(a0=a2,a2+=X.U16(a2,_BE),songsz=a2;E=X.U16(a0,_BE),a0+=2,18938!=E||a0>X.Sz(););for(;E=X.U16(a0,_BE),a0+=2,18938!=E||a0>X.Sz(););for(a0+=X.U16(a0,_BE),smp=(a0-smpip)/44,d1=0,a1=smpip,a3=21747;0<=(d2=X.I32(a1+32,_BE))&&d1<=d2&&(d1=d2,a3=a1),a1+=44,a0>a1;);d0=X.U16(a3+40,_BE),d1+=d0+d0,smpsz=d1,K=songsz+smpsz,a="smp:"+smp+" songsz:"+Hex(songsz)+" smpsz:"+Hex(smpsz)+" sz:"+outSz(K)}return 1})()&&(sName="Ashley Hogg's module (.ASH)",sVersion=sV,bDetected=1,bad&&(sVersion+="/malformed"),X.isVerbose())&&(1<k&&sOption(k,"×"),sOption(a)),!bDetected&&X.isDeepScan()&&(function(){if(X.c("'IBLK'")&&(d2=X.U8(4))&&!(128<d2)&&(a1=22+138*d2,!((aseq=X.fSig(a1,260,"'ASEQ'"))<0||1&aseq))){G=aseq+4,K=0,bad=!1
do{if((K+=5)+G>X.Sz()){if(X.isHeuristicScan()){bad=!0
break}return}}while(!X.c("102F00",K+G-3))
return K+=G,ord=Math.floor((K-G)/100),1}})()&&(sName="Cinemaware module (.CIN)",bDetected=1,bad&&(sVersion="malformed"),X.isVerbose())&&sOption("ord:"+ord+" sz:"+outSz(K)+" (sans ext.samples)"),!bDetected&&(function(){if(!(X.Sz()<3e3)){if(X.c("6000.... 6000")||X.c("4EF9.... ....4EF9")||X.c("4EB9.... ....4EF9")){G=8
for(var s=!1;X.c("42280030 42280031 42280032",G)&&(s=!0),G+=2,!s&&G<408;);}if(s){if(X.isVerbose()){for(G=q=d0=d5=0,d7=2048,org=0,smpi=0,songst=0,bad=!1;d7&&G<X.Sz();){if(3493939706===(l=X.U32(G,_BE)))d0=X.I16(G+4,_BE),q=G+d0+4,Table=q
else if([1223162108,1223163902].includes(l)){for(!(d6=a3)||org?d6=20:(q=G-a3,d5-=q,org=d5);0<=d6--;)if(E=X.U16(G,_BE),G+=2,16890===E){d0=X.I16(G,_BE),songst=q=G+d0
break}}else 3913828336===l?d1=X.I16(G+4,_BE):12571904===l?(tmrval=(X.U8(G-1)<<8)+X.U8(G+7),X.c("4E71",G+20)||(a3=X.c("21FC",G+28)?X.U32(G+30,_BE):X.c("C000",G+32)?X.U32(G+32,_BE):X.U32(G+22,_BE))):1118306332===l?(d0=X.I16(G+6,_BE),smpi=q=G+d0+6):[3829941242,3829932155].includes(l)?a4&&(d0=X.I16(G+4,_BE),a4-=X.I32(G+d0+4,_BE),org||(d5-=a4,org=d5)):1223098608===l&&(d0=X.I16(G+6,_BE),a4=G+d0+6)
if(G+=2,448796992===l)break
d7--}for(songst+=d1,k=0,G=songst+1;G<X.Sz()&&!X.c("DFF0A0",G);k++,G+=16);if(G>X.Sz())return bad=!0,1
for(smp=synsmp=0,G=smpi;!X.U32(G+28,_BE);G+=32)a2=X.U32(G,_BE)-org,2===(a24=X.U16(a2+4,_BE))||16===a24?smp++:synsmp++}return 1}}})()&&(sName="Ivo Zoer & Ron Klaren's CustomMade module (.CM)",bDetected=1,X.isVerbose())&&(1<k&&sOption(k,"×"),sOption("smp:"+smp+" syn:"+synsmp+" timer:"+tmrval)),!bDetected&&X.isDeepScan()&&(function(){if(a1=0,4===(d1=X.I16(0,_BE)))X.U32(24,_BE)||(a1+=4)
else{if(8!==d1)return
a1+=4}for(a1+=4,a2=a1,d2=0;d2<4;d2++){if(X.I16(a1,_BE))return
if(a1+=2,d1=X.I16(a1,_BE),a1+=2,d1<=0||1&d1)return}for(d0=0;d0<4;d0++){if(a1=d1=X.I32(a2,_BE),a2+=4,d2=X.I32(a1,_BE),X.I16(a1,_BE))return
if(a1+=2,d1=X.I16(a1,_BE),a1+=2,d1<=0||1&d1)return
if(a1=d2,48===(E=X.I16(a1,_BE))&&(a1+=2,E=X.I16(a1,_BE)),12===E&&(a1+=6,E=X.I16(a1,_BE),a1+=2,4===E))break}if(d2=X.I32(a1,_BE),1==X.I16(d2,_BE)&&!(a1=a2=d2>>16)){if(fmt=1,X.U32(24,_BE)){for(k=0,G=X.U16(0,_BE);G<X.Sz()&&(E=X.I16(G,_BE),G+=2,!E)&&(E=X.I16(G,_BE),G+=2,E&&!(1&E));)k++
k>>=2}else fmt=0,k=X.I16(2,_BE)-8>>5
for(bad="",K=0,a1=d2;a1<X.Sz()&&(a2=a1,a1-=14,1==X.I16(a1,_BE)););for(8!=(E=X.I16(a2-2,_BE))&&0!=E&&(a2+=14),smp=K=0;a2<X.Sz()&&1==(E=X.I16(a2,_BE));)smp++,a2+=2,d2=X.I32(a2,_BE),a2+=6,E=X.I32(a2,_BE),(d2=E>d2?E:d2)>K&&(K=d2),a2+=6
return K>X.Sz()&&(bad=bad.addIfNone("!short")),a2>=X.Sz()?bad=bad.addIfNone("!badsmpinfo"):K+=254,1}})()&&(sName='Dave "Uncle Art" Lowe New module (.DLN)',bDetected=1,sVersion="f."+fmt,""!=bad&&(sVersion+="/malformed"+bad),X.isVerbose())&&(1<k&&sOption(k,"×"),sOption("smp:"+smp+" sz:"+outSz(K))),!bDetected&&X.isDeepScan()&&(function(){if(!(X.Sz()<=2500)){for(a2=0,a0=8,d1=0;d1<4;d1++){if(!X.c("00010101",a0))return
a0+=16}a1=400+a0
do{if(a0===a1)return}while(E=X.I16(a0,_BE),a0+=2,18938!=E)
if(a0+=2,X.c("45F900DF F000357C 00FF009E 41FA",a0)&&(a0=(a0+=14)+X.I16(a0,_BE))==a2){for(a1=240;E=X.U16(a1,_BE),a1+=2,18938!=E&&a1<X.Sz(););for(a1-=2;E=X.U16(a1,_BE),a1+=2,18426!=E&&a1<X.Sz(););for(a2=a1+20,a1+=X.I16(a1,_BE),k=0,a1++;d1=X.U8(a1),a1++,d1&&(k++,d1!=X.U8(a1))&&a1<X.Sz(););for(;E=X.U16(a2,_BE),a2+=2,58177!=E&&a2<X.Sz(););for(;E=X.U16(a2,_BE),a2+=2,18426!=E&&a2<X.Sz(););for(smptsz=a1=a2+X.I16(a2,_BE);E=X.U16(a2,_BE),a2+=2,18426!=E&&a2<X.Sz(););for(a3=a2,a2+=X.I16(a2,_BE),smpp=a2,a0=a2,d4=a1-a2,a2=a1+d4,smp=0;E=X.I16(a1,_BE),a1+=2,E&&smp++,a1<a2;);for(;E=X.U16(a3,_BE),a3+=2,18426!=E&&a3<X.Sz(););for(a3+=2,(d6=3584&X.U16(a3,_BE))?d6>>=9:d6=8,ruch=d6,d1=X.I16(a0,_BE),songsz=d2=d1<<d6,E=d1,d1=d2,d2=E,d5=0;d0=X.I16(a0,_BE),a0+=2,d0>d2&&(d2=d0,d5=X.U16(a0+d4-2,_BE)),a0<smptsz;);return d2<<=d6,d5<<=1,d2+=d5,K=d2,smpsz=K-songsz,1}}})()&&(sName="Desire player module (.DSR)",bDetected=1,sVersion="v1.0",X.isVerbose())&&(1<k&&sOption(k,"×"),sOption("smp:"+smp+" songsz:"+Hex(songsz)+" smpsz:"+Hex(smpsz)+" sz:"+outSz(K)),K<X.Sz())&&(sVersion+="/malformed!short"),!bDetected&&X.isDeepScan()&&(function(){if(!(X.Sz()<2048)){var s=Math.min(X.Sz(),16384)
for(K=k=ch=smp=sqwfsmp=Y=0;Y<s&&(18426!=X.U16(Y,_BE)||240!=(240&X.U8(Y+2)));Y+=2);if(!(s-6<=Y)){for(sofs=Y+2+X.I16(Y+2,_BE);Y<s&&Y<X.Sz()&&24832!=X.U16(Y,_BE);Y+=2);if(!(s-6<=Y)){for(sinit=Y,ssmpsinit=Y,24832==X.U16(Y+4,_BE)&&(ssmpsinit=Y+6+X.I16(Y+6,_BE)),Y=ssmpsinit;Y<s&&18987!=X.U16(Y,_BE);Y+=2);if(!(s-36<=Y)){if(102!=X.U8(Y+4)){for(Y=sinit;Y<s&&16875!=X.U16(Y,_BE);Y+=2);if(s-36<=Y)return
if(smpdp=sofs+X.I16(Y+2,_BE),Y+=4,114!=X.U8(Y+4))return
for(smp=X.U8(Y+5)+1;Y<s-4&&!X.c("41EB....E34F",Y);Y+=2);if(s-4<=Y)return
for(chvolp=sofs+X.I16(Y+2,_BE),Y=sinit;Y<s&&!X.c("41EB....17",Y);Y+=2);if(s-4<=Y)return
sstp=sofs+X.I16(Y+2,_BE),is32bp=!0,old=!0}else{if(old=!1,X.U8(Y+5)||(Y+=2),16890!=X.U16(Y+6,_BE))return
if(smpdp=X.I16(Y+8,_BE)+Y+8,Y+=10,X.c("2748....D0FC",Y)){if(smpdp+=X.U16(Y+6,_BE),Y+=12,53500!=X.U16(Y,_BE))return
smpdp+=X.U16(Y+2,_BE),Y+=4}if(!X.c("4BFA....72",Y))return
for(smpip=X.I16(Y+2,_BE)+Y+2,smp=X.U8(Y+5)+1,Y=sinit;Y<s-4&&(16890!=X.U16(Y,_BE)||75==X.U8(Y+4));Y+=2);if(s-4<=Y)return
if(4656!=X.U16(Y+4,_BE)&&14192!=X.U16(Y+4,_BE))return
for(sstp=Y+2+X.I16(Y+2,_BE),Y+=4;Y<s-8&&(16890!=X.U16(Y,_BE)||35==X.U8(Y+4));Y+=2);if(s-8<=Y)return
if(8304==X.U16(Y+4,_BE))is32bp=!0
else{if(12400!=X.U16(Y+4,_BE))return
is32bp=!1}}for(G=smpdp,Y=0;Y<smp;Y++){if(A=X.U32(G,_BE),(G+=6)+A>X.Sz())return bad=bad.addIfNone("!short"),1
K=G+=A}for(Y=0;Y<s;Y+=2)if(18426==X.U16(Y,_BE)){if(s-10<=Y)return
if(X.c("4A2B....67",Y+4)){if([13308,6012,2233].includes(X.U16(Y+10,_BE)))continue
break}}for(splay=Y,ch=0,Y=splay;Y<splay+200;Y+=2)if(126==X.U8(Y)){if(ch=X.U8(Y+1))ch++
else for(;Y<splay+500;Y+=2)if([48764,48700].includes(X.U16(Y,_BE))){ch=X.U8(Y+3)
break}break}if(ch){for(Y=splay;Y<splay+100;Y+=2)if(X.c("207A.... 303A",Y)){if(sqwfsmp=(X.I16(Y+2,_BE)+Y+2-smpip)/12,![12732,4540].includes(X.U16(Y+14,_BE)))return
if(80!=(240&X.U8(Y+20))||107!=X.U8(Y+21))return
if(3179!=X.U16(Y+24,_BE))return
if(![12732,4540].includes(X.U16(Y+38,_BE)))return
if(3179!=X.U16(Y+48,_BE))return}if(old){for(Y=splay;Y<s&&28672!=X.U16(Y,_BE);Y+=2);if(16!=X.U8(Y+2))return
var e=Y}else{for(Y=splay;Y<s&&21352!=X.U16(Y,_BE);Y+=2);if(s-16<=Y||103!=X.U8(Y+4))return
e=X.U8(Y+5)+Y+6
if(102!=X.U8(Y+12))return
for(Y=e;Y<s&&!X.c("45FA.... 322D",Y);Y+=2);if(s-6<=Y)return
if(s-144<=(Y=X.U16(Y+2,_BE)+Y+2))return
if(![4096,8192].includes(X.U16(Y,_BE)))return}for(Y=e;Y<s&&27392!=X.U16(Y,_BE);Y+=2);if(!(s-6<=Y)){var t=endlym=!1
for(Y=splay;Y<splay+100;Y+=2)if(4154==X.U16(Y,_BE)){t=!0,49404==X.U16(Y+6,_BE)&&(endlym=!0)
break}for(k=0,G=sstp,minpp=4294967295,sngspd=dlyspd=0,bad="";G+8<minpp&&(dlyspd=t?(sngspd=X.U8(G++),X.U8(G++)):(sngspd=X.U16(G,_BE),G+=2,0),!(255<sngspd));){for(Y=0;Y<ch;Y++)is32bp?(E=X.U32(G,_BE),G+=4):(E=X.U16(G,_BE),G+=2),minpp>sofs+E&&(minpp=sofs+E)
if(G>X.Sz()){bad=bad.addIfNone("!short")
break}k++}return 1}}}}}}})()&&(sName="David Whittaker's module (.DW)",sVersion=old?"old":"new",bDetected=1,""!=bad&&(sVersion+="/malformed"+bad),X.isVerbose())&&(1<k&&sOption(k,"×"),sOption("ch:"+ch+" smp:"+smp+(sqwfsmp?" sqwf.smp:"+sqwfsmp:"")+" spd:"+sngspd+" sz:"+outSz(K))),!bDetected&&X.isDeepScan()&&(function(){if(X.c("13FC0040 ........ 4E710439 0001")&&X.c("66F44E75 48E7FFFE",18)){for(a2=0,bad="";9081!=X.U16(a2,_BE)&&a2<=1e3;)a2+=2
if(1e3<a2){if(!X.isHeuristicScan())return
bad="!badorigin"}for(org=X.U32(a2-4,_BE),a2=0,d1=1;9169==X.U16(a2,_BE)?(smplen=X.I32(a2+8,_BE)-org,smpp=X.I32(a2-6,_BE)-org,smplp=X.I32(a2+24,_BE)-org,smpnvol=X.I32(a2-30,_BE)-org,d1-=6):3237741568==X.U32(a2,_BE)?(ptn=X.I32(a2+6,_BE)-org,d1+=3):209257472==X.U32(a2,_BE)&&(songpos=X.I32(a2+12,_BE)-org,len=X.I32(a2+34,_BE),d1+=2),(a2+=2)<1e3;);if(d1){if(!X.isHeuristicScan())return
bad=bad.addIfNone("!badval")}for(a1=smpp,songsz=X.I32(smpp,_BE)-org,d0=X.I32(a1-4,_BE)<<1,a2=smplen,d1=a1-a2,a1+=d1,d1>>=2,smp=d1,d1=X.I32(a1-4,_BE)-org,K=d0+d1,smpsz=K-songsz,a1=songpos,a2=a1+len,ptn=0;E=X.U8(a1),ptn<E&&(ptn=E),++a1<a2;);return ptn++,d1=6*(d0-1),d0=d1,d1*=14187,dur=Math.floor(64*d1/709376),1}})()&&(sName="Fashion Tracker module (.EX)",bDetected=1,sVersion="v1.0",bad&&(sVersion+="/malformed."+bad),X.isVerbose())&&sOption("ord:"+len+" ptn:"+ptn+" smp:"+smp+" songsz:"+songsz+" sz:"+outSz(K)),!bDetected&&(function(){if(a0=a1=0,F=inst="",format="Aegis Sonix Music Driver",X.c("'FORM'")){if(!X.c("'SMUSSHDR'",8)||!X.U8(23)||!X.c("'NAME'",24))return
if((d1=X.U32(28,_BE))>>31)return
if(d1=(t_=d1)+1&4294967294,a1=32+d1,X.c("'SNX1'",a1)){if(a1+=4,(d1=X.U32(a1,_BE))>>31)return
a1+=4,d1=d1+1&4294967294,a1+=d1}else format="Electronic Arts' Simple Musical Score"
insinfp=a1,realsmp=[],ins=0
do{if(!X.c("'INS1'",a1))return
if(a1+=4,(d1=X.U32(a1,_BE))>>31)return
if(a1+=4,63<(d1=d1+1&4294967294)>>24)return
if(X.U8(a1+1))return}while(realsmp.push(X.U8(a1)),a1+=d1,ins++,!X.c("'TRAK'",a1))
for(K=a1,trk=0;K<X.Sz()&&(hkhd=X.SA(K,4),hksz=X.U32(K+4,_BE),"TRAK"==hkhd);)trk++,K+=8+hksz
F=X.SA(32,t_),fmt=2,ext="smus"}else if(240&X.U16(0,_BE)){if(X.Sz()<333)return
if(a1=48,320!=X.I32(a1,_BE))return
for(a1+=4,d1=3;d1;){if(d2=X.I32(a1,_BE),a1+=4,d2<=0||1&d2||d2>X.Sz())return
if(-1!=X.I16(d2,_BE)){if(X.I32(d2,_BE)||X.I16(d2+4,_BE))return
if(E=X.U8(d2+6),!isWithin(E,128,130))return}d1--}0<(K=X.fSig(d2,512,"FFFF"))&&(K+=2),fmt=1,ext="tiny"}else{for(d3=20,d1=4;d1;){if((d2=X.I32(a0,_BE))<=0||1&d2)return
a0+=4,d3+=d2,d1--}if(d3>=X.Sz())return
for(a0+=4,d1=4;d1;){if(!(32768&(E=X.U16(a0,_BE))))return
if(65535!=E&&132<E>>16)return
a0+=X.I32(a1,_BE),a1+=4,d1--}if(!X.U8(a0))return
if(0<(K=X.fSig(a0,512,"0000"))){for(;a0<K;)inst=inst.appendS(X.SA(a0,E=X.fSig(a0,512,"00")-a0),"; "),a0+=E+1
K+=2}fmt=0,ext="snx"}return 1})()&&(sName=format+" module (."+ext+")",sVersion="f."+fmt,bDetected=1,X.isVerbose())&&(F.length&&sOption(F),inst.length&&sOption(inst,'+instr.:"','"'),sOption("sz:"+outSz(K))),!bDetected&&X.isDeepScan()&&(function(){if(X.c("'AmBk'"))a0=G=4
else{if(!X.c("C0"))return
a0=G=0}if(X.c("'Music   '",G+8)&&(G=(G+=20)+X.I32(G,_BE),6==X.I16(G,_BE))&&(i=G+=2,G+=X.I16(G+2,_BE)-2,-2==(G=X.I16(G,_BE))||!G)){for(F=X.SA(i+12,32),G=i+30+X.I16(i+30,_BE),ord=-1;ord++,d1=X.I16(G,_BE),(G+=2)<X.Sz()&&0<=d1;);for(d3=a0?4+(16777215&X.I32(a0+4,_BE)):16777215&X.I32(a0,_BE),K=d3+8,bad="",K>X.Sz()&&(bad=bad.addIfNone("!short")),G=i+X.I16(i+6,_BE),ptn=0;G<X.Sz()&&(d1=X.I16(G,_BE),G+=2,!(d1<0));)d1>ptn&&(ptn=d1)
for(ptn++,X.I16(G,_BE)||(G+=2),X.I16(G,_BE)!=ptn&&(bad=bad.addIfNone("!badptn")),q=a0+32,smp=d1=X.I16(q,_BE),q+=16,d7=0;d1&&q<X.Sz();)d2=(d2=X.I16(q,_BE))||X.I16(q-6,_BE),d7+=d2<<1,q+=32,d1--
return smpsz=d7,songsz=K-d7,1}})()&&(sName="François Lionet's AMOS Music Bank module (.ABK)",bDetected=1,""!=bad&&(sVersion="malformed"+bad),X.isVerbose())&&(sOption(F),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K))),!bDetected&&X.isDeepScan()&&(function(){if(!(32<(ins=X.I16(0,_LE)))&&X.c("'INST'",4+2*ins)&&(E=8+114*ins,X.c("'SONG'",E))){for(E+=4,songsz=0,Y=0;Y<ins;Y++)songsz+=X.U16(4+2*Y,_LE)
return X.c("'ENDS'",E+4*songsz)?(K=E+4*songsz+4,1):void 0}})()&&(sName="TuneFish module (.TF4)",sVersion="v4",bDetected=1,X.isVerbose())&&sOption("ins:"+ins+" tempo:"+X.U16(2,_LE)+" songsz:"+Hex(songsz)+" sz:"+outSz(K)),!bDetected&&X.isDeepScan()&&(function(){if(a0=0,tfmx=0,X.c("'MCMD'"))fmt=-1,tfmx=a0
else if(X.c("48E7FFFE")){if(fmt=-1,a0+=4,d1=0,!X.c("61",a0))return
if(!(d1=X.U8(a0+1))||1&d1)return
if(a0+=d1+2,!X.c("2F006100",a0))return
if(a0+=4+X.I16(a0+4,_BE),!X.c("41FA",a0))return
if(!X.c("41FA",a0+18))return
if(a0=(a0+=20)+X.I16(a0,_BE),!X.c("'MCMD'",a0))return
tfmx=a0}else{if(fmt=0,!X.c("60",a0++))return
if(d1=X.U8(a0++)){if(1&d1)return
if(a0+=d1,!X.c("48E7FFFE",a0))return
if(a0+=4,!X.c("6100",a0))return
if(a0=(a0+=2)+X.I16(a0,_BE),!X.c("2F006100",a0))return
if(a0=(a0+=4)+X.I16(a0,_BE),!X.c("41FA",a0))return
a0+=20}else{if(fmt=1,(d1=X.I16(a0,_BE))<0||1&d1)return
if(!X.c("6000",a0+2))return
if(a0+=d1,!X.c("48E7FFFE",a0))return
a0+=4}if(E=X.c("41FA",a0),a0+=2,!E&&(E=X.c("41FA",a0),a0+=2,!E))return
if(a0+=X.I16(a0,_BE),tfmx=a0,!X.c("'TFMX'00",a0))return
if(a0+=4,!X.I16(a0+12,_BE))return fmt="sfx",K=0,k=1,1
if(d1=2+X.I16(a0,_BE)+X.I16(a0+2,_BE)<<6,d2=(1+X.I16(a0+4,_BE))*X.I16(a0+8,_BE),d3=12*(1+X.I16(a0+6,_BE)),d1+=d2+d3+6*(1+X.I16(a0+12,_BE))+32,a0+=d1+14,X.I32(a0,_BE))return
if(a0+=4,!(d2=X.I16(a0,_BE)))return
if((d2*=2)!=X.I32(a0+26,_BE))return}return K=a0=0,k=1,a1=a0+tfmx,d1=fmt<0?(d0=0,18):(d0=2,32),d0=(d0=d0+(X.I16(a1+4,_BE)+X.I16(a1+6,_BE))<<6)+d1,d1=fmt<0?0:1,d1+=X.I16(a1+8,_BE),ptn=d1,d1*=X.I16(a1+12,_BE),d0+=d1,d1=((d1=fmt<0?0:1)+X.I16(a1+10,_BE))*12,d0+=d1,a2=subp=a1+d0,d1=1,d1=fmt<0?(d2=X.I16(a1+14,_BE))<<3:(d2=X.I16(a1+16,_BE),6*(d1+d2)),k=d2,d0+=d1,a2=smpinfop=a1+d0,d2=fmt<0?(d1=X.I16(a1+16,_BE),28):(d1=X.I16(a1+18,_BE),30),smp=d1,d1*=d2,d0+=d1,smpp=a2=a1+d0,a1=smpp,fmt<0&&(a1+=2),smpsz=2*X.I16(a1-8,_BE)+X.I32(a1-12,_BE),songsz=a2-a0,K=songsz+smpsz,1})()&&(ext=fmt<0?".MCMD":".SOG",sName="Jochen 'Mad Max' Hippel's module ("+ext+",.HIP)",sVersion="f."+fmt,bDetected=1,X.Sz()<K&&(sVersion+="!short"),X.isVerbose())&&(1<k&&sOption(k,"×"),sOption("ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K))),!bDetected&&X.isDeepScan()&&(function(){if(G=0,X.c("6000")){if(G=2,(d1=X.I16(G,_BE))<=0||1&d1)return
if(G=d1+2,(G=4+X.fSig(G,20,"308141FA"))<4)return
if((d1=X.I16(G,_BE))<=0||1&d1)return
G+=d1}if(X.c("'TFMX'00",G)&&(d0=d1=2+X.I16(G+4,_BE)+X.I16(G+6,_BE)<<6,d0+=32,ptn=d2=X.I16(G+8,_BE)+1,d3=28*(X.I16(G+10,_BE)+1),d2*=X.I16(G+12,_BE),d0+=d2,d1+=d2+d3,txt=X.U8(G+4+d0)?X.SA(G+4+d0,24):"",k=X.I16(G+16,_BE),d2=k+1<<3,ins=X.I16(G+18,_BE),insip=G+d1+d2+32,!X.I32(insip+18,_BE))&&(d2=2*X.I16(insip+22,_BE))&&d2==X.I32(insip+22+30-4,_BE)){var s=0,e=0
for(Y=0;Y<ins;Y++){var t=X.I32(insip+30*Y+18,_BE),r=X.U16(insip+30*Y+22,_BE)
s<=t&&(s=t,e=r)}return smpp=insip+30*ins,K=smpp+s+2*e,1}})()&&(sName="Jochen 'Mad Max' Hippel's module (.HIP7,.S7G)",sVersion="7V",bDetected=1,X.c("'TFMX'")||(sVersion+="+replayer"),X.Sz()<K&&(sVersion+="!short"),X.isVerbose())&&(""!=txt&&sOptionT(txt),1<k&&sOption(k,"×"),sOption("ptn:"+ptn+" ins:"+ins+" sz:"+outSz(K))),!bDetected&&X.isDeepScan()&&(function(){if(X.c("'COSO'")&&X.c("'TFMX'",32)&&X.I16(48,_BE)&&X.I16(64,_BE)){var s=X.I32(28,_BE)
if(!(s>X.Sz())){a2=X.I32(4,_BE),d6=d7=0,d0=X.I16(36,_BE)
do{if(a1>X.Sz())return}while(a1=X.I16(a2,_BE),a2+=2,226===X.U8(a1)&&(128&X.U8(a1+1)?d7++:d6++),0<=--d0)
return d7>=d6?void 0:(ptn=X.I16(40,_BE)+1,smp=X.I16(50,_BE),a0=X.I32(24,_BE)+10*smp,smpsz=X.I32(a0-10,_BE)+2*X.I16(a0-6,_BE),K=s+smpsz,k=X.I16(48,_BE),1)}}})()&&(sName="Jochen 'Mad Max' Hippel's module (.HIPC)",sVersion="packed",bDetected=1,X.isVerbose())&&(1<k&&sOption(k,"×"),sOption("ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K))),!bDetected&&(function(){for(a0=a1=a4=d4=0,d1=128,d0=X.Sz(),bad=r="";d1;){if(a0>X.Sz()||a1>X.Sz())return
if(128!=d1&&(E=X.I16(a1,_BE),a1+=2,16890===E)&&0<=(d2=X.I16(a1,_BE))&&!(1&d2)&&(a0=a1+d2),X.c("'MMME'",a0)){d0=2
break}if(X.c("'TFMX'",a0)){if(512<=X.I16(a0+4,_BE))d0=0
else if(X.I16(a0+16,_BE)){for(d0=X.I16(a0+4,_BE),a1=a0+32,d6=d7=0;226===X.U8(a1)&&(128&X.U8(a1+1)?d6++:d7++),a1+=64,0<=--d0;);d0=d6>d7?2:5}else d0=0
break}if(X.c("'COSO'",a0)){if(!X.I16(a0+48))return
if(!X.I32(a0+24))return
if(X.c("'TFMX'",a0+32)){a2=a0+X.I32(a0+4,_BE),d6=d7=0,d0=X.I16(a0+36,_BE)
do{if(X.I16(a0+64,_BE)?(a1=a0+X.I16(a2,_BE),a2+=2):(a1=a0+X.I32(a2,_BE),a2+=4),a1>X.Sz())return}while(226===X.U8(a1)&&(128&X.U8(a1+1)?d7++:d6++),0<=--d0)
d0=d7<d6?4:2}else d0=X.c("'MMME'",a0+32)?2:0
break}d0-=2,d1--}if(2==d0){if(lsmp=X.c("'LSMP'",a0+28)?1:0,d0=X.Sz()-a0,d4=a0,songsz=smpsz=0,K=sz1=-1,X.c("'COSO'",a0)||X.c("'MMME'",a0+32)){if(sV="packed",a1=a0,d3=0,d3=6*(1+X.I16(a0+50,_BE)),d2=d3+X.I32(a0+24,_BE),(d3=0)<(d0=(d0-=d2)<0?28:d0))if(a1+=d2,128==(E=X.I16(a1,_BE))&&256==E){for(;d3=X.I16(a1,_BE),a1+=8,X.I16(a1,_BE)&&a1<X.Sz(););(d0-=d2)<0&&(d0=28)}else{for(E>>=8,G=a1+1,r=[];E&&G<X.Sz();)r.push(E),E=X.U8(G++)
r=decEncoding(r,CPAmiga,1,Chars0to1FLF)}if(songsz=d2,smpsz=d3,K=a0+d3+d2,r.length<3&&(r=""),sz1=r.length?K+r.length+1:K,100<(k=X.U16(a0+48,_BE)))return}else{if(sV="unpacked",d6=a0,d1=2,a2=a0,d1=2+X.I16(a0+4,_BE)+X.I16(a0+6,_BE)<<6,d2=(1+X.I16(a0+8,_BE))*X.I16(a0+12,_BE),d3=12*(1+X.I16(a0+10,_BE)),d1+=d2+d3,d2=2+X.I16(a0+16,_BE),d1+=6*(d2+X.I16(a0+18,_BE))+32,d2=32,d3=d7=0,(d0-=d1)<0)d0=28,bad=bad.addIfNone("!short")
else if(0<d0)if(a1=d1+a2,128===(E=X.I16(a1,_BE))||256===E){for(d7=a1;d3=X.I16(a1,_BE),a1+=8,X.I16(a1,_BE)&&a1<X.Sz(););(d0-=d3)<0&&(d0=28)}else{for(E>>=8,G=a1+1,r=[];E&&G<X.Sz();)r.push(E),E=X.U8(G++)
r=decEncoding(r,CPAmiga,1,Chars0to1FLF)}if(d0=d1,smpsz=d3,songsz=d1,K=a0+songsz+smpsz,sz1=""!=r?K+r.length+1:K,100<(k=X.U16(a0+16,_BE)))return}return 1}})()&&(sName="Jochen 'Mad Max' Hippel's Atari ST module (.HST,.SOC,.SOG)",bDetected=1,sVersion=sV,""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose())&&(sOptionT(r,'msg:"','"'),a="",lsmp&&(a=a.appendS("ext.samples"," ")),0<K&&(a=a.appendS("sz:"+outSz(K,sz1)," ")),smpsz&&(a=("smpsz:"+Hex(smpsz)).appendS(a," ")),1<k&&(a=("×"+k).appendS(a," ")),sOption(a)),!bDetected&&X.isDeepScan()&&(function(){if(!(X.Sz()<=1338)&&1==X.U8(0)&&!(37<X.U8(1))&&(E=X.I16(2,_BE))&&!(128<E)&&!(63<(d1=X.U16(4,_BE)))){for(d=255&d1,G=6;G<134;)if(E=X.U8(G),G++,d<E)return
for(l=0,G=314;G<1338;G+=4){if((E=X.I16(G,_BE))<0)return
if(E){if([1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,906,856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,151,127,120,113].indexOf(E)<0)return
l++}}return l?1:void 0}})()&&(sName="Editeur Musical Sequentiel module (.EMS)",bDetected=1),!bDetected&&(function(){if(!(X.Sz()<1280)&&X.c("48E7..F0 41FA.... 4CD80600")){if(X.c("78",2)&&X.c("0C0000FF",12))sversion="strange"
else if(!X.c("00",2)||!X.fSig(12,576,"700033FC 000F00DF F09641FA"))return
return soptions="",X.c("4A44",12)?(sversion="type 1",X.isVerbose()&&0<=(G=X.fSig(0,128,"0C04.... 66..41FA"))&&(O="×"+(X.U16(G+2,_BE)+3))):X.c("4A00",12)?sversion="type 2":X.c("0C00",12)&&(sversion="type 3"),1}})()&&(sName='Darius "Mark II" Zendeh module (.DZ)',sVersion=sversion,sOptions=soptions,bDetected=1),(function(){if(X.c("41FA",4)&&!(X.Sz()<1280)){for(G=8,Y=288;E=X.c("E742",G),G+=2,!E&&--Y;);if(Y){for(;E=X.c("41FA",G),G+=2,!E&&--Y;);if(Y){for(a3=G,G+=X.I16(G,_BE),d5=X.I16(a3+2,_BE),Y=24;E=X.c("D1FA",a3),a3+=2,!E&&--Y;);if(Y)a5=a3,a3+=X.I16(a3,_BE)
else{if(14192==d5)return
d5=0,a5=a3-28,Y=16}for(;E=X.c("41FA",a5),a5-=2,!E&&--Y;);return Y}}}})()&&(_setResult("audio","Darius Zendeh's Mark II Sound System module (.MK2)","",""),bDetected=1),!bDetected&&(function(){if((X.isHeuristicScan()||X.c("'BeEp'"))&&(smp=X.U8(5))&&!(31<smp)&&!(0<X.U8(6+40*smp))){for(U=B=0;U<smp;U++){if(!(j=X.U32(38+40*U,_BE))||j>X.Sz())return
B+=j}return 255<(ord=X.U16(6+40*smp,_BE))?void 0:(ptns=6+40*smp+2,!(255<(ptn=X.U16(ptns+6*ord,_BE)))&&(ptn0=X.U32(ptns+2,_BE),ptns+=6*ord,trkdtsz=X.U32(ptns-4,_BE)-ptn0,addlns=4*X.U8(ptns-5)*8,K=ptns+2+2*ptn+B+trkdtsz+addlns,1))}})()&&(sName="JamCracker/Pro module (.JAM,.JC)",bDetected=1,bad="",X.isHeuristicScan()&&(K+19==X.Sz()&&(sVersion="v1.0a (Xag)",X.isVerbose()&&sOptionT(X.SA(K,19)),K+=19),X.c("'BeEp'")||(bad=bad.addIfNone("!badsig"))),""!=(bad=K>X.Sz()?bad.addIfNone("!short"):bad)&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose())&&sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K)),!bDetected&&X.isHeuristicScan()&&(function(){if(2==X.U16(0,_LE)&&X.c("00FF01FF02FF03FF04FF05FF06FF07FF08FF09FF0AFFFD00",54)&&!(!(seqt=X.U16(4,_LE))||seqt<30||seqt>=X.Sz()||!(inst=X.U16(6,_LE))||inst<=seqt||inst>=X.Sz())){for(ins=X.Sz()-inst>>4,mptn=65535,ch=0,trk=[],Y=0;Y<11;Y++)if(G=X.U16(10+2*Y,_LE),trk[Y]=G){if(ch++,G<=seqt||G>=inst)return
G<mptn&&(mptn=G)}for(ptn=mptn-seqt>>1,Y=0;Y<5;Y++)if(trk[Y]){if(G=X.U16(seqt+2*Y,_LE),65023!=X.U16(G-1,_LE))return
if(G<=seqt||G>=inst)return}return Y=X.U16(2,_LE),tmr=(1193810/(Y||65535)).toFixed(2),1}})()&&(sName="Johannes Bjerregaard Adlib module (.JBM)",bDetected=1,X.isVerbose())&&sOption("tmr:"+tmr+" ch:"+ch+" ptn:"+ptn+" ins:"+ins),!bDetected&&(function(){if(X.c("'SONG'",60)&&660<X.Sz())msmp=15
else{if(!(X.c("'SO31'",124)&&1204<X.Sz()))return
msmp=31}if(hdrp=4*msmp,smptp=hdrp+20,ordp=smptp+30*msmp,!(128<(ord=X.U8(ordp))||(E=X.U16(hdrp+4,_BE))<178)){for(tmp0=(1776930/E).toFixed(0),spd0=6,smp=smpsz=ic=0,smps=[],Y=0;Y<msmp;Y++){if(131072<(A=X.U32(4*Y,_BE)))return
for(smpsz+=A,A&&smp++,E=X.readBytes(smptp+30*Y,20),l=0;l<20;l++)E[l]&&E[l]<32&&ic++
if(128<=ic)return
""!=(E=decEncoding(E,CPAmiga)).trim()&&smps.push(E.trim()),smth=X.U16(smptp+30*Y+2,_BE)}return 1}})()&&(sName=15==msmp?"SoundFX module (.SFX)":"SoundFX 2 / MultiMedia Sound module (.MMS)",15==msmp&&(sVersion="v1.0-8"),bDetected=1,X.isVerbose())){for(G+=2,ptn=0,Y=ordp+2;Y<ordp+2+ord;Y++)(E=X.U8(Y))>ptn&&(ptn=E)
ptn++,K=ordp+130+1024*ptn+smpsz,31==msmp&&(K+=6),(lp=X.U8(ordp+1))>ord&&(sVersion=sVersion.appendS("malformed!badloop","/")),sOption("tmp0:"+tmp0+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+(lp?" loop:"+lp:"")+" sz:"+outSz(K))}if(!bDetected&&(function(){if(fmt="",smp=smpp=0,K=-1,k=1,X.c("6000")){G=0,d1=3
do{if(!X.c("6000",G))return
if((E=X.I16(G+2,_BE))<=0||E%2)return}while(G+=4,d1--)
if(G=p0=6+X.I16(6,_BE),X.c("4A406B00",G)){if(!X.c("000641FA",G+4))return
if(G=(G+=8)+(X.I16(G,_BE)+4),!X.c("00017FFF",G))return
fmt="second"
var s=G=p0+8+X.I16(p0+8,_BE)
for(G+=8,k=0,d2=X.I32(G+10,_BE);G<X.Sz()&&d2==X.I32(G+10,_BE);)k++,G+=26
for(G=smpp=s+X.I32(s,_BE);G<X.Sz()&&(X.c("'FORM' 00?????? '8SVXVHDR'",G)&&(smp++,G+=4+X.I32(G+4,_BE)+2),!((G+=2)>=X.Sz())););if(G>X.Sz())return
if(K=G,G=s,d1=X.U32(G,_BE),(d2=X.U32(G+18,_BE))<=d1)G+=d1
else if(d3=d2-X.I32(G+22,_BE),35944==(K=d2+d3+G)&&--k,K>X.Sz())return}else{if(G-=4,X.c("C0FC",G))G+=2
else for(Y=0;Y<16&&G<X.Sz();Y++,G+=2)if(X.c("02800000",G)){if(!X.c("00FFC0FC",G+4))return
G+=8
break}if(G>X.Sz())return
for(mulu=X.I16(G,_BE),q=(G+=800)+900;G<X.Sz()&&!X.c("6AE064E0",G);)if((G+=2)===q)return
if(G>X.Sz())return
for(fmt="old",G=p0;G<X.Sz()&&(E=X.I16(G,_BE),G+=2,!(0<=E&&16634==(16634&E)&&(E=X.I16(G,_BE),G+=2,0<=E))););G+=E-2
for(k=(k=X.I16(G,_BE)-G)<mulu?1:Util.divu64(k,mulu);G<X.Sz()&&(X.c("'FORM' 0000???? '8SVXVHDR'",G)&&(smpp=smpp||G,smp++,G+=4+X.I32(G+4,_BE)+2),!((G+=2)>=X.Sz())););if(G>X.Sz())return
for(K=G,G=10+X.I16(10,_BE);G<X.Sz()&&(E=X.c("43FA",G),G+=2,!E););X.I16(G,_BE)
for(G+=2,d1=X.c("6000",12)?"7FFE":"7FFF";G<X.Sz()&&(E=X.c(d1,G),G+=2,!E););for(;G<X.Sz()&&(E=X.c("336C",G),G+=2,!E););X.I16(G+2,_BE)}}else if(X.c("0000 ???? 00017FFF")){var e=0
for(G=8;G<16;G+=2)if(E=X.I16(G,_BE)){if(E<0||E%2||!X.c("7FFF",E-2)&&!X.c("7FFE",E-4))return}else e++
if(1<e)return
if((G=2+X.I16(2,_BE))>X.Sz()||!X.c("'FORM' 00?????? '8SVXVHDR'",G))return
for(;G<X.Sz()&&(X.c("'FORM' 00?????? '8SVXVHDR'",G)&&(smp++,G+=4+X.I32(G+4,_BE)+2),!((G+=2)>=X.Sz())););if(G>X.Sz())return
K=G,fmt="harald"}else{if(512<(G=X.U16(0,_BE))||G<4||G%2)return
for(G+=2,Y=2;Y<G;Y+=2)if((E=X.I16(Y,_BE))<=0||E%2||!X.c("7FFF",E-2))return
fmt="latest",k=X.U16(0,_BE),G=smptp=X.U16(k+2,_BE),d3=X.U16(k,_BE),k>>=1,1==--k||!X.c("0000",d3-6)&&X.c("7F00",d3-4)||k--,smp0p=X.U16(G,_BE)
var t=hi=X.U24(smp0p+15,_BE)
for(smp=A=0;G<smp0p&&smp<128;){if(G>X.Sz())return
if(smp++,pp=X.U16(G,_BE),t>(sofs=X.U24(pp+15,_BE))&&(t=sofs),hi<=sofs&&(hi=sofs,A=X.I16(pp+18,_BE),X.c("'BODY'",sofs-8)||(sofs=X.U32(pp+20,_BE))>hi&&(hi=sofs,A=2*X.U16(pp+24,_BE))),hi>X.Sz())return
pp<smp0p&&(smp0p=pp),G+=2}X.c("'BODY'00'",t-8)&&(t=X.fSig("'FORM'00??????",t-150,t-20)),songsz=t,X.c("'BODY'00'",hi-8)?hi+=X.U32(hi-4,_BE):hi+=A<<1,K=hi}return 1})()&&(sName="Jesper Olsen's module (.JO)",sVersion=fmt,bDetected=1,X.isVerbose())&&(1<k&&sOption(k,"×"),sOption("smp:"+smp+" sz:"+outSz(K))),!bDetected&&Fs()&&(sName="Jason C. Brooke's module (.JB,.JCB)",sVersion=fmt,bDetected=1,X.isVerbose())&&(1<k&&sOption(k,"×"),sOption(("new"==fmt?"wf.smp:"+smp:"steps:"+steps)+" syn.smp:"+synsmp+" sz:"+outSz(K))),!bDetected&&(function(){if(X.c("000003F3 00000000 00000003 00000000 00000002 ???????? 40?????? 00000001 000003E9")&&(twofiles=!1,G=48,d1=X.U32(20,_BE)&~(1<<30),X.U32(36,_BE)==d1)){if(X.c("60000016",40)){if(!X.c("0000ABCD",44))return}else G=24
if(48==G&&!X.c("B07C0000",64)||24==G){if(!X.c("41F90000 00004E75",G+16))return
twofiles=!0}for(G=64,smpp=0;!smpp&&G<X.Sz();)!(E=X.fSig(G,TOEOF,"'FORM'"))%2?smpp=E:G=Math.max(E+1,G+1)
if(!(smpp<0)){for(smp=0;G<X.Sz()&&X.c("'FORM' ???????? '8SVXVHDR'",G);)smp++,G+=4+X.U32(G+4,_BE)
return K=G,1}}})()&&(sName="Kris Hatlelid's module (.KH"+(twofiles?"+SONGPLAY":"")+")",bDetected=1,X.isVerbose())&&sOption("sz:"+outSz(K)),!bDetected&&(function(){if(!(X.Sz()<1537)&&97==X.U8(15)){for(U=0;U<15;U++)if(64<X.U8(54+32*U))return
for(trks=0,U=0;U<1024&&255!=(k_=X.U8(U+512));U++)k_>trks&&(trks=k_)
if(1024!=U&&0!=trks&&!(1536+192*trks+192>X.Sz())){for(U=0;U<=trks;U++)for(j=0;j<64;j++)if(36<X.U8(1536+192*U+3*j))return
for(B=smp=0,U=0;U<15;U++)(E=X.U16(52+32*U,_BE))&&smp++,B+=E
return K=192*(trks+1)+B+1536,1}}})()&&(sName="Jess D. 'Razmo' Skov-Nielsen's Kefrens Sound Machine module (.KSM)",bDetected=1,X.isVerbose())&&(sOptionT(X.SA(2,13)),sOption("trk:"+trks+(smp?" smp:"+smp:"")+" sz:"+outSz(K)),K>X.Sz())&&(sVersion="malformed!short"),!bDetected&&(function(){if(trk=X.U16(0,_BE),d2=X.U16(2,_BE),d3=X.U16(4,_BE),smp=X.U16(6,_BE),G=8,trk&&!(4<trk)&&d2&&d3&&smp){for(mp=0,trks=[],d1=trk;d1;d1--){if(E=X.U32(G,_BE),G+=4,E>>16||!E)return
trks.push(E),mp<E&&(mp=E)}for(;d2;d2--){if(E=X.I32(G,_BE),G+=4,E<=0||E%2)return
mp<E&&(mp=E)}for(d2=X.I32(G,_BE);d3;d3--){if(E=X.I32(G,_BE),G+=4,E<=0||E%2)return
mp<E&&(mp=E)}if((G+=12*smp)==d2){for(d2=15;d2;d2--,G+=16)if(!X.c("3F3F3F3F 3F3F3F3F 3F3F3F3F 3F3F3F3F",G))return
return 1}}})()&&(sName="Paul Robotham's module (.DAT+.SSD)",bDetected=1,X.isVerbose())&&sOption("trk:"+trk+" smp:"+smp),!bDetected&&X.isDeepScan()&&(function(){for(Y=0;Y<6;Y++)if(!(192<=X.U8(2*Y+1)<=255))return
if(!(135&(ptnsz=X.U8(12)))){for(ptn=-1,Y=0;Y<50;Y++){if(23<(c=X.U8(14+Y)))return
c>ptn&&(ptn=c)}if(ptn++,!((tempo=X.U8(64))<3||30<tempo)&&!(50<(loop=X.U8(65)))&&(ord=X.U8(67))&&!(50<ord)&&!((hss=X.U8(68))<2||56<hss)){for(bad=!1,smp=0,Y=0;Y<16;Y++){if(smpst=X.U16(90+16*Y+9,_LE),smplm=X.U16(90+16*Y+12,_LE),smplp=X.U16(90+16*Y+14,_LE),smpst>smplm||smpst<49152||smplm<49152)return
if((smplp<49152||smplp>smplm||smpst>smplp||49152<smplm&&smplm-smplp<6)&&(bad=!0,!X.isHeuristicScan()))return
smpst<smplm&&smp++}return 1}}})()&&(bDetected=1,sVersion="v1.x",bad&&(sVersion+="/malformed"),sName="Vasilii 'BACA' Pakhomov/LAVE's Digital Music Maker module (.DMM)",X.isVerbose())&&sOption("tempo:"+tempo+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" loop:"+loop),!bDetected&&(function(){if(!(X.Sz()<2978)&&(spd=X.U8(0),isWithin(spd,1,15))){for(ord=0,ptn=[],Y=0;Y<256;Y++)if(255!=(o=X.U8(1698+Y))){if(128<=o)return
Y>ord&&(ord=Y),ptn.indexOf(o)<0&&ptn.push(o)}if(ord++,ptn=ptn.length,nonz=!1,!((lp=X.U8(1))>ord)){for(smp=opl=smpsz=0,Y=0;Y<32;Y++){if(X.U8(2+13*Y+12)||X.U32(418+16*Y)||X.U8(930+13*Y+12))return
var s=X.U32(418+16*Y+4),e=X.U32(418+16*Y+8),t=X.U32(418+16*Y+12)
if(1048575<s)return
if(s&&t<1048575&&(s<t||t<e))return
if(_opl=!X.c("00000000 00000000 000000",1346+11*Y),240&X.U8(1346+11*Y))return
if(252&X.U8(1346+11*Y+5))return
if(252&X.U8(1346+11*Y+10))return
s&&(smp++,smpsz+=s),_opl&&opl++}for(bad=!1,ptnend=notes=0,Y=0;Y<128;Y++){if(G=2978+X.U32(1954+4*Y,_LE),M=X.U32(2466+4*Y,_LE),bad=bad||M<3||4096<M,16777215<G||X.Sz()<G+M)return
for(G+M>ptnend&&(ptnend=G+M),i=0;G<ptnend;){var r=X.U8(G++)
if(r<=12)G+=2,notes++
else if(32<=r&&r<=44)G++
else{if(64!=r){if(96==r)break
return}i+=X.U8(G++)}}if(64<i)return}return K=ptnend+smpsz,0<smp+opl}}})()&&(sName="Thomas 'Tran' Pytel's CDFM/Composer 670 module (.C67)",bDetected=1,bad&&(sVersion="malformed!badptn"),X.isVerbose())&&sOption("spd:"+spd+" ord:"+ord+(lp?" lp:"+lp:"")+" ptn:"+ptn+" smp:"+smp+" fm:"+opl+" notes:"+notes+" sz:"+outSz(K)),!bDetected&&(function(){if(X.c("6000.... 6000.... 6000")){if(a0=2+X.I16(2,_BE),X.c("48E77FFE E98841FA",a0))v=2
else{if(!X.c("48E740F0 4A006B0A",a0))return
v=3}return 1}})()&&(sName="Sean 'Odie' Connolly's module (.SCN)",sVersion="v"+v,bDetected=1),!bDetected&&(function(){if(d1="48E7FCFE",a0=0,X.c(d1))return!X.c("45FA",220)&&X.c("E9417000 41FA",4)&&(X.c(d1,148)||X.c(d1,164)||X.c(d1,168))&&(fmt=0,base=8)
if(X.c("2F0841FA")){if(a0=(a0+=4)+(X.I16(a0,_BE)+28),!X.c("45FA",a0+220))return}else if(X.c(d1,28)){if(a0+=28,!X.c("45FA",a0+220))return}else{if(X.c("6000")){if(!X.c("6000.... 6000.... 6000.... 6000.... 6000.... 6000.... 6000",4))return
if(X.c("6000",32)&&!X.c("6000",36))return
if(a0=14,a0+=X.I16(a0,_BE),X.c(d1,a0)){if(!X.c("45FA",a0+268)&&!X.c("E942",a0+274))return
if(a0+=4,!X.c("E9417000 41FA",a0))return
if(a0+=4,X.c(d1,a0+140)||X.c(d1,a0+156)||X.c(d1,a0+160))return fmt=0,base=a0,1}return(a0=26+X.I16(26,_BE),X.c(d1+"43FA",a0))?(fmt=1,base=a0,1):void 0}for(;!X.c("2F0841FA",a0+28)&&(a0+=2)<10;);if(10==a0)return
for(Y=76;!X.c(d1,a0)&&(a0+=2,--Y););if(!Y)return
if(!X.c("45FA",a0+268)&&!X.c("E942",a0+274))return}return a0+=4,X.c("E9417000 41FA",a0)&&(a0+=4,X.c(d1,a0+140)||X.c(d1,a0+156)||X.c(d1,a0+160))&&(fmt=0,base=a0,1)})()&&(sName="Martin Walker's Activision Pro module (.AVP)",sVersion="f."+fmt,bDetected=1,X.isVerbose())&&sOption(Hex(base),"base:"),!bDetected&&(function(){if(fmt=0,X.c("0002")&&!(1&X.U8(3)))for(;!(1&(E=X.I16(4,_BE)))&&!(1&X.I16(E))&&!((d0=X.I16(48,_BE))>X.Sz());){for(a1=2;a1<=46&&!(!(E=X.U16(a1,_BE))||1&E||E>X.Sz()||d0<=E);a1+=2);if(a1<48)break
fmt=3840==(3840&X.U16(E,_BE))?2:1
break}if(!fmt){if(X.I16(0,_BE)||X.I16(128,_BE)||!X.c("00000CBE",132)||!X.c("000308BE",3254)||!X.c("000309BE",3258))return
fmt=3}if(smpsz=smp=0,k=1,3==fmt){if((K=X.U32(2234,_BE)+2)<2236||K>X.Sz())return
for(t0=X.U32(0,_BE),Y=4;Y<128;Y+=4){if(t1=X.U32(Y,_BE),(E=t1-t0)<0)return
smpsz+=E,E&&smp++,t0=t1}if(smpsz+=128,7382==K&&19290==smpsz)k=16
else for(k=0,a1=1726;d0=X.U32(a1,_BE),a1+=4,65280!=X.U16(d0,_BE)&&(k++,a1<K););}else for(K=X.U16(48,_BE),a0=X.U16(12,_BE)+2,a1=X.U16(28,_BE),k=a1-a0>>1,Y=X.U16(2,_BE);Y<K-4;Y+=4)slen=X.U32(Y,_BE),smpsz+=slen,slen&&smp++
return 1})()){switch(fmt){case 1:sName="Jason Page's module (.JP)"
break
case 2:sName="Jason Page's module (.JPN)"
break
case 3:sName="Jason Page's old module (.JP)"}sVersion="f."+fmt,bDetected=1,X.isVerbose()&&(1<k&&sOption(k,"×"),sOption("smp:"+smp+" smp.sz:"+smpsz+" song sz:"+outSz(K)))}if(!bDetected&&(function(){if(a2=242,(X.c("0C40",a2)||(a2-=6,X.c("33C0",a2)))&&X.c("48E7FFFE 61064CDF 7FFF4E75",a2-12)&&!((a2=X.fSig(a2,65535,"6000")+2)<2)&&!(!(E=X.I16(a2,_BE))||E<0||1&E)&&(a2+=E,X.c("2D58",a2))){a2=0
var s=[],e=(t("48E7FFFE"),s.push(a2>>16),s.push(65535&a2),t("33FC0001"),a2+=4,rel=X.U32(a2,_BE),r("41F9"),s.push(a2>>16),s.push(65535&a2),d1=X.I32(a2,_BE),r("B1FC"),d0=X.U32(a2,_BE),k=d0=d0-d1>>4,r("41F9"),s.push(a2>>16),s.push(65535&a2),r("B1FC"),s.push(a2>>16),s.push(65535&a2),r("303C"),t("48E7FFFE ........ 6100"),s.push(a2>>16),s.push(65535&a2),r("41F9"),s.push(a2>>16),s.push(65535&a2),d2=X.U32(a2,_BE),r("B1FC"),d3=X.U32(a2,_BE),(d3=d4=d3-d2)%24)
if(d3=Util.divu64(d3,24),e){if(e=(d4+=4)%24,d4=Util.divu64(d4,24),e)return i("@d436 error 5"),0
if(d3=d4,X.c("4654443C",2008))for(a3=1904,d4=2;0<=d4;d4--)a3-=4,wpU32be(a3+4,rpU32be(a3))}if(s.push(d3>>16),s.push(65535&d3),r("4BF9"),d5=rpU32be(a2)-rel,a2>X.Sz())return i("@d464 a2 too high"),0
if(X.isDeepScan()){s.push(d5>>16),s.push(65535&d5),s.push(0),a5=20178,s.push(a5>>16),s.push(65535&a5),a3=(s[0]<<16)+s[1]
s:for(;a3<X.Sz();)switch(rpU16be(a3)){case 13294:case 13308:a3+=2
case 12345:case 13248:case 13249:case 15417:case 16889:case 17017:case 19065:case 19449:case 19961:case 21369:case 45564:a3+=2,(a3_=rpU32be(a3))>>16!=223&&(wpU32be(a3,a3_-rel),a3+=4)
break
case 13305:a3+=2,(a3_=rpU32be(a3))>>16==223||wpU32be(a3,a3_-rel),a3+=4,(a3_=rpU32be(a3))>>16!=223&&(wpU32be(a3,a3_-rel),a3+=4)
break
default:if((a3+=2)>=d5)break s}if(d4=d3,a2=(s[10]<<16)+s[11],a2=rpU32be(a2),a2_=rpU32be(a2)-rel,wpU32be(a2,a2_),d2=a2_,d5=a2_+2*rpU32be(a2+4),a2+=24,a2_=rpU32be(a2),128<(d3-=2))return i("@d51a badsmp:"+Hex(d3)),0
for(;0<=d3;)a2_-=rel,wpU32be(a2,a2_),d5<=a2_&&(d5=a2_+2*rpU32be(a2+4)),d2>a2_&&(d2=a2_),a2+=24,a2_=rpU32be(a2),d3--
if(s.push(a2>>16),s.push(65535&a2),a2=rpU32be((s[4]<<16)+s[5]),a3=(s[6]<<16)+s[7],a3_=rpU32be(a3),d3=Util.divu64(a3_-a2,24),s.push(d3),smp=d3+d4,d4=d3,a2_=rpU32be(a2),128<d4)return i("@d55e d4="+Hex(d4)+" > 80h"),0
for(;0<d4;)a2_-=rel,wpU32be(a2,a2_),d5<=a2_&&(d5=a2_+2*rpU32be(a2+4)),d2>a2_&&(d2=a2_),a2+=24,a2_=rpU32be(a2),d4--
for(a2>(s[19]<<16)+s[20]&&(s[19]=a2>>16,s[20]=65535&a2),d0<<=2,a2=rpU32be((s[2]<<16)+s[3]),a2_=rpU32be(a2),d3=0;4294967295!=a2_&&d3<a2_-rel&&(d3=a2_-rel),a2+=4,a2_=rpU32be(a2),d0--,a2<X.Sz()&&0<d0;);for(a3=(s[8]<<16)+s[9];a3<X.Sz()&&(a3+=2,!X.c("0C40",a3-2)););if(d0=rpU16be(a3+22),s.push(d0),d5>d3){if(d5>X.Sz())return i("@d5ce error 1C"),0
for(a2=d2,a1=(s[19]<<16)+s[20];rpU16be(a1)==d0&&(a1+=6,wpU32be(a1,rpU32be(a1)-rel)),(a1+=2)!=a2&&a1<X.Sz(););a2=d5}else{if(d3>X.Sz())return i("@d5ee error 1C"),0
for(a2=d3;a2<X.Sz()&&(a2+=2,!(0<=[148,254,255,510,511].indexOf(rpU16be(a2-2)))););for(a1=d5,a1_=rpU32be(a1);d0==a1_>>16&&(a1+=6,a1_=rpU32be(a1)-rel,wpU32be(a1,a1_),d3<a1_)&&(d3=a1_),a1+=2,a1_=rpU32be(a1),a2!=a1;);if(a2<=d3)for(a2=d3;a2<X.Sz()&&(a2+=2,!(0<=[148,254,255,510,511].indexOf(rpU16be(a2-2)))););}patchClear(),K=a2,smpsz=d5-d2,songsz=a2-smpsz}else patchClear()
return 1}function t(s){for(;a2<X.Sz()&&!X.c(s,a2);)a2+=2}function r(s){for(;a2<X.Sz()&&(a2+=2,!X.c(s,a2-2)););}function i(s){return 1<debug&&_log("MikeDavies: "+s),patchClear(),!1}})()&&(sName="Mike Davies module (.MD)",bDetected=1,X.isVerbose())&&(1<k&&sOption(k,"×"),X.isDeepScan())&&sOption("smp:"+smp+" songsz:"+Hex(songsz)+" smpsz:"+Hex(smpsz)+" sz:"+outSz(K)),!bDetected&&(function(){if(a0=0,(X.c("0016",a0+4)||(a0+=6,X.c("0016",a0+4)))&&X.c("0000 00000000 00000000 ....0020 ....0020",a0+6)&&!(1&(d1=X.U32(a0+14,_BE)))&&X.c("00000058",a0+d1)){for(a2=a0+88,a3=0,X.c("0016",10)&&(a3+=6),a3=(a3+=X.U32(a3+14,_BE))+X.U32(a3,_BE),a2=a3,k=smp=K=d0=d3=0;a3<X.Sz();){if(a3=a2,a2+=4,!X.U32(a3,_BE)||X.U8(a3)){a3=K,K+=X.U32(a3+2,_BE)
break}if((a3+=X.I32(a3,_BE))>K&&(K=a3),a3>X.Sz())return
if(X.c("FF02",a3+6))k++
else{if((E=X.U32(a3+2,_BE))>X.Sz())return
smp++,d3+=E,d0<E&&(d0=E)}}return a3>X.Sz()||K>X.Sz()?void 0:(smpsz=d3,1)}})()&&(sName="Michel Pernot's Silmarils module (.MOK)",bDetected=1,bad="",3<k&&(bad=bad.addIfNone("!subsongs>3")),""!=(bad=32<smp?bad.addIfNone("!smp>32"):bad)&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose())&&(1<k&&sOption(k,"×"),sOption("smp:"+smp+" smpsz:"+Hex(smpsz)+" sz:"+outSz(K))),!bDetected&&(function(){if(!((E=X.U32(0,_BE))<112||1&E)&&X.c("FFFF FFFFFFFF",E-6)){for(K=E,smp=0,G=4;G<100;G+=12){if(1&(E=X.U32(G,_BE))||E&&E<112||K<E)return
E&&smp++}if(smp){for(;G<112;G+=4)if((E=X.U32(G,_BE))<112||1&E||K<E)return
return X.c("FFFF FFFFFFFF",G+E-6)?(smpsz=X.U32(100,_BE),G=116+smpsz,1):void 0}}})()&&(sName="GT Game Systems module (.DUX)",bDetected=1,X.isVerbose())&&(ord=1+Util.div64(X.U32(104,_BE)-smpsz,60),smpsz-=112,sOption("ord:"+ord+" smp:"+smp+" smpsz:"+Hex(smpsz)+" sz:"+outSz(K))),!bDetected&&(function(){if(X.c("'buz2'0200")&&(gvol=X.F32(8),isWithin(gvol,0,2))&&(bpm=X.U32(12),isWithin(bpm,10,200))&&(startpos=X.U32(16),ord=X.U32(20)+1,!(startpos>=ord||1<(looping=X.U8(24))))){for(nV=X.U16(6),G=156,K=-1,bad="",maxptn=maxtrk=64,maxtml=128,ptn=X.U32(G),trk=X.U32(G+4),G+=8,1<=nV&&(maxptn=X.I32(G),maxtrk=X.I32(G+4),maxtml=X.I32(G+8),G+=12),G+=16*maxptn+maxtrk*maxtml,trks=[],Y=0;Y<64;Y++)""!=(E=X.SA(G,64).trim())&&trks.push(E),G+=64
for(ptns=[],Y=0;Y<64;Y++)""!=(E=X.SA(G,64).trim())&&ptns.push(E),G+=64
if(ins=X.U32(G),!((G+=4)>X.Sz())){for(inss=[],totalops=0,Y=0;Y<ins;Y++){""!=(E=X.SA(G,128).trim())&&inss.push(E)
var s=X.U32(G+388)
totalops+=s,G+=9232+552*s}return(K=G)>X.Sz()&&(bad=bad.addIfNone("!short")),1}}})()&&(sName="Buzzic module (.buz2)",bDetected=1,sVersion="v2."+nV.padStart(2,"0"),X.isVerbose())&&sOption("bpm:"+bpm+" trk:"+trk+" ptn:"+ptn+" ins:"+ins+" g.vol:"+Math.round(100*gvol)+"% ops:"+totalops+" sz:"+outSz(K)),!bDetected&&(function(){if(X.c("000200")&&X.c("FF000F",X.U16(4,_BE)+1)){for(K=X.U16(16,_BE)+2,Y=10,oldp=X.U16(8,_BE);Y<32;Y+=2)if(16!=Y){if((G=X.U16(Y,_BE))<=oldp||G+1>X.Sz())return
if(!X.c("FF",G+1))return
oldp=G}return 1}})()&&(sName="Infogrames (RobHubbard2) module (.DUM&.INS)",bDetected=1,X.isVerbose())&&sOption(outSz(K),"sz:"),!bDetected&&(function(){if(X.c("6000")&&!((d2=X.U16(2,_BE))<=0||d2%2)){for(a1=2,a0=4,Y=0;Y<3;Y++){if(!X.c("6000",a0))return
if(E=X.U16(a0+2,_BE),a0+=4,E<=0||E%2)return}if(a1+=d2,X.c("6000",a0)){for(Y=0;Y<3;Y++){if(!X.c("6000",a0))return
if(E=X.U16(a0+2,_BE),a0+=4,E<=0||E%2)return}if(X.c("6000",a0))return}else{if(!X.c("6100",a1))return
a1+=4}return X.c("41F9",a1)?(a1+=6,!!X.c("43F9",a1)):void 0}})()&&(sName="M.Cannon & J.Dunn's Special FX module (.JD)",bDetected=1),!bDetected&&(function(){if(!(X.Sz()<2300)&&(X.c("00000000")||X.c("0101")||X.c("00000101")||X.c("6000"))){for(var s=0,e=140,t=X.Sz()-4;s<X.Sz()&&!X.c("00090800",s);)if(e==(s+=2))return
if(X.c("01120900",s+74)||X.c("02240A00",s+148)||X.c("00090800",s+222)||X.c("01120900",s+296)||X.c("02240A00",s+370)){for(s=e+1860;s<X.Sz()&&!X.c("0EF80E10",s);)if(t<=(s+=2))return
K=-1
for(var r,i,e=0,n=0;e<X.Sz()&&(d0-=2,e+=2,!X.c("E740",e-2)););for(k=X.U16(e-12,_BE),r=e-4+X.U16(e-4,_BE);e<X.Sz();){if(X.c("101A234A",e))e+=10
else if(X.c("4880D040",e))break
e+=2}for(i=e-2+X.U16(e-2,_BE);e<X.Sz()&&!X.c("08C70007",e);)e+=2
if(!((t=e)>=X.Sz())){for(;0<t&&(t-=2,!X.c("41FA",t)););for(;e<X.Sz();){if(X.c("41F9",e)){t=X.U16(e+2,_BE)
break}if(E=X.c("41FA",e),e+=2,E){t=e+X.U16(e,_BE)
break}}for(;e<X.Sz()&&!X.c("08870002",e);)e+=2
for(t=e+6,X.c("41F9",t-2)?n=t=X.U16(t,_BE):t+=X.U16(t,_BE);e<X.Sz()&&!X.c("08C70002",e);)e+=2
for(t=e+=10,X.c("41F9",t-2)?t=X.U16(t,_BE):t+=X.U16(t,_BE);e<X.Sz()&&(E=X.c("41FA",e),e+=2,!E););var t=e+X.U16(e,_BE),a=0
for(bad="";e<X.Sz();){if(X.c("0EF80E10",e)){a=1
break}if(X.c("7000101A",e))break
e+=2}if(!a){for(t=e-2+X.U16(e-2,_BE);e<X.Sz();){if(X.c("0EF80E10",e)){a=1
break}if(E=X.c("41FA",e),e+=2,E)break}t=e,e+=X.U16(e,_BE)}if(a||e>X.Sz()&&(bad=bad.addIfNone("!short"),a=2),!(a=a||(K=e,n)?a:1))for(;t<X.Sz()&&(X.c("41FA",t)&&(K=e=t+2+X.U16(t+2,_BE)+14),X.c("110010",t));)t+=2
return 2!=a&&(0<(d0=i-r)&&(d0>>=3),0<d0)&&(k=d0),1}}}})()&&(sName="Special FX ST module (.DODA)",bDetected=1,""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose())&&(1<k&&sOption(k,"×"),-1!=K)&&sOption(outSz(K),"sz:"),bDetected||(a0=d1=16+X.U16(2,_BE)+X.U16(6,_BE)+X.U16(10,_BE)+X.U16(14,_BE))>X.Sz()||a0%2||(a0+=X.U16(a0,_BE))%2||!X.c("005800B0",a0+4)||(sName="Tronic Delta Packer module (.DP)",bDetected=1,sOption("in:TronicTracker(?)")),!bDetected&&(function(){if(X.U16(0)&&(smp=X.U8(2))&&!((ord=X.U8(3))<2||!(d2=smpsz=X.U32(4,_BE))||d2%2||d2>X.Sz()||524288<d2||131072<(d3=X.U32(8,_BE)))){for(a0=12,k=0,Y=ord-1;Y;Y--){if((d4=X.I32(a0,_BE))<0||131072<d4||d4%2)return
X.U8(a0+4)||k++,a0+=6}if(X.c("00000000 0000",a0)){for(a0+=6,d3<<=2,a0+=d3,a2=a0+18*smp,s=0;a0<X.Sz()&&a0<a2;){if(d1=X.I32(a0+2,_BE),!isWithin(d1,0,d2))return
if((d0=X.U32(a0+12,_BE))>d2)return
if(64<X.U8(a0+16)||X.U8(a0+17))return
a0+=18}return a0>X.Sz()||d2!=d0+X.I32(a0-16,_BE)?void 0:(K=a0+smpsz,1)}}})()&&(sName="Andrew Bailey & David Hanlon's Digital Sonix & Chrome module (.DSC)",bDetected=1,X.isVerbose())&&(1<k&&sOption(k,"×"),sOption("ord:"+ord+" smp:"+smp+" sz:"+outSz(K))),!bDetected&&(function(){if(X.c("00000000 0000000 0000")){if((E=X.U16(164))===X.U16(168)&&E===X.U16(172)&&E===X.U16(176)&&0<(E=X.I16(160,_BE))&&!(E%2)&&X.c("00B400B6",E))fmt=1,G=166
else if((E=X.U16(516))===X.U16(520)&&E===X.U16(524)&&E===X.U16(528)&&0<(E=X.I16(512,_BE))&&!(E%2)&&X.c("02140216",E))fmt=-1,G=518
else{if(!((E=X.U16(514))===X.U16(518)&&E===X.U16(522)&&E===X.U16(526)&&0<(E=X.I16(516,_BE)))||E%2||!X.c("FFEC",E-2)&&!X.c("FFE8",E-2))return
fmt=0,G=516}for(mp=0,a3=0,Y=0;Y<4;Y++)E=X.U16(G,_BE),mp<E&&(mp=E),G+=4
for(a3+=mp,mp=X.U16(a3-2,_BE);a3<X.Sz()&&(E=X.U16(a3,_BE),a3+=2,E!=mp););if(smpp=a3,isWithin(smpp,1024,16384)){for(a3=1==fmt?X.I16(170,_BE):0==fmt?X.I16(516,_BE):X.I16(522,_BE),ord=0;a3<X.Sz()&&(E=X.U16(a3,_BE),a3+=2,E!=mp);)ord++
if(isWithin(ord,1,128)){for(Y=G=smp=smpsz=0;Y<16;Y++)G+=2,1!=fmt&&(G+=20),(E=X.U16(G,_BE))&&(smpsz+=E,smp++),G+=8,1!=fmt&&(G+=2)
return smpsz<<=1,smp&&isWithin(smpsz,8192,131072)?(K=smpp+smpsz,1):void 0}}}})()&&(sName="Paul Shields' module (.PS)",sVersion="f."+fmt,bDetected=1,X.isVerbose())&&sOption("ord:"+ord+" smp:"+smp+" smpsz:"+Hex(smpsz)+" sz:"+outSz(K)),!bDetected&&(function(){if(!(X.Sz()<863)&&isWithin(X.U32(0),196608,262144)&&X.c("'Tempo'00",182)&&isWithin(X.U16(44),1,48)&&isWithin(X.U16(46),1,16)&&isWithin(X.U16(48),16,80)&&isWithin(X.U16(50),32,80)&&isWithin(X.U8(52),0,1)&&!(1<(mode=X.U8(53)))){for(bpm0=X.F16(197),q=!0,ch=voices=X.U8(53)?9:11,ev=X.U16(199),Y=mclk=0,G=54;Y<45;Y++,G+=2)Y<11&&(X.U16(G)||ch--,mclk=Math.max(mclk,X.U16(G)))
for(Y=54;Y<76&&q;Y+=2)4351<X.U16(Y)&&(q=!1)
for(;Y<144&&q;Y+=2)511<X.U16(Y)&&(q=!1)
if(q){for(G=203+6*X.U16(201),mtln=mdur=notev=insev=volev=pitev=0,Y=0;Y<voices;Y++){if(G+=15,dur=0,tln=X.U16(G),G+=2,tln)for(;dur+=X.U16(G+2),G+=4,notev++,dur<tln&&G<X.Sz(););tln>mtln&&(mtln=tln),dur>mdur&&(mdur=dur),G+=15,insev+=E=X.U16(G),G+=2+14*E+15,volev+=E=X.U16(G),G+=2+6*E+15,pitev+=E=X.U16(G),G+=2+6*E}return K=G,1}}})()&&(sName="Ad Lib's AdLib Visual Composer pianoroll (.ROL)",bDetected=1,X.isVerbose())&&("\\roll\\default"!=(l=X.SA(4,40))&&sOption(l),sOption("ch:"+(ch!=voices?ch+"/":"")+voices+" rhythm:"+X.U16(44)+"/"+X.U16(46)+" bpm0:"+bpm0.toFixed(1)+" len:"+mdur+" notes:"+notev+" ins.ev:"+insev+" ins.ev:"+insev+" vol.ev:"+volev+" pitchev:"+pitev+" sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<428)&&X.c("'GYMX'")){for(Y=4;Y<424;Y++)if(isWithin(X.U8(Y),1,10)||isWithin(X.U8(Y),14,31))return
return(unpsz=X.U32(424))<=2&&parseMDGYM(428,X.isDeepScan()?BCParseToEoF:BCParseToReasonable)<=0?void 0:1}})()&&(sName="Sega Genesis/Mega Drive YM2612 chiptune (.GYM)",bDetected=1,unpsz<=2&&(sVersion=sVersion.append("unpacked")),X.isVerbose())&&(sOptionT(X.SC(4,32,"CP1252")),sOptionT(X.SC(36,32,"CP1252"),"for: "),sOptionT(X.SC(68,32,"CP1252"),"at: "),sOptionT(X.SC(100,32,"CP1252"),"emu: "),sOptionT(X.SC(132,32,"CP1252"),"by: "),sOptionT(X.SC(164,256,"CP1252")),2<unpsz)&&sOptionT(X.U32(424),"unp.sz:"),!bDetected&&(function(){if(!(!X.c("6000.... 6000.... 6000")||(G=base=a6=X.I16(2,_BE)+2)<=0||G%2||(playp=X.I16(6,_BE)+6)<=0||playp%2)){for(p1=G+30;G<p1&&!X.c("47FA",G-2);G+=2);if(!(G>=p1)){var s=G
for(E=Math.min(X.Sz(),131072);G<E&&!X.c("4E75",G-2);G+=2);if(!(G>=X.Sz()||E<=G)&&(fmt="old",X.c("177C0000",G-8)&&(fmt="new",G-=6),X.c("00BFE001",G-6))){if(G=base,k=1,d0=0,X.c("1740",G+6)||X.c("1740",G+4)){for(;G<X.Sz()&&!X.c("47FA",G-2);G+=2);G+=X.I16(G,_BE),a6=G}else do{if(X.c("3C00",G)){for(a3=a6=(G=s)+X.I16(G,_BE);G<X.Sz()&&!X.c("7600",G-2);G+=2);for(a3+=X.I16(G-4,_BE)+3,d0=7;d0&&(X.U16(a3,_BE)||1!=X.U8(a3+2));a3+=3,k++,d0--);d0=X.U8(a3-1)
break}for(X.c("4A00",G+40)&&(k++,d0=X.I16(G+52,_BE));G<X.Sz()&&!X.c("47FA",G-2);G+=2);}while(G+=X.I16(G,_BE),a6=G,0)
for(ord=d0,G=12;G<X.Sz()&&!X.c("1743",G-2);G+=2);for(a3=a6,pos=a6+X.I16(G,_BE),G=12;G<X.Sz()&&!X.c("5203",G-2);G+=2);if(K=-1,patchable=X.c("177C",G+10)){if(a2=base,a3+=X.I16(G+2,_BE),ord=ord||X.U8(a3),"new"==fmt){for(G=base+2;G<X.Sz()&&!X.c("41EB",G-2);G+=2);for(a3=a6,a6+=X.I16(G,_BE),a3+=X.I16(G+4,_BE),a6+=X.I32(a3,_BE),smpip=a6,songsz=a6+X.I16(a3-2,_BE),smp=smpsz=0;a6<X.Sz()&&(d3=X.I32(a6,_BE),a6+=4,0<d3&&(A=X.U16(a6,_BE)<<1)&&(smp++,d3+=A,smpsz<d3)&&(smpsz=d3),!((a6+=6)>=songsz)););}else{for(G=base+2;G<X.Sz()&&!X.c("3D70",G-2);G+=2);for(;G<X.Sz()&&!X.c("D5F0",G-2);G+=2);for(a3=a6+X.I16(G-4,_BE),a6+=X.I32(a3,_BE),E=a6,a6+=X.U16(G-18,_BE),smpip=a6,smp=smpsz=0,a3=a6+128,d1=32;d1;d1--)1<X.U16(a3,_BE)&&(smp++,A=X.U16(a3,_BE)<<1,d3=A+X.I32(a6,_BE),smpsz<d3)&&(smpsz=d3),a6+=4,a3+=2
songsz=E+X.U16(G-8,_BE)}K=songsz+smpsz}return 1}}}})()&&(sName="Sound Master module (.SM,.SMPRO,.SM3)",sVersion=fmt,bDetected=1,X.isVerbose())&&(1<k&&sOption(k,"×"),patchable)&&sOption("ord:"+ord+" sz:"+outSz(K)),!bDetected&&(function(){if(!(X.Sz()<1728||2097152<(K=X.U32(0,_BE))||K%2||(d2=X.U32(4,_BE))>K||d2%2||1023&(d2-=704)||(ptn=d2>>=10,d2--,G=444,X.U8(G))||(ord=d1=X.I8(G+1))<0)){for(G+=4,d2<<=10,d3=0;d1;G+=2,d1--){if(1023&(E=X.I16(G,_BE)))return
d3<E&&(d3=E)}if(d2==d3){for(smp=0,G=14;G<448;G+=14)X.U16(G,_BE)&&smp++
return 1}}})()&&(sName="Tom Pakarinen's Tomy Tracker module (.SG)",bDetected=1,X.isVerbose())&&sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K)),!bDetected&&(function(){if((X.c("0003",32)||X.c("0002",32)&&!X.U32(28,_BE))&&!X.U16(16,_BE)&&!((G=X.I16(18,_BE))<0||G%2)&&X.c("FFFF0000 0400",G+62)&&(F=X.readBytes(0,16),!(charStat(F,1).indexOf("allasc")<0||(F=decEncoding(F,"CP437"),a2=0,a3=K=64+X.U32(16,_BE),d2=X.U32(20,_BE),K+=d2,a4=K,d1=X.U32(24,_BE),K+=d1+X.U32(28,_BE),d2-=1024,X.Sz()<K)))){for(ord=d1=Util.divu64(d1,12),d1--,voc=0,d3=6;d3;d3--,a4+=2)for(G=a4,d4=ord;d4;d4--,G+=12)if(X.U16(G,_BE)){voc++
break}for(a3+=1084,smp=d3=0;d2>d3;)d4=X.U32(a3,_BE),a3+=d4,d3+=d4,smp++
if(k=1,nv=0,sv="",X.U32(28,_BE))switch(K){case 95960:k=2
case 54544:sv="v4.0"
break
case 81906:sv="v5.0"}else switch(K){case 126446:k=3,sv="v3.0"
break
case 136612:k=2,sv="v3.0"
break
case 154704:k=2
case 103808:sv="v3.2"}for(G=64,ptn=0;G<576;G+=2)X.U16(G,_BE)&&ptn++
return 1}})()&&(sName="Holger Gehrmann's Soundcontrol module (.SCT)",sVersion=sv,bDetected=1,X.isVerbose())&&(sOptionT(F),1<k&&sOption(k,"×"),sOption("ch:"+voc+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K))),!bDetected&&(function(){if(!(2097152<(K=X.U32(0,_BE))||K>X.Sz())){for(lastfound=!(k=16),G=19;4<=G;G--){if(15<(E=X.U8(G)))return
!lastfound&&E&&(k=G-4,lastfound=!0)}for(m=X.U32(20,_BE),G=24;G<276;G+=4){if(2097152<(E=X.U32(G,_BE))||K<E)return
m>E&&(m=E)}if(276==m){if(X.isDeepScan()){for(G=276,smp=smpsz=0;G<K-8;){for(;q=X.fSig(G,K-8-G,"84"),(G=q<0?K:q+q%2)<K&&!q%2;);G<K&&(d1=X.U8(G+1))<=31?(d1>>=2,smpp[d1]=G,d4=X.U16(G+2,_BE)<<1,smpsz+=d4-38,smp++,G+=d4):G+=2}if(!smp||32<smp)return}return 1}}})()&&(sName="Soundfactory module (.PSF)",bDetected=1,X.isVerbose())&&(1<k&&sOption(k,"×"),sOption((X.isDeepScan()?"smp:"+smp+" smpsz:"+Hex(smpsz)+" ":"")+"sz:"+outSz(K))),!bDetected&&(function(){if(ord=X.U8(0),ptn=X.U8(1),ins=X.U8(2),!(!ptn||204<ptn||31<ins)){var s=[],e=[]
for(G=3,mptn=mins=0,Y=0;Y<ptn;Y++){if(203<(E=X.U8(G++)))return
mptn<E&&(mptn=E),s.indexOf(E)<0&&s.push(E)}if(ins)for(Y=0;Y<ins;Y++){if(!isWithin(E=X.U8(G++),1,31))return
mins<E&&(mins=E),e.indexOf(E)<0&&e.push(E)}if(rptn=s.length,rins=e.length,mptn++,!(rptn!=ptn||ins&&rins!=ins)){for(o=0;o<ord;o++)for(Y=0;Y<9;Y++)if(s.indexOf(X.U8(G++))<0)return
for(notes=0,Y=0;Y<64*ptn;Y++,G+=3){var t=X.U8(G)>>4,r=(1&X.U8(G))<<4|X.U8(G+1)>>4
if(12<t||r&&e.indexOf(r)<0)return
12!=t&&notes++}return G+=11*ins,"v1.3"==(sv=X.c("'B.J.'",G)?(G+=4,"v1.8"):"v1.3")&&100<ptn?void 0:(K=G,1)}}})()&&(sName="SPP's Beni Tracker (Adlib) module (.PIS)",sVersion=sv,bDetected=1,X.isVerbose())&&sOption("ord:"+ord+" ptn:"+ptn+(ptn!=mptn?"/"+mptn:"")+" ins:"+ins+(ins!=mins?"/"+mins:"")+" notes:"+notes+" sz:"+outSz(K)),!bDetected&&(function(){for(G=0;G<16;G+=4)if(!X.c("6000",G)||(E=X.U16(G+2,_BE))>X.Sz()||E%2)return
if(E=X.I16(6,_BE)+6,X.c("49FA....1940....4E75 43FA.... 49FA.... 41FA.... 45FA",E)&&X.c("'FORM'66",E+28)&&(E=X.I16(10,_BE)+10,X.c("49FA....4CFA00FF",E))&&X.c("103A.... 660C 1940.... 6100... .6000",E+10)&&X.c("2A4C DAD8 22CD 2A4C DAD8 22CD 2A4C DAD8 22CD",E+52)&&(E=X.I16(14,_BE)+14,X.c("70002A7C 00DFF0A8 3A803B40",E))&&X.c("1A801B40 00011B40 00021B40",E+26)&&(initp=X.I16(2,_BE)+2,X.c("43FA....49FA....41FA....45FA",initp))&&X.c("'FORM'66",initp+18)){for(a0=0,G=initp;G<initp+16;G+=2)if(X.c("41FA",G-2)){a0=G+X.I16(G,_BE)
break}if(!((G=6+X.fSig(initp,4096,"E7404281"))<6)){for(E=G+X.I16(G,_BE);G<X.Sz()&&!X.c("41FA",G-2);G+=2);for(;G<X.Sz()&&!X.c("D08043FA",G);G+=2);for(G=(G+=4)+X.I16(G,_BE),k=G-E>>3,G=a0,smp=0;G<X.Sz();smp++){if(!X.c("'FORM'........'8SVXVHDR'",G)){X.U32(G)||(G+=4)
break}G+=8+X.U32(G+4,_BE)}return K=G,smp?1:void 0}}})()&&(sName="Steve Barrett's module (.SB)",bDetected=1,X.isVerbose())&&(1<k&&sOption(k,"×"),sOption("smp:"+smp+" sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<1024)&&X.c("49FA",16)){for(G=0;G<16;G+=4)if(!X.c("6000",G)||(E=X.I16(G+2,_BE))<=0||E%2)return
if(X.c("48E7FFFE 4DFA.... 51EE.... 41FA",G=2+X.I16(2,_BE))&&X.c("48E7FFFE 4DFA.... 4A2E.... 6700.... 70033F00 49FA",G=6+X.I16(6,_BE))&&X.c("48E7FFFE 4DFA.... 51EE.... 6100",G=10+X.I16(10,_BE))){for(G=16;G<X.Sz()&&!X.c("40C2",G);G+=2);for(;G<X.Sz()&&!X.c("41FA",G);G+=2);for(K=(G+=6)+X.I16(G,_BE),G+=2;G<X.Sz()&&!X.c("43E9",G-2);G+=2);if(K+=X.I16(G,_BE)<<1,!((a3=K)>X.Sz())){for(a0=0;G<X.Sz()&&(X.c("206C0032",G)&&(a0+=8,G+=4),!X.c("08380007",G)&&!X.c("08390007",G));G+=2);for(;G<K&&!X.c("40C1",G);G+=2);for(G+=4;G<X.Sz()&&!X.c("4CDF",G);G+=2);for(;G<K&&86!=X.I32(G,_BE);G+=2);for(k=0;G<a3;G+=2)70==X.I16(G,_BE)&&k++
return k>>=2,1}}}})()&&(sName="Illusions/Microdeal Quartet module (SQT.)",sVersion="PSG synth",bDetected=1,X.isVerbose())&&(1<k&&sOption(k,"×"),sOption(outSz(K),"sz:")),!bDetected&&(function(){if(G=modp=smp=synsmp=ord=ptn=0,k=1,sv=bad="",owner=[],X.c("'SOARV1.0STBL'")){if(k=X.I32(12,_BE),spd0=X.U8(17),ptnlen0=X.U8(19),pst0=X.U16(20,_BE),ped0=X.U16(22,_BE),lp0=X.U16(24,_BE),irqps0=X.U16(26,_BE),!isWithin(spd0,2,16)||!isWithin(irqps0,16,120)||pst0>ped0||lp0>ped0)return
if(G=16+12*k,!X.c("'OVTB'",G))return
if(ord=X.I32(G+4,_BE),ped0>ord)return
if(G+=24+(ord<<4),!X.c("'NTBL'",G-16))return
if(ntbl=X.I32(G-12,_BE),G+=ntbl<<2,!X.c("'INST'",G-8))return
for(ptn=Util.divu64(ntbl,16),ins=X.I32(G-4,_BE),inss=[],Y=0;Y<ins;Y++,G+=152)X.U16(G,_BE)?synsmp++:smp++,E=X.readBytes(G+122,30,!0),""!=(E=decEncoding(E,CPAmiga).trim())&&inss.push(E)
if(!X.c("'SD8B'",G))return
for(n=smp=X.I32(G+4,_BE),G+=8+38*smp,pp=G,G+=smp<<2;n--&&G<X.Sz();pp+=4)G+=X.U32(pp,_BE)
if(!X.c("'SYWT'",G))return
if(synsmp=X.I32(G+4,_BE),G+=8+(synsmp<<7),!X.c("'SYAR'",G))return
if(E=X.I32(G+4,_BE),G+=8+(E<<7),!X.c("'SYAF'",G))return
if(E=X.I32(G+4,_BE),G+=8+(E<<7),!X.c("'EDAT'",G))return
K=G+24,sv="song"}else{if(X.c("4EFA")){if((E=X.I16(2,_BE))<=0||E%2)return
if(!X.c("48E7FFFE 41FA",E+2)||!X.c("201045F0 0800228A 43FA",E+14)||!X.c("20280004 45F00800 228A 43FA",E+26))return
if((G=X.I16(E+8,_BE))<=0||G%2)return
modp=G+=E+8,sv="+replayer"}else sv="pure"
if(G+40>X.Sz()||!X.c("00000028",G))return
if(spd0=X.U16(G+40,_BE),irqps0=X.U16(G+50,_BE),lp0=X.U16(G+48,_BE),!isWithin(spd0,2,16)||!isWithin(irqps0,16,120))return;(1==(k=(X.I32(G+4,_BE)-40)/12)||X.I16(G+60,_BE)<0)&&(k=1)
var s=[0]
for(Y=0;Y<8;Y++){if(E=X.I32(G,_BE),G+=4,E<=0||E%2||E<s[s.length-1])return
s.push(E)}var e=s[2],t=s[3],r=s[4],i=s[5],n=X.I32(modp+E,_BE)
if(ord=Util.div64(t-e,16),ptn=Util.div64(r-t,64),ins=Util.div64(i-r,152),(G=modp+E)>X.Sz())return
for(Y=0;Y<ins;Y++)X.U16(modp+r+152*Y,_BE)?synsmp++:smp++
if(smp!=n&&(bad=bad.addIfNone("!inconsistentsmpcnt"+n)),G+=4,smp)for(pp=G,G+=n<<2;n--&&G<X.Sz();pp+=4)G+=X.U32(pp,_BE)
if(!X.c("'deadbeef'",G)){if(!X.isHeuristicScan())return
bad=bad.addIfNone("!badeof")}for(n=G+=12,lim=Math.min(G+1024,X.Sz());G<lim&&!(255==(l=255^X.U8(G++))||isWithin(l,0,8)||isWithin(l,11,12)||isWithin(l,14,31));)10==l&&(l=32)==owner[owner.length-1]||owner.push(l)
32==owner[owner.length-1]&&owner.pop(),K=G,255!=l&&G-n!=80&&(bad=bad.addIfNone("!badinfo"))}return bpm0=(15*irqps0/spd0).toFixed(1),owner=decEncoding(owner,CPAmiga).trim(),1})()&&(sName="BrainTrace Design's Sonic Arranger module (.SA"+("pure"==sv?",.LION":"")+")",bDetected=1,sVersion=sv,""!=bad&&(sVersion=sVersion.appendS("malformed:"+bad,"/")),X.isVerbose())&&(1<k&&sOption(k,"×"),""!=owner&&sOption(addEllipsis(owner,160,128),'info:"','"'),sOption("bpm0:"+bpm0+(ord?" ord:"+ord:"")+(lp0?" lp0:"+lp0:"")+(ptn?" ptn:"+ptn:"")+(ins?" ins:"+ins:"")+(smp?" wf.smp:"+smp:"")+(synsmp?" syn.smp:"+synsmp:"")+" sz:"+outSz(K))),!bDetected&&X.c("'SASI'00000000000100")&&(sName="BrainTrace Design/MEDIA Verlags Sonic Arranger synth instrument",bDetected=1),!bDetected&&(function(){if(!(X.Sz()<1700)){for(G=0;G<40&&!X.c("02390001",G);G+=2);if(40!=G&&(G+=8,X.c("66..4E75",G++))&&!((E=X.I8(G++))<=0)){if(G+=E,X.c("4A39",G))for(c=4;c--;G+=18)if(!X.c("4A39",G))return
if(X.c("78001839",G)){for(c=G;;){if((G=X.fSig(c,262144,"1400E302"))<0)return
if(!(Y%2))break
c=G+1}for(var s=X.U32(G+6,_BE);;){if((G=X.fSig(c,262144,"03580328"))<0)return
if(!(Y%2))break
c=G+1}for(s-=G,G=0;G<262144&&(!X.c("B23C00FF",G)&&!X.c("0C0100FF",G));G+=2);if(!(262144<=G)){for(;G<262144&&!X.c("267C",G-2);G+=2);if(!(262144<=G)){for(G+=4;G<262144&&!X.c("49F9",G-2);G+=2);if(!(262144<=G)){for(smpip=X.U32(G,_BE)-s,G+=4;G<262144&&!X.c("0026267C",G-4);G+=2);if(!(262144<=G)){for(G+=4;G<262144&&!X.c("23F4",G);G+=2);if(!(262144<=G)){for(subsongp=X.U32(G-4,_BE)-s,G+=6,k=0,G=subsongp;G<262144&&12==X.U8(G+16)&&(E=X.U32(G,_BE),X.U32(G+4,_BE)!=E||X.U32(G+8,_BE)!=E||X.U32(G+12,_BE)!=E);G+=18)k++
for(c=X.U32(smpip,_BE)-s,Y=smpip+4,a=c-Y>>2,d0=X.I32(c+4,_BE),d1=2*X.I16(c+2,_BE)+d0,smp=1;Y<c;Y+=4)E=X.U32(Y,_BE)-s,(d3=X.U32(E+4,_BE))&&(d4=2*X.I16(E+2,_BE)+d3,d3<d0&&(d0=d3),d4>d1&&(d1=d4),smp++)
for(songsz=d0-s,K=d1-s,Y=0;Y<262144&&!X.c("4E75",Y-2);Y+=2);return specialmsg="",2!=(d1=X.U8(Y-3))&&(specialmsg=X.SC(Y,256,CPAmiga)),1}}}}}}}}})()&&(sName="Jeroen 'WAVE' Tel's module (.JT)",bDetected=1,X.isVerbose())&&(""!=specialmsg&&sOption(specialmsg),1<k&&sOption(k,"×"),sOption("smp:"+smp+" songsz:"+Hex(songsz)+" sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<=306||!X.c("'AN COOL'")||127<(ptn=X.U32(8,_BE))||15<(tmp0=X.U8(12))||X.U8(13)||(ord=X.I8(142))<=0)){if("!"==X.SA(7,1))fmt=0
else{if("."!=X.SA(7,1))return
fmt=1}if(ptnp=fmt?306:272,!((smpp=ptnp+512*ptn)+212>X.Sz())&&X.c("FFFFFFFF00000000",smpp+204)&&212==X.U32(smpp+68,_BE)){for(smp=0,G=smpp+72,Y=0;Y<16&&G<X.Sz();Y++)1!=X.U32(G,_BE)&&smp++
return K=smpp+X.U32(smpp,_BE),1}}})()&&(sName="Anders 'AN Cool' Nilsson's TCB Tracker module (.TCB)",sVersion="f."+fmt,bDetected=1,X.isVerbose())&&sOption("tempo:"+tmp0+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K)),!bDetected&&(function(){if(!(!X.c("'if'")&&!X.c("'JN'")||X.Sz()<2033||64<(smp=X.U8(110))||128<(ptn=X.U8(111))||128<=(lp=X.U8(112)))){for(ic=0,Y=2;Y<109;Y++)if(isWithin(X.U8(Y),1,31)&&40<++ic)return
for(Y=ord=0;Y<128;Y++){if((o=X.U8(113+Y))>=ptn&&o<254)return
if(o<128&&!(E=X.U8(241+Y)))return
if(15<E||64<=X.U8(369+Y))return
o<254&&ord++}if(K=497+25*smp+1536*ptn,!(X.Sz()<K)){for(Y=rsmp=0;Y<smp;Y++)if(A=X.U32(510+25*Y),slps=X.U32(514+25*Y),slpe=X.U32(518+25*Y),A){if(rsmp++,67108864<A)return
if([1048575,15794175,4294967295].indexOf(slps)<0&&slps>A)return
if([1048575,15794175,4294967295].indexOf(slpe)<0&&(slpe>A||slpe<slps))return
K+=A}return 1}}})()&&(sName=(X.c("'if'")?"Renaissance's Composer 669":"Jason 'JsNO BAR----' Nunn's UNIS 669 Composer")+" module (.669)",bDetected=1,X.isVerbose())&&(E=(E=(E=X.SC(2,36,"CP850").trim()).appendS(X.SC(38,36,"CP850").trim()," ")).appendS(X.SC(74,36,"CP850").trim()," "),sOption(E),sOption("ord:"+ord+(lp?" loop:"+lp:"")+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K))),!bDetected&&X.isDeepScan()&&(function(){if(!(X.Sz()<44712)&&(susv=0,ins=X.U32(18944))&&!(128<ins)&&(trk=X.U32(36492))&&!(64<trk)&&(ptn=X.U32(36484))&&!(128<ptn)&&!((gvol=X.F32(36500))<0||2<gvol||(gvol=Math.round(100*gvol)+"%",(bpm=X.U8(36504))<10&&susv++,start=X.U32(36508),(ord=X.U32(36512))||susv++,127<ord)||start>ord||(ord++,1<(floop=X.U32(36516))))){for(Y=0;Y<ins;Y++){if((G=148*Y)+147>Math.min(X.Sz(),18944))return
if(1<X.U8(G+128))return
var s=X.I8(G+129)
if(s||susv++,s<0&&-s>trk)return
var e=X.I8(G+130)
if(e<0&&-e>trk)return
e=X.U8(G+131)
if(127<e)return
var t=X.I8(G+132)
if(t<0&&-t>trk)return
e||susv++,t||susv++
e=X.U8(G+133)
if(3<e)return
e<3&&!s&&susv++
t=X.I8(G+134)
if(0<s&&s+t<=0)return;(t<-32||64<t)&&susv++
e=X.U8(G+135),s=X.U8(G+136),t=X.U8(G+137)
if(s<e||t<s||127<t||127<e||127<t)return
e||s||t||susv++
e=X.I8(G+138)
if(e<0&&-e>trk)return
s=X.I8(G+140)
if(s<0&&-s>trk)return
t=X.U8(G+141),e=X.U8(G+142),s=X.U8(G+143)
if(127<t||127<e||127<s)return
t=X.I8(G+144)
if(t<0&&t>trk)return
e=X.I8(G+145)
if(e<0&&e>trk)return
s=X.U8(G+146),t=X.U8(G+147)
if(127<s||127<t||!t&&s||t&&t<=s)return}if(!(susv>3*ins)){for(Y=18948;Y<20100;Y++)if(127<X.U8(Y))return
for(Y=20100;Y<28292;Y++)if(X.U8(Y)>ptn)return 0<debug&&_logIt("@"+Hex(Y)+": bad ptn"),0
return isAllZeroes(28292,8192)?1:void 0}0<debug&&_logIt("data too suspicious")}})()&&(sName="Buzzic module (.BUZ)",sVersion="v1.0",bDetected=1,sOption("trk:"+trk+" ord:"+ord+(start?" (from "+start+")":"")+" ptn:"+ptn+" ins:"+ins+" bpm:"+bpm+" gvol:"+gvol+" sz:44712")),!bDetected&&X.isDeepScan()&&(function(){if(!(X.Sz()<45224)&&(susv=0,ins=X.U32(19456))&&!(128<ins)&&(trk=X.U32(37004))&&!(64<trk)&&(ptn=X.U32(36996))&&!(128<ptn)&&!((gvol=X.F32(37012))<0|1.91<gvol||(gvol=Math.round(100*gvol)+"%",(bpm=X.U8(37016))<10&&susv++,start=X.U32(37020),(ord=X.U32(37024))||susv++,127<ord)||start>ord||(ord++,1<(floop=X.U32(37028))))){for(Y=0;Y<ins;Y++){if((G=152*Y)+151>Math.min(X.Sz(),18944))return
if(1<X.U8(G+128))return
var s=X.I8(G+129)
if(s||susv++,s<0&&-s>trk)return
var e=X.I8(G+130)
if(e<0&&-e>trk)return
e=X.U8(G+131)
if(127<e)return
var t=X.I8(G+132)
if(t<0&&-t>trk)return
e||susv++,t||susv++
e=X.U8(G+133)
if(3<e)return
e<3&&!s&&susv++
t=X.I8(G+134)
if(0<s&&s+t<=0)return;(t<-32||64<t)&&susv++
e=X.U8(G+135),s=X.U8(G+136),t=X.U8(G+137)
if(s<e||t<s||127<t||127<e||127<t)return
e||s||t||susv++
e=X.I8(G+138)
if(e<0&&-e>trk)return
s=X.I8(G+140)
if(s<0&&-s>trk)return
t=X.U8(G+141),e=X.U8(G+142),s=X.U8(G+143)
if(127<t||127<e||127<s)return
t=X.I8(G+144)
if(t<0&&t>trk)return
e=X.I8(G+145)
if(e<0&&e>trk)return
s=X.U8(G+146),t=X.U8(G+147)
if(127<s||127<t||!t&&s||t&&t<=s)return
if(118<X.I8(G+148))return
e=X.I8(G+149),t=X.I8(G+151)
if(e<0&&-e>trk||t<0&&-t>trk)return}if(!(susv>3*ins)){for(Y=19460;Y<20612;Y++)if(127<X.U8(Y))return
for(Y=20612;Y<28804;Y++)if(X.U8(Y)>ptn)return 0<debug&&_logIt("@"+Hex(Y)),0
return isAllZeroes(28804,8192)?1:void 0}0<debug&&_logIt("too suspicious")}})()&&(sName="Buzzic module (.BUZ)",sVersion="v1.1",bDetected=1,sOption("trk:"+trk+" ord:"+ord+(start?" (from "+start+")":"")+" ptn:"+ptn+" ins:"+ins+" bpm:"+bpm+" gvol:"+gvol+" sz:45224")),!bDetected&&(function(){function s(s,e){return-1<debug&&_l2r("mdx",s,e),!1}if(!(X.Sz()<42||(da1=X.fSig(0,Math.min(1024,X.Sz()),"0D0A1A"))<0)){for(crypt=X.c("00'crypt'",da1-6),sus=crypt?-10:0,Y=0;Y<da1;Y++)if(X.U8(Y)<32&&[0,9,27,10,26].indexOf(X.U8(Y))<0)return
if(F=X.SC(0,da1,"SJIS"),!((G=X.fSig(da1+3,Math.min(15,X.Sz()-da1),"00"))<0)){if(pdxfn=da1+3!=G?X.SC(da1+3,G,"SJIS"):"",ofs=++G,bad="",comp=!1,ch=9,"LZX "==X.SA(ofs+4,4)&&(lzxsz=X.U32(ofs+18,_BE)))return comp=!0,(K=X.fSig(ofs+22,TOEOF,"'[ LZX.X ]'0D0A0000")+13)<13&&(bad=bad.addIfNone("!short")),usedch=ch,bpm0=notes=vdn=0,1
if(crypt?vd=-1:((vd=X.U16(ofs,_BE)+ofs)>X.Sz()&&(vd=-1,sus++),241!=X.U8(vd-2)&&241!=X.U8(vd-3)&&(vd=-1,sus++),G+=2),X.c("0014",G)||X.c("0022",G)){if(m=Math.min(1048575,X.Sz()-2),crypt)K=X.fSig(ofs+20,m,"'protected by cryptmdx v1.00 (c)1995 H.Yano'00")+43,usedch=ch,bpm0=0
else{var e=chn=oldchn=X.U16(G,_BE)+ofs
if(!isWithin(chn,G,m))return s(chn,"!chn"+Hex(G)+"-"+Hex(m)),0
ch=(chn-ofs-2)/2,usedch=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],notes=vdn=mp=0,vds=[]
var t=bpm0=-1,r=[],i=[0,1]
if(X.isDeepScan())for(visited=[],Y=0;Y<m;Y++)visited[Y]=0
for(U=1;U<=ch;U++){(G+=2)>mp&&(mp=G),U==ch?chn=isWithin(vd,oldchn+2,X.Sz())?vd:m:(chn=X.U16(G,_BE)+ofs,isWithin(chn,oldchn+2,m)&&(241==X.U8(chn-2)||241==X.U8(chn-3))||(chn=oldchn,usedch[U-1]=!1),isWithin(chn,oldchn+2,m)||(s(chn,"!p="+Hex(G)+",ch["+U+"] not between "+Hex(oldchn+2)+" and "+Hex(m)),sus+=2),241!=X.U8(chn-2)&&241!=X.U8(chn-3)&&(bad=bad.addIfNone("!badchnend@"+Hex(chn-2)+"="+Hex(X.U24(chn-3,_BE))),X.isDeepScan()||sus++))
var n=clk=0
if(X.isDeepScan())for(t=oldchn,stop=!1;!stop&&t!=chn&&t<m;){_log(Hex(t)+" >> "+MDXCmdStr(U-1,t)),visited[t]=1,t>mp&&(mp=t)
var a=X.U8(t++)
if(a<128)clk+=a+1
else if(a<=223)n++,notes++,usedch[U-1]=!0,clk+=X.U8(t++)+1
else switch(a){case 255:bpm0<0&&(bpm0=X.U8(t)),t++
break
case 254:p=X.U8(t),b=X.U8(t+1),isYM2151Reg()?8==p&&200&b?(n++,notes++,usedch[7&b]=!0):isWithin(p,96,127)&&(i[0]=!0):(sus++,bad=bad.addIfNone("!OPMreg@"+Hex(t-2))),t+=2
break
case 253:E=X.U8(t++),vds.indexOf(E)<0&&vds.push(E)
break
case 252:t++
break
case 251:E=X.U8(t++),isWithin(E,22,127)&&(bad=bad.addIfNone("!FB@"+Hex(t-2)+"="+Hex(E)),sus++),i[0]=1
break
case 250:case 249:case 247:case 238:case 232:break
case 248:(E=X.U8(t++))||(bad=bad.addIfNone("!F8@"+Hex(t-1)),sus++)
break
case 246:X.U8(t+1)?t++:t+=2
break
case 245:246!=X.U8(t+X.I16(t,_BE)-1)&&(bad=bad.addIfNone("!F5→F6@"+Hex(t)),sus++),t+=2
break
case 244:245!=X.U8(t+X.I16(t,_BE)+1)&&(bad=bad.addIfNone("!F4→F5@"+Hex(t)),sus++),t+=2
break
case 243:case 242:t+=2
break
case 241:X.U8(t)?(r[U]=t+2+X.I16(t,_BE),isWithin(r[U],e,m)||(bad=bad.addIfNone("!loopOOB@"+Hex(t-1)),sus++),visited[r[U]]?(stop=!0,t+=2):t=r[U]):t++,0<vd&&vd<t&&(vd=t)
break
case 240:case 239:case 237:t++
break
case 236:case 235:case 234:128!=(E=X.U8(t++))&&129!=E&&(t+=4)
break
case 233:t++
break
case 231:1!=X.U8(t)&&(bad=bad.addIfNone("!E7@"+Hex(t-1)),sus++),t+=2
break
default:stop=!0,bad=bad.addIfNone("!unk"+Hex(a)),sus++}t>mp&&(mp=t)}if(n&&(usedch[U-1]=!0),oldchn=chn,8<sus)return s(mp,sus+" "+bad),0}if(X.isDeepScan()&&"1"!=i[0]&&(bad=bad.addIfNone("!novol"),sus++),8<sus)return s(mp,sus+" "+bad),0
if(0<vd&&vd<chn&&(bad=bad.addIfNone("!ins@"+Hex(vd)+"<chn@"+Hex(chn)),sus++),X.isDeepScan()){vdn=vds.length,vds.sort(function(s,e){return s-e})
var o=[]
for(m=Math.min(X.Sz(),vd+6912),G=0<vd&&vd<chn?chn:0<vd?vd:G;vds.length&&G<m&&vds.length&&(!(192&X.U8(G+1)||240&X.U8(G+2))&&o.indexOf(E=X.U8(G))<0);G+=27)o.push(E),vds=vds.filter(function(s,e,t){return s!=X.U8(G)}),G>mp&&(mp=G)
o.sort(function(s,e){return s-e}),vds.length&&(bad+="!missingInst"+outArray(vds,16)),K=mp+27}K=X.isDeepScan()?mp:-1,vd==X.Sz()&&(K=vd)}return 1}}}})()&&(sName="Konami's X68k Music Data eXtended module (.MDX)",bDetected=1,""!=pdxfn&&(sVersion=sVersion.appendS("+ "+pdxfn," ")),9<ch&&(sVersion+="#EX-PCM"),comp&&(sVersion=sVersion.appendS("compressed","/")),crypt&&(sVersion=sVersion.appendS("cryptmdx","/")),bad.length&&(sVersion=sVersion.appendS("malformed"+bad+(sus?"/sus"+sus:""),"/")),X.isVerbose())){for(sOption(addEllipsis(F),'"','"'),ch=0,Y=0;Y<16;Y++)usedch[Y]&&ch++
crypt?sOption("sz:"+outSz(K)):sOption("ch:"+ch+" bpm0:"+(bpm0<0?"default":bpm0)+(notes?" notes:"+notes:"")+(vdn?" ins:"+vdn:"")+(0<K?" sz:"+outSz(K):""))}if(!bDetected&&_s()&&(sName="Fred & Julien Clermonte's Fred Editor module (.FRED,.FRD)",sVersion="final",bDetected=1,""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose())&&(1<k&&sOption(k,"×"),sOption("tempo:"+spds.sort().join("-")+(smp?" smp:"+smp:"")+(syn?" syn:"+syn:"")+" sz:"+outSz(K))),!bDetected&&(function(){if(X.c("'AMF'")){var s=X.U8(3)
if((1==s||isWithin(s,8,14))&&(G=s<9?4:36,smp=X.U8(G),ord=X.U8(G+1),trk=X.U16(G+2),ch=9<=s?X.U8(G+4):16,smp)&&ord&&trk&&(G+=9<=s?5:4,!(s<12)||isWithin(ch,1,16))&&isWithin(ch,1,32)){G+=11<=s?12<=s?32:16:9<=s?16:0,spd0=13<=s?((tmp0=X.U8(G++))<32&&(tmp0=125),X.U8(G++)):(tmp0=125,6)
for(14<=s&&0,Y=0;Y<ord;Y++)14<=s&&(ord,X.U16(G),X.U16(G),G+=2),G+=2*ch
var e=!1
if(10==s){var t=G
for(Y=0;Y<smp;Y++)if(t+65<X.Sz()){if(1<X.U8(t)||X.U32(t+46)>smp||1048576<(A=X.U32(t+50))||64<X.U8(t+56)||X.U32(t+57)>A||X.U32(t+61)>A){e=!0
break}t+=65}}smps=[]
var r=0
for(rsmp=0,Y=0;Y<smp;Y++)(E=X.SC(G+1,32,"CP437").trim()).length&&smps.push(E),s<10?(r+=E=X.U16(G+50),E&&rsmp++,G+=59):(r+=E=X.U32(G+50),E&&rsmp++,G+=e?59:65)
for(trkc=0,Y=0;Y<trk;Y++)E=X.U16(G),G+=2,E>trkc&&(trkc=E)
for(Y=0;Y<trkc;Y++)E=X.U16(G),G+=3,E&&(G+=3*E+(1==s?3:0))
return K=G+r,1}}})()&&(sName="Digital Sound and Music Interface Advanced Music Format module (.AMF)",sVersion="v"+X.U8(3),bDetected=1,X.isVerbose())&&(sOptionT(X.SC(4,32,"CP437")),sOption(addEllipsis(smps.join(" "),160),'smp/msg:"','"'),sOption("ch:"+ch+" spd0:"+spd0+" tmp0:"+tmp0+" ord:"+ord+" trk:"+(trkc!=trk?trkc+"/":"")+trk+" smp:"+(rsmp==smp?"":rsmp+"/")+smp+" sz:"+outSz(K))),!bDetected&&(function(){if(X.c("'SAdT'")&&isWithin(nV=X.U8(4),1,9)){var s
switch(nV){case 1:s=7
break
case 2:s=6
break
case 3:s=6
break
case 4:s=14
break
case 5:0
case 6:s=142
break
case 7:s=200
break
case 8:s=152
break
case 9:s=184}for(G=5+31*(8&s?15:11),Y=0,inst=[];Y<29;Y++)""!=(E=X.SC(G+1,X.U8(G),"CP437").trim())&&inst.push(E),G+=17
G+=3
var e=X.readBytes(G,128)
if(G+=128,1&s&&(G+=127),isWithin(ptn=X.U16(G),1,64)&&(G+=2,isWithin(ord=X.U8(G++),1,128))){for(Y=rptn=0;Y<ord;Y++)e[Y]+1>rptn&&(rptn=e[Y]+1)
if(e=void 0,!(rptn>ptn||(lp=X.U8(G++))>=ord)){if(bpm=X.U16(G),G+=2,4&s&&(bpm=5*bpm/2),128&s&&(G+=512),16&s&&(G+=576),32&s?(actch=X.U16(G)<<16,G+=2):actch=-1,trk=0,2&s)for(;trk<ptn&&G<X.Sz();)G+=2880,trk++
else if(64&s)for(;trk<ptn&&G<X.Sz();)G+=1728,trk++
else for(;trk<576&&G<X.Sz();)G+=192,trk++
return K=G,1}}}})()&&(sName=nV<8?"Surprise! AdLib Tracker module (.SAT)":"Surprise! AdLib Tracker 2 module (.SA2)",sVersion="v"+nV,bDetected=1,X.isVerbose())&&(sOptionT(addEllipsis(inst.join(" "),160),'ins/msg:"','"'),sOption("bpm:"+bpm+(0<=actch?"ch:"+actch:"")+" ord:"+(lp?lp+"-":"")+ord+" ptn:"+(rptn!=ptn?rptn+"/":"")+ptn+(trk!=ptn?" trk:"+trk:"")+" sz:"+outSz(K))),!bDetected&&Os()){switch(sName="Chris Hülsbeck's The Final Musicsystem eXtended module (TFX.,.TFM,MDAT.+SMPL.,MDST.+SMPL.)",bDetected=1,tp){case"1.5":sVersion="v1.5"
break
case"pro":sVersion="Professional"
break
case"7v":sVersion="7 voices"}tfmxst&&(sVersion="ST "+sVersion),pt<ptn&&(sVersion+="/malformed!badptn"),X.isVerbose()&&(sOptionT(F),1<k&&sOption(k,"×"),sOption(album,"in: "),sOptionT(by,"by: "),0<=flag5&&sOption(flag5,"flag5:"),"(Empty)"==cmt&&(cmt=""),sOption(addEllipsis(cmt,160),'msg:"','"'),sOption("ord:"+ord.join("+")+" ptn:"+ptn+(ptn!=pt?"/"+pt:"")+" ins:"+(128<ins?"128/":"")+ins+" sz:"+outSz(K)))}if(!bDetected&&(function(){if((X.c("'P22A'")||X.c("'P30A'")||X.c("'P40A'")||X.c("'P40B'")||X.c("'P41A'"))&&(ptn=X.U8(4),smp=X.U8(6),volofs="41A"==X.SA(1,3)?32:34,!(127<ptn||!smp||31<smp))){for(Y=0;Y<smp;Y++){if(!isWithin(X.U16(volofs+16*Y,_BE),1,64))return
if(32==volofs&&X.U16(volofs+2+16*Y,_BE)%74)return}for(Y=smpsz=0;Y<smp;Y++){if(!(A=X.U16(24+16*Y,_BE)<<1)||65534<A||X.U16(30+16*Y,_BE)<<1>A+2)return
smpsz+=A}if(!(smpsz<=4)){ord=X.SA(1,1)<"4"?(X.U8(5)>>1)-1:X.U8(5),G=16+16*smp
var s=X.U32(8,_BE),e=X.U32(12,_BE),t=X.U32(16,_BE),r=0
if(G!=e&&(s-=r=e-G,e-=r,t-=r),isWithin(s,G,X.Sz())&&isWithin(e,G,X.Sz())&&isWithin(t,G,X.Sz())){for(Y=G=0;Y<smp;Y++){if(32==volofs&&1110<X.U16(volofs+2+16*Y,_BE))continue;(Q=X.U32(20+16*Y,_BE))>G&&(G=Q-r,A=X.U16(24+16*Y,_BE))}return K=4+t+G+(A<<1),1}}}})()&&(sName="Jarno 'Guru' Paananen's The Player module (."+X.SA(0,2)+"X,."+X.SA(0,4)+")",sVersion="v"+X.SA(1,1)+"."+X.SA(2,2),bDetected=1,X.isVerbose())&&sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K)),!bDetected&&Bs()&&(sName="Jarno 'Guru' Paananen's The Player module (.P"+sv[0]+"X,.P"+sv[0]+sv[2]+"A)",sVersion="v"+sv+"A",bDetected=1,dtsmp&&(sVersion=sVersion.appendS("deltasmp","/")),pksmp&&(sVersion=sVersion.appendS("packedsmp","/")),X.isVerbose())&&sOption("ord:"+ord+" ptn:"+(mptn!=ptn?mptn+"/":"")+ptn+" smp:"+smp+(0<notes?" notes:"+notes:"")+" sz:"+outSz(smpp+smpsz)),!bDetected&&(function(){if(!(X.Sz()<6800)){var s=X.I32(46,_BE)
if(isWithin(s,2,67108864)&&!(s%2)&&X.I32(0,_BE)-s==64){for(G=4,Y=0,d4=64;Y<4;Y++,G+=4)if(d4+=1024,X.I32(G,_BE)-s!=d4)return
for(Y=0;Y<3;Y++,G+=4)if(d4+=256,X.I32(G,_BE)-s!=d4)return
for(smp=X.U8(35),K=smp-1,smpsz=-1,G=68;G<4160;G+=4)(E=X.U32(G-4,_BE)-s)>K&&(K=E)
if(!(((K+=64)-6800)%3)){if(k=11792==K?5:10112==K?3:1,ptn=Util.divu64(Util.divu64(K-6800,3),X.U8(41)+1),bad="",1024<ptn&&(bad=bad.addIfNone("!badptn")),31<smp)bad=bad.addIfNone("!badsmp")
else for(Y=0,G=5360;Y<smp;Y++,G+=48)smpsz+=X.U16(G,_BE)
return d1=256+X.U8(33)-X.U8(34)+1,d1*=2+X.U8(44),d2=d1,d1*=X.U16(42,_BE),d3=Util.divu64(14318==K?715904:709376,X.U8(41)+1),d1=Util.divu64(d1,d3),dur=secondsToTimeStr(d1),1}}}})()&&(sName="Thomas Hermann's module (.THM+.SMP)",bDetected=1,bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose())&&(1<k&&sOption(k,"×"),sOption("len."+dur+" ptn:"+ptn+" smp:"+smp+" smpsz:"+smpsz+" sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<26243)&&isWithin(X.U32(0),3456,3457)&&(ptn=X.U32(4))&&(k=X.U32(8))&&(ins=X.U32(12))&&isAllZeroes(16,36)){for(mbpm=400,Mbpm=ch=smp=0,ord=[],titles=[],s=0,G=52;s<k&&G<X.Sz();s++,G+=16564){for(Y=G+64;Y<G+80;Y++)if(1<X.U8(Y))return
if(!isWithin(bpm=X.U32(G+80),10,300))return
if(mbpm>bpm&&(mbpm=bpm),Mbpm<bpm&&(Mbpm=bpm),!isWithin(X.U8(G+84),0,3))return
if((startpos=X.U32(G+88))>(endpos=X.U32(G+96)))return
if((looppos=X.U32(G+104))>endpos)return
if(!isWithin(E=X.U16(G+146),1,16))return
if(ch<E&&(ch=E),!isWithin(delay=X.U16(G+148),2e3,6e4))return
if(!isWithin(amp=X.U16(G+166),20,999))return
if(X.isDeepScan())for(o=G+180;o<G+16564;o+=4)if(X.U16(o)>=ptn||!X.U16(o+2)||-121&X.U16(o+2))return
"Empty"!==(E=X.SC(G+114,32,"CP1250"))&&""!==E.trim()&&titles.push(E.trim()),ord.push(endpos)}for(G+=64*ptn*5,Y=0;Y<ptn&&G<X.Sz();Y++)G+=4+X.U32(G)
for(Y=0;Y<ins&&G<X.Sz();Y++,G+=8712){if([1234,1235].indexOf(X.U16(G))<0)return
if(16<X.U16(G+34)||!isWithin(X.U16(G+36),1,256))return
if(255<X.U16(G+38)||16<X.U16(G+40)||32<X.U16(G+42))return
if(15<X.U16(G+46)||16<X.U16(G+48)||64<X.U16(G+50))return
X.U32(G+512)&&smp++,(E=X.U32(G+516))&&(G+=E)}return G>X.Sz()?void 0:(G+=256,1)}})()&&(sName="Reinier 'Rhino' van Vliet's Jaytrax/Syntrax module (.JXS)",sVersion="v."+X.U32(0),bDetected=1,X.isVerbose())&&(1<titles.length?sOption(addEllipsis(titles.join("/"),192),"×"+k+" subsongs:"):(titles.length&&sOption(titles[0]),1<k&&sOption(k,"×")),ord=1<k?ord.join("+"):(startpos?startpos+"~":"")+(looppos>startpos?"("+looppos+"-)":"")+endpos,sOption("ch:"+ch+" bpm:"+mbpm+(mbpm!=Mbpm?"-"+Mbpm:"")+" ord:"+ord+" ptn:"+ptn+" ins:"+ins+" smp:"+smp+" sz:"+outSz(G))),!bDetected&&(function(){if(33==X.U8(0)&&128==X.U8(9)&&(ord=X.U16(1))&&(ins=X.U16(3))&&(smp=X.U16(5))&&!(smp>ins)&&(ptn=X.U16(7))&&isWithin(mvol=X.U8(10),1,32)&&isWithin(spd=X.U8(11),1,32)&&isWithin(tmp=X.U8(12),32,160)&&!(charStat(X.readBytes(13,26),1).indexOf("allxsc")<0)){for(G=39;G<103;G++)if(64<X.U8(G))return
for(G=167;G<167+ord;G++)if(255!=X.U8(G)&&X.U8(G)>=ptn)return
if(255==X.U8(G-1)){var s
for(rins=0,rsmp=0,bad="",Y=0;Y<ins&&G<X.Sz();Y++){if(["I","i"].indexOf(s=X.SA(G++,1))<0)return
if("I"===s){if(128<X.U8(G+2))return
for(G+=0<=X.I8(G+5)?244:6,c=3;c;c--)if(X.U8(G++)){if(X.U8(G+1)>X.U8(G+2)||X.U8(G+3)>X.U8(G+4))return
G+=5+3*X.U8(G)}rins++}}for(Y=smpsz=0;Y<smp&&G<X.Sz();Y++){if(s=X.SA(G++,1),["S","s"].indexOf(s)<0)return
if("S"==s){if(64<X.U8(G)||64<X.U8(G+2))return
X.U8(G+1)
var e=X.I32(G+3),t=X.U32(G+7),r=X.U32(G+11),i=X.U32(G+14),n=X.U32(G+19),a=X.readBytes(G+32,13)
if(charStat(a,1).indexOf("allxsc")<0)return
switch(decEncoding(a,CP437)){case"909OH.WAV":e=3424
break
case"909SD.WAV":e=3413
break
case"CRASH.WAV":e=16098}if(e<t||e<r||e<i||e<n||r<t||n<i)return
smpsz+=e,G+=45,rsmp++}}for(Y=0;Y<ptn&&G<X.Sz();Y++){if(s=X.SA(G++,1),["P","p"].indexOf(s)<0)return
if("P"==s){var o=X.U16(G),p=X.U16(G+2)
if(!o||!p)return
G+=4+o}}for(c=X.U32(G),G+=4,Y=0;Y<c&&G<X.Sz()&&!(charStat(X.readBytes(G,8),1).indexOf("allxsc")<0);Y++,G+=268);return c=X.U8(G++),1}}})()&&(sName="Sahara Surfers' iXalance module (.IXS)",sVersion="unpacked",bDetected=1,bad.length&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose())&&(sOptionT(X.SA(13,26,"CP1250")),sOption("ord:"+ord+" ptn:"+ptn+" ins:"+(rins!=ins?rins+"/":"")+ins+" smp:"+(rsmp!=smp?rsmp+"/":"")+smp+" smpsz:"+smpsz+"s sz:"+outSz(G))),!bDetected&&(function(){var s=126
if(X.c("200D0A1A",122)){if(!X.c("0D0A",53)||!X.c("0D0A",108))return}else if(!X.c("20202020",122))if(X.c("04C50964c504641A2609810F9919008C82100C830382100CC464C464C464C4641A"))s=0
else{if(!X.c("'msx2'00469E2A4E8A22626C2D'bl-demo.bas'00",2607)||!X.c("'OPXPLAY SYS'00",2860))return
s=3198}if(4!=X.U8(0))for(Y=0;Y<53;Y++)if(X.U8(Y)<32)return
return!(2<X.U8(s+1)||63<X.U8(s+3)||6<X.U8(s+4)||5<X.U8(s+6)||33<X.U8(s+7)||1<X.U8(s+8)||79<X.U8(s+9)||X.U8(s+10)||1<X.U8(s+12)||3<X.U8(s+14)||3<X.U8(s+16)||3<X.U8(s+18))})()&&(sName="MSX Performer OPX chiptune (.OPX)",bDetected=1,X.isVerbose())&&sOption(addEllipsis(X.SC(0,123,"SJIS"))),!bDetected&&(function(){if(!(X.Sz()<1852||(smpp=X.U32(1080,_BE))<=1084||(d1h=(smpp-1084)%768)||(ptn=d2=Util.div64(smpp-1084,768),127<(ord=X.U8(950))))){for(mptn=0,Y=0;Y<=ord;Y++){if(127<(E=X.U8(952+Y)))return
mptn<E&&(mptn=E)}if(ptn==mptn+1){for(smp=smpsz=0,smps=[],bad="",smpns=[],Y=0;Y<31;Y++)X.isVerbose()&&smpns.push(X.SC(20+30*Y,22,"CP437").trim()),(E=X.U16(20+30*Y+22,_BE))&&(smp++,smpsz+=E<<1)
if(msmp=smpns[smpns.length-1],(K=smpp+smpsz)<X.Sz()&&(bad=bad.addIfNone("!short")),a1=952,d1=ord,k=a0=notes=0,X.isVerbose()){do{a0=1084+768*X.U8(a1),a3=a0+768,a1++
do{var s=X.readBytes(a0,2),e=(192&s[0])>>2|s[1]>>4
if(63&s[0]&&(notes++,debug)&&e>msmp&&(bad=bad.addIfNone("!missingsmp#"+e)),!1&s[1]){k++
break}}while((a0+=3)<a3&&a0<X.Sz())}while(--d1)
k=k||1}else k=1
return 28732===smpp&&12898===smpsz&&X.c("'beast-busters1.st'")&&(k=11),1}}})()&&(sName="Neil Crossley's Images Music System module (.IMS)",bDetected=1,sVersion="v1.0",""!=bad&&(sVersion=sVersion.appendS("malformed"+bad,"/")),X.isVerbose())&&(sOption(X.SC(0,20,"CP437")),1<k&&sOption(k,"×"),sOption(addEllipsis(smpns.filter(funSampleName).join(","),256,160),'smp/msg:"','"'),sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K))),!bDetected&&(function(){if(!(X.Sz()<555)){var s,e=0,t=!0,r=0,e=b(X.readBytes(0,20))
for(bad="",B=allvols=smp=r=0,snames=[],U=0;U<15;U++){var i=X.readBytes(20+30*U,22,!0),n=decEncoding(i,CPAmiga).trim()
if(/ST-[0-9A-F]+:/i.test(n)?e-=4:snames.push(n),e+=b(i),S(20+30*U,"STKsmp["+U+'] "'+n.trim()+'" invalid chars:'+e+" ("+charStat(i,1)+")"),10<e)return S(20+30*U,"!title or sample names too broken"),0
if(X.U8(20+30*U)&&!/^st-[0-9a-f]\d:/i.test(n)&&(t=!1),73728<(slen=2*X.U16(42+30*U,_BE)))return S(42+30*U,"!smp #"+U+" too large:"+Hex(slen)),0
if(15<X.U8(44+30*U)&&(bad=bad.addIfNone("!finetune"),e+=16),64<(T=X.U8(45+30*U)))return
sls=X.U16(46+30*U,_BE),sll=X.U16(48+30*U,_BE),(9998<slen||4999<sls)&&(r=Math.max(r,5)),slen&&smp++,B+=slen,allvols+=T,sll>slen+2&&(S(42+30*U,"!smp "+U+" LpLen "+sll+" > sSz "+slen),bad=bad.addIfNone("!sLpLen>sSz")),slen&&sls>=slen&&(S(46+30*U,"!smp "+U+" LpStart "+sls+" >= sSz "+slen),bad=bad.addIfNone("!sLpStart>=sSz")),sls&&!sll&&(S(42+30*U,"!smp "+U+" LpStart "+sls+" LpSz 0"),bad=bad.addIfNone("!sLpStart0LpSz")),sls&&!slen&&(S(46+30*U,"!smp "+U+" LpStart "+sls+" sSz 0"),bad=bad.addIfNone("!sLpStart0SSz"))}if(B<8||!allvols)return S(20,"!smps too small or no smpvols"),0
if(!(128<(ord=X.U8(470))||220<(restartp=X.U8(471)))){for(restartp&&!/jjk55/.test(X.SA(0,6))||(restartp=120),bpm0=125,120!=restartp&&(bpm0=(88672375/(6100*(240-restartp))).toFixed(2),r=1<r?Math.max(r,t?4:5):Math.max(r,t?1:2)),ptn=offptn=badptn=ord_=0,usedptns=[],usedsmps=[],o=0;o<128;o++){if(63<(k=X.U8(472+o)))return S(472+o,"!impossible ptn #"+k),0
ptn<=k&&(ptn=k+1,o<ord)&&(offptn=ptn,usedptns.indexOf(k)<0)&&usedptns.push(k),k>=badptn&&(badptn=ptn+1),k&&ord_++}if(ord_++,(songszoffptn=600+1024*offptn)>X.Sz())return S(songszoffptn,"!patterns cut off"),0
for(e=tnDxx=notes=0,Y=0;Y<ptn;Y++){for(emptycmd=nDxx=badnote=ptnic=ptnotes=0,row=0;row<64;row++)for(chn=0;chn<4;chn++){var a=600+(Y<<10)+(row<<4)+(chn<<2),a=(k=X.readBytes(a,4),X.isDeepScan()&&(emptycmd||k[0]||k[1]||k[2]||k[3]?emptycmd=0:32<++emptycmd&&(r=6)),240&k[0]|(240&k[2])>>4),p=((15&k[0])<<8)+k[1],d=15&k[2]
if(0<=usedptns.indexOf(Y)&&(15<a?ptnic++:usedsmps.indexOf(a)<0&&usedsmps.push(a)),!(X.isDeepScan()||notes<100)||0<=(a=[0,856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113]).indexOf(s=p)||0<=a.indexOf(s-1)||0<=a.indexOf(s+1)?p&&ptnotes++:(ptnic+=2,badnote++),X.isDeepScan())switch(d){case 1:case 2:31<k[3]&&1==r?r=t?1:0:1==d&&0<k[3]&&k[3]<3?r=Math.max(r,2):1==d&&(55==k[3]||71==k[3])&&r<=2&&(r=t?1:0)
break
case 11:r=6
break
case 12:case 13:case 14:if(r=Math.max(r,2),13==d){if(emptycmd=1,!k[3]&&!row)break
nDxx++}break
case 15:r<3&&(r=3)}}if(ptn>=offptn&&64<ptnic?ptn=offptn:(e+=ptnic,notes+=ptnotes,badnote&&(bad=bad.addIfNone("!badnotes"))),e>Math.max(512,128*ptn))return S("!badbytes:"+e),0
nDxx&&nDxx<3&&(r=6),tnDxx+=nDxx}if(tnDxx>ptn+32&&6==r&&(r=5),X.isDeepScan())switch(r){case 0:tracker="Karsten Obarski's Ultimate ST 1.0~21"
break
case 1:tracker="Karsten Obarski's Ultimate ST 1.8~2.0"
break
case 2:tracker="The Exterminator's ST 2.0 / D.O.C.'s ST II"
break
case 3:tracker="Il Scuro/Defjam's ST III / Alpha Flight ST IV / D.O.C.'s' ST IV / VI"
break
case 4:tracker="D.O.C.'s' ST IX"
break
case 5:tracker="Tip/The New Masters' Master ST 1.0"
break
case 6:tracker="D.O.C.'s ST 2.0~2"
break
default:tracker="???"}K=600+1024*ptn+B
var c=Math.abs(K-X.Sz()),m=Math.abs(ord-ord_),f=ord||1e-4,l=0
return(20<e&&l++,isWithin(smp,3,15)||l++,2048<c&&l++,K>X.Sz()&&l++,restartp||l++,ord&&ord_&&!(badptn>ptn+2)||l++,.8<m/f&&l++,ptn||l++,notes<2&&l++,allvols<smp&&l++,isWithin(bpm0,20,300)||l++,4<=l)?S(l,"!too suspicious"):(e&&(bad=bad.addIfNone("!baddata="+e)),K>X.Sz()&&(bad=bad.addIfNone("!short")),l&&(bad=bad.addIfNone("!sus+"+l)),1)}}function b(s){for(var e=0,t=0;t<s.length;t++)s[t]&&(s[t]<32||isWithin(128,254))&&[10,13,14].indexOf(s[t])<0&&e++
return e}function S(s,e){return 1<debug&&_l2r("stk",s,e),!1}})()&&(sName="Karsten Obarski's SoundTracker module (.STK,.MOD)",bDetected=1,""!=bad&&(sVersion="malformed"+bad),X.isVerbose())&&(sOptionT(X.SA(0,20)),X.isDeepScan()&&sOption(tracker,"in:"),sOption(snames.filter(funSampleName).join(" "),'smps/msg:"','"'),sOption("bpm0:"+bpm0+" ord:"+ord+(ord_!=ord?"/"+ord_:"")+" ptn:"+(offptn!=ptn?offptn+"/":"")+ptn+" smp:"+smp+(X.isDeepScan()?" notes:"+notes:"")+" sz:"+outSz(K))),!bDetected&&(function(){if(spd=X.U8(0),isWithin(spd,1,15)&&(ord=X.U8(1))&&!(128<=ord)&&(ptn=X.U8(2))&&!(32<(smp=X.U8(3))||(opl=X.U8(4),(lp=X.U8(5))>ord)||(smpp=X.U32(6))>X.Sz())){for(G=10,Y=0;Y<ord;Y++)if(X.U8(G++)>=ptn)return
for(ptnpt=G,G+=4*ptn,Y=smpsz=0;Y<smp;Y++,G+=16){if(X.U32(G))return
var s=X.U32(G+4),e=X.U32(G+8),t=X.U32(G+12)
if(!s||1048575<s)return
if(smpsz+=s,t<1048575&&(s<t||t<e))return}for(Y=0;Y<opl;Y++,G+=11){if(240&X.U8(G))return
if(252&X.U8(G+5))return
if(252&X.U8(G+10))return}for(Y=notes=0,ptnp=G,bad=!1;Y<ptn;Y++){if((G=ptnp+X.U32(ptnpt+4*Y))>smpp-3)return
if(ptnend=Y>=ptn-1?smpp:ptnp+X.U32(ptnpt+4*Y+4),!isWithin(ptnend-G,3,4096))return
for(i=0;G<ptnend;){var r=X.U8(G++)
if(r<=12)G+=2,notes++
else if(32<=r&&r<=44)G++
else{if(64!=r){if(96==r)break
return}i+=X.U8(G++)}}if(64<i)return}return K=smpsz+smpp,0<opl+smp}})()&&(sName="CDFM/Composer 670 module (.670)",sVersion="compact",bDetected=1,bad&&(sVersion="malformed!badptn"),X.isVerbose())&&sOption("spd:"+spd+" ord:"+ord+(lp?" lp:"+lp:"")+" ptn:"+ptn+" smp:"+smp+" fm:"+opl+" notes:"+notes+" sz:"+outSz(K)),!bDetected&&(function(){if(!(X.Sz()<136||2<(mode=X.U8(0))||31<X.U8(1)&&208!=X.U8(1)||X.U8(2)<66||67<X.U8(2)||(tempo=X.U8(3))<3||31<tempo||135&(ptnsz=X.U8(4)))){for(Y=5;Y<14;Y++)if(4<X.U8(Y))return
if(!(2<(regbd=X.U8(14)))&&(ins=X.U16(15))&&!(63<ins)){for(G=17;G<17+46*ins;G+=46){if(3<X.U8(G+4)&&225!=X.U8(G+4)||4<X.U8(G+9))return
if(127<X.U8(G+10)||192&X.U8(G+12))return
if(!isWithin(X.I8(G+21),-48,48)||!isWithin(X.I8(G+23),-48,48))return
if(!isWithin(X.I8(G+27),-48,48)||!isWithin(X.I8(G+32),-48,48))return
if(48<X.U8(G+36)||1<X.U8(G+37)||!isWithin(X.I8(G+39),-4,0))return
if(isInside(X.U8(G+43),48,232)||X.U16(G+44))return}if((ord=X.U16(G))&&!(96<ord)){for(mp=-1,ptnp=(G+=2)+9*ord*3+2,Y=0;Y<ord;Y++)for(c=0;c<9;c++){if((pt=X.U16(G))%2||pt+ptnp>X.Sz()||16384<pt)return
mp<pt&&(mp=pt),G+=3}return digisnd=X.U16(G),G+=2,K=ptnp+digisnd,X.Sz()<K?void 0:(ptn=Util.divu64(digisnd,2),1)}}}})()&&(sName="Loudness Sound System Ad Lib module (.LDS)",bDetected=1,X.isVerbose())&&sOption("ch:9 mode:"+mode+" spd:"+X.U16(1)+" tempo:"+tempo+" ord:"+ord+" ptn:"+ptn+" ins:"+ins+" sz:"+outSz(K)),!bDetected&&(function(){for(Y=0;Y<4;Y++)if(!isWithin(X.U8(Y),0,87))return
for(;Y<11;Y++)if(X.U8(Y))return
for(;Y<16;Y++)if(X.U8(Y)<251)return
for(;Y<32;Y++)if([240,4,6,8,12].indexOf(X.U8(Y))<0)return
for(l=0;Y<37;Y++){if(5<X.U8(Y))return
X.U8(Y)||l++}if(!(3<l)){for(;Y<42;Y++)if(X.U8(Y))return
for(;Y<48;Y++)if(1<X.U8(Y))return
for(Y=64;Y<80;Y++)if(!isWithin(X.U8(Y),32,63))return
return X.c("32323232 323232",68)?1:void 0}})()&&(sName="Ken Silverman's Adlib module (.KSM)",bDetected=1,X.isVerbose())&&sOption("notes:"+(notes=X.U16(80))+" sz:"+outSz(82+4*notes)),!bDetected&&(function(){function s(s,e){return 1<debug&&_l2r("tmc",s,e),!1}if(!(X.Sz()<464||32!=X.U8(35))){if((bin=parseAtariBinary())[0]<470)return s("!binsz"),0
if(255!=X.U8(bin[1][0][1]+5))return s(0,"!ptnend"+outArray(bin,16)),0
if(!isWithin(spd0=X.U8(36),1,16)||!isWithin(ticks=X.U8(37),1,4))return s(37,"!spd"+spd0+"/"+ticks),0
for(ins=t0=0,p0=65536,G=38;G<102;G++)if(X.U8(G)||X.U8(G+64)){if([0,9].indexOf(15&X.U8(G))<0)return s("!susins"),0
if((E=(X.U8(G+64)<<8)+X.U8(G)+6-X.U16(2))<0||E<=t0)return s(E,"!-insptr"),0
if(0<(t0=E)){if(!isWithin(E,416,bin[1][0][1]+6))return s(E,"!insptr"),0
ins++,p0>E&&(p0=E)}}if(!ins)return s(p0,"!0inst"),0
if([0,9].indexOf(15&X.U8(166))<0)return s(p0,"!0ptnptr"),0
for(ptn=t0=0,G=166;G<294;G++){if(E=(X.U8(G+128)<<8)+X.U8(G)-X.U16(2)+6,p0>E&&(p0=E),E<0||E<=t0)return s(E,"!-ptnptr"),0
if((t0=E)&&!isWithin(E,416,bin[1][0][1]+6))return s(E,"!ptnptr"),0
E&&255!=X.U8(E)&&ptn++}for(ord=p0-422>>4,G=423,pt=-1,ic=0;G<p0;G+=2)X.c("FF",G)||X.c("7F",G)||(127<X.U8(G)?ic++:X.U8(G)>=pt&&(pt=X.U8(G)+1))
return 1}})()&&(sName="Marcin 'Jaskier' Lewandowski's Theta Music Composer module (.TMC,.TM4,.TM8)",sVersion="v1.x",bDetected=1,ic&&(sVersion=sVersion.appendS("malformed!"+ic+"ptns","/")),X.isVerbose())&&(sOption(decAnsi(6,30,CPATASCII,Chars0to1FATASCII_PL)),sOption("spd0:"+spd0+" ticks:"+ticks+" ord:"+ord+" ptn:"+(pt!=ptn?pt+"/":"")+ptn+" ins:"+ins+" sz:"+outSz(bin[0]))),!bDetected&&Vs()&&(sName="Radik 'Raster' Štěrba's Raster Music Tracker module (.RMT)",sVersion="v"+v,bDetected=1,X.isVerbose())&&(1<bin[1].length&&sOption("metadata present"),sOption("ch:"+ch+" spd0:"+spd0+" ticks:"+ticks+" sz:"+outSz(bin[0]))),!bDetected&&(function(){if(X.c("AE")&&!(X.Sz()<121)){K=unpsz=-(G=1)
for(var s=end=W=0,e=Array(65536),t=[-1,-2,-3,-4];!end&&s<(X.isDeepScan()?65536:256)&&G<Math.min(X.isDeepScan()?65535:256,X.Sz());)if(174==(E=i(G++))){if((l=i(G++))<0)return n("PTFault: bad count"),0
if(!l){end=!0
break}if(1===l)e[s++]=174
else{if((b=i(G++))<0)return n("PTFault: bad byte"),0
for(;l;l--)e[s++]=b}}else e[s++]=E
if((tempo=e[8129])<16)return n("PTFault: tempo < 10h"),0
if(e[8064]||e[8080])return n("PTFault: nonzero smp#0"),0
if(s%256)for(;s%256&&32===e[s-1];)s--
if(s%256||X.isDeepScan()&&s<8192||65535<s||65535<G)return n("PTFault: bad range! o="+Hex(s)+" p="+Hex(G)),0
if((modsz=e[8131]+16<<8)!=s)return n("PTFault: allsmpsz mismatch: "+Hex(modsz)+" != "+Hex(s)),0
var r=[4,12]
for(smp=0,Y=8065;Y<8080;Y++)16<=e[Y]&&smp++,e[Y]>r[0]&&(r[0]=e[Y],r[1]=e[Y+16])
if((lastsmpend=(r[0]+16<<8)+(r[1]<<8))!=s)return n("PTFault: last smp end "+Hex(lastsmpend)+" != "+Hex(s)),0
for(notes=ic=0,Y=0;Y<Math.min(7936,s);Y++)e[Y]&&240!=e[Y]&&(notes++,(240&e[Y])==e[Y])&&ic++
if(X.isDeepScan())for(Y=8192;Y<s;Y++)if(63<e[Y])return n("PTFault: bad sample @"+Hex(Y)),0
for(unpsz=s,K=G,ord=ptn=0,Y=7936;Y<8064&&e[Y];Y++)ord++,(pt=e[Y]-223)>ptn&&(ptn=pt)
if(ic>ptn<<2)return n("PTFault: "+ic+" bad notes"),0
for(Y=8096;Y<8128;Y++)e[Y]&&e[Y]<26&&(e[Y]+=96)
return a=decEncoding(e.slice(8096,8112),CPAmiga),composer=decEncoding(e.slice(8112,8128),CPAmiga),e=void 0,1}function i(s){return t[W++]=X.U8(s),3<W&&(W=0),t[0]===t[1]===t[2]===t[3]?-(end=1):X.U8(s)}function n(s){return e=void 0,debug&&_log(s),!1}})()&&(sName="Polly Tracker module (.MOD)",bDetected=1,X.isVerbose())&&X.isDeepScan()&&(sOptionT(a),sOptionT(composer,"by:"),sOption("tempo:"+Hex(tempo)+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" notes:"+notes+" unpsz:"+unpsz+" sz:"+outSz(K))),!bDetected&&gs()&&(sName="Ultima 6 Adlib module (.M)",sOption("unpsz:"+unpsz+" sz:"+outSz(K)),bDetected=1),!bDetected&&(function(){if(isWithin(X.U16(0,_BE),4,16)&&isWithin(X.U16(2,_BE),8,32)&&isWithin(X.U16(4,_BE),4,48)&&isWithin(X.U8(6),1,4)&&X.c("0400000000",7)&&(X.c("'WT'",12)||!X.U32(12,_BE))&&isWithin(X.U8(23),3,119)&&!(76<(E=X.U32(24,_BE))||3&E)){K=16
var s=Math.min(X.Sz(),65535)
for(k=0,G=28;G<Math.min(X.Sz()-1,1024);G+=12)if(!isWithin(X.U16(G,_BE),70,108))return
for(;K<s&&X.c("0056",K);){for(k++,Y=0;Y<4;Y++)for(K+=2;K<s&&!X.c("0046",K);K+=2);K+=12
break}return spd0=X.U16(14,_BE),!k||K<=s}})()&&(sName="Illusions/Microdeal Quartet module (QTS.+SMP., .4V+.SET)",sVersion="samples",bDetected=1,X.isVerbose())&&sOption((spd0?"spd0:"+spd0+" ":"")+"sz:"+outSz(K)),(function(){if(!(X.Sz()<17408)&&(124==X.U8(256)||124==X.U8(287))&&!(charStat(X.readBytes(256,32),1).indexOf("allasc")<0)&&255==X.U8(516)&&(tempo=X.U8(528),isWithin(tempo,2,10))&&(ord=X.U8(530)+1,isWithin(ord,1,101))&&!((loop=X.U8(529))>=ord||charStat(X.readBytes(768,128),1).indexOf("allasc")<0)){for(K=16384,Y=0;Y<8;Y++){if(X.U8(192+4*Y))return
if(!isWithin(X.U8(192+4*Y+1),128,192))return
if(!isWithin(bnk=X.U8(192+4*Y+2),88,95))return
if(!isWithin(sec=X.U8(192+4*Y+3),1,128))return
X.U16(192+4*Y)
var s=sec<<8
bnk&=7,K+=s}if(!(K>X.Sz())){for(K+=1024,F=X.SC(257,30,"CP1251").trim(),Y=smp=0;Y<16;Y++)if(1<X.U8(288+8*Y+4))return
for(Y=ptn=0;Y<100;Y++){if(31<(E=X.U8(416+Y)))return
ptn<E&&(ptn=E)}return ptn++,1}}})()&&(sName="SQ Digital Tracker module (.SQD,.M)",bDetected=1,X.isVerbose())&&(sOptionT(F),sOption("tempo:"+tempo+" ord:"+ord+(loop?" loop:"+loop:"")+" ptn:"+ptn+" sz:"+outSz(K))),!bDetected&&(function(){if(!X.U8(0)&&X.c("00000200",12)){for(G=16,ptn=0;G<4112&&-1!=X.I32(G);G+=2){if(X.U8(G))return
X.U8(G+1)>ptn&&(ptn=X.U8(G+1))}for(ptn++,ord=G-16>>3,d2=G,G=4112+48*ptn;G<Math.min(X.Sz(),196608)&&!X.U32(G,_BE);)G+=4
if(X.c("'FORM'........'8SVXVHDR'",G+640)){for(smptp=G,smp=0,smps="",Y=32,K=0;Y--;G+=4)if(!X.U8(G)){var s=smptp+X.I32(G,_BE),e=X.I32(G+128,_BE)
if(s<640||!X.c("'FORM'........'8SVXVHDR'",s))return
smp++,K<s+e&&(K=s+e)}return 1}}})()&&(sName="Michael Winterberg's Speedy A1 System module (.SAS)",bDetected=1,X.isVerbose())&&sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K)),!bDetected&&(function(){if(!(X.Sz()<382)&&isWithin(ord=X.U8(248),1,127)&&127==X.U8(249)){var s=X.U16(378,_BE)
if(G=377,B=0,s==X.U16(380,_BE)&&s==ord){for(ord_=-1,ptn=0;249<G;G--){if(100<(o=X.U8(G)))return
o&&ord_<0&&(ord_=G-249),o>=ptn&&(ptn=o+1)}for(ord_<0&&(ord_=1),G=smp=Y=0;Y<31;Y++,G+=8)(A=X.U16(G,_BE))&&(smp++,B+=A)
for(B<<=1,G=382,Y=m=0;Y<4*s;Y++,G+=2)m=Math.max(m,X.U16(G,_BE))
if(G+=m,1==ptn)for(E=X.U16(G-2,_BE),G+=2;G<X.Sz();G+=2)if(X.U16(G-2,_BE)==E)return 1
for(q=G,m=0;q<G+4;q++)m=Math.max(m,X.U8(q))
for(a3=G+m+4,m=0;q<a3;q++)m=Math.max(m,X.U8(q))
for(a3=G+m+4,m=0;q<a3;q++)m=Math.max(m,X.U8(q))
for(G+=2*m+4,songsz=G;X.c("04040404 08080808",G)&&G<65535;)G+=16
return 1}}})()&&(sName="Shaun Southern's Magnetic Fields Packer module (.MFP+.SMP)",bDetected=1,X.isVerbose())&&sOption("ord:"+ord+(ord!=ord_?"/"+ord_:"")+" ptn:"+ptn+" smp:"+smp+" smpsz:"+B+" songsz:"+songsz+" sz:"+outSz(G)),!bDetected&&(function(){if(!(X.Sz()<720)){for(G=ap=z=ic=0,nV=4,ofs=500;G<ofs;G+=2)4==nV&&isWithin(w=X.U16(G),500,65534)&&(1<debug&&_logIt("@"+Hex(G)+": "+Hex(w)),nV=3,ofs=X.c("6C776DFFFFFF6E6F",120)?250:120)
var s=Math.min(65535+ofs,X.Sz())
if(G=ofs,nV<4){for(nprog=150,Y=0;Y<nprog;Y++)if(w=X.U16(G),G+=2,w&&65535!=w){if(ap++,w<1e3&&(nV=1,600!=X.U16(120)))return
if(!isWithin(w,600,s))return 0<debug&&_logIt("!w="+w+"<600 or > sz"),0
w+=ofs,142!=(y=X.U8(w))&&9<y&&z++}if(1<nV){if(X.Sz()<1120)return
for(nprog=250,G=ofs+300,Y=150;Y<nprog;Y++,G+=2)if((w=X.U16(G))&&65535!=w){if(ap++,!isWithin(w,1e3,s))return 0<debug&&_logIt("!w="+w+"<1000 or > sz"),0
w+=ofs,(y=X.U8(w))||z++,142!=y&&9<y&&ic++}}}else{if(X.Sz()<2500)return
for(nprog=500,G=ofs,Y=0;Y<nprog;Y++,G+=2)if((w=X.U16(G))&&65535!=w){if(ap++,!isWithin(w,2e3,s))return 0<debug&&_logIt("!w="+w+"< 2000 or > sz"),0
w+=ofs,(y=X.U8(w))||z++,142!=y&&9<y&&ic++}}for(mw=Y=0,mo=(nprog<<1)+ofs;Y<nprog;Y++,G+=2)if((w=X.U16(G))&&65535!=w){if(ap++,w+=ofs,!isWithin(w,mo,X.Sz()))return 0<debug&&_logIt(!1+Hex(G)),0
mw=Math.max(mw,w)}if(!((K=mw+11)<6900)){if(ptn=[],4==nV)for(G=0;G<500;G+=2)!isWithin(y=X.U16(G),1,65534)||ptn.includes(y)||ptn.push(y)
else for(G=ofs;G<250;G+=2)!isWithin(y=X.U16(G),1,65534)||ptn.includes(y)||ptn.push(y)
return ptn=ptn.length,0<debug&&_log("@"+Hex(G)+" v:"+nV+" ic:"+ic+" zeros:"+z+" ap:"+ap+" ptn:"+ptn),ic<5&&z<50&&1<ap}}})()&&(sType="audio",sName="Westwood ADL module (.ADL)",bDetected=1,sVersion=250==ofs?"v.sfx":"v"+[,"1","2","2","3"][nV],X.isVerbose())&&sOption("ptn:"+ptn+" sz:"+outSz(K)),!bDetected&&(function(){var s,e,t,r,i,n,a,o
if(!(X.Sz()<52)&&(ordp=X.U16(0),ornp=X.U16(2),smpp=X.U16(4),orn=smpp-ornp,isWithin(orn,0,30))&&!(orn%2)&&(orn>>=1,s=ordp,!((smp=ordp-smpp)<=0||64<smp||smp%4))&&(smp>>=2,e=X.U16(6),ord=e-s-1,isWithin(ord,1,256))&&!(X.Sz()<12+ord+1+36*smp+34*orn+3-1)){for(n=(r=6)+2*orn+4*smp,p=X.Sz()+1-n,(n+=186)>X.Sz()+1-ord-1-3&&(n=X.Sz()+1-ord-1-3)%2&&--n;r<n&&(a=(i=X.U16(r))-s,isWithin(a,1,p))&&!(f()&&r+6<n&&l(r)&&(t=X.U16(r+2),!orn||t-X.I16(r-2)==32)&&(1==smp&&s-t==96||1<smp&&l(r+4)&&X.I16(r+6)-t==96));){if(i<e)return m("!cura < ptna: "+Hex(i)+" < "+Hex(e)),0
r+=2}if(!f())return m("!post-cycle invalid smp ofs"),0
if(!((n=r+4*smp)>X.Sz()+1-ord-1-3)){for(var p=X.Sz()+1-n,d=0,c=0;c<smp;c++,r+=4){if(l(r)||d++,1<d)return m("!badsmpparams"),0
if(a=(i=X.U16(r+2))-s,!isWithin(a,1,p))return m("!bad cura-orda"),0}for(c=0;c<ord;c++,r++)if(!isWithin(X.U8(r),1,31))return m("!badpos"),0
return X.U8(r)?(m("!badordendmarker"),0):(o=e-r-1,(ornp-o)%2||(smpp-o)%2?(m("!odd orna or smpa"),0):(s-=o)%2?(m("!odd orda"),0):!((K=X.U16(s-2)+96-o)<=s)||(m("!size<=orda"),0))}}function m(s){0<debug&&_log("[isFLS]@"+Hex(r)+": "+s)}function f(){return r>=12+2*orn&&!((r-2*orn)%6)}function l(s){var e=X.U8(s),s=X.U8(s+1)
if(!(32<e)){if(e){if(!isWithin(s,1,33-e))return}else if(!isWithin(s,1,32))return
return 1}}})()&&(sName="Amadeus Voxon/Flash Inc.'s Flash Tracker module (.FLS)",bDetected=1,X.isVerbose())&&sOption("ord:"+ord+" ptn:"+ptn+" smp:"+smp+" orn:"+orn+" sz:"+outSz(K)),X.isHeuristicScan()){if(extIs("imf")||extIs("wlf")?(freq=extIs("imf")?"560Hz (or 280Hz if Duke Nukem II)":"700Hz",_setResult("~audio","id/Apogee Music Format chiptune (.IMF)","","freq: "+freq)):extIs("svar")&&X.c("'PK'")&&_setResult("~audio","SVArTracker module (.SVAR)","",""),X.c("8400")?(sversion=240==X.U8(2)?"adv.":"",_setResult("~audio","Sierra Adlib chiptune (.SCI)",sversion,"")):X.c("1C52")?_setResult("~audio","Sound Interface System module (.LEM)","",""):X.c("'NED'")?_setResult("~audio","Nerd Tracker ][ module (.NED)","",""):X.c("'MODU'")?_setResult("~audio","NovoTrade Packer module (.NTP)","",X.isVerbose()?X.SA(4,16):""):(X.c("'Ice!'")||X.c("'ICE!'"))&&(dsize=X.U32(8,_BE),_setResult("~audio","Atari ST module (.SND,.SNDH)","compressed",X.isVerbose()?"orig.sz:"+dsize+" sz:"+outSz(X.U32(4,_BE)):"")),hdr=X.SA(0,2),!(["AY","YM","ay","ym"].indexOf(hdr)<0||6<X.U8(2)||(hasyear=["AY","YM"].indexOf(hdr)<0,yr=0,hasyear&&(yr=X.U16(10,_LE))&&(yr<1980||2050<yr))||(unpsz=X.U32(hasyear?12:10,_LE))<2||10485760<unpsz||(chipfrq=X.U32(5,_LE))<8e5||4e6<chipfrq)&&(intfrq=X.U8(9),1)){switch(sversion=X.U8(2)?"2ch":"1ch",hdr){case"AY":case"ay":sversion+=" AY-3-8910/12"
break
case"YM":case"ym":sversion+=" YM2149"
break
default:sversion+=" unk.chip"}X.isVerbose()&&(G=hasyear?16:14,E=X.SC(G,Math.min(256,X.Sz()-G),"CP1251"),sOptionT(E),G+=E.length+1,p=X.SC(G,Math.min(256,X.Sz()-G),"CP1251"),sOptionT(p,"by:"),G+=p.length+1,hasyear&&(yr&&sOption(yr,"'"),pr=X.SC(G,Math.min(256,X.Sz()-G),"CP1251"),G+=pr.length+1,sOptionT(pr,"for:"),tn=X.SA(G,Math.min(256,X.Sz()-G)),sOptionT(tn,"in:"),G+=tn.length+1,l=X.SA(G,Math.min(256,X.Sz()-G)),sOptionT(l)),sOption((7&X.U8(2)).toString(2).padStart(3,"0"),"mode:"),sOption(chipfrq,"chip freq:","Hz"),sOption(intfrq,"int.freq:","kHz"),E=Util.div64(unpsz,14*intfrq),sOption("time:"+secondsToTimeStr(E)),loop=X.U16(3,_LE))&&sOption(loop,"loop:"),_setResult("~audio","Vortex Project chiptune (.VTX)",sversion,sOptions),sOptions=""}(function(){if(!(X.Sz()<768||16793599<X.Sz())){K=en=0
nonzeroaddr=-1
var s=4294967295,e=[]
for(sus=0,bad="",Y=0;8*Y<(4294967295==s?768:Math.min(s,X.Sz()));Y++){var t=X.U32(8*Y,_BE),r=X.U32(8*Y+4,_BE)
if(t){if(t<8*Y||1048575<r)return
nonzeroaddr<0&&(nonzeroaddr=Y),t<s&&768<=t&&(s=t),e.push([t,r]),en++,K<t+r&&(K=t+r)}}return!en||4<findGaps(e,2).length?void 0:!((e=e.sort(function(s,e){return s[0]!=e[0]?s[0]-e[0]:s[1]-e[1]}))[0][0]%8||!isWithin(e[0][0],768,16384))}})()&&(sversion="",K>X.Sz()&&!X.isVerbose()&&(bad+="!short"),bad.length&&(sversion=sversion.appendS("malformed"+bad+(sus?"sus"+sus:""),"/")),_setResult("~audio","Konami's MXDRV PCM resource (.PDX)",sversion,X.isVerbose()?"entries:"+en+" sz:"+outSz(K):"")),X.Sz()<12||X.U32(0,_LE)||!(numnotes=X.U32(4,_LE))||8192<numnotes||!(numtracks=X.U32(8,_LE))||256<numtracks||(K=12+4*numtracks+11*numnotes)!=X.Sz()&&K!=X.Sz()+numnotes||(sversion=K>X.Sz()?"no panning effects":"",_setResult("~audio","Ken Silverman's Digital Music module (.KDM)",sversion,X.isVerbose()?"trk:"+numtracks+" notes:"+numnotes:"")),(function(){if(!(X.Sz()<111104||63<(lp=X.U8(0)))){for(ptn=0,Y=1;Y<100;Y++){if(31<(pt=X.U8(Y)))return
pt>ptn&&(ptn=pt)}if(ptn++,tmp=X.U8(100),(ord=X.U8(101))&&!(100<ord)&&!(lp>ord)){for(F=X.readBytes(102,28),Y=0;Y<28;Y++)if(F[Y]<32||127<F[Y])return
for(F=decEncoding(F,CPSpeccy),compiled=!isAllZeroes(200,56),allsmp=smp4bit=0,smps=[],G=256;G<512;G+=16){X.U16(G),X.U16(G+2),X.U8(G+4),X.U8(G+5),X.U16(G+6)
for(Y=8;Y<16;Y++)if(X.I8(G+Y)<32)return
""!=(E=decAnsi(G+8,8,CPSpeccy,!1).trim())&&smps.push(E)}return 1}}})()&&(C="Underground Systems Digital Studio module (.DST)",sversion=compiled?"compiled":"",X.isVerbose()?(sOptionT(F),sOptionT(smps.filter(funSampleName).join(" "),'smp/msg:"','"'),sOption("ord:"+ord+" ptn:"+ptn+(lp?" loop:"+lp:"")+" page0:"+X.U8(512)+" sz:"+outSz(compiled?115200:111104)),O=sOptions,sOptions=""):O="",_setResult("~audio",C,sversion,O)),(function(){if(!(X.Sz()<112640||63<(lp=X.U8(0))||(tmp=X.U8(1))<3||15<tmp||64<(ord=X.U8(2)))){for(F=X.readBytes(3,30),Y=0;Y<30;Y++)if(F[Y]<32||127<F[Y])return
for(F=decEncoding(F,CPSpeccy),ptn=0,G=34;G<134;G++){if(31<(pt=X.U8(G)))return
pt>ptn&&(ptn=pt)}for(ptn++;G<166;G++){var s=X.U8(G)
if(s<4||64<s)return}var e=[81,83,84,86,87]
for(Y=0;G<186;Y++,G+=4){if(124<X.U8(G))return
if(X.U8(G+1)!=e[Y])return
if(X.U8(G+2)&&X.U8(G+2)<132)return
if(16<X.U8(G+3))return}var t=0
for(G=188;G<203;G++)X.U8(G)&&t++
if(!(3<t)){var r=X.readBytes(203,53,!0)
if(!(charStat(r,!0).indexOf("allasc")<=0||X.U8(255)))for(smps=[],G=256;G<512;G+=16){if(e.indexOf(X.U8(G+4))<0)return
if(16<X.U8(G+5))return
if(124<X.U8(G+6))return
for(E=X.readBytes(G+8,8),Y=0;Y<8;Y++)if(E[Y]<32||127<E[Y])return
""!=(E=decEncoding(F,CPSpeccy).trim())&&smps.push(E)}}}})(),(!X.c("4EFA....4EFA....4EFA")||(Z=X.U16(2,_BE))>X.Sz()-10?void 0:X.c("4BFA.... 08AD 0000",Z+2))&&_setResult("~audio","Jeroen 'WAVE' Tel & Charles Deenen's Maniacs of Noise module (.MON)","",""),(function(){if(!(X.Sz()<128)){for(oldp=smp=0,Y=0;Y<128;Y+=8){if((G=X.U16(Y,_BE))>X.Sz())return
if(G){if(G<oldp)return
oldp=G,smp++}if(!X.c("0010 01000000",Y+2)&&!X.c("0000 00000000",Y+2))return}return smp<8?void 0:1}})()&&_setResult("~audio","Jochen 'Mad Max' Hippel's Atari ST sample set (SMP.set)","",X.isVerbose()?"smp:"+smp+" sz:"+outSz(oldp):""),!bDetected&&X.isDeepScan()&&(function(){if(notes=chs=0,!(X.Sz()<480)&&(timediv=X.U32(0,_LE))&&!([96,128,480].indexOf(timediv)<0)&&(maxtime=X.U32(4))&&(gdnum=X.U32(8))){G=12+10*gdnum
var s=pbs=ccs=0
for(ch=0;ch<16;ch++){if(notenum=X.U32(G),G+=4,notes+=notenum,1e6<notenum)return
if(notenum){if(chs++,(G+=5*notenum)>X.Sz())return
for(s+=pcnum=X.U32(G),G+=4+4*pcnum,pbnum=X.U32(G),pbs+=pbnum,G+=4+5*pbnum,cn=0;cn<7;cn++)ccnum=X.U32(G),ccs+=ccnum,G+=4+4*ccnum}if(G>X.Sz())return}if(!(!notes||ccs>50*notes||pbs>3*notes||s>3*notes||maxtime<notes||16384<(size=X.U32(G))||(G+=4+size)>X.Sz()||1048576<(size=X.U32(G))||(G+=4+size)>X.Sz())){if(spsize=X.U32(G),G+=4,spsize<8192){for(Y=G+4,q=4*X.U32(G),E=Math.min(X.Sz,G+4+q);Y<E;Y+=4)if(!isWithin(X.U32(Y),q,G-4+spsize))return
G+=spsize}return K=G,1}}})()&&(sName="farbrausch V2 Synthesizer module (.V2M)",bDetected=1,X.isVerbose())&&(sOptions="ch:"+chs+" notes:"+notes+" timediv:"+timediv+" maxtime:"+maxtime+(spsize?" syn.speech":"")+" sz:"+outSz(K)),!X.c("01000000",6)||X.Sz()<1500||9e3<X.Sz()||X.calculateEntropy(12,1200)<7.8||_setResult("~audio","TwinTeam's Twin Trackplayer module (.DMO)","",X.isVerbose()?"unp.sz:"+X.U16(12):""),(function(){for(O="",smp=ptn=smpsz=0,Y=0;Y<32;Y++){if(charStat(E=X.readBytes(32*Y,16),1).indexOf("allxsc")<0)return
var s=E.indexOf(0)
if(s){if(s<0)return
for(c=15;s<c&&!E[c];)c--
if(s<c)return
var e=X.U32(32*Y+20,_BE)
e&&(smpsz+=e,smp++)}}if(tmp0=X.U8(1152),ord=X.U8(1153),!(!smpsz||!tmp0||15<tmp0||!ord||128<ord)){for(Y=0;Y<ord;Y++)(E=X.U8(1154+Y)+1)>ptn&&(ptn=E)
if(!(32<ptn)){for(;Y<128;Y++)if(X.U8(1154+Y))return
return K=1282+2048*ptn+smpsz,X.Sz()<K?void 0:(O="tmp0:"+tmp0+" ord:"+ord+" ptn:"+ptn+" smp:"+smp+" sz:"+outSz(K),1)}}})()&&_setResult("~audio","SHINING 8's Voices_8/8CHNL Soundtracker module","",X.isVerbose()?O:""),(function(){if(!(X.Sz()<2739||59188<X.Sz()||isAllZeroes(0,1524))){G=E=ic=0
var s=[[10,13],[23,14],[35,38],[41,45],[58,63],[69,80],[90,94],[105,107],[117,119],[122,125],[131,133],[137,138],[179,191],[211,223],[250,254]],e=[[27,28],[33,47],[52,62],[65,71],[73,84],[90,94],[102,114],[117,127],[129,135],[137,191],[201,207],[209,223]],t=[[43,46],,[54,62],[69,76],[81,87],[89,103],[105,108],[110,113],[118,128],[136,143],[157,175],[177,191],[193,201],[203,207]],r=[[1,5],[7,16],[21,30],[39,44],[57,62],[69,79],[87,95],[105,109],[138,142],[154,159],[172,176],[185,191],[199,209],[215,223],[232,239],[250,253]],i=[[1,15],[25,30],[39,46],[55,63],[73,79],[88,95],[106,110],[120,127],[137,143],[154,159],[172,174],[186,198],[201,210],[213,227],[234,238],[250,252]],a=[[10,14],[27,30],[36,38],[55,58],[60,63],[73,78],[90,96],[107,110],[124,126],[128,131],[138,144],[154,161],[167,175],[177,198],[200,205],[207,220],[222,224],[226,230],[232,237]],o=[[12,14],[25,30],[39,46],[57,65],[89,94],[106,110],[121,127],[138,149],[154,165],[171,198],[202,205],[209,222],[224,237]],p=[[18,21],[23,31],[35,54],[56,63],[65,77],[79,81],[90,96],[98,104],[106,109],[111,126],[128,147],[149,245]],d=[[16,23],[25,64],[66,96],[101,104],[106,118],[122,144],[146,177]],c=[[16,28],[33,47],[49,66],[73,84],[86,93],[96,109],[111,114],[116,136],[1930,152]],f=[[10,15],[18,31],[33,47],[49,54],[56,63],[69,86],[88,95],[97,102],[104,111],[120,127],[129,150],[154,239],[241,254]]
for(Y=0,m=X.isDeepScan()?127:16;Y<m;Y++,G+=12)if(E=X.U8(G),(isWithinRanges(E,s)||isWithin(E,165,177))&&ic++,E=X.U8(G+1),(isWithinRanges(E,s)||isWithin(E,146,167))&&ic++,(225<=(E=X.U8(G+2))||isWithinRanges(E,e))&&ic++,(209<=(E=X.U8(G+3))||isWithinRanges(E,t))&&ic++,E=X.U8(G+4),isWithinRanges(E,r)&&ic++,E=X.U8(G+5),isWithinRanges(E,i)&&ic++,E=X.U8(G+6),isWithinRanges(E,a)&&ic++,E=X.U8(G+7),isWithinRanges(E,o)&&ic++,(247<=(E=X.U8(G+8))||isWithinRanges(E,p))&&ic++,(179<=(E=X.U8(G+9))||isWithinRanges(E,d))&&ic++,(154<=(E=X.U8(G+10))||isWithinRanges(E,c))&&ic++,E=X.U8(G+11),isWithinRanges(E,f)&&ic++,2<ic)return
if(ptn=ord=k=0,!(177<X.U8(1536))){for(visited=[],Y=0;Y<50;Y++)visited[Y]=!1
for(G=1536;G<1587&&!visited[G-1536]&&(visited[G-1536]=!0,isInside(E,49,128)&&(E=255),!(177<(E=X.U8(G))));G++)if(128&E&&E<=177){if(1586<(E=(E&63)+1536)||177<X.U8(E)||E==G)return 0<debug&&_logIt("@"+Hex(G)+", t:"+Hex(E)+" :: "+Hex(X.U8(E))),0
G=1536+E-1}else 128&E?ic++:(ptn<E&&(ptn=E),ord++)
for(q=1586;1536<q&&255!=X.U8(q);q--);if(ord&&(ptn||255==X.U8(G))&&(k||k++,!(50<++ptn))){K=(G=1587)+1152*ptn
var l=0
for(Y=0;Y<576*ptn&&l<100;Y++)if(n=X.U8(G++),m=X.U8(G++),n||m){if(202<=n||isWithinRanges(n,[[98,126],[129,143],[145,200]]))return
if(isWithinRanges(m,[[56,67],[69,81],[86,95],[105,128],[130,136],[138,155],[157,159],[170,174],[215,221],[223,230],[232,239],[249,254]]))return
if(isWithin(m,7,15)&&128!=n&&0!=n&&ic++,isWithin(m,112,159)){if(129!=m&&137!=m)return
ic++}if(20<ic)return
l++}return ic&&(bad="!ic"+ic),1}}}})()&&(O="",X.isVerbose()&&(O=(O=1<k?"×"+k:O).appendS("ord:"+ord+" ptn:"+ptn+" sz:"+outSz(K),", ")),_setResult("~audio","Hannes Seifert's HSC Adlib Composer/ECR HSC-Tracker module (.HSC)",bad.length?"malformed"+bad:"",O)),(function(){if(!(X.Sz()<Math.max(X.U16(30),48))){var s
for(ch=0,Y=oldp=0;Y<16;Y++){if(!isWithin(s=X.U16(2*Y),Math.max(48,oldp),X.Sz()))return
if(Y&&128!=X.U8(s-1))return
128!=X.U8(s)&&ch++,oldp=s}return 1}})()&&_setResult("~audio","K.Ohshima's FMX chiptune (.FMX)","",X.isVerbose()?"ch:"+ch:""),X.Sz()<352||(_gyminfo=parseMDGYM(0,X.isDeepScan()?BCParseToEoF:BCParseToReasonable),0<debug&&_logIt("gym?"+outArray(_gyminfo,16)),_gyminfo[0]<0)||_setResult("~audio","Sega Genesis/Mega Drive YM2612 chiptune (.GYM)","headerless",X.isDeepScan()?"notes:"+_gyminfo[0]+" sz:"+outSz(_gyminfo[1]):""),X.isOverlay()||X.Sz()<352||(0<debug&&(rs=new CheckpointTimer).init(300),_cyminfo=parseYM2151RegLog(0,X.isDeepScan()?BCParseToEoF:BCParseToReasonable),0<debug&&rs.next("OPM (.cym) parsed"),0<debug&&_logIt("cym?"+outArray(_cyminfo,16)),_cyminfo[0]<0)||_setResult("~audio","YM2151 OPM/Callus chiptune (.CYM)","headerless",X.isDeepScan()?"notes:"+_cyminfo[0]+" sz:"+outSz(_cyminfo[1]):""),X.isOverlay()||X.Sz()<352||(0<debug&&(es=new CheckpointTimer).init(300),_opl2info=parseYM3812RegLog(0,X.isDeepScan()?BCParseToEoF:BCParseToReasonable),0<debug&&es.next("OPM (.cym) parsed"),0<debug&&_logIt("cym?"+outArray(_cyminfo,16)),_opl2info[0]<0)||_setResult("~audio","YM3812/OPL2/Ad Lib chiptune","headerless",X.isDeepScan()?"notes:"+_opl2info[0]+" sz:"+outSz(_opl2info[1]):""),(function(){var s,e,t
return X.Sz()<27||(X.U16(0),(t=(e=(s=8+X.U16(2))+X.U16(4))+X.U16(6))>X.Sz())||1&s||1&e||1&t?void 0:X.c("014F",s-2)&&X.c("014F",e-2)&&X.c("014F",t-2)&&(K=t,E="",X.Sz()>t&&0<(G=X.fSig(t,4096,"00")-t+1)&&(E=decAnsi(t,G,CPFullCPETshifted,!0).trim(),K+=G),1)})()&&_setResult("~audio","COMPUTE!'s Enhanced SidPlayer tune (.MUS+.STR+.WDS)","",(E.length?'"'+addEllipsis(E,256,160)+'"':"").append("sz:"+outSz(K)))}return result()}function zs(){for(E=X.readBytes(20,8),Y=0;Y<8;Y++)if(E[Y]<32||127<=E[Y])return
if((isstm=!([26,2].indexOf(X.U8(28))<0||[1,2].indexOf(X.U8(29))<0||!X.c("02",30)||[0,10,20,21].indexOf(X.U8(31))<0||64<X.U8(33)||64<(gvol=X.U8(34))&&88!=gvol||(nVm=X.U8(31),ptn=X.U8(33),maxord=nVm?128:64,minsz=1040+maxord+256*ptn,X.Sz()<minsz)||(smp=0,ord=-1,tracker="Sami 'Psi' Tammilehto's Scream Tracker 2 module",ext="STM",0)))||(isstx=(function(){if(!X.c("'SCRM'",60))return!1
if((ptnsz=X.U16(28))<64&&26!=ptnsz||2112<ptnsz)return!1
if(X.U16(30)||X.U32(38)||1!=X.U32(44))return!1
if(64<(E=X.U8(42))&&88!=E)return!1
if(64<(ptn=X.U16(48)))return!1
if(96<(smp=X.U16(50)))return!1
if(129<(ord=X.U16(52))&&257!=ord)return!1
if(ptntp=X.U16(32)<<4,smptp=X.U16(34)<<4,chtp=X.U16(36)<<4,minsz=64+Math.max(ptntp+2*ptn,smptp+2*smp,chtp+32+5*ord),X.Sz()<minsz)return!1
if(findIntersections([[ptntp,2*ptn],[smptp,2*smp],[chtp,32+5*ord]]).length)return!1
for(G=chtp+32,Y=0;Y<ord;Y++,G+=5)if(63<(E=X.U8(G))&&99!=E&&255!=E)return!1
return tracker="Sami 'Psi' Tammilehto's Scream Tracker Music Interface Kit module",ext="STX",!0})())){if(K=sz1=minsz,smpn=[],max=0,isstm){for(Y=0;Y<31;Y++){if((zero=X.U8(48+32*Y+12))&&46!=zero)return
smpn.push(X.SC(48+32*Y,12,"CP437").trim())
var s=X.U16(48+32*Y+14,_LE)<<4,e=X.U16(48+32*Y+16,_LE)
e&&48<s&&s<X.Sz()&&((sz1=e?s+e:sz1)>K&&(K=sz1),1<e)&&smp++}for(Y=0;Y<maxord;Y++)if(99===(E=X.U8(1040+Y))||255===E)E=255
else{if(63<E)return
ord++}ord++}else{if(!isstx)return
for(G=smptp,Y=0;Y<smp;Y++)si=X.U16(G+2*Y)<<4,smpn.push(X.SC(si+48,28,"CP437").trim()),si&&1===X.U8(si)&&(s=X.U16(si+14)<<4)>max&&(e=X.U32(si+16),4&X.U8(si+31)&&(e*=2),max=s,K<max+e)&&(K=max+e)
if(fmt=1,ptntp&&26!=ptnsz){if((G=X.U16(ptntp)<<4)>X.Sz())return X.isHeuristicScan()&&(bad=bad.addIfNone("!badptnp"),1)
X.U16(G)===ptnsz&&(fmt=0)}for(Y=0,G=ptntp;Y<ptn;Y++,G+=2){if((E=X.U16(G)<<4)>X.Sz()&&X.isHeuristicScan())return bad=bad.addIfNone("!badptnp"),1
if(0==fmt&&2112<X.U16(E))return}}return 1}}function Es(){var e=0
if(X.c("'IMPM'"))type="it"
else{if(!X.c("'tpm.'"))return
type="mpt"}if((ord=X.U16(32,_LE))||e++,99<(ins=X.U16(34,_LE))&&e++,255<(smp=X.U16(36,_LE))&&e++,(ptn=X.U16(38,_LE))||X.isHeuristicScan()||e++,!(X.Sz()<192+4*(ins+smp+ptn)||(cwtv=X.U16(40,_LE),cmwt=X.U16(42,_LE),flags=X.U16(44,_LE),special=X.U16(46,_LE),128<(gvol=X.U8(48))&&e++,128<(mvol=X.U8(49))&&e++,(spd0=X.U8(50))||e++,(tmp0=X.U8(51))<31&&e++,128<(sep=X.U8(52))&&e++,msglen=X.U16(54,_LE),(msgofs=X.U32(56,_LE))+msglen>X.Sz()&&e++,2<e))){bad="",e&&(bad=bad.addIfNone("!badinitinfo")),pwd=X.U8(53),nreserved=X.U32(60,_LE),sreserved=X.SA(60,4),tracker=auth="",mVlsw=mVcw=sV="?",ch=1,cord=0,K=-1
var s=0,t=0
if(type="it",chnm=[],insnlst=[],smpnlst=[],X.isDeepScan()){var w=0<=X.fSig(64,64,"FF"),r=0
function i(s){return s.slice(0,1)+"."+s.slice(1,3)+"."+s.slice(3,5)+"."+s.slice(5,7)}if(X.c("'tpm.'"))type="mpt",G=X.Sz()-4,s=X.U32(G,_LE),X.c("'228'04'mptm'",s)?K=X.Sz():s=0
else{if(2184<cwtv<=4095&&(G=X.Sz()-4,256<=(s=X.U32(G,_LE))<X.Sz()-4))if(X.c("'228'04'mptm'",s)){if(type="mpt",K=X.Sz(),4096<=cwtv)return sV="future",charset="UTF8",extsmp=0,1}else s=0
"it"===type&&(20480==(61440&cwtv)?(r=(4095&cwtv)<<16,X.c("'OMPT'",60)?0:19464192<=r&&(r|=65535&nreserved),mVlsw=i(r.toString(16).toUpperCase().padStart(7,"0"))):2184===cwtv||2184===cmwt?mVlsw="1.17.00.00":532!==cwtv||514!==cmwt||nreserved?768!==cwtv||768!==cmwt||nreserved||256!==ord||128!==sep||pwd||(mVlsw="1.17.02.20",0):(mVlsw="1.09.00.00",tracker="ModPlug Tracker b3.2 - 1.09",0))}var n=-1,a=0
if("mpt"===type&&2186<cwtv&&cwtv<=2189){if(G=192,X.U16(G,_LE))return
if(G+=2,n=X.U32(G,_LE),G+=4,256<n||X.Sz()<G+4*n)return}else G=192
for(0<=n&&(ord=n),Y=0;Y<ord;Y++)n<0?254===(o=X.U8(G++))?a=65534:(cord++,255===o&&(a=65535)):(o=X.U32(G,_LE),G+=4,a=o,cord++)
minp=4294967295
var L=[]
for(Y=0;Y<ins;Y++){if((e=X.U32(G,_LE))<=(G+=4)||e>X.Sz())return
q=X.readBytes(e+32,26,!0),""!=(q=decEncoding(q,CP437,!1).trim())&&insnlst.push(q),K<e&&(K=e),e&&e<minp&&(minp=e),L.push(e)}var p=[]
for(Y=0;Y<smp;Y++)e=X.U32(G,_LE),G+=4,e>X.Sz()&&(bad=bad.addIfNone("!short")),q=X.readBytes(e+20,26,!0),""!=(q=decEncoding(q,CP437,!1).trim())&&smpnlst.push(q),K<e&&(K=e),e&&e<minp&&(minp=e),p.push(e)
var d=[]
for(Y=0;Y<ptn;Y++){if(e=X.U32(G,_LE),G+=4,30<e&&e<=G||e>X.Sz())return
K<e&&(K=e),e&&e<minp&&(minp=e),d.push(e)}1&special&&(minp=Math.min(minp,msgofs),K<msgofs+msglen)&&(K=msgofs+msglen)
r=!(532!==cmwt||cwtv&&532!==cwtv||X.U16(30)||pwd||nreserved||192&flags)
if(r&&!ins&&smp&&G+4*p.length+2<=minp){var c=!0
for(Y=0;Y<smp;Y++){if(X.U32(G)){c=!1,G-=4*Y
break}G+=4}c&&(tracker="UNMO3 <= v2.4")}r&&!cwtv&&(tracker="UNMO3 v0/1"),2&special?(T=X.U16(G),X.Sz()>G+8*T&&G+8*T<=minp&&(G+=2+8*T,r)&&!T&&(tracker=4&special?"UNMO3 <= 2.4.0.1":"UNMO3")):r&&special<=1&&!X.U16(G)&&(tracker="UNMO3 <= 2.4",G+=2)
var m=0
if((128&flags||8&special)&&(G+=4896),G>X.Sz())return
for(var f=hasPluginChunks=hasMPTM=!1;G+9<X.Sz();){if(hkhd=X.SA(G,4),hksz=X.U32(G+4,_LE),"MODU"===hkhd)f=!0
else if("CNAM"===hkhd)for(ch=hksz/20,m=G+8,hasMPTM=!0,Y=0;Y<ch;Y++)e=X.SA(m,20).trim(),m+=20,""!=e&&chnm.push(e)
else"PNAM"===hkhd?hasMPTM=!0:"CHFX"!==hkhd&&!/F[X0-9]\d\d/.test(hkhd)||(hasPluginChunks=!0)
if(0<=["IMPI","IMPS","XTPM","STPM"].indexOf(hkhd)||G+8+hksz>X.Sz()||G>=msgofs)break
G+=8+hksz}535!==cwtv||512!==cmwt||nreserved||f||(tracker=hasMPTM||0<ord&&65535==a||w?(mVlsw="1.16.00.00","ModPlug Tracker 1.09-16"):(mVlsw="1.17.00.00","OpenMPT 1.17 (compat.export)"),0)
var l,t=0<smp?p[smp-1]+80:G,b=!1,U=!(extsmp=[])
for(Ss=[],maxsmpofs=-1,Y=0;Y<smp;Y++)if(p[Y])if(p[Y]>X.Sz())bad=bad.addIfNone("!short")
else{X.c("'IMPS'",p[Y])||(bad=bad.addIfNone("!badsmp"))
var u=X.U8(p[Y]+18),z=X.U8(p[Y]+46),E=X.U32(p[Y]+48),k=X.U32(p[Y]+72)
if(S={ofs:0,slen:0,bits:2&u?16:8,chn:1,en:"LE",codec:"sPCM",bps:0,length:0},G=k,S.ofs=k,S.slen=E,64===z)G+=12
else if(128===z)e=readVarUInt(G),extsmp.push(X.SA(G+1,e[1])),G+=e[0]+e[1]
else if(X.c("'fLaC'",k))S.codec="FLAC"
else if(X.c("'OggS'",k))S.codec="Ogg"
else{switch(S.codec=1&z?"sPCM":"uPCM",4&u&&532<=cwtv&&(S.chn=2),8&u?S.codec=4&z?"IT215":"IT214":2&u||255!=z?(2&z&&(S.en="BE"),4&z&&(S.codec="dPCM"),8&z&&(S.codec="8d16")):S.codec="ADPCM",S.codec){case"sPCM":case"uPCM":case"dPCM":case"fPCM":case"MT2":case"fPCM15":case"fPCM23":case"fPCMn":case"sPCMn":S.bps=S.bits
break
case"8d16":S.bps=16
break
case"ADPCM":S.bps=4
break
case"uLaw":case"aLaw":S.bps=8
break
default:S.bps=0}S.bps?(S.length=E*S.chn*(S.bps>>3),G+=S.length):b=!0,Ss[Y]=S}K<(t=t<G?G:t)&&(K=t),"uPCM"===S.codec&&E&&(U=!0)}if(U&&516===cwtv&&512===cmwt&&!special&&!nreserved&&21==(-9&flags)&&128===gvol&&48===mvol&&128===sep&&!pwd&&!msglen){for(Y=0;Y<64;Y++)if([32,64].indexOf(X.U8(64+Y))<0){U=!1
break}if(U)for(Y=0;Y<64;Y++)if(64!=X.U8(128+Y)){U=!1
break}if(U)for(Y=20;Y<26;Y++)if(X.U8(4+Y)){U=!1
break}U&&(tracker="XM Conversion")}for(Y=0;Y<ptn;Y++)if((e=d[Y])&&!(e>X.Sz())){X.U16(e,_LE)
var F=X.U16(e+2,_LE)
if(e+=4,!(!F||1024<F||e+4>X.Sz())){G=e+4
for(var _,O=[],B=0;B<F&&G<X.Sz();)(x=X.U8(G++))?((_=127&x)&&_--,128&x&&(O[_]=X.U8(G++)),15&O[_]&&ch<=_&&_<127&&(ch=_+1),1&O[_]&&G++,2&O[_]&&G++,4&O[_]&&G++,8&O[_]&&(G+=2)):B++
K<(t=t<G?G:t)&&(K=t)}}if(ch=ch||1,t&&(G=t,b)){if((S=Ss[Ss.length-1]).bps)S.bps%8?S.length=("ADPCM"==S.codec?16:0)+Math.ceil((E+1)/2*S.ch):S.length=("ADPCM"==S.codec?16:0)+S.slen*S.bps/8*S.chn
else if(4==S.bps&&1==S.chn&&"LE"==S.en&&"ADPCM"==S.codec)S.length=16+(S.slen+1)/2,G+=S.length
else if(1<S.slen&&("IT214"===S.codec||"IT215"===S.codec)){for(var m=G,V=0,R=0;m<X.Sz()&&V<S.slen;){if(X.c("'XTPM'",m)||X.c("'STPM'",m)||X.c("'228'04'mptm'",m)){R=1,G=m
break}V+=ucsz=X.U16(m,_LE),m+=2+ucsz}if(R)G=m
else{var v=bit_buf=cend=readdef=0
function W(s){for(;v<s;)bit_buf|=Util.shlu64(X.U8(G++),v),v+=8
var e=bit_buf&Util.shlu64(1,s)-1
return bit_buf=Util.shru64(bit_buf,s),v-=s,e}for(defW=16==S.bits?(fetchA=4,lowerB=-8,upperB=7,17):(fetchA=3,lowerB=-4,upperB=3,9),_=0;_<S.chn;_++){var g=S.slen,A=csz=clen=topbit=0
for(cend=G;g&&G<X.Sz();)if(csz=X.U16(G,_LE),cend=(G+=2)+csz,csz){if(cend>X.Sz()){_=3599,bad=bad.addIfNone("!short")
break}clen=Math.min(g,32768>>(S.bits>>4))
var D=defW
for(bit_buf=v=0;clen&&G<X.Sz();){if(D>defW){bad=bad.addIfNone("!badITsmp"),g=0
break}if(A=W(D),topbit=1<<D-1,D<7){if(A==topbit){D<=(A=W(fetchA)+1)&&A++,D=A
continue}}else if(D<defW){if(A>=topbit+lowerB&&A<=topbit+upperB){D<=(A-=topbit-1+lowerB)&&A++,D=A
continue}}else if(A&topbit){D=1+(255&A)
continue}clen--,g--}}else readdef=10,_log("IT @"+Hex(G)+" malformed sample?")
G>X.Sz()&&(bad=bad.addIfNone("!short"))}}}else"FLAC"!==S.codec&&"Ogg"!==S.codec&&("AMS"===S.codec&&1==S.chn?(sOption("\n!!! Please send this file to the detector dev!!! Poor fella hasn't any to test on"),l=X.U32(G+4,_LE),X.U8(G+8),S.length=l+9):"8d16"===S.codec&&1==S.chn&&16==S.bps?sOption("\n!!! Please send this file to the detector dev!!! Poor fella hasn't any to test on"):"MDL"===S.codec&&1==S.chn&&S.bps<=16?(l=X.U32(G),S.length=4+l):"DMF"===S.codec&&1==S.chn&&S.bps<=16?sOption("\n!!! Please send this file to the detector dev!!! Poor fella hasn't any to test on"):"uLaw"!==S.codec&&"aLaw"!==S.codec||16!=S.bps||(S.length=S.slen*S.chn))
K<G&&(K=G)}if(X.c("'XTPM'",G)){for(G+=4;G+6<X.Sz()&&(e=X.SA(G,4),it=X.U32(G),!("STPM"===e||"228"===e||2155905152&it))&&1616928864&it;){var M=X.U16(G+4,_LE)
for(G+=6,Y=0;Y<ins;Y++)G+=M}K<G&&(K=G)}if(X.c("'STPM'",G)){for(G+=4;G+7<X.Sz();){if(e=X.SA(G,4),it=X.U32(G),M=X.U16(G+4,_LE),"228"===e||"228"==e){s=G
break}if(2155905152&it||!(1616928864&it)||G+6+M>X.Sz())break
switch(G+=6,e){case"...C":var C=0
switch(M){case 2:C=X.U16(G,_LE)
break
case 3:C=X.U24(G,_LE)
break
case 4:C=X.U32(G,_LE)
break
default:C=X.U8(G)}C>ch&&(ch=C)
break
case".VWC":A=0
switch(M){case 1:A=X.U8(G)
break
case 2:A=X.U16(G,_LE)
break
case 3:A=X.U24(G,_LE)
break
case 8:A=X.U64(G,_LE)
break
default:A=X.U32(G,_LE)}A&&(mVcw=i(A.toString(16).toUpperCase().padStart(7,"0")))
break
case"VWSL":A=0
switch(M){case 1:A=X.U8(G)
break
case 2:A=X.U16(G,_LE)
break
case 3:A=X.U24(G,_LE)
break
case 8:A=X.U64(G,_LE)
break
default:A=X.U32(G,_LE)}A&&(mVlsw=i(A.toString(16).toUpperCase().padStart(7,"0")))
break
case"AUTH":auth=X.SC(G,M,"UTF8")}G+=M}K<G&&(K=G)}if(tunings=0,X.c("'HSCT'",G)){var T=!1,A=X.I32(G+4,_LE)
G+=8,1==A?(sOption("Please send this file to the detection author!!! This is ultra-rare, how did you make it?!"),G=(G+=X.U32(G))+(4+Math.min(256,j))):2==A?G+=1+X.U8(G):(T=!0,bad=bad.addIfNone("!badtuningver")),T||(tunings=X.U32(G+2),G+=6,e=X.fSig(G,4096,"'FSCT'"),G<=e&&(G=e+4)),K<G&&(K=G)}else if(X.c("'228'04'mptm'",G)){function I(s){var e=0,t=0,r=0
if(!(G+1<X.Sz()))return 0
if(e=X.U8(G++),16==s)t=1&e
else if(32==s)t=3&e
else{if(64!=s)return 0
t=(1<<(3&e))-1}for(var r=16==s?e>>1:e>>2,i=0;i<t;i++){if(e=0,!(G+1<X.Sz()))return 0
r|=(e=X.U8(G++))<<8*(i+1)-2}return r}if(s=s||G,(function(){var s
return!X.c("'228'",G)||(posstart=G,G+=3,s=X.U8(G++),h=X.SA(G,s),G+=s,flagbyte=0,hd=X.U8(G++),idbytes=3==(3&hd)?4:3&hd,twochar=64&hd,1<(hsz=I(32))&&((e=X.U8(G++))||(flagbyte=X.U8(G)),G+=hsz-1),s=i((e=16&hd?I(64):e).toString(16).toUpperCase().padStart(7,"0")),"?"===mVlsw&&(mVlsw=s+"[mptinfo]"),32&hd&&(G+=X.U8(G++)),1&flagbyte&&(e=X.U8(G++),idbytes=1&e?65535:e>>1),fes=0,2&flagbyte&&(fes=I(32)),hasstartpos=4&hd,hassz=8&hd,hasid=idbytes,hasdesc=128&hd,hasmap=hasid||hasstartpos||hassz||hasdesc,4&flagbyte&&(e=I(16),G+=e*(twochar?2:1)),8&flagbyte&&(G+=5),entries=I(64),hasmap&&(e=I(64)),G>X.Sz())?void 0:(rposMapBegin=hasmap?e:G-posstart,1)})()&&(hasmap||fes))for(G=posstart+rposMapBegin,Y=0;Y<entries&&G<X.Sz();Y++){var N=idbytes
65535==N&&(N=I(16)),G+=N,hasstartpos&&I(64),fes||hassz&&I(64),hasdesc&&(e=I(16),G+=e*(twochar?2:1))}K<G+4&&(K=G+4),X.U32(G,_LE)!=s&&(bad=bad.addIfNone("!badmptptr"))}if("?"!=(mVlsw="?"===mVlsw&&2184===cwtv?"1.17.00.00":mVlsw)&&""===tracker)tracker="OpenMPT",isCompatX=20480==(61440&cwtv),(isCompatX="1.17.00.00"===mVlsw&&"OMPT"!=sreserved?!1:isCompatX)?tracker+=" (compat. export)":("1.17.02.54"<mVlsw&&mVlsw<"1.18.02.00"&&"1.18.00.00"!=mVlsw||"1.18.02.00"<mVlsw&&"00"!=mVlsw.slice(mVlsw.length-2,mVlsw.length))&&(tracker+=" (test build)")
else{8191===cwtv?nreserved:cwtv
switch(cwtv>>12){case 0:f?tracker="BeRoTracker":532!==cwtv||512!==cmwt||9!==flags||special||X.U16(62)||ins||ptn+1!==ord||128!==gvol||100!==mvol||1!==spd||128!==sep||pwd||msglen||msgofs||nreserved?532!==cwtv||512!==cmwt||X.U16(62)||nreserved?532===cwtv&&532===cmwt&&"CHBI"===sreserved?tracker="ChibiTracker":532===cwtv&&532===cmwt&&special<=1&&!pwd&&!nreserved&&4==(4262&flags)&&1<smp&&X.c("'XXXXXXXX.YYY'",p[1]+4)?tracker="CheeseTracker":cwtv||""!==tracker?cmwt<768&&""===tracker&&(tracker=532<cmwt?"Impulse Tracker 2.15":isWithin(cwtv,533,535)?"Impulse Tracker 2.14p"+(533==cwtv?"1-2":534==cwtv?"3":"4-5"):"Impulse Tracker "+((3840&cwtv)>>8)+"."+(255&cwtv).toString(16).padStart(2)):tracker="Unknown":(mVlsw="1.00.00.A5",tracker="ModPlug Tracker 1.00a5",0):tracker="OpenSPC conversion"
break
case 1:var x,P,y=4095&cwtv
tracker=y<=80?"Schism Tracker 0."+y.toString(16):((P=(y=734016+(y<4095?y-80:nreserved))-(365*(x=Util.div64(1e4*y+14780,3652425))+Util.div64(x,4)-Util.div64(x,100)+Util.div64(x,400)))<0&&(P=y-(365*--x+Util.div64(x,4)-Util.div64(x,100)+Util.div64(x,400))),y=Util.div64(100*P+52,3060),"Schism Tracker "+(x+Util.div64(y+2,12)).padStart(4,"0")+"-"+((y+2)%12+1).padStart(2,"0")+"-"+(P-Util.div64(306*y+5,10)+1).padStart(2,"0"))
break
case 4:tracker="pyIT "+((3840&cwtv)>>8)+"."+(255&cwtv).toString(16)
break
case 6:tracker="BeRoTracker"
break
case 7:tracker=32767===cwtv&&533===cmwt?"munch.py":"ITMCK "+(cwtv>>8&15)+"."+(cwtv>>4&15)+"."+(15&cwtv)
break
case 13:tracker=56043==cwtv?"spc2it":53710==cwtv?"itwriter":"unknown"}}}"?"!=mVlsw?(charset="CP1252",sV="?"==mVcw?mVlsw:mVcw!=mVlsw?"cw:"+mVcw+"/lsw:"+mVlsw:mVcw):(charset="CP437","?"!=mVcw&&(sV=mVcw))
var H=0
for(Y=0;Y<bad.length;Y++)"!"==bad[Y]&&H++
return H<3}}function ks(s){switch(s){case 1:sv="v1.04+"
break
case 0:sv="v1.00~3"
break
default:return}var e=Math.min(X.Sz(),65536)
if(!(e<78)){var t=X.U16(69),r=X.U16(71),i=X.U16(74)
if(isWithin(t,78,e)&&isWithin(r,78,e-11)&&isWithin(i,78,Math.min(e,140))&&!(i%2)){var n=X.U16(i)+s*i,t=X.U16(76)+76*s,a=X.U16(i-2)+76*s
if(!(t>Math.min(i+64,X.Sz()-5)||e<=n||e<=a||n-a<8||(n-a)%6!=2)){for(G=t+4,smp=0;G<e&&32&X.U8(G);G+=6)smp++
if(!(65534<G||G>X.Sz())){if(0<i-76-2){if(G+3!=X.U16(78)+76*s)return}else if(G+4!=n)return
if(G=r+1,255!=X.U8(G)){for(ord=ptn=0;G+3<e;){if(!isInside(X.U16(G+1),n,r)||!isInside(X.U16(G+3),n,r)||!isInside(X.U16(G+5),n,r))return
if(G+=8,ord++,255==X.U8(G)){if(X.U8(G-1)>=ord)return
lp=X.U8(G-1)
break}ptn=Math.max(ptn,X.U8(G-1)+1)}return K=G+3,dly=X.U8(73),ftitle=0<=charStat(X.readBytes(0,24),!0).indexOf("allasc"),fby=0<=charStat(X.readBytes(46,23),!0).indexOf("allasc"),1}}}}}}function ss(){if(!(X.Sz()<8||(orntp=X.U16(5))>X.Sz()-6||(ptntp=X.U16(7),(j1=ptntp-orntp)<=0)||(smptp=X.U16(3),(j2=orntp-smptp)<=0)||(ordp=X.U16(1),(j3=smptp-ordp)>X.Sz())||(j4=ordp-9)<=0)){if(j4%130){if(j4<55||(j4-55)%130)return
fID=!0}else fID=!1
if(smp=X.U8(smptp),isWithin(smp,1,16)&&(G=130*smp+9+(fID?55:0),ordp==G)&&(ord=X.U8(G))){for(ptn=Y=0;Y<ord;Y++)ptn=Math.max(ptn+1,X.U8(G+1+2*Y))
if(G+=2*ord+1,(smptp==G||smptp==G+2)&&(orn=X.U8(orntp))&&!(16<orn)&&(G=smptp+2*smp+1+32*orn,orntp==G)&&(G+=2*orn+1,X.U16(ptntp)==G)&&(base=X.U16(smptp+1)-9,fID&&(base-=55),!(base<0))&&(G=X.U16(orntp+1)-base)==smptp+2*smp+1){for(Y=G;Y<G+32;Y++)if(X.U8(Y))return
for(j8=-1,G=ordp+2,Y=0;Y<ord;Y++){if((b=X.U8(G))%6)return
j8<b&&(j8=b),G+=2}if(bad="",(K=ptntp+j8+6)-1>X.Sz()&&(bad=bad.addIfNone("!short")),!(65536<base+G))return!0}}}}function Fs(){function s(s){for(;G<X.Sz()&&(E=X.c(s,G),G+=2,!E););}function e(s){for(;0<G&&(G-=2,!X.c(s,G)););}if(fmt="",G=0,X.c("48E7F0F0")){if(!X.c("424047FA FFF84A2B",4))return
if(fmt="old",!X.isVerbose())return 1
for(a0=G=12,s("43FA"),d7=G+X.U16(G,_BE)+1,s("228A"),d2=(G+=2)-8+X.U16(G-8,_BE),s("137B"),d6=a4=G+X.U16(G,_BE)-1,k=1;d6<X.Sz()&&(d6+=10,X.U16(d6,_BE))&&!X.U8(d6);)k++
e("48E7")
var t,r=X.U16(a4+2,_BE)
for(d0=k;d0--;)for(a4+=2,d3=4;d3--;)E=X.U16(a4,_BE),a4+=2,E<r&&(r=E)
for(G=r,r=t=X.U16(G,_BE),G+=2;(E=X.U16(G,_BE))&&(E<r&&(r=E),t<E)&&(t=E),(G+=2)<d7;);for(a3=r,synsmp=r-d2>>7,G=t;G<X.Sz()&&!(0<=[133,135].indexOf(X.U8(G)));)G++
d0=0
do{for(;a3<X.Sz()&&!(0<=[133,135].indexOf(X.U8(a3)));)a3++}while(a3++,d0++,a3<G)
if(G++,a3=d6){for(d1=128,found=!1;d1--&&!found;)E=X.c("41FA",a3),a3+=2,E&&(found=!0)
if(found){for(a3+=X.U16(a3,_BE);a3<X.Sz()&&(X.c("FF",a3+4)||X.c("FF",a3+6));)a3+=18
G=a3}K=G,steps=d0}}else{for(G=172;G<224&&(E=X.c("48E7",G),G+=2,!E););if(224<G)return
if(!X.c("F8FC",G)&&!X.c("F8F8",G))return
if(!X.c("08F90001 00BFE001 33FC0780 00DFF09A 47FA",G+2))return
if(65536-(G+=20)-X.U16(G,_BE))return
if(fmt="new",!X.isVerbose())return 1
G=0,s("48E7"),s("49F9"),G+=6,s("7600"),d0=X.U16(G-10,_BE)
for(var i="10320000";G<X.Sz()&&!X.c(i,G);)G+=2
for(a4=G-2+X.U16(G-2,_BE),s("48E7"),G=a3=G-6,s("43FA"),G+=X.U16(G,_BE)-1,a4-=G,d3=Util.divu64(a4,18),k=1,d2=0;G<X.Sz()&&(G+=18,d2=X.U16(G,_BE),!X.U8(G,_BE))&&!(--d2<=0);k++);for(d3<k&&(k=d3),G=a3,e("45FA"),d0=G=G-2+X.U16(G-2,_BE),synsmp=smp=d5=0,smpp=G+=4;G<X.Sz();)if((E=X.U32(G,_BE))>d0){if(smp||(d5=E),E<=d5&&(d5=a4=E),smp++,(G+=10)>a4)break}else synsmp++,G+=10
for(Y=smp+synsmp,K=0,G=smpp;Y--&&G<X.Sz();)E=X.U32(G,_BE)+X.U16(G+4,_BE),K<E&&(K=E),G+=10}return 1}function _s(){var s=modp=ofsdiff=0
if(bad="",(function(){if(!(X.Sz()<2830)&&X.c("4EFA....4EFA....4EFA....4EFA")&&!((s=X.I16(2,_BE)+2)<=16||s%2)&&(X.c("123A.... B0016200 007E47FA 08761680 45FA0873 49FA086E D5C01892 E7887E03 7C0041FA 08D8",s)||X.c("42380001 123A.... B0016200 007E47FA 08B61680 45FA08B3 49FA08AE D5C01892 E7887E03 7C0041FA 0918",s))){for(Y=0;Y<4;Y++)if(X.c("123A....B001",s+2*Y)){modp=s+2*Y+1+X.I16(s+2*Y+2,_BE)
break}if(!(4==Y||modp>X.Sz()))for(;Y<60;Y++)if(X.c("47FA....D7FA",s+2*Y))return ofsdiff=s+2*(Y+1)+X.I16(s+2*Y+2,_BE),1}})()&&(s=modp+1,!(10<(k=X.U8(s++)+1)))){for(spd0=X.U8(s++),spds=[],Y=0;Y<10;Y++)E=X.U8(s++),spds.indexOf(E)<0&&spds.push(E)
s++
var e=ofsdiff+X.U32(s,_BE),t=ofsdiff+X.U32(s+4,_BE),r=(Math.abs(e-t),[]),i=[],n=[]
for(Y=0,ord=[],s+=620;Y<k;Y++)r[Y]=[0,0,0,0],ord[Y]=0
for(Y=0;Y<k;Y++)for(c=0;c<4&&s<X.Sz();c++,s+=2)r[Y][c]=X.U16(s,_BE)-8*k>>1
if(!(s>X.Sz())){for(ordp=s,otsz=Math.min(e,t)-s>>1,Y=0;Y<otsz;Y++,s+=2)i.push(X.I16(s,_BE))
for(trksz=Math.abs(e-t),Y=tr=0;Y<trksz;tr++){for(si=Y;128!=X.U8(s+Y++)&&Y!=trksz&&s+Y<X.Sz(););if(Y==trksz&&128!=X.U8(s+Y-1))break
n[si]=tr}for(Y=0;Y<k&&s<X.Sz();Y++)for(c=0;c<4&&s<X.Sz();c++)for(on=!0,l=r[Y][c];l-r[Y][c]<255&&0<=i[l];l++)if(void 0===n[i[l]])return
for(syn=smp=0,msmpp=2147483647,Msmpp=smpe=0,s=e;;){var a=X.U32(s,_BE),o=X.I16(s+4,_BE),p=X.U16(s+6,_BE)<<1,d=X.U8(s+39)
if(s+40>=X.Sz()||s+63>=msmpp)break
if(255!=d)if(a){if((a+=ofsdiff)>X.Sz())break
a<msmpp&&(msmpp=a),a>Msmpp&&a<X.Sz()&&(Msmpp=a,smpe=a+p),smp++}else{if(-779===o)break
if(-1!=o&&0!=d)return
syn++}s+=64}return K=smp?smpe:s,1}}}function Os(){if(!(X.Sz()<512)){var s=tp=mdatsz=smplsz=-1,e=0
if(F=album=by="",flag5=-1,tfmxst=!1,X.c("'TFMX-MOD'")){if(s=e=20,K=X.U32(12,_LE),smplsz=K-X.U32(8,_LE),!(mdatsz=X.U32(8,_LE)-8)||!isWithin(K,530,X.Sz()))return
for(;K<X.Sz();){E=X.U8(K)
var t=X.U16(K+1,_LE)
if(K+=3,!E&&!t)break
switch(E){case 1:by=X.SC(K,t,"CP1252")
break
case 2:album=X.SC(K,t,"CP1252")
break
case 5:flag5=X.U8(K)
break
case 6:F=X.SC(K,t,"CP1252")}if(!E){K+=17
break}K+=t}}if(X.c("'TFHD'")){if(s=X.U32(4,_BE),tp=X.U8(8),v=X.U8(9),mdatsz=X.U32(10,_BE),smplsz=X.U32(14,_BE),K=s+mdatsz+smplsz,s<18||!mdatsz||!isWithin(K,530,X.Sz()))return
if(128&tp||!(127&tp))e=G=s
else switch(127&tp){case 1:tp="1.5"
break
case 2:tp="pro"
break
case 3:tp="7v"
break
default:return}}else if(X.c("'TFMX '",e)&&!X.c("'SONG'",e+5))tp="1.5"
else{if(!(X.c("'TFMX-SONG'",e)||X.c("'TFMX_SONG'",e)||X.c("'tfmxsong'",e)))return
var r=0,i=!1,n=X.readBytes(e+256,31),a=(a=X.U32(e+464,_BE))||2048
for(Y=0;Y<31;Y++){var o=!0,p=n[Y]
if(511==p)break
for(;o&&G<X.Sz();)if(G=e+a+16*p,E=X.U16(G,_BE),cmd=X.U16(G+2,_BE),G+=4,61438!=E)o=!1
else switch(cmd){case 1:r?r<0?(p=X.U16(G,_BE),r=X.I16(G+2,_BE)-1,G+=4):(r--,p=X.U16(G,_BE),G+=2):(r=-1,p++)
break
case 2:case 4:p++
break
case 3:i=!0,p++
break
default:o=i=!1}if(i)break}if((function(s){var e,t=X.U32(s+468,_BE)
t?(e=X.U32(s+472,_BE),e=X.U32(s+e,_BE)):(e=X.U32(s+1536,_BE),t=X.U32(s+2044,_BE))
for(var r=X.readBytes(s+e,t-e),i=0;i<r.length;i+=4)if(isWithin(r[i],64,127))return 1})())return
tfmxst=!0,tp=i?"7v":"pro"}for(Y=0,G=e+16,cmt="";Y<6;Y++,G+=40)cmt=cmt.appendS(decAnsi(G,40,CPAmiga).trim(),"  ")
cmt=cmt.trim(),_l2r("tfmxcmt",e+16,decAnsi(G,240,CPAmiga).trim())
var d=[],c=[],m=[]
for(Y=0;Y<32;Y++)d.push(X.I16(G,_BE)),G+=2
for(Y=0;Y<32;Y++)c.push(X.I16(G,_BE)),G+=2
for(Y=0;Y<32;Y++)m.push(X.I16(G,_BE)),G+=2
G+=16
var f=X.I32(G,_BE),l=X.I32(G+4,_BE),b=X.I32(G+8,_BE)
if(l?l-=512:l=512,b?b-=512:b=1024,f?f-=512:f=1536,!((G+=48)>X.Sz())){var S=G,U=Math.min(196608+S,X.Sz())
for(l+=S,b+=S,f+=S,len=0<s?mdatsz:Math.min(U,X.Sz())-G,ins=mip=0,G=b,ino=X.I32(G,_BE);ins<256&&G+4<=X.Sz()&&!(3&(E=X.I32(G,_BE)-512+S)||!isWithin(E,f,U)||E&!X.c("F0000000",E-4)&&!X.c("07000000",E-4)||ins&&8192<Math.abs(E-ino));ins++,G+=4)mip<E&&(mip=E),ins&&(ino=E)
ptn=Math.min(b-l>>2,128)
var u=X.U32(l,_BE)-512+S
if(pt=ptn,(trkst=u-f>>4)<0&&(trkst=0),s<0)switch(Math.max(b,l,mip)){case b:K=b+4*ins
break
case mip:for(G=mip;G<U&&!X.c("07000000",G);G+=4);(K=G)<U&&(K+=4)
break
case l:for(_l2r("tfmx",S,"p:"+Hex(G)+" ptnp:"+Hex(l)+" insp:"+Hex(b)+" trkp:"+Hex(f)+" trkst["+Hex(l)+"="+Hex(u)+"]:"+Hex(trkst)+" len:"+Hex(len)+"/"+Hex(U)),G=l+4,po=X.I32(l,_BE),pt=1;pt<256&&!(3&(E=X.I32(G,_BE)-512+S)||!isWithin(E,f,U)||!X.c("F0000000",E-4)&&!X.c("07000000",E-4)||8192<Math.abs(E-po));G+=4,pt++)po=E
K=G}k=-1
var h=2
for(ord=[0],Y=0;Y<32&&0<h&&(k++,d[Y]||h--,511!=d[Y]&&511!=c[Y])&&(d[Y]<=trkst&&(ord[k]=c[Y]-d[Y]+1),!(d[Y]>=trkst))&&(d[Y]!=c[Y]||d[Y]||d[Y+1]);Y++);return k=k||1,1}}}function Bs(){if(!(X.Sz()<7)&&(z=sig=X.c("'P50A'")||X.c("'P60A'")||X.c("'P61A'")?4:0,smpp=X.U16(z,_BE)+z,ptn=X.U8(z+2))&&!(127<ptn)&&!(32&(smp=X.U8(z+3)))&&(pksmp=64&smp,dtsmp=128&smp,smp&=63)&&!(7+6*smp>X.Sz())&&(pksmp&&(z+=4),!(smpp<z+4+6*smp+8*ptn||smpp>X.Sz()))){smpsz=notes=0
var s=vols=0
for(Y=0,G=z+4;Y<smp;Y++,G+=6){if(isWithin(A=X.U16(G,_BE),32768,65503)||!A)return
if(65503<A&&65535-A>smp)return
var e=128&X.U8(G+2)
if(15<(127&X.U8(G+2))||64<X.U8(G+3))return
if(vols|=X.U8(G+3),isWithin(X.U16(G+4,_BE),A,65534))return
A<65280&&(smpsz+=A<<(e?0:1),s+=A<<1)}if(vols&&(!pksmp||X.U32(z,_BE)==s)){for(Y=0;Y<4*ptn;Y++)if(X.U16(z+4+6*smp,_BE)+4+z+6*smp+8*ptn>smpp)return
if(Y=mptn=0,(function(){for(;255!=(E=X.U8(z+4+6*smp+8*ptn+Y))&&Y<128;Y++){if(E>ptn-1)return
E>mptn&&(mptn=E)}return 1})())v=6
else{if(!(function(){for(;255!=(E=X.U8(z+4+6*smp+8*ptn+Y))&&Y<128;Y++){if(E%2||E>2*ptn)return
E>mptn&&(mptn=E)}return mptn>>=1,1})())return
v=5}if(Y&&128!=Y){if(ord=Y,mptn++,6==v)if(t())sv="6.0"
else{if(!(function(){for(Y=ord+z+5+6*smp+8*ptn;Y<smpp;Y++)if(127!=(E=X.U8(Y))){if(255==E)switch(192&X.U8(Y+1)){case 0:Y++
continue
case 64:Y+=2
continue
case 192:if(Y<X.U16(Y+2,_BE)-1)return
Y+=3
continue}switch(240&E){case 240:if((31&X.U8(Y+1))>smp)return
Y+=2
continue
case 112:if((31&X.U8(Y+1))>smp)return
Y+=1
continue
case 224:Y+=2
continue
case 96:Y+=1
continue}if(128==(128&E)){if((E<<4&16|X.U8(Y+1)>>4)>smp)return
Y+=3}else{if((E<<4&16|X.U8(Y+1)>>4)>smp)return
Y+=2}}return 1})())return
sv="6.1"}else t()&&(sv="5.0")
return 1}}}function t(){for(Y=ord+z+5+6*smp+8*ptn;Y<smpp;Y++)if(128&(E=X.U8(Y)))Y+=3
else{if(73<E||(E<<4&16|X.U8(Y+1)>>4)>smp)return
2<=E&&notes++,Y+=2}return 0<notes}}function Vs(){if((bin=parseAtariBinary(0))[0]<256)return 1<debug&&_l2r("rmt","!binsz",void 0),0
if(base=X.U16(2),G=bin[1][0][0],ch=X.U8(G+3)-48,X.c("'RMT'",G)&&[4,8].includes(ch)){var s,e,t,r
X.U8(G+4)
if(spd0=X.U8(G+5),spd)if(ticks=X.U8(G+6))return v=X.U8(G+7),s=G+X.U16(G+8)-base,e=G+X.U16(G+10)-base,t=G+X.U16(G+12)-base,r=G+X.U16(G+14)-base,s>X.Sz()||e<s||t<e||r<t||e>X.Sz()||t>X.Sz()||r>X.Sz()?void 0:1}}function gs(){if(!(X.Sz()<421)&&isWithin(unpsz=X.U16(0),782,2849)&&X.c("00000007",2)){var s,e,t=0,r=Math.min(X.Sz(),unpsz),i=new BitReader(4),n=!1,a=0,o=9,p=258,d=[],c=defdictsz=4096,m=[],f=258
for(Y=0;Y<c-256;Y++)m.push({rt:0,cw:0})
var l=[]
for(Y=0;Y<unpsz;Y++)l.push(0)
for(;!n&&i.offset<=r&&t<=unpsz;){if(o<9||12<o)return
switch(e=i.read(o)){case 256:if(c=512,f=p=258,(o=9)<9||12<o)return
if(e=i.read(o),t>=unpsz)return
l[t++]=255&e
break
case 257:n=!0
break
default:S=b=void 0
for(var b=e<p?e:a,S=b;255<S;)d.push(m[S-256].rt),S=m[S-256].cw
if(d.push(255&S),s=255&d[d.length-1],e<p)for(;d.length;){if(t>=unpsz)return
l[t++]=255&d.pop()}else{for(;d.length;){if(t>=unpsz)return
l[t++]=s,d.pop()}if(e!=p)return}f<c&&(m[f-256]={rt:s,cw:a},f++),c<=++p&&o<12&&(o++,c<<=1)}a=e}return n?(K=i.offset,!(131!=l[0]||l[1]||8&l[2]||32&l[3]||128&l[5]||1<l[6])):void 0}}}