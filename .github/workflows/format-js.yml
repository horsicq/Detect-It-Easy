name: Format JavaScript Files

on:
  push:
    paths:
      - 'db/**'
      - 'db_custom/**'
      - 'db_extra/**'
    branches: 
      - master

jobs:
  format: 
    runs-on: ubuntu-latest
    
    permissions:
      contents:  write
    
    steps: 
      - name:  Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets. RELEASE_TOKEN }}
      
      - name: Setup Node. js
        uses:  actions/setup-node@v4
        with:
          node-version: '20'
      
      - name:  Install Prettier
        run:  npm install -g prettier
      
      - name: Format JavaScript files in db directories
        run: |
          find db db_custom db_extra -type f \
            !  -path '*/.vscode/*' \
            ! -path '*/_icons/*' \
            ! -name '*.txt' \
            ! -name '*.md' \
            ! -name '*.png' \
            ! -name '*.ico' \
            ! -name '*.svg' \
            -print0 2>/dev/null | while IFS= read -r -d '' file; do
              # Skip files with beautify ignore comment
              if grep -q 'beautify ignore: start' "$file" 2>/dev/null; then
                echo "Skipping (beautify ignore): $file"
                continue
              fi
              
              # Check if file contains JavaScript-like syntax
              if head -c 1000 "$file" 2>/dev/null | grep -qE '(function|var |if\s*\(|for\s*\(|return |includeScript)'; then
                echo "Formatting: $file"
                
                # Check if file ends with newline
                if [ -s "$file" ] && [ "$(tail -c 1 "$file" | od -An -tx1 | tr -d ' ')" = "0a" ]; then
                  HAS_NEWLINE=true
                else
                  HAS_NEWLINE=false
                fi
                
                # Format with prettier
                prettier --write "$file" --parser babel || true
                
                # Restore original ending if file had no trailing newline
                if [ "$HAS_NEWLINE" = false ] && [ -s "$file" ]; then
                  truncate -s -1 "$file" 2>/dev/null || perl -pi -e 'chomp if eof' "$file"
                fi
              fi
            done
      
      - name: Check for changes
        id: check_changes
        run:  |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name:  Commit and push changes
        if: steps.check_changes. outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply. github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "style: auto-format JavaScript files in db directories"
          git push
