name: Format JavaScript Files

on:
  push:
    paths:
      - 'db/**'
      - 'db_custom/**'
      - 'db_extra/**'
    branches: 
      - master

jobs:
  format:
    runs-on: ubuntu-latest
    
    permissions:
      contents:  write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets. RELEASE_TOKEN }}
      
      - name:  Setup Node.js
        uses: actions/setup-node@v4
        with: 
          node-version:  '20'
      
      - name:  Install Prettier
        run:  npm install -g prettier
      
      - name: Format JavaScript files in db directories
        run: |
          # Find all files (excluding . vscode, _icons, and binary files)
          # Format files that contain JavaScript-like syntax
          
          find db db_custom db_extra -type f \
            !  -path '*/.vscode/*' \
            ! -path '*/_icons/*' \
            !  -name '*.txt' \
            !  -name '*.md' \
            !  -name '*.png' \
            !  -name '*.ico' \
            !  -name '*.svg' \
            -print0 2>/dev/null | while IFS= read -r -d '' file; do
              # Check if file contains JavaScript-like syntax
              if head -c 1000 "$file" 2>/dev/null | grep -qE '(function|var |if\s*\(|for\s*\(|return |includeScript)'; then
                echo "Formatting:  $file"
                prettier --write "$file" --parser babel --tab-width 4 --print-width 120 || true
              fi
            done
      
      - name: Check for changes
        id: check_changes
        run:  |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name:  Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users. noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "style: auto-format JavaScript files in db directories"
          git push
